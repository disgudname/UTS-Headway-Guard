<!doctype html>
<link rel="icon" type="image/png" href="UTSShield.png" />
<meta charset="utf-8">
<title>UTS Operations Dashboard Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
@font-face{font-family:'FGDC';src:url('FGDC.ttf') format('truetype')}
body{font:16px 'FGDC',system-ui;background:#0b0e11;color:#e8eef5;margin:0;padding:20px;}
label{display:block;margin:8px 0;}
input,textarea{width:100%;padding:6px;border-radius:4px;border:1px solid #2a3442;background:#10151c;color:#e8eef5;}
button{margin-top:12px;padding:10px 14px;border-radius:6px;border:1px solid #2a3442;background:#15202b;color:#e8eef5;cursor:pointer;}
.panel{margin-top:24px;padding:16px;border:1px solid #2a3442;border-radius:8px;background:#10151c;}
.panel h2{margin-top:0;margin-bottom:12px;font-size:18px;}
.secret{display:flex;flex-direction:column;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid #202a36;}
.secret:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
.secret code{word-break:break-all;background:#15202b;padding:6px;border-radius:6px;margin-top:6px;display:block;}
.credit{position:fixed;bottom:8px;right:8px;font-size:12px;color:var(--muted,#9fb0c9)}
.logout-button{position:fixed;top:16px;right:16px;padding:10px 16px;border-radius:6px;border:1px solid #2a3442;background:#182330;color:#e8eef5;cursor:pointer;z-index:10001}
.modal-overlay{position:fixed;inset:0;background:rgba(11,14,17,.92);display:flex;align-items:center;justify-content:center;z-index:10002;padding:20px;}
.modal{max-width:420px;background:#10151c;border:1px solid #2a3442;border-radius:10px;padding:24px;box-shadow:0 12px 32px rgba(0,0,0,.5);text-align:center;}
.modal h2{margin:0 0 12px;font-size:20px;}
.modal p{margin:0 0 20px;line-height:1.4;}
.modal button{margin-top:0;width:100%;}
.progress{width:100%;height:12px;border-radius:6px;background:#15202b;overflow:hidden;margin-top:16px;}
.progress-bar{height:100%;width:0;background:#3a8ef6;transition:width .3s ease;}
</style>
<button id="logoutButton" type="button" class="logout-button" hidden>Log Out</button>
<div class="modal-overlay" id="adminWarning">
  <div class="modal">
    <h2>Heads Up!</h2>
    <p>Hey! There are a lot of delicate settings here! Are you certain whatever you're doing is worth it?</p>
    <button type="button" id="adminWarningAck">Yep, I'm prepared to break things</button>
  </div>
</div>
<div class="modal-overlay" id="savingModal" style="display:none;">
  <div class="modal">
    <h2>Saving, please do not close this page</h2>
    <div class="progress">
      <div class="progress-bar" id="savingProgress"></div>
    </div>
  </div>
</div>
<h1>UTS Operations Dashboard Admin</h1>
<form id="cfg"></form>
<button id="save">Save</button>
<button id="forceRefresh">Force Refresh</button>
<div class="panel" id="secretPanel">
  <h2>Environment Secrets</h2>
  <div id="secrets"></div>
</div>
<div class="credit">proof of concept created by pat cox â€¢ phc6j@virginia.edu</div>
<script>
async function load(){
  let resp;
  try{
    resp=await fetch('/v1/config',{cache:'no-store'});
  }catch(err){
    const error=new Error('Failed to load configuration');
    error.cause=err;
    throw error;
  }
  if(!resp.ok){
    const error=new Error('Failed to load configuration');
    error.status=resp.status;
    throw error;
  }
  const cfg=await resp.json();
  const form=document.getElementById('cfg');
  form.innerHTML='';
  for(const [k,v] of Object.entries(cfg)){
    const label=document.createElement('label');
    label.textContent=k;
    let inp;
    if(Array.isArray(v)){
      inp=document.createElement('textarea');
      inp.rows=2;
      inp.value=v.join(',');
    }else{
      inp=document.createElement('input');
      inp.value=v;
    }
    inp.name=k;
    label.appendChild(inp);
    form.appendChild(label);
  }
  const secretRoot=document.getElementById('secrets');
  if(secretRoot){
    secretRoot.innerHTML='';
    const notice=document.createElement('div');
    notice.textContent='Environment secrets are hidden for security reasons.';
    secretRoot.appendChild(notice);
  }
}
const REQUIRED_CONFIG_SAVE_MACHINES=2;
async function save(){
  const form=document.getElementById('cfg');
  const data={};
  for(const el of form.elements){
    if(!el.name) continue;
    if(el.tagName==='TEXTAREA'){
      data[el.name]=el.value.split(',').map(s=>s.trim()).filter(Boolean);
    }else{
      const num=parseFloat(el.value);
      data[el.name]=isNaN(num)?el.value:num;
    }
  }
  if(saveButton) saveButton.disabled=true;
  if(savingProgress) savingProgress.style.width='0%';
  if(savingModal) savingModal.style.display='flex';
  try{
    const resp=await fetch('/v1/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    if(!resp.ok){
      throw new Error('Failed to save configuration');
    }
    let payload=null;
    try{
      payload=await resp.json();
    }catch(_err){
      payload=null;
    }
    const machines=new Set();
    const headerMachines=resp.headers && resp.headers.get ? resp.headers.get('x-commit-machines') : null;
    if(headerMachines){
      headerMachines.split(',').map(s=>s.trim()).filter(Boolean).forEach(id=>machines.add(id));
    }
    const committed=payload && typeof payload==='object' ? payload.committed_machine_ids || payload.committedMachineIds : null;
    if(Array.isArray(committed)){
      committed.map(id=>String(id).trim()).filter(Boolean).forEach(id=>machines.add(id));
    }
    if(machines.size<REQUIRED_CONFIG_SAVE_MACHINES){
      throw new Error('Commit confirmation missing required machines');
    }
    if(savingProgress){
      savingProgress.style.width='100%';
    }
    alert('Saved!');
  }catch(err){
    console.error('Failed to save configuration',err);
    alert('Unable to save configuration. Please try again.');
  }finally{
    if(savingModal) savingModal.style.display='none';
    if(savingProgress) savingProgress.style.width='0%';
    if(saveButton) saveButton.disabled=false;
  }
}
function buildReturnTarget(){
  const path=window.location.pathname||'/';
  const search=window.location.search||'';
  const hash=window.location.hash||'';
  return `${path}${search}${hash}`;
}
function redirectToLogin(){
  const target=buildReturnTarget();
  window.location.href=`/login?return=${encodeURIComponent(target)}`;
}
const saveButton=document.getElementById('save');
const savingModal=document.getElementById('savingModal');
const savingProgress=document.getElementById('savingProgress');
if(saveButton){
  saveButton.addEventListener('click',evt=>{
    evt.preventDefault();
    save();
  });
}
document.getElementById('forceRefresh').onclick=()=>{
  fetch('/v1/servicecrew/refresh',{method:'POST'});
};
const logoutButton=document.getElementById('logoutButton');
if(logoutButton){
  const defaultLabel=logoutButton.textContent;
  logoutButton.addEventListener('click',async ()=>{
    logoutButton.disabled=true;
    logoutButton.textContent='Logging out...';
    try{
      const resp=await fetch('/api/dispatcher/logout',{method:'POST'});
      if(!resp.ok) throw new Error('logout failed');
      window.location.href=`/login?return=${encodeURIComponent(buildReturnTarget())}`;
    }catch(err){
      logoutButton.disabled=false;
      logoutButton.textContent=defaultLabel;
      alert('Unable to log out. Please try again.');
    }
  });
}
const warningModal=document.getElementById('adminWarning');
const warningButton=document.getElementById('adminWarningAck');
if(warningButton){
  warningButton.addEventListener('click',()=>{
    if(warningModal){
      warningModal.style.display='none';
    }
  });
}
async function bootstrap(){
  try{
    await load();
    if(logoutButton) logoutButton.hidden=false;
  }catch(err){
    if(err && err.status===401){
      redirectToLogin();
      return;
    }
    console.error('Failed to load admin panel',err);
    alert('Unable to load admin panel. Please refresh.');
  }
}
if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded',bootstrap,{once:true});
}else{
  bootstrap();
}
</script>
