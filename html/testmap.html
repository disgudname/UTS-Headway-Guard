<!DOCTYPE html>
<html>
  <head>
<link rel="icon" type="image/png" href="UTSShield.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/media/apple-touch-icon-120.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/media/apple-touch-icon-152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/media/apple-touch-icon-180.png" />
    <title>Live Map - UTS Operations Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="testmap.css" />
    <script defer src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script defer src="https://unpkg.com/@mapbox/polyline@1.1.1"></script>
    <script defer src="https://unpkg.com/rbush@3.0.1/rbush.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
    <script defer src="testmap.js"></script>
  </head>
  <body>
    <div id="map"></div>
    <div id="kioskStatusMessage" class="kiosk-status-message" aria-live="polite" aria-hidden="true">
      No active vehicles
    </div>
    <div id="routeLegend" aria-live="polite"></div>
    <div id="controlPanel" class="selector-panel"></div>
    <div id="routeSelector" class="selector-panel"></div>
    <div
      id="controlPanelTab"
      class="panel-toggle panel-toggle--left"
      data-arrow-direction="in"
      onclick="toggleControlPanel()"
      title="Toggle system controls"
    >
      <svg class="panel-toggle__arrow" viewBox="0 0 16 24" aria-hidden="true" focusable="false">
        <path d="M4 3l8 9-8 9z" />
      </svg>
    </div>
    <div
      id="routeSelectorTab"
      class="panel-toggle panel-toggle--right"
      data-arrow-direction="in"
      onclick="toggleRoutePanel()"
      title="Toggle route selector"
    >
      <svg class="panel-toggle__arrow" viewBox="0 0 16 24" aria-hidden="true" focusable="false">
        <path d="M4 3l8 9-8 9z" />
      </svg>
    </div>
    <div class="credit">proof of concept created by pat cox • phc6j@virginia.edu • Radar tiles © NOAA/NWS via Iowa Environmental Mesonet.</div>
    <div id="mapToast" class="map-toast" role="status" aria-live="polite" aria-atomic="true" aria-hidden="true"></div>
    <div id="cookieBanner" class="cookie-banner" style="display:none;">
      This site stores your selected transit agency on your device to remember your preference.
      <button id="cookieAccept">OK</button>
    </div>
    <div id="loadingOverlay" class="loading-overlay" aria-live="polite" aria-busy="false">
      <div class="loading-overlay__inner">
        <div class="loading-overlay__spinner" aria-hidden="true"></div>
        <div class="loading-overlay__text">Loading agency data…</div>
      </div>
    </div>
    <script>
      // Minimal helper to draw a local OSMnx route for the UVA on-demand area.
      (() => {
        let localRouteLine = null;

        async function drawLocalRoute(fromLat, fromLng, toLat, toLng) {
          const params = new URLSearchParams({
            from_lat: fromLat,
            from_lng: fromLng,
            to_lat: toLat,
            to_lng: toLng,
          });

          const response = await fetch(`/api/local_route?${params.toString()}`, {
            cache: 'no-store',
          });

          if (!response.ok) {
            let detail = `Route request failed (${response.status})`;
            try {
              const payload = await response.json();
              if (payload && payload.detail) detail = payload.detail;
            } catch (error) {
              // ignore parse errors
            }
            throw new Error(detail);
          }

          const data = await response.json();
          const coords = Array.isArray(data.coordinates) ? data.coordinates : [];
          if (typeof map === 'undefined' || !coords.length) {
            console.warn('Map not ready or empty route payload');
            return data;
          }

          if (localRouteLine) {
            localRouteLine.remove();
          }

          localRouteLine = L.polyline(coords, {
            color: '#2563eb',
            weight: 5,
            opacity: 0.8,
          }).addTo(map);

          map.fitBounds(localRouteLine.getBounds(), { padding: [20, 20] });
          return data;
        }

        // Expose helper for future UI hooks and console experimentation.
        window.drawLocalRoute = drawLocalRoute;

        window.addEventListener('DOMContentLoaded', () => {
          // Temporary demo: trace a short campus route after the map initializes.
          const demoOrigin = [38.0301, -78.5006];
          const demoDestination = [38.0346, -78.5087];
          setTimeout(() => {
            if (typeof map === 'undefined') return;
            drawLocalRoute(
              demoOrigin[0],
              demoOrigin[1],
              demoDestination[0],
              demoDestination[1]
            ).catch(error => console.warn('Demo route failed:', error));
          }, 3500);
        });
      })();
    </script>
    <script src="nav-bar.js"></script>
  </body>
</html>
