<!doctype html>
<html>
<head>
<link rel="icon" type="image/png" href="/media/favicon.ico" />
<link rel="apple-touch-icon" sizes="120x120" href="/media/apple-touch-icon-120.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/media/apple-touch-icon-152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/media/apple-touch-icon-180.png" />
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#E57200">
<meta charset="utf-8" />
<title>UTS Operations Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script>
(function () {
  const currentHost = window.location.hostname;
  const oldHosts = [
    'uts-headway-guard.fly.dev',
    'uts-headway-guard.fly.io'
  ];

  if (oldHosts.includes(currentHost)) {
    const newUrl =
      window.location.protocol +
      '//' +
      'utsopsdashboard.com' +
      window.location.pathname +
      window.location.search +
      window.location.hash;

    window.location.replace(newUrl);
  }
})();
</script>
<link rel="preload" href="FGDC.ttf" as="font" type="font/ttf" crossorigin />
<style>
  @font-face{font-family:'FGDC';src:url('FGDC.ttf') format('truetype');font-weight:normal;font-style:normal;}
  :root{--bg:#232D4B;--bg-dark:#1A2140;--ink:#FFFFFF;--muted:#9fb0c9;--accent:#E57200;--panel:rgba(26,33,64,0.72);--panel-border:rgba(229,114,0,0.4);}
  body{margin:0;min-height:100vh;background:radial-gradient(circle at top left,rgba(229,114,0,0.18),transparent 40%),linear-gradient(160deg,var(--bg) 0%,var(--bg-dark) 60%,#11162a 100%);color:var(--ink);font:16px/1.45 'FGDC',sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 20px;box-sizing:border-box;}
  header{display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:32px;text-align:center;}
  header::after{content:"";display:block;width:80px;height:4px;background:var(--accent);border-radius:999px;}
  .title{font-size:28px;letter-spacing:0.04em;text-transform:uppercase;}
  .main-content{width:100%;max-width:760px;display:flex;flex-direction:column;align-items:stretch;}
  .container{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:24px;width:100%;}
  .card{border-radius:18px;background:var(--panel);border:1px solid var(--panel-border);box-shadow:0 18px 35px rgba(0,0,0,0.25);display:flex;flex-direction:column;align-items:center;justify-content:center;text-decoration:none;color:var(--ink);position:relative;overflow:hidden;padding:26px 12px;transition:transform 0.2s ease,box-shadow 0.2s ease,border-color 0.2s ease;backdrop-filter:blur(8px);}
  .card::before{content:"";position:absolute;inset:auto auto 0 0;height:4px;width:100%;background:linear-gradient(90deg,rgba(229,114,0,0.8),rgba(229,114,0,0));opacity:0;transition:opacity 0.2s ease;}
  .card:hover{transform:translateY(-6px);box-shadow:0 24px 45px rgba(0,0,0,0.35);border-color:rgba(229,114,0,0.7);}
  .card:hover::before{opacity:1;}
  .card .card__icon{width:64px;height:64px;margin-bottom:12px;display:block;filter:drop-shadow(0 6px 8px rgba(0,0,0,0.35));}
  .card div{font-size:17px;letter-spacing:0.02em;}
  .auth-container{position:fixed;top:16px;left:20px;right:20px;display:flex;flex-direction:column;align-items:flex-end;gap:6px;z-index:10;}
  .auth-row{display:flex;justify-content:space-between;width:100%;}
  .auth-button{background:rgba(17,22,42,0.6);border:1px solid rgba(229,114,0,0.6);border-radius:999px;padding:7px 18px;color:var(--ink);font:inherit;font-size:14px;cursor:pointer;transition:background 0.2s ease,border-color 0.2s ease,box-shadow 0.2s ease;box-shadow:0 8px 16px rgba(0,0,0,0.25);white-space:nowrap;}
  .auth-button:hover{background:rgba(229,114,0,0.18);border-color:rgba(229,114,0,0.85);box-shadow:0 10px 18px rgba(0,0,0,0.28);}
  .auth-button:disabled{opacity:0.6;cursor:not-allowed;}
  .auth-secret{font-size:12px;color:var(--muted);text-shadow:0 2px 6px rgba(0,0,0,0.25);}
  .github-link{color:var(--ink);text-decoration:none;font-size:14px;letter-spacing:0.04em;padding:7px 18px;border-radius:999px;background:rgba(17,22,42,0.6);border:1px solid rgba(229,114,0,0.6);box-shadow:0 8px 16px rgba(0,0,0,0.25);transition:background 0.2s ease,border-color 0.2s ease,box-shadow 0.2s ease;white-space:nowrap;}
  .github-link:hover{background:rgba(229,114,0,0.18);border-color:rgba(229,114,0,0.85);box-shadow:0 10px 18px rgba(0,0,0,0.28);}
  .credit{position:fixed;bottom:12px;right:16px;font-size:12px;color:var(--muted);text-shadow:0 2px 6px rgba(0,0,0,0.25);}
  @media(max-width:600px){
    body{justify-content:flex-start;padding:24px 16px 32px;}
    .auth-container{position:static;align-self:stretch;align-items:center;margin-bottom:20px;order:-1;}
    .auth-row{justify-content:center;gap:12px;}
    header{margin-bottom:24px;}
    .main-content{max-width:420px;}
    .container{grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;}
    .credit{position:static;margin-top:32px;text-align:center;}
  }
  /* System Notices */
  .system-notices{width:100%;margin-bottom:24px;display:flex;flex-direction:column;gap:12px;}
  .system-notice{padding:14px 18px;border-radius:12px;font-size:15px;line-height:1.5;text-align:left;box-sizing:border-box;}
  .system-notice--red{background:linear-gradient(135deg,rgba(220,38,38,0.18),rgba(220,38,38,0.08));border:1px solid rgba(220,38,38,0.4);color:#fecaca;}
  .system-notice--yellow{background:linear-gradient(135deg,rgba(250,204,21,0.18),rgba(250,204,21,0.08));border:1px solid rgba(250,204,21,0.4);color:#fef3c7;}
  .system-notice--green{background:linear-gradient(135deg,rgba(34,197,94,0.18),rgba(34,197,94,0.08));border:1px solid rgba(34,197,94,0.4);color:#bbf7d0;}
  .system-notice__header{display:flex;align-items:center;gap:10px;font-weight:700;font-size:14px;text-transform:uppercase;letter-spacing:0.04em;cursor:pointer;user-select:none;}
  .system-notice__header:not(.is-collapsed){margin-bottom:6px;}
  .system-notice--red .system-notice__header{color:#fca5a5;}
  .system-notice--yellow .system-notice__header{color:#fde047;}
  .system-notice--green .system-notice__header{color:#86efac;}
  .system-notice__icon{width:18px;height:18px;flex-shrink:0;}
  .system-notice__toggle{width:16px;height:16px;margin-left:auto;flex-shrink:0;transition:transform 0.2s ease;}
  .system-notice__toggle.is-collapsed{transform:rotate(-90deg);}
  .system-notice__body{overflow:hidden;transition:max-height 0.2s ease,opacity 0.2s ease;}
  .system-notice__body.is-collapsed{max-height:0 !important;opacity:0;}
  @media(max-width:600px){
    .system-notices{margin-bottom:16px;gap:10px;}
    .system-notice{padding:12px 14px;}
  }
  /* Service Alerts (collapsible) */
  .service-alerts{width:100%;margin-bottom:24px;display:flex;flex-direction:column;gap:12px;}
  .service-alert{padding:16px 20px;border-radius:14px;background:linear-gradient(135deg,rgba(220,38,38,0.15),rgba(220,38,38,0.08));border:1px solid rgba(220,38,38,0.35);color:#fecaca;font-size:15px;line-height:1.5;text-align:left;box-sizing:border-box;}
  .service-alert__header{display:flex;align-items:center;gap:10px;font-weight:700;font-size:16px;color:#fca5a5;text-transform:uppercase;letter-spacing:0.04em;cursor:pointer;user-select:none;}
  .service-alert__header:not(.is-collapsed){margin-bottom:8px;}
  .service-alert__icon{width:20px;height:20px;flex-shrink:0;}
  .service-alert__toggle{width:16px;height:16px;margin-left:auto;flex-shrink:0;transition:transform 0.2s ease;}
  .service-alert__toggle.is-collapsed{transform:rotate(-90deg);}
  .service-alert__body{color:#fee2e2;overflow:hidden;transition:max-height 0.2s ease,opacity 0.2s ease;}
  .service-alert__body.is-collapsed{max-height:0 !important;opacity:0;}
  @media(max-width:600px){
    .service-alerts{margin-bottom:16px;gap:10px;}
    .service-alert{padding:14px 16px;}
  }
  /* Service Level */
  .service-level{font-size:13px;color:var(--muted);text-align:center;margin-bottom:20px;}
  .service-level a{color:var(--muted);text-decoration:none;transition:color 0.2s ease;}
  .service-level a:hover{color:var(--ink);}
  .service-level__value{color:var(--accent);font-weight:700;}
</style>
</head>
<body>
<div class="auth-container">
  <div class="auth-row">
    <a href="https://github.com/disgudname/UTS-Headway-Guard" class="github-link" target="_blank" rel="noopener" data-requires-auth>GitHub</a>
    <button type="button" class="auth-button" id="auth-button">UTS Staff Access</button>
  </div>
  <div class="auth-secret" id="auth-secret" hidden></div>
</div>
<header>
  <div class="title">UTS Operations Dashboard</div>
</header>
<div class="service-level" id="service-level"></div>
<div class="main-content">
<div class="system-notices" id="system-notices"></div>
<div class="service-alerts" id="service-alerts"></div>
<div class="container">
  <a class="card" href="/dispatcher" data-requires-auth>
    <img src="/media/dispatcher.svg" alt="" class="card__icon" />
    <div>Dispatch</div>
  </a>
  <a class="card" href="https://uva-uts.transloc.com/secure/dispatch/" target="_blank" rel="noopener" data-requires-auth>
    <img src="/media/transloc.svg" alt="" class="card__icon" />
    <div>TransLōc</div>
  </a>
  <a class="card" href="/map">
    <img src="/media/map.svg" alt="" class="card__icon" />
    <div>Live Map</div>
  </a>
  <a class="card" href="https://parking.virginia.edu/" target="_blank" rel="noopener" data-guest-only>
    <img src="/media/web.svg" alt="" class="card__icon" />
    <div>Parking & Transportation</div>
  </a>
  <a class="card" href="/ridership" data-requires-auth>
    <img src="/media/ridership.svg" alt="" class="card__icon" />
    <div>Ridership</div>
  </a>
  <a class="card" href="/headway" data-requires-auth>
    <img src="/media/headway.svg" alt="" class="card__icon" />
    <div>Headway</div>
  </a>
  <a class="card" href="/replay" data-requires-auth>
    <img src="/media/replay.svg" alt="" class="card__icon" />
    <div>Replay</div>
  </a>
  <a class="card" href="/downed" data-requires-auth>
    <img src="/media/downed.svg" alt="" class="card__icon" />
    <div>Downed Vehicles</div>
  </a>
  <a class="card" href="/driver" data-requires-auth>
    <img src="/media/driver.svg" alt="" class="card__icon" />
    <div>Driver</div>
  </a>
</div>
</div>
<div class="credit">proof of concept created by pat cox • phc6j@virginia.edu</div>
<script>
  (function(){
    const authButton = document.getElementById('auth-button');
    const authSecret = document.getElementById('auth-secret');
    const gatedElements = Array.from(document.querySelectorAll('[data-requires-auth]'));
    const guestOnlyElements = Array.from(document.querySelectorAll('[data-guest-only]'));
    if(!authButton || !authSecret){
      return;
    }

    let loggedIn = false;

    const applyAccessRestrictions = () => {
      gatedElements.forEach((element) => {
        const shouldHide = !loggedIn;
        if(shouldHide){
          element.setAttribute('hidden', '');
          element.setAttribute('aria-hidden', 'true');
          element.style.display = 'none';
        } else {
          element.removeAttribute('hidden');
          element.removeAttribute('aria-hidden');
          element.style.removeProperty('display');
        }
      });
      guestOnlyElements.forEach((element) => {
        const shouldHide = loggedIn;
        if(shouldHide){
          element.setAttribute('hidden', '');
          element.setAttribute('aria-hidden', 'true');
          element.style.display = 'none';
        } else {
          element.removeAttribute('hidden');
          element.removeAttribute('aria-hidden');
          element.style.removeProperty('display');
        }
      });
    };

    function applyAuthData(data){
      loggedIn = Boolean(data?.authorized);
      if(loggedIn){
        authButton.textContent = 'Log out';
        if(data.secret){
          authSecret.textContent = `Logged in as ${data.secret}`;
          authSecret.hidden = false;
        } else {
          authSecret.hidden = true;
        }
      } else {
        authButton.textContent = 'UTS Staff Access';
        authSecret.hidden = true;
      }
      applyAccessRestrictions();
    }

    async function updateAuthState(){
      try{
        const response = await fetch('/api/dispatcher/auth', {credentials: 'same-origin'});
        if(!response.ok){
          throw new Error('status');
        }
        const data = await response.json();
        applyAuthData(data);
      } catch(err){
        applyAuthData(null);
      }
    }

    // Expose for combined init
    window._applyAuthData = applyAuthData;

    authButton.addEventListener('click', async () => {
      if(loggedIn){
        authButton.disabled = true;
        try{
          await fetch('/api/dispatcher/logout', {method: 'POST', credentials: 'same-origin'});
        } finally {
          authButton.disabled = false;
        }
        await updateAuthState();
      } else {
        window.location.href = '/login?return=%2F';
      }
    });

    applyAccessRestrictions();
    // Initial auth fetch replaced by combined init
  })();
</script>
<script>
  // Service Alert Fetching (collapsible)
  (function(){
    const container = document.getElementById('service-alerts');
    if(!container) return;

    const STORAGE_KEY = 'collapsed_service_alerts';

    function getCollapsedIds(){
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
      } catch(e) { return []; }
    }

    function setCollapsedIds(ids){
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
      } catch(e) {}
    }

    function toggleCollapse(alertId){
      const ids = getCollapsedIds();
      const idx = ids.indexOf(alertId);
      if(idx >= 0){
        ids.splice(idx, 1);
      } else {
        ids.push(alertId);
      }
      setCollapsedIds(ids);
      // Update DOM
      const el = container.querySelector(`[data-alert-id="${alertId}"]`);
      if(el){
        const header = el.querySelector('.service-alert__header');
        const body = el.querySelector('.service-alert__body');
        const toggle = el.querySelector('.service-alert__toggle');
        const isCollapsed = ids.indexOf(alertId) >= 0;
        if(header) header.classList.toggle('is-collapsed', isCollapsed);
        if(body) body.classList.toggle('is-collapsed', isCollapsed);
        if(toggle) toggle.classList.toggle('is-collapsed', isCollapsed);
      }
    }

    // Parse TransLoc date format: /Date(1234567890000)/ or /Date(1234567890000-0700)/
    function parseTransLocDate(dateStr){
      if(!dateStr) return null;
      const match = dateStr.match(/\/Date\((-?\d+)/);
      if(match) return parseInt(match[1], 10);
      const parsed = Date.parse(dateStr);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function escapeAndFormat(str){
      if(!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
        .replace(/\*\*(.+?)\*\*/g, '<strong style="font-size:1.1em">$1</strong>')
        .replace(/\*(.+?)\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
    }

    const chevronSvg = '<svg class="service-alert__toggle" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>';
    const alertIcon = '<svg class="service-alert__icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>';

    function renderAlerts(alerts){
      if(!alerts || !alerts.length){
        container.innerHTML = '';
        return;
      }
      const collapsedIds = getCollapsedIds();
      container.innerHTML = alerts.map(alert => {
        const id = String(alert.MessageId || alert.Id || '');
        const message = (alert.MessageText || alert.Message || alert.message || alert.text || '').trim();
        if(!message || !id) return '';
        const isCollapsed = collapsedIds.includes(id);
        const collapsedClass = isCollapsed ? 'is-collapsed' : '';
        return `
          <div class="service-alert" data-alert-id="${id}">
            <div class="service-alert__header ${collapsedClass}" onclick="window._toggleServiceAlert('${id}')">
              ${alertIcon}
              <span>Service Alert</span>
              ${chevronSvg.replace('class="service-alert__toggle"', `class="service-alert__toggle ${collapsedClass}"`)}
            </div>
            <div class="service-alert__body ${collapsedClass}">${escapeAndFormat(message)}</div>
          </div>
        `;
      }).join('');
    }

    window._toggleServiceAlert = toggleCollapse;

    function filterActiveAlerts(alerts){
      const now = Date.now();
      return alerts.filter(alert => {
        if(!alert) return false;
        const endDate = alert.EndDateUtc || alert.endDate || alert.end_date;
        const endTime = parseTransLocDate(endDate);
        if(endTime !== null && endTime < now) return false;
        const startDate = alert.StartDateUtc || alert.startDate || alert.start_date;
        const startTime = parseTransLocDate(startDate);
        if(startTime !== null && startTime > now) return false;
        const message = alert.MessageText || alert.Message || alert.message || alert.text || '';
        return message.trim().length > 0;
      });
    }

    async function fetchServiceAlerts(){
      try{
        const response = await fetch('/v1/transloc/alerts?showInactive=false&rows=5');
        if(!response.ok) return;
        const data = await response.json();
        const alerts = Array.isArray(data?.Rows) ? data.Rows : Array.isArray(data?.Data) ? data.Data : Array.isArray(data) ? data : [];
        renderAlerts(filterActiveAlerts(alerts));
      } catch(err){
        container.innerHTML = '';
      }
    }

    // Expose for combined init
    window._renderServiceAlerts = function(data){
      const alerts = Array.isArray(data?.Rows) ? data.Rows : Array.isArray(data?.Data) ? data.Data : Array.isArray(data) ? data : [];
      renderAlerts(filterActiveAlerts(alerts));
    };

    // Initial fetch replaced by combined init; keep refresh interval
    setInterval(fetchServiceAlerts, 60000);
  })();
</script>
<script>
  // System Notices Fetching (collapsible)
  (function(){
    const container = document.getElementById('system-notices');
    if(!container) return;

    const STORAGE_KEY = 'collapsed_system_notices';
    let isAuthenticated = false;

    function getCollapsedIds(){
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
      } catch(e) { return []; }
    }

    function setCollapsedIds(ids){
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
      } catch(e) {}
    }

    function toggleCollapse(noticeId){
      const ids = getCollapsedIds();
      const idx = ids.indexOf(noticeId);
      if(idx >= 0){
        ids.splice(idx, 1);
      } else {
        ids.push(noticeId);
      }
      setCollapsedIds(ids);
      // Update DOM
      const el = container.querySelector(`[data-notice-id="${noticeId}"]`);
      if(el){
        const header = el.querySelector('.system-notice__header');
        const body = el.querySelector('.system-notice__body');
        const toggle = el.querySelector('.system-notice__toggle');
        const isCollapsed = ids.indexOf(noticeId) >= 0;
        if(header) header.classList.toggle('is-collapsed', isCollapsed);
        if(body) body.classList.toggle('is-collapsed', isCollapsed);
        if(toggle) toggle.classList.toggle('is-collapsed', isCollapsed);
      }
    }

    window._toggleSystemNotice = toggleCollapse;

    function escapeHtml(str){
      if(!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
        .replace(/\n/g, '<br>');
    }

    function getSeverityIcon(severity){
      if(severity === 'red'){
        return '<svg class="system-notice__icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>';
      }
      if(severity === 'green'){
        return '<svg class="system-notice__icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>';
      }
      return '<svg class="system-notice__icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>';
    }

    const chevronSvg = '<svg class="system-notice__toggle" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>';

    function renderNotices(notices){
      if(!notices || !notices.length){
        container.innerHTML = '';
        return;
      }
      const collapsedIds = getCollapsedIds();
      container.innerHTML = notices.map(n => {
        const sev = n.severity || 'yellow';
        const id = n.id || '';
        if(!id) return '';
        const isCollapsed = collapsedIds.includes(id);
        const collapsedClass = isCollapsed ? 'is-collapsed' : '';
        const staffBadge = n.auth_only ? '<span style="margin-left:8px;font-size:11px;padding:2px 6px;background:rgba(58,142,246,0.3);border-radius:4px;color:#93c5fd;">STAFF ONLY</span>' : '';
        return `
          <div class="system-notice system-notice--${sev}" data-notice-id="${id}">
            <div class="system-notice__header ${collapsedClass}" onclick="window._toggleSystemNotice('${id}')">
              ${getSeverityIcon(sev)}
              <span>System Notice</span>${staffBadge}
              ${chevronSvg.replace('class="system-notice__toggle"', `class="system-notice__toggle ${collapsedClass}"`)}
            </div>
            <div class="system-notice__body ${collapsedClass}">${escapeHtml(n.message)}</div>
          </div>
        `;
      }).join('');
    }

    async function fetchSystemNotices(){
      try{
        const response = await fetch('/v1/system-notices');
        if(!response.ok) return;
        const data = await response.json();
        renderNotices(data.notices || []);
      } catch(err){
        // Silently fail
      }
    }

    // Expose for combined init
    window._renderSystemNotices = function(notices){
      renderNotices(notices || []);
    };

    // Initial fetch replaced by combined init; keep refresh interval
    setInterval(fetchSystemNotices, 60000);
  })();
</script>
<script>
  // Service Level
  (function(){
    const el = document.getElementById('service-level');
    if(!el) return;

    function renderServiceLevel(data){
      const level = data?.service_level;
      if(!level || level === 'UNKNOWN'){
        el.textContent = '';
        return;
      }
      el.innerHTML = `<a href="https://parking.virginia.edu/serviceschedule" target="_blank" rel="noopener">Today's Service Level: <span class="service-level__value">${level.replace(/</g,'&lt;')}</span></a>`;
    }

    async function fetchServiceLevel(){
      try{
        const resp = await fetch('/v1/uts/service_level');
        if(!resp.ok) return;
        const data = await resp.json();
        renderServiceLevel(data);
      } catch(e){
        // Silently fail
      }
    }

    // Expose for combined init
    window._renderServiceLevel = renderServiceLevel;

    // Initial fetch replaced by combined init; keep refresh interval
    setInterval(fetchServiceLevel, 300000);
  })();
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js');
  }
</script>
<script>
  // Combined init: fetch all initial data in one request
  (async function(){
    try{
      const resp = await fetch('/v1/index/init', {credentials: 'same-origin'});
      if(!resp.ok) throw new Error('init failed');
      const data = await resp.json();
      // Apply auth state and render all components with combined data
      if(window._applyAuthData) window._applyAuthData(data.auth);
      if(window._renderServiceAlerts) window._renderServiceAlerts(data.alerts);
      if(window._renderSystemNotices) window._renderSystemNotices(data.notices);
      if(window._renderServiceLevel) window._renderServiceLevel(data.service_level);
    } catch(e){
      // Fallback: trigger individual fetches if combined fails
      console.warn('Combined init failed, using individual fetches');
    }
  })();
</script>
<script src="/scripts/push-notifications.js" defer></script>
</body>
</html>
