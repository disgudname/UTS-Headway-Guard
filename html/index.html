<!doctype html>
<html>
<head>
<link rel="icon" type="image/png" href="/media/favicon.ico" />
<link rel="apple-touch-icon" sizes="120x120" href="/media/apple-touch-icon-120.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/media/apple-touch-icon-152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/media/apple-touch-icon-180.png" />
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#E57200">
<meta charset="utf-8" />
<title>UTS Operations Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script>
(function () {
  const currentHost = window.location.hostname;
  const oldHosts = [
    'uts-headway-guard.fly.dev',
    'uts-headway-guard.fly.io'
  ];

  if (oldHosts.includes(currentHost)) {
    const newUrl =
      window.location.protocol +
      '//' +
      'utsopsdashboard.com' +
      window.location.pathname +
      window.location.search +
      window.location.hash;

    window.location.replace(newUrl);
  }
})();
</script>
<link rel="preload" href="FGDC.ttf" as="font" type="font/ttf" crossorigin />
<style>
  @font-face{font-family:'FGDC';src:url('FGDC.ttf') format('truetype');font-weight:normal;font-style:normal;}
  :root{--bg:#232D4B;--bg-dark:#1A2140;--ink:#FFFFFF;--muted:#9fb0c9;--accent:#E57200;--panel:rgba(26,33,64,0.72);--panel-border:rgba(229,114,0,0.4);}
  body{margin:0;min-height:100vh;background:radial-gradient(circle at top left,rgba(229,114,0,0.18),transparent 40%),linear-gradient(160deg,var(--bg) 0%,var(--bg-dark) 60%,#11162a 100%);color:var(--ink);font:16px/1.45 'FGDC',sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 20px;box-sizing:border-box;}
  header{display:flex;flex-direction:column;align-items:center;gap:12px;margin-bottom:32px;text-align:center;}
  header::after{content:"";display:block;width:80px;height:4px;background:var(--accent);border-radius:999px;}
  .title{font-size:28px;letter-spacing:0.04em;text-transform:uppercase;}
  .container{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:24px;width:100%;max-width:760px;}
  .card{border-radius:18px;background:var(--panel);border:1px solid var(--panel-border);box-shadow:0 18px 35px rgba(0,0,0,0.25);display:flex;flex-direction:column;align-items:center;justify-content:center;text-decoration:none;color:var(--ink);position:relative;overflow:hidden;padding:26px 12px;transition:transform 0.2s ease,box-shadow 0.2s ease,border-color 0.2s ease;backdrop-filter:blur(8px);}
  .card::before{content:"";position:absolute;inset:auto auto 0 0;height:4px;width:100%;background:linear-gradient(90deg,rgba(229,114,0,0.8),rgba(229,114,0,0));opacity:0;transition:opacity 0.2s ease;}
  .card:hover{transform:translateY(-6px);box-shadow:0 24px 45px rgba(0,0,0,0.35);border-color:rgba(229,114,0,0.7);}
  .card:hover::before{opacity:1;}
  .card .card__icon{width:64px;height:64px;margin-bottom:12px;display:block;filter:drop-shadow(0 6px 8px rgba(0,0,0,0.35));}
  .card div{font-size:17px;letter-spacing:0.02em;}
  .auth-container{position:fixed;top:16px;right:20px;display:flex;flex-direction:column;align-items:flex-end;gap:6px;}
  .auth-button{background:rgba(17,22,42,0.6);border:1px solid rgba(229,114,0,0.6);border-radius:999px;padding:7px 18px;color:var(--ink);font-size:14px;cursor:pointer;transition:background 0.2s ease,border-color 0.2s ease,box-shadow 0.2s ease;box-shadow:0 8px 16px rgba(0,0,0,0.25);}
  .auth-button:hover{background:rgba(229,114,0,0.18);border-color:rgba(229,114,0,0.85);box-shadow:0 10px 18px rgba(0,0,0,0.28);}
  .auth-button:disabled{opacity:0.6;cursor:not-allowed;}
  .auth-secret{font-size:12px;color:var(--muted);text-shadow:0 2px 6px rgba(0,0,0,0.25);}
  .github-link{position:fixed;top:16px;left:20px;color:var(--ink);text-decoration:none;font-size:14px;letter-spacing:0.04em;padding:6px 10px;border-radius:999px;background:rgba(26,33,64,0.6);border:1px solid rgba(255,255,255,0.1);box-shadow:0 8px 16px rgba(0,0,0,0.25);transition:background 0.2s ease,border-color 0.2s ease;}
  .github-link:hover{background:rgba(229,114,0,0.22);border-color:rgba(229,114,0,0.6);}
  .credit{position:fixed;bottom:12px;right:16px;font-size:12px;color:var(--muted);text-shadow:0 2px 6px rgba(0,0,0,0.25);}
  @media(max-width:600px){
    body{justify-content:flex-start;padding:32px 16px;}
    header{margin-bottom:24px;}
    .container{grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;max-width:420px;}
  }
</style>
</head>
<body>
<a href="https://github.com/disgudname/UTS-Headway-Guard" class="github-link" target="_blank" rel="noopener" data-requires-auth>GitHub</a>
<div class="auth-container">
  <button type="button" class="auth-button" id="auth-button">Log in</button>
  <div class="auth-secret" id="auth-secret" hidden></div>
</div>
<header>
  <div class="title">UTS Operations Dashboard</div>
</header>
<div class="container">
  <a class="card" href="/dispatcher" data-requires-auth>
    <img src="/media/dispatcher.svg" alt="" class="card__icon" />
    <div>Dispatch</div>
  </a>
  <a class="card" href="https://uva-uts.transloc.com/secure/dispatch/" target="_blank" rel="noopener" data-requires-auth>
    <img src="/media/transloc.svg" alt="" class="card__icon" />
    <div>TransLōc</div>
  </a>
  <a class="card" href="/map">
    <img src="/media/map.svg" alt="" class="card__icon" />
    <div>Live Map</div>
  </a>
  <a class="card" href="/ridership" data-requires-auth>
    <img src="/media/ridership.svg" alt="" class="card__icon" />
    <div>Ridership</div>
  </a>
  <a class="card" href="/headway" data-requires-auth>
    <img src="/media/headway.svg" alt="" class="card__icon" />
    <div>Headway</div>
  </a>
  <a class="card" href="/replay" data-requires-auth>
    <img src="/media/replay.svg" alt="" class="card__icon" />
    <div>Replay</div>
  </a>
  <a class="card" href="/downed" data-requires-auth>
    <img src="/media/downed.svg" alt="" class="card__icon" />
    <div>Downed Vehicles</div>
  </a>
  <a class="card" href="/driver" data-requires-auth>
    <img src="/media/driver.svg" alt="" class="card__icon" />
    <div>Driver</div>
  </a>
</div>
<div class="credit">proof of concept created by pat cox • phc6j@virginia.edu</div>
<script>
  (function(){
    const authButton = document.getElementById('auth-button');
    const authSecret = document.getElementById('auth-secret');
    const gatedElements = Array.from(document.querySelectorAll('[data-requires-auth]'));
    if(!authButton || !authSecret){
      return;
    }

    let loggedIn = false;

    const applyAccessRestrictions = () => {
      gatedElements.forEach((element) => {
        const shouldHide = !loggedIn;
        if(shouldHide){
          element.setAttribute('hidden', '');
          element.setAttribute('aria-hidden', 'true');
          element.style.display = 'none';
        } else {
          element.removeAttribute('hidden');
          element.removeAttribute('aria-hidden');
          element.style.removeProperty('display');
        }
      });
    };

    async function updateAuthState(){
      try{
        const response = await fetch('/api/dispatcher/auth', {credentials: 'same-origin'});
        if(!response.ok){
          throw new Error('status');
        }
        const data = await response.json();
        loggedIn = Boolean(data.authorized);
        if(loggedIn){
          authButton.textContent = 'Log out';
          if(data.secret){
            authSecret.textContent = `Logged in as ${data.secret}`;
            authSecret.hidden = false;
          } else {
            authSecret.hidden = true;
          }
        } else {
          authButton.textContent = 'Log in';
          authSecret.hidden = true;
        }
        applyAccessRestrictions();
      } catch(err){
        loggedIn = false;
        authButton.textContent = 'Log in';
        authSecret.hidden = true;
        applyAccessRestrictions();
      }
    }

    authButton.addEventListener('click', async () => {
      if(loggedIn){
        authButton.disabled = true;
        try{
          await fetch('/api/dispatcher/logout', {method: 'POST', credentials: 'same-origin'});
        } finally {
          authButton.disabled = false;
        }
        await updateAuthState();
      } else {
        window.location.href = '/login?return=%2F';
      }
    });

    applyAccessRestrictions();
    updateAuthState();
  })();
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js');
  }
</script>
</body>
</html>
