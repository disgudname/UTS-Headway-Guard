<!doctype html>
<html>
<head>
<link rel="icon" type="image/png" href="headwayguardicon.png" />
<meta charset="utf-8" />
<title>Downed Vehicles - Headway Guard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preload" href="FGDC.ttf" as="font" type="font/ttf" crossorigin />
<style>
  @font-face{
    font-family:'FGDC';
    src:url('FGDC.ttf') format('truetype');
    font-weight:normal;
    font-style:normal;
  }
  :root{
    --bg:#24234B;
    --panel:#101935;
    --row-alt:#152349;
    --panel-soft:#142040;
    --ink:#f0f4ff;
    --muted:#9fb0c9;
    --line:rgba(159,176,201,0.25);
    --accent:#ffb347;
    --pill-down:#ff0000;
    --pill-hold:#FFFFFF;
    --pill-up:#00ff00;
    --pill-usable:#0000ff;
    --base-font-size:clamp(24px,calc(1.45vw + 0.85vh),38px);
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:'FGDC',sans-serif;
    font-size:var(--dynamic-base-font-size, var(--base-font-size));
    line-height:1.45;
    min-height:100vh;
    display:flex;
    justify-content:center;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    text-rendering:geometricPrecision;
  }
  @media (max-width:1400px){
    :root{
      --dynamic-base-font-size:clamp(22px,calc(1.2vw + 0.9vh),30px);
    }
  }
  main{
    width:100%;
    padding:0 0 36px;
    display:flex;
    flex-direction:column;
    gap:20px;
    min-height:100vh;
  }
  #sections{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:stretch;
  }
  section{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:18px;
    overflow:hidden;
    box-shadow:0 18px 32px rgba(6,11,28,0.35);
    display:flex;
    flex-direction:column;
  }
  section header{
    padding:18px 24px 0;
  }
  section h2{
    margin:0;
    font-size:clamp(1.55rem,1.35rem + 0.35vw,1.9rem);
    text-transform:uppercase;
    letter-spacing:0.08em;
  }
  table{
    width:100%;
    border-collapse:collapse;
    table-layout:auto;
    background:var(--panel);
  }
  .table-wrapper{
    width:100%;
    max-width:100%;
    overflow-x:auto;
  }
  thead th{
    font-size:clamp(0.95rem,0.85rem + 0.22vw,1.15rem);
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:0.05em;
    padding:12px 6px 8px;
    border-bottom:1px solid var(--line);
    text-align:center;
    word-break:normal;
    white-space:nowrap;
  }
  tbody td{
    padding:9px 6px;
    border-top:1px solid rgba(159,176,201,0.08);
    vertical-align:middle;
    font-size:clamp(1.1rem,1.05rem + 0.26vw,1.35rem);
    line-height:1.35;
    text-align:center;
    word-break:normal;
    white-space:nowrap;
  }
  tbody td.wrap-allowed{
    white-space:normal;
    word-break:break-word;
    text-align:left;
  }
  tbody td.vehicle-column{
    font-size:clamp(1.55rem,1.25rem + 0.5vw,2rem);
    font-weight:700;
    letter-spacing:0.08em;
    text-transform:uppercase;
    white-space:nowrap;
    word-break:normal;
    padding:9px 6px;
  }
  thead th.vehicle-column{
    white-space:nowrap;
    word-break:normal;
    padding:12px 6px 8px;
  }
  tbody tr:nth-child(even){
    background:var(--row-alt);
  }
  tbody tr:hover{
    background:var(--panel-soft);
  }
  tbody td.status{
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.08em;
  }
  .pill{
    position:relative;
    z-index:0;
    display:inline-flex;
    align-items:center;
    padding:5px 14px;
    border-radius:999px;
    font-size:1rem;
    text-transform:uppercase;
    letter-spacing:0.05em;
    --pill-bg:rgba(255,255,255,0.08);
    background:var(--pill-bg);
    box-shadow:0 0 0 1px rgba(255,255,255,0.12) inset;
  }
  .pill span+span{
    margin-left:6px;
  }
  .pill.pulse-alert::after{
    content:'';
    position:absolute;
    inset:0;
    border-radius:inherit;
    background:none;
    color:var(--pill-bg);
    opacity:0.6;
    box-shadow:0 0 0 0 currentColor;
    z-index:-1;
    animation:statusPulse 1.8s ease-out infinite;
    pointer-events:none;
  }
  @keyframes statusPulse{
    0%{opacity:0.6; box-shadow:0 0 0 0 currentColor;}
    70%{opacity:0.15; box-shadow:0 0 0 18px currentColor;}
    100%{opacity:0; box-shadow:0 0 0 18px currentColor;}
  }
  .pill.down,
  .pill.downed{
    --pill-bg:var(--pill-down);
    background:var(--pill-bg);
    color:#fff;
  }
  .pill.hold{
    --pill-bg:var(--pill-hold);
    background:var(--pill-bg);
    color:#000;
  }
  .pill.up{
    --pill-bg:var(--pill-up);
    background:var(--pill-bg);
    color:#000;
  }
  .pill.usable{
    --pill-bg:var(--pill-usable);
    background:var(--pill-bg);
    color:#fff;
  }
  .pill.cosmetic{
    --pill-bg:#00ffff;
    background:var(--pill-bg);
    color:#000;
  }
  .pill.comfort{
    --pill-bg:#ff00ff;
    background:var(--pill-bg);
    color:#fff;
  }
  .pill.limited{
    --pill-bg:#ffff00;
    background:var(--pill-bg);
    color:#000;
  }
  .pill.vsi{
    --pill-bg:#ff6d01;
    background:var(--pill-bg);
    color:#000;
  }
  .pill.pm{
    --pill-bg:#34a853;
    background:var(--pill-bg);
    color:#fff;
  }
  .empty-indicator{
    padding:36px 24px;
    text-align:center;
    font-size:1.05rem;
    color:var(--muted);
  }
  .mobile-list{
    display:none;
    flex-direction:column;
    background:var(--panel);
  }
  .mobile-card{
    border-top:1px solid rgba(159,176,201,0.08);
  }
  .mobile-card:first-child{
    border-top:none;
  }
  .card-summary{
    width:100%;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:14px;
    padding:12px 20px;
    background:none;
    border:none;
    color:inherit;
    font:inherit;
    text-align:left;
    cursor:pointer;
    appearance:none;
    -webkit-appearance:none;
  }
  .card-summary:focus{
    outline:2px solid var(--accent);
    outline-offset:2px;
  }
  .card-summary .vehicle{
    font-size:1.45rem;
    font-weight:600;
    letter-spacing:0.05em;
    text-transform:uppercase;
  }
  .card-summary .summary-meta{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:8px;
  }
  .card-summary .summary-date{
    font-size:0.9rem;
    color:var(--muted);
  }
  .card-summary .chevron{
    margin-left:12px;
    transition:transform 0.2s ease;
  }
  .mobile-card.expanded .card-summary .chevron{
    transform:rotate(90deg);
  }
  .card-details{
    display:none;
    padding:0 20px 12px;
    margin:0;
    column-gap:12px;
  }
  .mobile-card.expanded .card-details{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    row-gap:14px;
  }
  .card-details dt{
    margin:0 0 4px;
    font-size:0.8rem;
    text-transform:uppercase;
    letter-spacing:0.08em;
    color:var(--muted);
  }
  .card-details dd{
    margin:0;
    font-size:1.05rem;
    line-height:1.4;
    word-break:break-word;
  }
  @media (max-width:1100px){
    body{font-size:calc(var(--dynamic-base-font-size, var(--base-font-size)) * 0.92);}
    main{padding:0 0 1.5rem;}
  }
  @media (max-width:960px){
    #sections{gap:10px;}
  }
  @media (max-width:780px){
    .table-wrapper{display:none;}
    table{display:none;}
    .mobile-list{display:flex;}
    section{border-radius:14px;}
  }
</style>
</head>
<body>
<main>
  <div id="sections"></div>
</main>
<script>
const ENDPOINT = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZz9HtiUnA6MONcaHw_Kz1Cd8dHhm7Gt9OBuOy7bPfNiHaGYvkVlONxttrUgNCjXdLDnDcgCh4IeQH/pub?gid=0&single=true&output=csv';
const REFRESH_MS = 5 * 60 * 1000;
const sectionsContainer = document.getElementById('sections');
let refreshTimer = null;

const MIN_DYNAMIC_FONT_SIZE = 12;
const MAX_DYNAMIC_FONT_SIZE = 48;
let fontAdjustmentFrame = 0;
let resizeDebounceTimer = 0;

function setDynamicFontSize(size){
  const clamped=Math.max(MIN_DYNAMIC_FONT_SIZE, Math.min(MAX_DYNAMIC_FONT_SIZE, size));
  document.documentElement.style.setProperty('--dynamic-base-font-size', `${clamped.toFixed(3)}px`);
}

function removeDynamicFontSize(){
  document.documentElement.style.removeProperty('--dynamic-base-font-size');
}

function readBaselineFontSize(){
  const root=document.documentElement;
  const override=root.style.getPropertyValue('--dynamic-base-font-size');
  if(override) root.style.removeProperty('--dynamic-base-font-size');
  const baseline=parseFloat(getComputedStyle(document.body).fontSize) || 16;
  if(override) root.style.setProperty('--dynamic-base-font-size', override);
  return baseline;
}

function doesAnyPillWrap(){
  const pills=document.querySelectorAll('.pill');
  for(const pill of pills){
    if(pill.getClientRects().length>1) return true;
    for(const child of pill.children){
      if(child.getClientRects && child.getClientRects().length>1) return true;
    }
    if(pill.scrollHeight-pill.clientHeight>0.5) return true;
  }
  return false;
}

function adjustBaseFontSize(){
  const pills=document.querySelectorAll('.pill');
  if(!pills.length){
    removeDynamicFontSize();
    return;
  }
  const baseline=readBaselineFontSize();
  const minSize=Math.max(MIN_DYNAMIC_FONT_SIZE, baseline*0.75);
  const maxSize=Math.min(MAX_DYNAMIC_FONT_SIZE, Math.max(baseline*1.9, baseline+12));

  setDynamicFontSize(baseline);
  if(doesAnyPillWrap()){
    let low=minSize;
    setDynamicFontSize(low);
    if(doesAnyPillWrap()){
      setDynamicFontSize(low);
      return;
    }
    let high=baseline;
    let best=low;
    while(high-low>0.2){
      const mid=(low+high)/2;
      setDynamicFontSize(mid);
      if(doesAnyPillWrap()){
        high=mid;
      }else{
        best=mid;
        low=mid;
      }
    }
    setDynamicFontSize(best);
    return;
  }

  let low=baseline;
  setDynamicFontSize(maxSize);
  if(!doesAnyPillWrap()){
    setDynamicFontSize(maxSize);
    return;
  }

  let high=maxSize;
  let best=low;
  while(high-low>0.2){
    const mid=(low+high)/2;
    setDynamicFontSize(mid);
    if(doesAnyPillWrap()){
      high=mid;
    }else{
      best=mid;
      low=mid;
    }
  }
  setDynamicFontSize(best);
}

function scheduleFontAdjustment(){
  if(fontAdjustmentFrame) cancelAnimationFrame(fontAdjustmentFrame);
  fontAdjustmentFrame=requestAnimationFrame(()=>{
    fontAdjustmentFrame=requestAnimationFrame(()=>{
      adjustBaseFontSize();
    });
  });
}

window.addEventListener('resize',()=>{
  if(resizeDebounceTimer) clearTimeout(resizeDebounceTimer);
  resizeDebounceTimer=setTimeout(scheduleFontAdjustment, 150);
});

const urlParams = new URLSearchParams(window.location.search);

function getQueryFlag(name){
  const value=urlParams.get(name);
  if(value===null) return false;
  const normalized=String(value).trim().toLowerCase();
  if(!normalized) return true;
  return !['0','false','no','off'].includes(normalized);
}

const prioritizedSectionTitles=[];
if(getQueryFlag('bus')) prioritizedSectionTitles.push('Bus');
if(getQueryFlag('support')) prioritizedSectionTitles.push('P&T Support Vehicle');

function getSectionPriority(title){
  const idx=prioritizedSectionTitles.indexOf(title);
  return idx===-1 ? Number.POSITIVE_INFINITY : idx;
}

const HIDDEN_HEADER_LABELS = new Set(['current eta']);

function abbreviateHeaderLabel(text){
  if(!text) return text;
  return String(text)
    .replace(/SUPERVISOR/gi,'SUP')
    .replace(/MECHANIC/gi,'MECH')
    .replace(/DIAGNOSTIC[\s\u00a0]*DATE/gi,'DIAG DATE')
    .replace(/ACTUAL DELIVERY DATE/gi,'DEL DATE');
}

function allowsWrappingForHeader(text){
  const normalized=normalizeHeader(text);
  if(!normalized) return false;
  if(normalized.includes('note')) return true;
  if(normalized.includes('description')) return true;
  if(normalized.includes('notes/description')) return true;
  return false;
}

function normalizeHeader(text){
  return String(text || '')
    .replace(/\s+/g,' ')
    .trim()
    .toLowerCase();
}

function isHiddenHeader(text){
  return HIDDEN_HEADER_LABELS.has(normalizeHeader(text));
}

function isStatusHeader(text){
  return normalizeHeader(text) === 'status';
}

function findDiagnosticDateIndex(headers){
  if(!Array.isArray(headers)) return -1;
  for(let i=0;i<headers.length;i++){
    const normalized=normalizeHeader(headers[i]);
    if(!normalized) continue;
    if(normalized==='diagnostic date' || normalized==='diag date' || normalized.includes('diagnostic date')){
      return i;
    }
  }
  return -1;
}

function findDeliveryDateIndex(headers){
  if(!Array.isArray(headers)) return -1;
  for(let i=0;i<headers.length;i++){
    const normalized=normalizeHeader(headers[i]);
    if(!normalized) continue;
    if(normalized==='actual delivery date' || normalized==='delivery date' || normalized.includes('delivery date')){
      return i;
    }
  }
  return -1;
}

function findDownDateIndex(headers){
  if(!Array.isArray(headers)) return -1;
  for(let i=0;i<headers.length;i++){
    const normalized=normalizeHeader(headers[i]);
    if(!normalized) continue;
    if(normalized==='date' || normalized==='down date' || normalized.includes('down date')){
      return i;
    }
  }
  return -1;
}

function findVehicleIndex(headers){
  if(!Array.isArray(headers)) return 0;
  for(let i=0;i<headers.length;i++){
    const normalized=normalizeHeader(headers[i]);
    if(normalized==='bus' || normalized==='p&t support vehicle' || normalized==='vehicle' || normalized.includes('vehicle')){
      return i;
    }
  }
  return 0;
}

function findStatusIndices(headers){
  if(!Array.isArray(headers)) return [];
  const results=[];
  headers.forEach((text,index)=>{
    if(normalizeHeader(text)==='status') results.push(index);
  });
  return results;
}

function getMobileLabel(text){
  const normalized=normalizeHeader(text);
  if(normalized==='bus' || normalized==='p&t support vehicle' || normalized==='vehicle') return 'Vehicle';
  if(!text) return 'Info';
  const abbreviated=abbreviateHeaderLabel(text);
  return abbreviated || 'Info';
}

function getPreferredStatus(values, headers){
  const indices=findStatusIndices(headers);
  if(!indices.length) return '';
  for(let i=indices.length-1;i>=0;i--){
    const value=values[indices[i]];
    if(value && String(value).trim()) return value;
  }
  for(let i=0;i<indices.length;i++){
    const value=values[indices[i]];
    if(value && String(value).trim()) return value;
  }
  return '';
}

function getDisplayDate(values, deliveryIndex, downIndex){
  if(deliveryIndex>=0 && deliveryIndex<values.length){
    const delivery=values[deliveryIndex];
    if(delivery && String(delivery).trim()) return delivery;
  }
  if(downIndex>=0 && downIndex<values.length){
    const down=values[downIndex];
    if(down && String(down).trim()) return down;
  }
  return '';
}

function parseCsv(text){
  const rows=[];
  let row=[];
  let cur='';
  let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(inQuotes){
      if(ch==='"'){
        if(text[i+1]==='"'){ cur+='"'; i++; }
        else{ inQuotes=false; }
      }else{
        cur+=ch;
      }
    }else{
      if(ch==='"') inQuotes=true;
      else if(ch===','){ row.push(cur); cur=''; }
      else if(ch==='\r'){ }
      else if(ch==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else{ cur+=ch; }
    }
  }
  if(cur!=='' || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

function cleanCell(value){
  if(value==null) return '';
  return String(value).replace(/\r\n?/g,'\n').trim();
}

function parseDeliveryDate(value){
  if(value==null) return null;
  const text=String(value).trim();
  if(!text) return null;
  const parsed=Date.parse(text);
  if(Number.isNaN(parsed)) return null;
  return new Date(parsed);
}

function getDeliveryCutoff(){
  const now=new Date();
  const startOfToday=new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const cutoff=new Date(startOfToday);
  cutoff.setDate(cutoff.getDate()-1);
  return cutoff;
}

function shouldHideByDeliveryDate(values, deliveryIndex, cutoff, statusText=''){
  if(deliveryIndex<0 || !Array.isArray(values) || deliveryIndex>=values.length) return false;
  if(statusText && /\bUP\b/i.test(String(statusText))) return false;
  const date=parseDeliveryDate(values[deliveryIndex]);
  if(!date) return false;
  return date<=cutoff;
}

function parseSheet(csvText){
  const rawRows = parseCsv(csvText||'');
  if(!rawRows.length) return { headerLine:[], sections:[] };
  const rows = rawRows.map(r => r.map(cleanCell));
  const headerLine = rows.shift() || [];
  const sections=[];
  let current=null;
  for(const row of rows){
    if(row.every(cell => !cell)) continue;
    const first=row[0];
    if(first==='Bus' || first==='P&T Support Vehicle'){
      current={ title:first, headers:row.slice(), rows:[] };
      sections.push(current);
      continue;
    }
    if(!current) continue;
    current.rows.push(row.slice());
  }
  return { headerLine, sections };
}

function getStatusClass(text){
  if(!text) return '';
  const upper=text.toUpperCase();
  const hasTerm=term=>new RegExp('\\b'+term+'\\b').test(upper);
  if(hasTerm('COSMETIC')) return 'cosmetic';
  if(hasTerm('COMFORT')) return 'comfort';
  if(hasTerm('DOWNED') || hasTerm('DOWN')) return 'downed';
  if(hasTerm('LIMITED')) return 'limited';
  if(hasTerm('VSI')) return 'vsi';
  if(hasTerm('PM')) return 'pm';
  if(hasTerm('HOLD')) return 'hold';
  if(hasTerm('USABLE')) return 'usable';
  if(hasTerm('UP')) return 'up';
  return '';
}

function renderSection(section){
  const wrapper=document.createElement('section');
  const title=section.title ? String(section.title).trim() : '';
  if(title && title!=='Bus' && title!=='P&T Support Vehicle'){
    const header=document.createElement('header');
    const heading=document.createElement('h2');
    heading.textContent=title;
    header.appendChild(heading);
    wrapper.appendChild(header);
  }

  if(!section.rows.length){
    const empty=document.createElement('div');
    empty.className='empty-indicator';
    empty.textContent='No records to display.';
    wrapper.appendChild(empty);
    return wrapper;
  }

  const tableWrapper=document.createElement('div');
  tableWrapper.className='table-wrapper';
  const table=document.createElement('table');
  const thead=document.createElement('thead');
  const headRow=document.createElement('tr');
  const visibleColumns=section.headers
    .map((text,index)=>({ text, index }))
    .filter(col=>!isHiddenHeader(col.text));

  visibleColumns.forEach(col => {
    const text=abbreviateHeaderLabel(col.text);
    const th=document.createElement('th');
    const normalized=normalizeHeader(text);
    const originalNormalized=normalizeHeader(col.text);
    const isVehicleColumn=originalNormalized==='bus' || originalNormalized==='p&t support vehicle' || originalNormalized==='vehicle' || originalNormalized.includes('vehicle');
    if(isVehicleColumn) th.classList.add('vehicle-column');
    if(text && normalized!=='bus' && normalized!=='p&t support vehicle'){
      th.textContent=String(text).replace(/[\n\r]+/g,' ').replace(/\s{2,}/g,' ').trim();
    }else{
      th.textContent='';
    }
    headRow.appendChild(th);
  });
  thead.appendChild(headRow);
  table.appendChild(thead);

  const tbody=document.createElement('tbody');
  const diagnosticIndex=findDiagnosticDateIndex(section.headers);
  const deliveryIndex=findDeliveryDateIndex(section.headers);
  const deliveryCutoff=getDeliveryCutoff();
  const downIndex=findDownDateIndex(section.headers);
  const vehicleIndex=findVehicleIndex(section.headers);
  const mobileList=document.createElement('div');
  mobileList.className='mobile-list';
  section.rows.forEach(row => {
    const tr=document.createElement('tr');
    const padded=row.slice();
    while(padded.length<section.headers.length){ padded.push(''); }
    const statusText=getPreferredStatus(padded, section.headers);
    if(shouldHideByDeliveryDate(padded, deliveryIndex, deliveryCutoff, statusText)) return;
    const diagnosticValue=(diagnosticIndex>=0 && diagnosticIndex<padded.length) ? padded[diagnosticIndex] : '';
    const hasDiagnosticDate=!!(diagnosticValue && String(diagnosticValue).trim());
    const displayDate=getDisplayDate(padded, deliveryIndex, downIndex);
    visibleColumns.forEach(col => {
      const { index, text: headerText } = col;
      const cell=padded[index];
      const td=document.createElement('td');
      const text=cell;
      const normalizedHeader=normalizeHeader(headerText);
      const isVehicleColumn=normalizedHeader==='bus' || normalizedHeader==='p&t support vehicle' || normalizedHeader==='vehicle' || normalizedHeader.includes('vehicle');
      const allowsWrapping=allowsWrappingForHeader(headerText);
      if(isVehicleColumn) td.classList.add('vehicle-column');
      if(allowsWrapping) td.classList.add('wrap-allowed');
      if(isStatusHeader(headerText)){
        const cls=getStatusClass(text);
        td.className='status';
        if(text && cls){
          const pill=document.createElement('span');
          pill.classList.add('pill', cls);
          if(!hasDiagnosticDate){
            pill.classList.add('pulse-alert');
          }

          const label=document.createElement('span');
          label.textContent=text;
          pill.appendChild(label);

          td.appendChild(pill);
        }else{
          td.textContent=text;
        }
      }else{
        td.textContent=text;
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);

    const card=document.createElement('div');
    card.className='mobile-card';
    const summaryButton=document.createElement('button');
    summaryButton.type='button';
    summaryButton.className='card-summary';
    summaryButton.setAttribute('aria-expanded','false');

    const vehicleLabel=document.createElement('span');
    vehicleLabel.className='vehicle';
    vehicleLabel.textContent=padded[vehicleIndex] || 'Unknown Vehicle';
    summaryButton.appendChild(vehicleLabel);

    const summaryMeta=document.createElement('div');
    summaryMeta.className='summary-meta';

    if(statusText){
      const statusCls=getStatusClass(statusText);
      const pill=document.createElement('span');
      pill.className='pill';
      if(statusCls) pill.classList.add(statusCls);
      if(!hasDiagnosticDate){
        pill.classList.add('pulse-alert');
      }
      const label=document.createElement('span');
      label.textContent=statusText;
      pill.appendChild(label);
      summaryMeta.appendChild(pill);
    }

    const dateEl=document.createElement('span');
    dateEl.className='summary-date';
    dateEl.textContent=displayDate || '—';
    summaryMeta.appendChild(dateEl);

    const chevron=document.createElement('span');
    chevron.className='chevron';
    chevron.textContent='›';
    chevron.setAttribute('aria-hidden','true');

    summaryButton.appendChild(summaryMeta);
    summaryButton.appendChild(chevron);

    const details=document.createElement('dl');
    details.className='card-details';
    visibleColumns.forEach(col => {
      const { index, text: headerText } = col;
      const value=padded[index];
      if(!value) return;
      const dt=document.createElement('dt');
      dt.textContent=getMobileLabel(headerText);
      const dd=document.createElement('dd');
      if(isStatusHeader(headerText)){
        const cls=getStatusClass(value);
        if(value && cls){
          const pill=document.createElement('span');
          pill.className='pill';
          pill.classList.add(cls);
          if(!hasDiagnosticDate){
            pill.classList.add('pulse-alert');
          }
          const label=document.createElement('span');
          label.textContent=value;
          pill.appendChild(label);
          dd.appendChild(pill);
        }else{
          dd.textContent=value;
        }
      }else{
        dd.textContent=value;
      }
      details.appendChild(dt);
      details.appendChild(dd);
    });

    const hasDetails=details.children.length>0;
    if(!hasDetails){
      chevron.style.visibility='hidden';
      summaryButton.setAttribute('aria-expanded','false');
    }

    summaryButton.addEventListener('click',()=>{
      if(!hasDetails) return;
      const expanded=!card.classList.contains('expanded');
      card.classList.toggle('expanded');
      summaryButton.setAttribute('aria-expanded', expanded ? 'true':'false');
      scheduleFontAdjustment();
    });

    card.appendChild(summaryButton);
    card.appendChild(details);
    mobileList.appendChild(card);
  });
  if(!tbody.children.length){
    const empty=document.createElement('div');
    empty.className='empty-indicator';
    empty.textContent='No records to display.';
    wrapper.appendChild(empty);
    return wrapper;
  }
  table.appendChild(tbody);
  tableWrapper.appendChild(table);
  wrapper.appendChild(tableWrapper);
  if(mobileList.children.length){
    wrapper.appendChild(mobileList);
  }
  return wrapper;
}

function renderSheet(data){
  sectionsContainer.innerHTML='';
  if(!data.sections.length){
    const empty=document.createElement('div');
    empty.className='empty-indicator';
    empty.textContent='Unable to load downed vehicle data.';
    sectionsContainer.appendChild(empty);
    scheduleFontAdjustment();
    return;
  }
  const orderedSections=data.sections
    .map((section,index)=>({ section, index }))
    .sort((a,b)=>{
      const priorityDiff=getSectionPriority(a.section.title)-getSectionPriority(b.section.title);
      if(priorityDiff!==0) return priorityDiff;
      return a.index-b.index;
    })
    .map(item=>item.section);
  orderedSections.forEach(section => {
    sectionsContainer.appendChild(renderSection(section));
  });
  scheduleFontAdjustment();
}

async function loadSheet(){
  try{
    const res=await fetch(ENDPOINT,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const csv=await res.text();
    renderSheet(parseSheet(csv));
  }catch(err){
    console.error('Failed to load downed vehicles sheet', err);
    renderSheet({ headerLine:[], sections:[] });
  }
}

function start(){
  loadSheet();
  if(refreshTimer) clearInterval(refreshTimer);
  refreshTimer=setInterval(loadSheet, REFRESH_MS);
}

document.addEventListener('visibilitychange',()=>{
  if(document.hidden) return;
  loadSheet();
});

start();
</script>
<script src="mobile-nav.js"></script>
</body>
</html>
