<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maintenance Tickets - UTS Operations Dashboard</title>
  <link rel="icon" type="image/png" href="UTSShield.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/media/apple-touch-icon-120.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/media/apple-touch-icon-152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/media/apple-touch-icon-180.png" />
  <style>
    :root {
      color-scheme: dark;
      --bg:#0b1628;
      --panel:#121f38;
      --panel-alt:#182848;
      --line:rgba(124,158,213,0.4);
      --ink:#f7fbff;
      --muted:#9cb5d6;
      --accent:#7cc9ff;
      --danger:#ff6488;
      --success:#3dd68c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at top,#13264a 0%,#0b1628 55%,#050912 100%);
      color: var(--ink);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }
    main {
      width: min(1400px, 100%);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    header h1 {
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }
    header p {
      margin: 6px 0 0;
      color: var(--muted);
    }
    section {
      background: linear-gradient(160deg,rgba(18,31,56,0.95),rgba(18,31,56,0.75));
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 18px 24px 24px;
      box-shadow: 0 18px 40px rgba(5,11,28,0.45);
    }
    h2 {
      margin: 0 0 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: clamp(1.2rem,1.1rem + 0.3vw,1.6rem);
    }
    form {
      display: grid;
      gap: 16px;
    }
    .form-sections {
      display: grid;
      gap: 16px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 18px 20px;
      border-radius: 16px;
      border: 1px solid rgba(124,158,213,0.25);
      background: rgba(10,18,36,0.6);
    }
    .form-group h3 {
      margin: 0;
      font-size: 0.9rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
    }
    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
    }
    .grid .full-span {
      grid-column: 1 / -1;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.95rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--muted);
    }
    input, select, textarea {
      font: inherit;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(124,158,213,0.35);
      background: rgba(7,14,28,0.6);
      color: var(--ink);
      resize: vertical;
      min-height: 44px;
    }
    textarea { min-height: 110px; }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid var(--accent);
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(124,201,255,0.25);
    }
    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    button {
      font: inherit;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 12px 18px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: var(--accent);
      color: #041120;
      font-weight: 600;
    }
    button.secondary {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    button.danger {
      background: var(--danger);
      color: #fff;
    }
    .required-marker {
      color: var(--danger);
      margin-left: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    thead th {
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      padding: 8px 10px;
      border-bottom: 1px solid rgba(124,158,213,0.35);
      text-align: left;
      font-size: 0.82rem;
      white-space: nowrap;
    }
    tbody td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(124,158,213,0.2);
      vertical-align: top;
      font-size: 0.95rem;
    }
    tbody tr:hover {
      background: rgba(20,36,68,0.65);
    }
    tbody td .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin-right: 6px;
      color: #071226;
    }
    .pill.downed { background: #ff4d6d; color: #fff; }
    .pill.hold { background: #ffe29a; color: #161616; }
    .pill.limited { background: #ffb347; }
    .pill.comfort { background: #ffb347; }
    .pill.cosmetic { background: #7fb2ff; }
    .pill.pm { background: #7fb2ff; }
    .pill.vsi { background: #6b7bff; color: #fff; }
    .pill.down { background: #ff4d6d; color: #fff; }
    .pill.up { background: #6be39a; }
    .pill.usable { background: #6b7bff; color: #fff; }
    .row-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .row-actions button {
      padding: 6px 12px;
      font-size: 0.75rem;
    }
    #message {
      margin-top: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      background: rgba(124,201,255,0.14);
      color: var(--accent);
      display: none;
    }
    #message.error {
      background: rgba(255,100,136,0.18);
      color: var(--danger);
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Maintenance Tickets</h1>
      <p>Create, update, and track maintenance tickets synced from the shop.</p>
    </header>

    <section>
      <h2 id="form-title">Create Ticket</h2>
      <form id="ticket-form">
        <input type="hidden" id="ticket-id" />
        <div class="form-sections">
          <div class="form-group">
            <h3>Operations</h3>
            <div class="grid">
              <label>Fleet # <span class="required-marker">*</span>
                <input id="fleet-no" name="fleet_no" autocomplete="off" required />
              </label>
              <label>Reported At <span class="required-marker">*</span>
                <input id="reported-at" type="datetime-local" required />
              </label>
              <label>Reported By <span class="required-marker">*</span>
                <input id="reported-by" autocomplete="off" required />
              </label>
              <label>OPS Status <span class="required-marker">*</span>
                <select id="ops-status" required>
                  <option value="">--</option>
                  <option value="DOWNED">Downed</option>
                  <option value="HOLD">Hold</option>
                  <option value="LIMITED">Limited</option>
                  <option value="COMFORT">Comfort</option>
                  <option value="COSMETIC">Cosmetic</option>
                  <option value="PM">PM</option>
                  <option value="VSI">VSI</option>
                </select>
              </label>
              <label class="full-span">OPS Notes <span class="required-marker">*</span>
                <textarea id="ops-description" required></textarea>
              </label>
            </div>
          </div>
          <div class="form-group">
            <h3>Shop</h3>
            <div class="grid">
              <label>Shop Status
                <select id="shop-status">
                  <option value="">--</option>
                  <option value="DOWN">Down</option>
                  <option value="UP">Up</option>
                  <option value="USABLE">Usable</option>
                </select>
              </label>
              <label>Mechanic
                <input id="mechanic" autocomplete="off" />
              </label>
              <label>Diag Date
                <input id="diag-date" type="date" />
              </label>
              <label>Completed Date
                <input id="completed-at" type="date" />
              </label>
              <label class="full-span">Diagnosis / Notes
                <textarea id="diagnosis-text"></textarea>
              </label>
            </div>
          </div>
        </div>
        <div class="actions">
          <button type="submit" id="submit-btn">Create Ticket</button>
          <button type="button" class="secondary" id="history-btn" hidden>Show History</button>
          <button type="button" class="secondary" id="reset-btn">New Ticket</button>
          <button type="button" class="secondary" id="refresh-btn">Refresh List</button>
        </div>
        <div id="message"></div>
      </form>
    </section>

    <section>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <h2>Tickets</h2>
        <label style="flex-direction:row;align-items:center;gap:8px;">
          <input type="checkbox" id="include-closed" /> Include closed
        </label>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>VEHICLE</th>
              <th>OPS STATUS</th>
              <th>REPORTED</th>
              <th>REPORTED BY</th>
              <th>OPS NOTES</th>
              <th>DIAG DATE</th>
              <th>MECHANIC</th>
              <th>DIAGNOSIS</th>
              <th>COMPLETED</th>
              <th>SHOP STATUS</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tickets-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const OPS_CLASS = {
      DOWNED: 'downed',
      HOLD: 'hold',
      LIMITED: 'limited',
      COMFORT: 'comfort',
      COSMETIC: 'cosmetic',
      PM: 'pm',
      VSI: 'vsi'
    };
    const SHOP_CLASS = {
      DOWN: 'down',
      UP: 'up',
      USABLE: 'usable'
    };

    const TICKETS_API_BASE = '/api/tickets';

    const messageEl = document.getElementById('message');
    const includeClosedEl = document.getElementById('include-closed');
    const ticketsBody = document.getElementById('tickets-body');
    const form = document.getElementById('ticket-form');
    const resetBtn = document.getElementById('reset-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const submitBtn = document.getElementById('submit-btn');
    const historyBtn = document.getElementById('history-btn');
    const formTitle = document.getElementById('form-title');
    const ticketIdEl = document.getElementById('ticket-id');
    const fleetInput = document.getElementById('fleet-no');
    const reportedAtInput = document.getElementById('reported-at');
    const reportedByInput = document.getElementById('reported-by');
    const opsStatusInput = document.getElementById('ops-status');
    const shopStatusInput = document.getElementById('shop-status');
    const mechanicInput = document.getElementById('mechanic');
    const diagDateInput = document.getElementById('diag-date');
    const completedAtInput = document.getElementById('completed-at');
    const opsDescriptionInput = document.getElementById('ops-description');
    const diagnosisInput = document.getElementById('diagnosis-text');

    function formatDateTime(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return value;
      }
      return date.toLocaleString();
    }

    function formatDateOnly(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
          return value;
        }
        return value;
      }
      return date.toLocaleDateString();
    }

    function isoToLocalDateTimeInput(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '';
      const offset = date.getTimezoneOffset();
      const local = new Date(date.getTime() - offset * 60000);
      return local.toISOString().slice(0, 16);
    }

    function localDateTimeInputToIso(value) {
      if (!value) return null;
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return value;
      }
      return date.toISOString();
    }

    function isoToDateInput(value) {
      if (!value) return '';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return typeof value === 'string' ? value : '';
      }
      return date.toISOString().slice(0, 10);
    }

    function dateInputToValue(value) {
      if (!value) return null;
      return value;
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return '';
      return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatChangeValue(value) {
      if (value === null || value === undefined || value === '') return '—';
      if (typeof value === 'string') return value;
      if (value instanceof Date) return value.toISOString();
      if (Array.isArray(value) || typeof value === 'object') {
        try {
          return JSON.stringify(value);
        } catch (err) {
          return String(value);
        }
      }
      return String(value);
    }

    function renderHistoryWindow(ticket, historyWin) {
      if (!historyWin || historyWin.closed) return;
      const doc = historyWin.document;
      if (!ticket || typeof ticket !== 'object') {
        doc.open();
        doc.write('<!doctype html><html lang="en"><head><meta charset="utf-8" /><title>No History</title><style>body{margin:0;font-family:Segoe UI,system-ui,sans-serif;padding:32px;background:#0b1628;color:#f7fbff;}p{margin:0;font-size:1.1rem;}</style></head><body><p>Ticket history unavailable.</p></body></html>');
        doc.close();
        return;
      }
      const historyEntries = Array.isArray(ticket.history) ? [...ticket.history] : [];
      historyEntries.sort((a, b) => {
        const aTime = new Date(a?.ts || 0).getTime();
        const bTime = new Date(b?.ts || 0).getTime();
        return bTime - aTime;
      });
      const detailRows = [
        ['Ticket ID', ticket.id || ''],
        ['Vehicle', ticket.vehicle_label || ''],
        ['OPS Status', ticket.ops_status || ''],
        ['Shop Status', ticket.shop_status || ''],
        ['Reported At', formatDateTime(ticket.reported_at)],
        ['Reported By', ticket.reported_by || ''],
        ['OPS Notes', ticket.ops_description || ''],
        ['Mechanic', ticket.mechanic || ''],
        ['Diagnosis', ticket.diagnosis_text || ''],
        ['Diag Date', formatDateOnly(ticket.diag_date)],
        ['Completed Date', formatDateOnly(ticket.completed_at)],
        ['Closed At', formatDateTime(ticket.closed_at)],
        ['Created At', formatDateTime(ticket.created_at)],
        ['Updated At', formatDateTime(ticket.updated_at)]
      ];
      const detailsHtml = detailRows
        .map(([label, value]) => `<tr><th>${escapeHtml(label)}</th><td>${escapeHtml(value ?? '')}</td></tr>`)
        .join('');
      const historyHtml = historyEntries.length
        ? historyEntries.map((entry) => {
            const timestamp = entry?.ts ? formatDateTime(entry.ts) : 'Unknown time';
            const actor = entry?.actor || 'unknown';
            const action = entry?.action || 'updated';
            const changedFields = Object.entries(entry?.changes || {});
            changedFields.sort(([a], [b]) => a.localeCompare(b));
            const changesHtml = changedFields.length
              ? `<ul class="change-list">${changedFields.map(([field, change]) => {
                  const fromValue = escapeHtml(formatChangeValue(change?.from));
                  const toValue = escapeHtml(formatChangeValue(change?.to));
                  return `<li><span class="field">${escapeHtml(field)}</span><span class="values">${fromValue} → ${toValue}</span></li>`;
                }).join('')}</ul>`
              : '<p class="no-changes">No field changes recorded.</p>';
            return `<div class="history-entry">`
              + `<div class="history-header">`
              + `<span class="history-ts">${escapeHtml(timestamp || '')}</span>`
              + `<span class="history-actor">${escapeHtml(actor)}</span>`
              + `<span class="history-action">${escapeHtml(action)}</span>`
              + `</div>${changesHtml}</div>`;
          }).join('')
        : '<p class="empty">No history recorded yet.</p>';
      const html = `<!doctype html><html lang="en"><head><meta charset="utf-8" />`
        + `<title>Ticket ${escapeHtml(ticket.id || '')} History</title>`
        + `<style>`
        + `:root{color-scheme:dark;}body{margin:0;font-family:'Segoe UI',system-ui,sans-serif;background:#0b1628;color:#f7fbff;padding:28px;}main{max-width:860px;margin:0 auto;display:flex;flex-direction:column;gap:24px;}section{background:linear-gradient(160deg,rgba(18,31,56,0.95),rgba(18,31,56,0.75));border-radius:18px;padding:20px 24px;border:1px solid rgba(124,158,213,0.35);box-shadow:0 18px 36px rgba(5,11,28,0.45);}h1,h2{text-transform:uppercase;letter-spacing:0.1em;margin:0 0 12px;}table.details{width:100%;border-collapse:collapse;}table.details th{text-align:left;padding:6px 8px;color:#9cb5d6;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.06em;}table.details td{padding:6px 8px;border-bottom:1px solid rgba(124,158,213,0.2);font-size:0.95rem;}table.details tr:last-child td{border-bottom:none;}.history-entry{border:1px solid rgba(124,158,213,0.25);border-radius:16px;padding:14px 16px;margin-bottom:14px;background:rgba(7,14,28,0.6);}.history-entry:last-child{margin-bottom:0;}.history-header{display:flex;flex-wrap:wrap;gap:10px 14px;align-items:center;margin-bottom:10px;font-size:0.9rem;color:#9cb5d6;}.history-ts{font-weight:600;color:#f7fbff;}.history-actor{font-weight:600;color:#7cc9ff;}.history-action{text-transform:uppercase;letter-spacing:0.08em;font-size:0.75rem;background:rgba(124,201,255,0.18);color:#7cc9ff;padding:4px 10px;border-radius:999px;}ul.change-list{margin:0;padding-left:20px;display:flex;flex-direction:column;gap:6px;}ul.change-list li{list-style:disc;color:#f7fbff;}ul.change-list .field{font-weight:600;color:#7cc9ff;margin-right:6px;text-transform:uppercase;letter-spacing:0.05em;font-size:0.75rem;display:inline-block;}ul.change-list .values{font-size:0.9rem;}p.empty,p.no-changes{margin:0;color:#9cb5d6;font-style:italic;}`
        + `</style></head><body><main>`
        + `<h1>Ticket ${escapeHtml(ticket.id || '')}</h1>`
        + `<section><h2>Details</h2><table class="details">${detailsHtml}</table></section>`
        + `<section><h2>Edit History</h2>${historyHtml}</section>`
        + `</main></body></html>`;
      doc.open();
      doc.write(html);
      doc.close();
      try {
        historyWin.focus();
      } catch (err) {
        /* ignore */
      }
    }

    function showMessage(text, isError = false) {
      messageEl.textContent = text;
      messageEl.style.display = 'block';
      messageEl.classList.toggle('error', isError);
      if (!isError) {
        setTimeout(() => { messageEl.style.display = 'none'; }, 4000);
      }
    }

    function clearForm() {
      form.reset();
      ticketIdEl.value = '';
      formTitle.textContent = 'Create Ticket';
      submitBtn.textContent = 'Create Ticket';
      fleetInput.removeAttribute('disabled');
      historyBtn.hidden = true;
      historyBtn.dataset.ticketId = '';
    }

    function populateForm(ticket) {
      ticketIdEl.value = ticket.id;
      formTitle.textContent = `Update Ticket ${ticket.id.slice(0, 8)}`;
      submitBtn.textContent = 'Update Ticket';
      fleetInput.value = ticket.vehicle_label || '';
      fleetInput.setAttribute('disabled', 'true');
      reportedAtInput.value = isoToLocalDateTimeInput(ticket.reported_at);
      reportedByInput.value = ticket.reported_by || '';
      opsStatusInput.value = ticket.ops_status || '';
      shopStatusInput.value = ticket.shop_status || '';
      mechanicInput.value = ticket.mechanic || '';
      diagDateInput.value = isoToDateInput(ticket.diag_date);
      completedAtInput.value = isoToDateInput(ticket.completed_at);
      opsDescriptionInput.value = ticket.ops_description || '';
      diagnosisInput.value = ticket.diagnosis_text || '';
      historyBtn.hidden = false;
      historyBtn.dataset.ticketId = ticket.id;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function fetchTickets() {
      ticketsBody.innerHTML = '<tr><td colspan="11">Loading…</td></tr>';
      try {
        const params = new URLSearchParams();
        if (includeClosedEl.checked) params.set('includeClosed', 'true');
        const query = params.toString();
        const res = await fetch(`${TICKETS_API_BASE}${query ? `?${query}` : ''}`);
        if (!res.ok) throw new Error('Request failed');
        const body = await res.json();
        const tickets = Array.isArray(body)
          ? body
          : (Array.isArray(body?.tickets) ? body.tickets : []);
        renderTickets(tickets);
      } catch (err) {
        ticketsBody.innerHTML = '<tr><td colspan="11">Unable to load tickets.</td></tr>';
      }
    }

    function renderTickets(tickets) {
      if (!tickets.length) {
        ticketsBody.innerHTML = '<tr><td colspan="11">No tickets found.</td></tr>';
        return;
      }
      ticketsBody.innerHTML = '';
      tickets.forEach((ticket) => {
        const tr = document.createElement('tr');

        const vehicleCell = document.createElement('td');
        vehicleCell.textContent = ticket.vehicle_label || '';
        tr.appendChild(vehicleCell);

        const opsStatusCell = document.createElement('td');
        if (ticket.ops_status) {
          const span = document.createElement('span');
          span.className = `pill ${OPS_CLASS[ticket.ops_status] || ''}`.trim();
          span.textContent = ticket.ops_status;
          opsStatusCell.appendChild(span);
        }
        tr.appendChild(opsStatusCell);

        const reportedCell = document.createElement('td');
        reportedCell.textContent = formatDateTime(ticket.reported_at);
        tr.appendChild(reportedCell);

        const reportedByCell = document.createElement('td');
        reportedByCell.textContent = ticket.reported_by || '';
        tr.appendChild(reportedByCell);

        const opsNotesCell = document.createElement('td');
        opsNotesCell.textContent = ticket.ops_description || '';
        tr.appendChild(opsNotesCell);

        const diagDateCell = document.createElement('td');
        const diagValue = ticket.diag_date || ticket.started_at;
        diagDateCell.textContent = formatDateOnly(diagValue);
        tr.appendChild(diagDateCell);

        const mechanicCell = document.createElement('td');
        mechanicCell.textContent = ticket.mechanic || '';
        tr.appendChild(mechanicCell);

        const diagnosisCell = document.createElement('td');
        diagnosisCell.textContent = ticket.diagnosis_text || '';
        tr.appendChild(diagnosisCell);

        const completedCell = document.createElement('td');
        completedCell.textContent = formatDateOnly(ticket.completed_at);
        tr.appendChild(completedCell);

        const shopStatusCell = document.createElement('td');
        if (ticket.shop_status) {
          const span = document.createElement('span');
          span.className = `pill ${SHOP_CLASS[ticket.shop_status] || ''}`.trim();
          span.textContent = ticket.shop_status;
          shopStatusCell.appendChild(span);
        }
        tr.appendChild(shopStatusCell);

        const actionsCell = document.createElement('td');
        tr.appendChild(actionsCell);

        const actions = document.createElement('div');
        actions.className = 'row-actions';
        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'secondary';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', () => populateForm(ticket));
        actions.appendChild(editBtn);

        const completeBtn = document.createElement('button');
        completeBtn.type = 'button';
        completeBtn.textContent = ticket.closed_at ? 'Reopen' : 'Complete';
        if (ticket.closed_at) {
          completeBtn.className = 'secondary';
        }
        completeBtn.addEventListener('click', async () => {
          const payload = {};
          if (ticket.closed_at) {
            payload.closed_at = null;
          } else {
            payload.closed_at = new Date().toISOString();
          }
          try {
            const idempotencyKey = `complete-${ticket.id}-${crypto.randomUUID()}`;
            await syncTicketRequest(`${TICKETS_API_BASE}/${ticket.id}`, 'PUT', payload, idempotencyKey);
            await fetchTickets();
            const baseMessage = ticket.closed_at ? 'Ticket reopened.' : 'Ticket marked complete.';
            showMessage(baseMessage);
          } catch (err) {
            showMessage('Unable to update ticket.', true);
          }
        });
        actions.appendChild(completeBtn);

        actionsCell.appendChild(actions);
        ticketsBody.appendChild(tr);
      });
    }

    async function syncTicketRequest(url, method, payload, idempotencyKey) {
      const res = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          ...(idempotencyKey ? { 'Idempotency-Key': idempotencyKey } : {})
        },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const errorText = await res.text();
        throw new Error(errorText || 'Request failed');
      }
      let lastResponse;
      try {
        lastResponse = await res.json();
      } catch (jsonErr) {
        throw new Error('Invalid server response');
      }
      return { body: lastResponse };
    }

    async function submitForm(event) {
      event.preventDefault();
      if (!form.reportValidity()) {
        return;
      }
      const ticketId = ticketIdEl.value;
      const fleetValue = fleetInput.value.trim();
      const reportedBy = reportedByInput.value.trim();
      const opsNotes = opsDescriptionInput.value.trim();
      if (!reportedBy) {
        showMessage('Reported By is required.', true);
        reportedByInput.focus();
        return;
      }
      if (!opsNotes) {
        showMessage('OPS Notes are required.', true);
        opsDescriptionInput.focus();
        return;
      }
      if (!ticketId && !fleetValue) {
        showMessage('Fleet # is required.', true);
        fleetInput.focus();
        return;
      }
      const payload = {
        reported_at: localDateTimeInputToIso(reportedAtInput.value),
        reported_by: reportedBy,
        ops_status: opsStatusInput.value || null,
        ops_description: opsNotes,
        shop_status: shopStatusInput.value || null,
        mechanic: mechanicInput.value.trim() || null,
        diag_date: dateInputToValue(diagDateInput.value),
        diagnosis_text: diagnosisInput.value.trim() || null,
        completed_at: dateInputToValue(completedAtInput.value)
      };
      if (!payload.completed_at) delete payload.completed_at;
      if (!payload.reported_at) delete payload.reported_at;

      try {
        if (ticketId) {
          const idempotencyKey = `update-${ticketId}-${crypto.randomUUID()}`;
          await syncTicketRequest(`${TICKETS_API_BASE}/${ticketId}`, 'PUT', payload, idempotencyKey);
          showMessage('Ticket updated.');
        } else {
          payload.fleet_no = fleetValue;
          const idempotencyKey = `create-${crypto.randomUUID()}`;
          await syncTicketRequest(TICKETS_API_BASE, 'POST', payload, idempotencyKey);
          showMessage('Ticket created.');
        }
        clearForm();
        await fetchTickets();
      } catch (err) {
        showMessage(err.message || 'Request failed.', true);
      }
    }

    historyBtn.addEventListener('click', async () => {
      const ticketId = historyBtn.dataset.ticketId || ticketIdEl.value;
      if (!ticketId) {
        showMessage('Select a ticket before viewing history.', true);
        return;
      }
      const historyWin = window.open('', '_blank', 'noopener,noreferrer,width=880,height=920');
      if (!historyWin) {
        showMessage('Enable pop-ups to view ticket history.', true);
        return;
      }
      historyWin.document.open();
      historyWin.document.write('<!doctype html><html lang="en"><head><meta charset="utf-8" /><title>Loading History</title><style>body{margin:0;font-family:Segoe UI,system-ui,sans-serif;background:#0b1628;color:#f7fbff;padding:32px;}p{margin:0;font-size:1.1rem;}</style></head><body><p>Loading history…</p></body></html>');
      historyWin.document.close();
      try {
        const res = await fetch(`${TICKETS_API_BASE}/${encodeURIComponent(ticketId)}`);
        if (!res.ok) throw new Error('Unable to load history.');
        const body = await res.json();
        const ticket = body?.ticket || body;
        if (!ticket || typeof ticket !== 'object') {
          throw new Error('Ticket history unavailable.');
        }
        renderHistoryWindow(ticket, historyWin);
      } catch (err) {
        const message = err?.message || 'Unable to load history.';
        if (historyWin && !historyWin.closed) {
          historyWin.document.open();
          historyWin.document.write(`<!doctype html><html lang="en"><head><meta charset="utf-8" /><title>Error</title><style>body{margin:0;font-family:Segoe UI,system-ui,sans-serif;background:#0b1628;color:#ff6488;padding:32px;}p{margin:0;font-size:1.1rem;}</style></head><body><p>${escapeHtml(message)}</p></body></html>`);
          historyWin.document.close();
        }
        showMessage(message, true);
      }
    });

    includeClosedEl.addEventListener('change', fetchTickets);
    form.addEventListener('submit', submitForm);
    resetBtn.addEventListener('click', () => {
      clearForm();
      messageEl.style.display = 'none';
    });
    refreshBtn.addEventListener('click', fetchTickets);

    clearForm();
    fetchTickets();
  </script>
</body>
</html>
