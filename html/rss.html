<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bus Arrival RSS Feed - UTS</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1.5rem; color: #1a1a1a; line-height: 1.6; }
    h1 { color: #232D4B; }
    h2 { color: #232D4B; margin-top: 2rem; }
    code, pre { background: #f0f0f0; border-radius: 4px; font-family: monospace; }
    code { padding: 2px 6px; }
    pre { padding: 1rem; overflow-x: auto; white-space: pre-wrap; word-break: break-all; }
    .feed-url { background: #eef4ff; border-left: 4px solid #232D4B; padding: 0.75rem 1rem; border-radius: 0 4px 4px 0; font-family: monospace; word-break: break-all; }
    .step { margin-bottom: 1rem; }
    .step strong { display: inline-block; background: #232D4B; color: #fff; border-radius: 50%; width: 1.5rem; height: 1.5rem; text-align: center; line-height: 1.5rem; margin-right: 0.5rem; font-size: 0.85rem; }
    a { color: #0b63ce; }
    table { border-collapse: collapse; width: 100%; margin-top: 0.5rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem 0.75rem; text-align: left; }
    th { background: #232D4B; color: #fff; }
    tr:nth-child(even) { background: #f8f8f8; }

    /* Sign preview */
    #sign-outer {
      display: inline-block;
      background: #111;
      border: 4px solid #555;
      border-radius: 6px;
      padding: 10px 14px;
      box-shadow: inset 0 0 8px #000, 0 2px 6px rgba(0,0,0,0.4);
    }
    #sign {
      display: block;
      width: 384px;
      height: 64px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .sign-label {
      color: #888;
      font-size: 0.75rem;
      margin-top: 4px;
      text-align: right;
    }
    .disclaimer {
      background: #fff8e6;
      border-left: 4px solid #E57200;
      padding: 0.6rem 1rem;
      border-radius: 0 4px 4px 0;
      font-size: 0.9rem;
      margin-top: 1rem;
    }
    #preview-controls { margin-top: 0.75rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    #preview-status { color: #555; font-size: 0.9rem; font-style: italic; }
    #preview-stop { width: 70px; font-size: 1rem; padding: 3px 6px; }
    #load-btn { font-size: 1rem; padding: 4px 12px; cursor: pointer; }
  </style>
</head>
<body>

  <h1>Bus Arrival RSS Feed</h1>
  <p>
    UTS provides a real-time RSS 2.0 feed of bus arrival predictions for any stop on the system.
    The feed is designed for digital signage devices (such as NovaNex LED displays) that consume RSS,
    but it works with any standard RSS reader.
  </p>

  <h2>Feed URL</h2>
  <div class="feed-url">https://utsopsdashboard.com/api/rss/stop_arrivals?stopID=<strong>{stopID}</strong></div>
  <p>Replace <code>{stopID}</code> with the numeric ID for the stop you want. The feed updates every 15 seconds on the server; configure your device to poll at least once per minute.</p>

  <h2>How to Find a Stop ID</h2>
  <div class="step"><strong>1</strong> Go to <a href="https://uva.transloc.com/" target="_blank">uva.transloc.com</a></div>
  <div class="step"><strong>2</strong> Click on the bus stop you need on the map.</div>
  <div class="step"><strong>3</strong> The stop ID appears in the URL, for example:<br>
    <code>https://uva.transloc.com/stops/<strong>26</strong></code><br>
    In this case the stop ID is <strong>26</strong>.
  </div>

  <h2>Example</h2>
  <p>Feed for <strong>Massie Rd @ JPJ South Lot</strong> (stop 26):</p>
  <div class="feed-url">https://utsopsdashboard.com/api/rss/stop_arrivals?stopID=26</div>
  <p>This produces an RSS feed like:</p>
  <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;rss version="2.0"&gt;
  &lt;channel&gt;
    &lt;title&gt;Bus Arrivals - Massie Rd @ JPJ South Lot&lt;/title&gt;
    &lt;ttl&gt;1&lt;/ttl&gt;
    &lt;item&gt;
      &lt;title&gt;Silver Line: Arriving&lt;/title&gt;
      &lt;description&gt;Next arrivals: Arriving, 8 min&lt;/description&gt;
    &lt;/item&gt;
    &lt;item&gt;
      &lt;title&gt;Gold Line: 3 min&lt;/title&gt;
      &lt;description&gt;Next arrivals: 3 min, 10 min, 18 min, 24 min&lt;/description&gt;
    &lt;/item&gt;
  &lt;/channel&gt;
&lt;/rss&gt;</pre>

  <h2>Feed Structure</h2>
  <table>
    <tr><th>Field</th><th>Description</th></tr>
    <tr><td><code>&lt;title&gt;</code> (channel)</td><td>Stop name, e.g. "Bus Arrivals - Massie Rd @ JPJ South Lot"</td></tr>
    <tr><td><code>&lt;ttl&gt;</code></td><td>1 (minute) — recommended poll interval</td></tr>
    <tr><td><code>&lt;item&gt; &lt;title&gt;</code></td><td>Route name and next arrival, e.g. "Gold Line: 3 min" or "Silver Line: Arriving"</td></tr>
    <tr><td><code>&lt;item&gt; &lt;description&gt;</code></td><td>All upcoming arrivals for that route, e.g. "Next arrivals: 3 min, 10 min, 18 min"</td></tr>
  </table>
  <p>Items are sorted by soonest arrival. If no buses are scheduled, the feed contains a single item indicating no arrivals.</p>

  <h2>Common Stop IDs</h2>
  <table>
    <tr><th>Stop</th><th>ID</th><th>Feed URL</th></tr>
    <tr><td>Massie Rd @ JPJ South Lot</td><td>26</td><td><a href="/api/rss/stop_arrivals?stopID=26">/api/rss/stop_arrivals?stopID=26</a></td></tr>
    <tr><td>Jefferson Park Ave @ Brandon Ave</td><td>54</td><td><a href="/api/rss/stop_arrivals?stopID=54">/api/rss/stop_arrivals?stopID=54</a></td></tr>
    <tr><td>Jefferson Park Ave @ Cabell Hall</td><td>2</td><td><a href="/api/rss/stop_arrivals?stopID=2">/api/rss/stop_arrivals?stopID=2</a></td></tr>
    <tr><td>Ivy Rd @ Emmet / Ivy Garage (EIG)</td><td>3</td><td><a href="/api/rss/stop_arrivals?stopID=3">/api/rss/stop_arrivals?stopID=3</a></td></tr>
    <tr><td>Emmet St @ Central Grounds Garage</td><td>159</td><td><a href="/api/rss/stop_arrivals?stopID=159">/api/rss/stop_arrivals?stopID=159</a></td></tr>
  </table>
  <p>This table lists a few common stops from the live system. Use the TransLoc map above to find any stop not listed here.</p>

  <h2>Sign Preview</h2>
  <p>Enter a stop ID below to see a simulation of how live arrival data might scroll across a NovaNex 16&times;96 LED display (rendered at 4&times; scale).</p>

  <div class="disclaimer">
    <strong>Note:</strong> This render is entirely theoretical. The actual appearance — font, scroll speed, color, layout, and content format — will depend on how UVA Safety &amp; Security chooses to configure the display.
  </div>

  <br>
  <div id="sign-outer">
    <canvas id="sign" width="96" height="16"></canvas>
    <div class="sign-label">NovaNex 16&times;96 &mdash; 4&times; scale</div>
  </div>

  <div id="preview-controls">
    <label for="preview-stop">Stop ID:</label>
    <input id="preview-stop" type="number" value="26" min="1">
    <button id="load-btn" onclick="loadStop()">Load</button>
    <span id="preview-status">Loading&hellip;</span>
  </div>

  <script>
  (function () {
    const canvas = document.getElementById('sign');
    const ctx = canvas.getContext('2d');
    const statusEl = document.getElementById('preview-status');

    let scrollText = '';
    let scrollX = 96;
    let lastTs = null;
    const SPEED = 25; // canvas pixels per second

    function draw(ts) {
      if (lastTs !== null) {
        scrollX -= SPEED * (ts - lastTs) / 1000;
      }
      lastTs = ts;

      // Background — very dark, not pure black, to hint at unlit LEDs
      ctx.fillStyle = '#0d0d0d';
      ctx.fillRect(0, 0, 96, 16);

      if (scrollText) {
        ctx.font = '7px "Luminator4x7"';
        ctx.fillStyle = '#FF8C00';
        ctx.textBaseline = 'middle';
        ctx.fillText(scrollText, Math.round(scrollX), 8);

        const w = ctx.measureText(scrollText).width;
        if (scrollX < -w) {
          scrollX = 96;
        }
      }

      requestAnimationFrame(draw);
    }

    // Build scroll text from stop arrivals JSON
    async function loadStop() {
      const stopID = document.getElementById('preview-stop').value.trim();
      if (!stopID) return;
      statusEl.textContent = 'Loading\u2026';

      try {
        const r = await fetch('/v1/transloc/stop_arrivals?stopIDs=' + encodeURIComponent(stopID));
        const data = await r.json();

        if (!Array.isArray(data) || !data.length) {
          scrollText = 'No arrivals currently scheduled     ';
          statusEl.textContent = 'No data for stop ' + stopID + '.';
          scrollX = 96;
          return;
        }

        const rawName = (data[0].StopDescription || ('Stop ' + stopID)).replace(/\s*\(.*?\)\s*/g, ' ').trim();
        statusEl.textContent = rawName;

        // Group all times by route name
        const routes = new Map();
        for (const entry of data) {
          const name = (entry.RouteDescription || 'Bus').trim().replace(/\.$/, '');
          if (!routes.has(name)) {
            routes.set(name, { firstSecs: Infinity, labels: [] });
          }
          const route = routes.get(name);
          for (const t of (entry.Times || [])) {
            const arriving = t.IsArriving || (t.Text || '').trim().toLowerCase() === 'arriving';
            if (arriving) {
              route.labels.push('Arriving');
              route.firstSecs = 0;
            } else if (t.Seconds != null) {
              const mins = Math.ceil(t.Seconds / 60);
              route.labels.push(mins <= 1 ? '1 min' : mins + ' min');
              if (t.Seconds < route.firstSecs) route.firstSecs = t.Seconds;
            }
          }
        }

        const sorted = [...routes.entries()]
          .filter(([, r]) => r.labels.length > 0)
          .sort((a, b) => a[1].firstSecs - b[1].firstSecs);

        if (!sorted.length) {
          scrollText = 'No arrivals currently scheduled     ';
        } else {
          // Each route shown as "Route Name: X min", separated by wide gaps
          scrollText = sorted.map(([name, r]) => name + ': ' + r.labels[0]).join('          ') + '          ';
        }

        scrollX = 96;
      } catch (e) {
        statusEl.textContent = 'Error loading data.';
        console.error(e);
      }
    }

    // Load font, then kick off animation and initial data fetch
    const face = new FontFace('Luminator4x7', 'url(/fonts/luminator-4x7s.otf)');
    face.load().then(function (f) {
      document.fonts.add(f);
    }).catch(function (e) {
      console.warn('Luminator font failed to load:', e);
    }).finally(function () {
      loadStop();
      requestAnimationFrame(draw);
    });

    // Expose for inline onclick
    window.loadStop = loadStop;
  })();
  </script>

</body>
</html>
