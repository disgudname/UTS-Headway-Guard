<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bus Arrival RSS Feed - UTS</title>
  <style>
    @font-face { font-family: 'Luminator'; src: url('/fonts/luminator-4x7s.otf'); }

    body { font-family: Arial, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1.5rem; color: #1a1a1a; line-height: 1.6; }
    h1 { color: #232D4B; }
    h2 { color: #232D4B; margin-top: 2rem; }
    code, pre { background: #f0f0f0; border-radius: 4px; font-family: monospace; }
    code { padding: 2px 6px; }
    pre { padding: 1rem; overflow-x: auto; white-space: pre-wrap; word-break: break-all; }
    .feed-url { background: #eef4ff; border-left: 4px solid #232D4B; padding: 0.75rem 1rem; border-radius: 0 4px 4px 0; font-family: monospace; word-break: break-all; }
    .step { margin-bottom: 1rem; }
    .step strong { display: inline-block; background: #232D4B; color: #fff; border-radius: 50%; width: 1.5rem; height: 1.5rem; text-align: center; line-height: 1.5rem; margin-right: 0.5rem; font-size: 0.85rem; }
    a { color: #0b63ce; }
    table { border-collapse: collapse; width: 100%; margin-top: 0.5rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem 0.75rem; text-align: left; }
    th { background: #232D4B; color: #fff; }
    tr:nth-child(even) { background: #f8f8f8; }

    /* Sign preview */
    #sign-outer {
      background: #0d0d0d;
      border: 5px solid #444;
      border-radius: 6px;
      padding: 10px 0;
      overflow: hidden;
      max-width: 100%;
      box-shadow: inset 0 0 10px #000, 0 3px 8px rgba(0,0,0,0.4);
    }
    #sign-viewport {
      overflow: hidden;
      white-space: nowrap;
      height: 2.4rem;
      display: flex;
      align-items: center;
    }
    #sign-text {
      display: inline-block;
      font-family: 'Luminator', monospace;
      font-size: 2rem;
      color: #FF8C00;
      white-space: nowrap;
      will-change: transform;
      padding-left: 100%;
    }
    .disclaimer {
      background: #fff8e6;
      border-left: 4px solid #E57200;
      padding: 0.6rem 1rem;
      border-radius: 0 4px 4px 0;
      font-size: 0.9rem;
      margin-top: 1rem;
    }
    #preview-controls { margin-top: 0.75rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    #preview-status { color: #555; font-size: 0.9rem; font-style: italic; }
    #preview-stop { width: 70px; font-size: 1rem; padding: 3px 6px; }
    #load-btn { font-size: 1rem; padding: 4px 12px; cursor: pointer; }
  </style>
</head>
<body>

  <h1>Bus Arrival RSS Feed</h1>
  <p>
    UTS provides a real-time RSS 2.0 feed of bus arrival predictions for any stop on the system.
    The feed is designed for digital signage devices (such as NovaNex LED displays) that consume RSS,
    but it works with any standard RSS reader.
  </p>

  <h2>Feed URL</h2>
  <div class="feed-url">https://utsopsdashboard.com/api/rss/stop_arrivals?stopID=<strong>{stopID}</strong></div>
  <p>Replace <code>{stopID}</code> with the numeric ID for the stop you want. The feed updates every 15 seconds on the server; configure your device to poll at least once per minute.</p>

  <h2>How to Find a Stop ID</h2>
  <div class="step"><strong>1</strong> Go to <a href="https://uva.transloc.com/" target="_blank">uva.transloc.com</a></div>
  <div class="step"><strong>2</strong> Click on the bus stop you need on the map.</div>
  <div class="step"><strong>3</strong> The stop ID appears in the URL, for example:<br>
    <code>https://uva.transloc.com/stops/<strong>26</strong></code><br>
    In this case the stop ID is <strong>26</strong>.
  </div>

  <h2>Example</h2>
  <p>Feed for <strong>Massie Rd @ JPJ South Lot</strong> (stop 26):</p>
  <div class="feed-url">https://utsopsdashboard.com/api/rss/stop_arrivals?stopID=26</div>
  <p>This produces an RSS feed like:</p>
  <pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;rss version="2.0"&gt;
  &lt;channel&gt;
    &lt;title&gt;Bus Arrivals - Massie Rd @ JPJ South Lot&lt;/title&gt;
    &lt;ttl&gt;1&lt;/ttl&gt;
    &lt;item&gt;
      &lt;title&gt;Silver Line: Arriving&lt;/title&gt;
      &lt;description&gt;Next arrivals: Arriving, 8 min&lt;/description&gt;
    &lt;/item&gt;
    &lt;item&gt;
      &lt;title&gt;Gold Line: 3 min&lt;/title&gt;
      &lt;description&gt;Next arrivals: 3 min, 10 min, 18 min, 24 min&lt;/description&gt;
    &lt;/item&gt;
  &lt;/channel&gt;
&lt;/rss&gt;</pre>

  <h2>Feed Structure</h2>
  <table>
    <tr><th>Field</th><th>Description</th></tr>
    <tr><td><code>&lt;title&gt;</code> (channel)</td><td>Stop name, e.g. "Bus Arrivals - Massie Rd @ JPJ South Lot"</td></tr>
    <tr><td><code>&lt;ttl&gt;</code></td><td>1 (minute) — recommended poll interval</td></tr>
    <tr><td><code>&lt;item&gt; &lt;title&gt;</code></td><td>Route name and next arrival, e.g. "Gold Line: 3 min" or "Silver Line: Arriving"</td></tr>
    <tr><td><code>&lt;item&gt; &lt;description&gt;</code></td><td>All upcoming arrivals for that route, e.g. "Next arrivals: 3 min, 10 min, 18 min"</td></tr>
  </table>
  <p>Items are sorted by soonest arrival. If no buses are scheduled, the feed contains a single item indicating no arrivals.</p>

  <h2>Common Stop IDs</h2>
  <table>
    <tr><th>Stop</th><th>ID</th><th>Feed URL</th></tr>
    <tr><td>Massie Rd @ JPJ South Lot</td><td>26</td><td><a href="/api/rss/stop_arrivals?stopID=26">/api/rss/stop_arrivals?stopID=26</a></td></tr>
    <tr><td>Jefferson Park Ave @ Brandon Ave</td><td>54</td><td><a href="/api/rss/stop_arrivals?stopID=54">/api/rss/stop_arrivals?stopID=54</a></td></tr>
    <tr><td>Jefferson Park Ave @ Cabell Hall</td><td>2</td><td><a href="/api/rss/stop_arrivals?stopID=2">/api/rss/stop_arrivals?stopID=2</a></td></tr>
    <tr><td>Ivy Rd @ Emmet / Ivy Garage (EIG)</td><td>3</td><td><a href="/api/rss/stop_arrivals?stopID=3">/api/rss/stop_arrivals?stopID=3</a></td></tr>
    <tr><td>Emmet St @ Central Grounds Garage</td><td>159</td><td><a href="/api/rss/stop_arrivals?stopID=159">/api/rss/stop_arrivals?stopID=159</a></td></tr>
  </table>
  <p>This table lists a few common stops from the live system. Use the TransLoc map above to find any stop not listed here.</p>

  <h2>Sign Preview</h2>
  <p>Enter a stop ID below to preview live arrival data as it would appear on a destination-sign style display. Data is pulled directly from the RSS feed.</p>

  <div class="disclaimer">
    <strong>Note:</strong> Arrival times shown are live data from the RSS feed. The visual appearance — font, scroll speed, color, and layout — is illustrative; the actual sign configuration will depend on how UVA Safety &amp; Security programs the display.
  </div>

  <br>
  <div id="sign-outer">
    <div id="sign-viewport">
      <span id="sign-text"></span>
    </div>
  </div>

  <div id="preview-controls">
    <label for="preview-stop">Stop ID:</label>
    <input id="preview-stop" type="number" value="26" min="1">
    <button id="load-btn" onclick="loadStop()">Load</button>
    <span id="preview-status">Loading&hellip;</span>
  </div>

  <script>
  (function () {
    const textEl = document.getElementById('sign-text');
    const viewport = document.getElementById('sign-viewport');
    const statusEl = document.getElementById('preview-status');

    let posX = 0;       // current offset in px, starting just off right edge
    let textWidth = 0;
    let lastTs = null;
    const SPEED = 80;   // px per second

    function scroll(ts) {
      if (lastTs !== null) {
        posX -= SPEED * (ts - lastTs) / 1000;
      }
      lastTs = ts;

      // Reset once the text has fully scrolled off the left
      if (posX < -textWidth) {
        posX = viewport.offsetWidth;
      }

      textEl.style.transform = 'translateX(' + Math.round(posX) + 'px)';
      textEl.style.paddingLeft = '0';
      requestAnimationFrame(scroll);
    }

    function setText(text) {
      textEl.textContent = text;
      // Measure after paint so width is accurate
      requestAnimationFrame(function () {
        textWidth = textEl.offsetWidth;
        posX = viewport.offsetWidth;
      });
    }

    window.loadStop = async function () {
      const stopID = document.getElementById('preview-stop').value.trim();
      if (!stopID) return;
      statusEl.textContent = 'Loading\u2026';

      try {
        const r = await fetch('/api/rss/stop_arrivals?stopID=' + encodeURIComponent(stopID));
        const xmlText = await r.text();
        const doc = new DOMParser().parseFromString(xmlText, 'application/xml');

        // Show stop name from channel title ("Bus Arrivals - {Stop Name}")
        const chanTitle = doc.querySelector('channel > title');
        const stopName = chanTitle ? chanTitle.textContent.replace(/^Bus Arrivals\s*-\s*/i, '').trim() : 'Stop ' + stopID;
        statusEl.textContent = stopName;

        // Each <item><title> is already formatted as "Route: time"
        const items = [...doc.querySelectorAll('item > title')].map(el => el.textContent.trim());

        const text = items.length ? items.join('          ') : 'No arrivals currently scheduled';
        setText(text.toUpperCase());
      } catch (e) {
        statusEl.textContent = 'Error loading data.';
        console.error(e);
      }
    };

    // Start animation loop, then load initial data
    requestAnimationFrame(scroll);
    loadStop();
  })();
  </script>

</body>
</html>
