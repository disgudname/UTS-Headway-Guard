<!doctype html>
<link rel="icon" type="image/png" href="UTSShield.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/media/apple-touch-icon-120.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/media/apple-touch-icon-152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/media/apple-touch-icon-180.png" />
<meta charset="utf-8">
<title>Dispatch - UTS Operations Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style id="dispatcher-style">
@font-face{font-family:'FGDC';src:url('FGDC.ttf') format('truetype')}
@font-face{font-family:'Antonio';src:url('ANTONIO.ttf') format('truetype');font-weight:400;font-style:normal;font-display:swap}
:root{--route-color:#2a3442}
body{font-family:'FGDC',system-ui;font-size:17px;margin:0;background:#0b0e11;color:#e8eef5;display:flex;height:100vh;position:relative;overflow:hidden}
body.howell-mode{background:radial-gradient(circle at 12% 18%,rgba(255,153,102,.12)0,transparent 54%),radial-gradient(circle at 86% 84%,rgba(102,204,204,.1)0,transparent 60%),linear-gradient(130deg,#070b1a 0,#04060f 42%,#070b1a 100%)}
body.howell-mode header h1{letter-spacing:.14em}

#left{overflow:auto;flex:1 1 50%;min-width:260px;max-width:100%}
#splitter{flex:0 0 8px;cursor:col-resize;background:linear-gradient(180deg,rgba(31,38,48,.8),rgba(21,27,36,.8));border-left:1px solid rgba(61,74,92,.65);border-right:1px solid rgba(8,10,14,.85);position:relative;z-index:3}
#splitter::after{content:"";position:absolute;top:50%;left:50%;width:2px;height:40px;background:rgba(143,163,193,.55);border-radius:999px;transform:translate(-50%,-50%)}
iframe#map-frame{flex:1 1 0%;min-width:320px;border-left:1px solid #1f2630;height:100%}
body.resizing{cursor:col-resize;user-select:none}
body.resizing iframe#map-frame{pointer-events:none}
header{display:flex;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid #1f2630;flex-wrap:wrap}
header h1{flex-basis:100%}
#controls{display:flex;gap:10px;align-items:center;position:relative;padding-right:200px}
#controls label.control-field{display:flex;align-items:center;gap:8px;font-size:15px;color:#cfe1ff}
#controls label.control-field span{font-size:14px;opacity:.82}
#controls label.control-field select{min-width:160px}
#duty-roster{display:flex;flex-direction:column;gap:4px;margin-left:12px;font-size:14px;color:#e8eef5}
#duty-roster .duty-line{display:flex;align-items:baseline;gap:6px;flex-wrap:nowrap}
#duty-roster .duty-title{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#9fb0c9;white-space:nowrap;flex:0 0 auto}
#duty-roster .duty-name{font-weight:600;white-space:nowrap;flex:0 0 auto}
#duty-roster .duty-line.duty-empty .duty-name{font-weight:400;color:#6b778a}
body.kiosk-mode #controls label.control-field{flex:0 0 auto}
body.lcars #controls label.control-field{display:flex;flex-direction:column;align-items:flex-start;gap:6px;font-size:12px;color:#FFCC66}
body.lcars #controls label.control-field span{text-transform:uppercase;letter-spacing:.08em;font-size:12px}
body.lcars #controls label.control-field select{width:180px;max-width:100%}
body.lcars #duty-roster{margin-left:auto;align-items:flex-end;color:#FFCC66}
body.lcars #duty-roster .duty-title{color:#FFCC66;font-size:11px}
body.cyberpunk #duty-roster{color:#d9fbff}
body.cyberpunk #duty-roster .duty-title{color:#7fffd4}
body.cyberpunk #controls label.control-field span{color:#7fffd4}
select{background:#10151c;color:#e8eef5;border:1px solid #2a3442;border-radius:10px;padding:8px 10px}
button{background:#10151c;color:#e8eef5;border:1px solid #2a3442;border-radius:10px;padding:8px 12px;font-family:inherit;font-size:15px;cursor:pointer;transition:background-color .2s ease,border-color .2s ease}
button:hover{background:#15202b;border-color:#334355}
button:focus{outline:2px solid #3a83f5;outline-offset:2px}
button:disabled{opacity:.65;cursor:not-allowed}
.chip{display:inline-block;border:1px solid #2a3442;border-radius:999px;padding:2px 8px;margin-left:8px;color:#cfe1ff}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border-bottom:1px solid #1f2630;padding:8px 10px;text-align:left}
body:not(.lcars):not(.cyberpunk) .panel.downed-panel{
  --downed-bg:#101935;
  --downed-alt:#152349;
  --downed-soft:#142040;
  --downed-ink:#f0f4ff;
  --downed-muted:#9fb0c9;
  --downed-line:rgba(159,176,201,0.25);
  --downed-pill-downed:#ff4d6d;
  --downed-pill-hold:#ffe29a;
  --downed-pill-cosmetic:#7fb2ff;
  --downed-pill-comfort:#ffb347;
  --downed-pill-up:#6be39a;
  --downed-pill-usable:#6b7bff;
  background:var(--downed-bg);
  border:1px solid var(--downed-line);
  border-radius:18px;
  box-shadow:0 18px 32px rgba(6,11,28,0.35);
  color:var(--downed-ink);
  overflow:hidden;
}
body:not(.lcars):not(.cyberpunk) .panel.downed-panel h2{
  margin:0;
  padding:18px 24px 0;
  font-size:clamp(16px,1.2vw,20px);
  text-transform:uppercase;
  letter-spacing:.08em;
}
body:not(.lcars):not(.cyberpunk) .panel.downed-panel .panel-body{
  padding:12px 24px 24px;
  display:flex;
  flex-direction:column;
  gap:16px;
}
.downed-embed-wrapper{
  width:100%;
  border-radius:16px;
  overflow:hidden;
  background:var(--downed-bg);
  border:1px solid var(--downed-line);
  box-shadow:0 18px 32px rgba(6,11,28,0.35);
}
.downed-embed-frame{
  display:block;
  width:100%;
  border:0;
  height:600px;
  background:transparent;
}
.downed-embed-frame:focus{
  outline:2px solid #3a83f5;
  outline-offset:2px;
}
.ops-status{margin-bottom:8px}
.ops-status:last-child{margin-bottom:0}
body:not(.lcars):not(.cyberpunk) .status-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:6px 16px;
  border-radius:999px;
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:.08em;
  position:relative;
  background:rgba(255,255,255,0.08);
  color:var(--downed-ink);
  box-shadow:0 0 0 1px rgba(255,255,255,0.12) inset;
}
body:not(.lcars):not(.cyberpunk) .status-pill span+span{margin-left:6px}
body:not(.lcars):not(.cyberpunk) .status-pill.pulse-alert::after{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:inherit;
  background:none;
  opacity:.6;
  box-shadow:0 0 0 0 currentColor;
  animation:downedStatusPulse 1.8s ease-out infinite;
  pointer-events:none;
}
@keyframes downedStatusPulse{
  0%{opacity:.6;box-shadow:0 0 0 0 currentColor}
  70%{opacity:.15;box-shadow:0 0 0 18px currentColor}
  100%{opacity:0;box-shadow:0 0 0 18px currentColor}
}
body:not(.lcars):not(.cyberpunk) .status-pill.downed,
body:not(.lcars):not(.cyberpunk) .status-pill.down{
  background:var(--downed-pill-downed);
  color:#fff;
  box-shadow:none;
}
body:not(.lcars):not(.cyberpunk) .status-pill.hold{
  background:var(--downed-pill-hold);
  color:#1a1a1a;
  box-shadow:none;
}
body:not(.lcars):not(.cyberpunk) .status-pill.cosmetic{
  background:var(--downed-pill-cosmetic);
  color:#0b1526;
  box-shadow:none;
}
body:not(.lcars):not(.cyberpunk) .status-pill.comfort{
  background:var(--downed-pill-comfort);
  color:#281401;
  box-shadow:none;
}
body:not(.lcars):not(.cyberpunk) .status-pill.up{
  background:var(--downed-pill-up);
  color:#082012;
  box-shadow:none;
}
body:not(.lcars):not(.cyberpunk) .status-pill.usable{
  background:var(--downed-pill-usable);
  color:#f0f4ff;
  box-shadow:none;
}
body:not(.lcars):not(.cyberpunk) .downed-panel .hint{color:var(--downed-muted)}
body:not(.lcars):not(.cyberpunk) .downed-panel .panel-body .hint{font-size:clamp(13px,0.95vw,15px)}
body.kiosk-mode:not(.lcars):not(.cyberpunk) .panel.downed-panel{
  border-radius:10px;
  box-shadow:none;
}
body.kiosk-mode:not(.lcars):not(.cyberpunk) .panel.downed-panel h2{
  padding:0 0 8px;
  font-size:16px;
  letter-spacing:.1em;
}
body.kiosk-mode:not(.lcars):not(.cyberpunk) .panel.downed-panel .panel-body{
  padding:0;
  gap:8px;
}
body.kiosk-mode:not(.lcars):not(.cyberpunk) .panel.downed-panel .downed-embed-wrapper{
  flex:1;
}
#blocks-table{width:auto;table-layout:fixed}
#blocks td{border:none;padding:2px 4px;text-align:center;width:12ch}
#blocks td .cell{border-radius:4px;background:var(--route-color,transparent);color:var(--text-color,#e8eef5);display:flex;flex-direction:column;justify-content:center;align-items:center;width:100%;min-height:2.6em;max-height:2.6em;padding:2px 0;line-height:1.15}
.blocks-grid{display:flex;flex-direction:column;gap:8px}
.blocks-grid-status{font-size:14px;color:#9fb0c9}
.blocks-grid-status[hidden]{display:none}
.blocks-grid-table{--grid-columns:4;display:grid;grid-template-columns:repeat(var(--grid-columns),minmax(0,1fr));gap:4px}
.blocks-grid .cell{background:var(--cell-bg,#10151c);border:1px solid var(--cell-border,#1f2630);border-radius:10px;padding:8px;min-height:64px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:6px;transition:background-color .2s ease,border-color .2s ease,color .2s ease}
.blocks-grid .cell[data-empty="true"]{background:#0f141c;border-color:#1b232d;color:#6f7d92}
.blocks-grid .cell .block-label{font-size:18px;letter-spacing:.08em;text-transform:uppercase;color:var(--label-color,#9fb0c9)}
.blocks-grid .cell .bus{font-size:34px;font-weight:600;letter-spacing:.08em;color:var(--cell-text,#e8eef5)}
.blocks-grid .cell .drivers{display:flex;flex-direction:column;gap:2px;font-size:12px;line-height:1.2;color:var(--driver-color,#cfe1ff)}
.blocks-grid .cell .drivers[hidden]{display:none}
#blocks-grid[hidden]{display:none}
#blocks-grid .hint{margin:0}
#blocks-grid .mono{font-family:FGDC,ui-monospace,Menlo,Consolas,monospace}
#blocks-grid .cell .mono{font-size:12px;letter-spacing:.08em}
#blocks-grid .cell .mono+.drivers{margin-top:2px}
#blocks-grid .cell .drivers .driver-line{white-space:normal;word-break:keep-all}
#blocks-grid .cell .status{font-size:12px;color:#9fb0c9}
#extra-buses{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:repeat(auto-fill,minmax(10ch,1fr));gap:4px}
.panel-body{position:relative}
#extra-buses li{background:#10151c;border:1px solid #2a3442;border-radius:4px;padding:4px 6px;text-align:center;line-height:1.15;display:flex;align-items:center;justify-content:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-height:calc(1.2em + 8px)}
#extra-buses .hint{background:none;border:none;padding:0;grid-column:1/-1;text-align:left;display:block;white-space:normal;overflow:visible;text-overflow:clip;min-height:auto;line-height:inherit}
.mono{font-family:FGDC,ui-monospace,Menlo,Consolas,monospace}
body.cyberpunk .mono{font-family:'Courier Prime','Fira Code','Source Code Pro','IBM Plex Mono','Lucida Console','Courier New',monospace}
.pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #2a3442;border-radius:999px;padding:4px 8px;background:#10151c}
.dot{width:10px;height:10px;border-radius:50%}
.ok{color:#b6f0cb}.ok .dot{background:#24c28a}
.warn{color:#ffe29a}.warn .dot{background:#ffbf47}
.bad{color:#ffb0b0}.bad .dot{background:#ff6b6b}
.hint{color:#9fb0c9}
.banner{display:none;position:absolute;right:0;top:50%;transform:translateY(-50%);padding:4px 8px;text-align:right;border-radius:4px}
.banner.error{background:#3b1f1f;color:#ffbfbf;border:1px solid #5a2b2b}
.banner.info{background:#121922;color:#cfe1ff;border:1px solid #2a3442}
h2{font-size:18px;margin:16px 0 0}
#layout{display:flex}
aside .panel+.panel{margin-top:16px}
body.kiosk-mode{font-size:16px;--kiosk-block-height:2.6em;--kiosk-entry-padding:4px}
body.kiosk-mode header{padding:10px 12px}
body.kiosk-mode #controls{flex-wrap:wrap;padding-right:0}
body.kiosk-mode #controls label{flex:1 1 140px}
body.kiosk-mode #banner{position:static;transform:none;margin-left:auto}
body.kiosk-mode #left{overflow:hidden;display:flex;flex-direction:column}
body.kiosk-mode #layout{flex:1;overflow:hidden}
body.kiosk-mode main{display:none}
body.kiosk-mode #layout aside{border-left:none;padding:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));grid-auto-rows:minmax(0,1fr);gap:12px}
body.kiosk-mode #layout aside .panel{margin:0;display:flex;flex-direction:column;min-height:0;background:#0f141c;border:1px solid #1f2630;border-radius:10px;padding:12px}
body.kiosk-mode #layout aside .panel h2{margin:0 0 8px;font-size:16px}
body.kiosk-mode #layout aside .panel .panel-body{flex:1;min-height:0;display:flex;flex-direction:column;overflow:hidden}
body.kiosk-mode #layout aside .panel .panel-body table{flex:1;overflow:auto;width:100%}
body.kiosk-mode #layout aside .panel .panel-body ul{flex:1;overflow:auto;margin:0;width:100%}
body.kiosk-mode #blocks-table{width:100%;table-layout:fixed}
body.kiosk-mode #blocks td{width:clamp(11ch,25%,14ch)}
body.kiosk-mode #blocks td .cell{min-height:var(--kiosk-block-height);max-height:var(--kiosk-block-height);padding:var(--kiosk-entry-padding) 0;gap:2px}
body.kiosk-mode #blocks-grid .blocks-grid-table{gap:10px}
body.kiosk-mode #blocks-grid .cell{min-height:var(--kiosk-block-height);padding:var(--kiosk-entry-padding) 10px}
body.kiosk-mode #blocks-grid .cell .bus{font-size:20px}
body.kiosk-mode #blocks-grid .cell .drivers{font-size:11px}
body.kiosk-mode #extra-buses{grid-template-columns:repeat(auto-fill,minmax(11ch,1fr));grid-auto-rows:auto;gap:6px}
body.kiosk-mode #extra-buses li{display:flex;align-items:center;justify-content:center;min-height:calc(1.2em + 2*var(--kiosk-entry-padding));padding:var(--kiosk-entry-padding) calc(var(--kiosk-entry-padding)*1.5)}
body.kiosk-mode .downed-embed-frame{height:70vh}
body.kiosk-mode iframe#map-frame{flex:1;border-left:1px solid #1f2630}
body.kiosk-mode .credit{margin-top:auto;padding:8px 12px}
body.cyberpunk.kiosk-mode #layout aside .panel{background:rgba(3,18,28,.92);border-color:rgba(117,247,255,.35);box-shadow:0 0 18px rgba(0,255,255,.18)}
body.cyberpunk.kiosk-mode #layout aside .panel h2{color:#ff80ff}
@media(max-width:600px){
  #layout{flex-direction:column}
  #layout aside{border-left:none !important;border-top:1px solid #1f2630}
}
@media(max-width:768px){
  body{flex-direction:column;align-items:stretch;height:auto;min-height:100vh;overflow:auto}
  #splitter{display:none}
  #left{
    order:1;
    flex:1 1 auto!important;
    min-height:0;
    width:100%!important;
    max-width:none!important;
  }
  iframe#map-frame{
    order:0;
    width:100%;
    flex:none;
    min-width:0;
    height:320px!important;
    min-height:320px;
    max-height:360px;
    border-left:none;
    border-bottom:1px solid #1f2630;
  }
  #layout{flex-direction:column}
  #layout aside{border-left:none !important;border-top:1px solid #1f2630;padding:12px 12px 24px !important}
}
.credit{position:absolute;bottom:8px;right:8px;font-size:12px;color:var(--muted,#9fb0c9)}

body.lcars{background:#0C0C12;color:#E0E0E0;font-family:'Antonio','FGDC',system-ui;letter-spacing:.08em;text-transform:uppercase;gap:32px;padding:32px;align-items:stretch;transition:background-color .5s ease,color .5s ease}
body.lcars *{font-family:'Antonio','FGDC',system-ui;letter-spacing:.08em;text-transform:inherit}
body.lcars #left,body.lcars iframe#map-frame{position:relative;z-index:1}
body.lcars #left{background:#0C0C12;border:4px solid #66CCCC;border-radius:40px;padding:0 0 56px 0;overflow:hidden;transition:border-color .45s ease}
body.lcars #left::before{content:"";position:absolute;top:120px;left:0;width:26px;height:calc(100% - 200px);background:#66CCCC;border-radius:0 22px 22px 0;pointer-events:none}
body.lcars #left::after{content:"";position:absolute;top:40px;right:-110px;width:320px;height:220px;background:#CC6699;border-radius:160px 0 0 160px;transform:rotate(-6deg);pointer-events:none}
body.lcars header{background:#0C0C12;padding:32px 48px 20px;border-bottom:none;position:relative;margin:0 0 24px;align-items:flex-end;gap:28px;transition:background-color .45s ease,color .45s ease}
body.lcars header::before{content:"";position:absolute;left:0;top:18px;bottom:-36px;width:150px;background:#FF9966;border-radius:0 36px 36px 0;pointer-events:none}
body.lcars header::after{content:"";position:absolute;left:150px;right:120px;bottom:-36px;height:28px;background:#FFCC66;border-radius:0 0 32px 32px;pointer-events:none}
body.lcars header h1{font-size:30px!important;margin:0!important;color:#E0E0E0;padding-left:180px;position:relative;z-index:1;letter-spacing:.16em;line-height:1.1}
body.lcars #controls{margin-left:auto;position:static;padding-right:0;display:flex;flex-wrap:wrap;gap:18px;justify-content:flex-end;z-index:1}
body.lcars #controls label{display:flex;flex-direction:column;gap:6px;font-size:12px;color:#FFCC66}
body.lcars #controls select{order:2}
body.lcars select{background:#0C0C12;color:#E0E0E0;border:3px solid #FF9966;border-radius:28px;padding:12px 18px;letter-spacing:.08em;text-transform:uppercase;transition:border-color .4s ease,color .4s ease,background-color .4s ease}
body.lcars select:focus{outline:none;border-color:#FFCC66}
body.lcars option{background:#0C0C12;color:#E0E0E0}
body.lcars #layout{padding:0 48px 36px;gap:32px}
body.lcars aside{padding:0 28px 28px 28px!important;border-left:none!important;display:grid;gap:28px}
body.lcars .panel{background:#0C0C12;border:3px solid #66CCCC;border-radius:36px;padding-top:20px;overflow:hidden;position:relative;transition:transform .5s ease,border-color .5s ease}
body.lcars .panel::before{content:"";position:absolute;top:0;left:0;right:0;height:18px;background:#FF9966;pointer-events:none}
body.lcars .panel::after{content:"";position:absolute;bottom:0;right:0;width:32%;height:16px;background:#CC6699;border-radius:16px 0 0 0;pointer-events:none}
body.lcars .panel:hover{transform:translateX(6px)}
body.lcars h2{margin:0;padding:26px 32px 0;font-size:16px;letter-spacing:.14em;color:#FFCC66}
body.lcars .panel-body{padding:20px 32px 28px}
body.lcars table{border-collapse:separate;border-spacing:0;width:100%}
body.lcars th,body.lcars td{border-bottom:1px solid #66CCCC;padding:10px 0;text-align:left;color:#E0E0E0}
body.lcars th{font-size:12px;color:#FFCC66}
body.lcars tbody tr:last-child td{border-bottom:none}
body.lcars tbody tr{transition:background-color .45s ease,transform .45s ease}
body.lcars tbody tr:hover{background:rgba(255,204,102,.16);transform:translateX(4px)}
body.lcars #blocks td .cell{border-radius:20px;padding:10px 0;min-height:3.1em;max-height:3.1em}
body.lcars #extra-buses{gap:12px}
body.lcars #extra-buses li{background:#0C0C12;border:3px solid #FF9966;border-radius:30px;padding:12px 10px;color:#E0E0E0;transition:border-color .45s ease,transform .45s ease}
body.lcars #extra-buses li:hover{transform:translateY(-2px);border-color:#FFCC66}
body.lcars .hint{color:#B3A6C9}
body.lcars .pill{background:#CC6699;border:3px solid #FF9966;color:#0C0C12;border-radius:32px;padding:6px 14px}
body.lcars .pill .dot{background:#FFCC66}
body.lcars .ok{color:#FFCC66}
body.lcars .ok .dot{background:#FFCC66}
body.lcars .warn{color:#FF9966}
body.lcars .warn .dot{background:#FF9966}
body.lcars .bad{color:#FF3300}
body.lcars .bad .dot{background:#FF3300}
body.lcars .banner{position:static;border-radius:28px;padding:10px 18px;border:none}
body.lcars .banner.info{background:#66CCCC;color:#0C0C12}
body.lcars .banner.error{background:#FF3300;color:#0C0C12}
body.lcars iframe#map-frame{border:none!important;border-left:none!important;border-radius:40px!important;border:4px solid #FF9966!important;height:100%;margin:0;transition:border-color .45s ease}
body.lcars .credit{right:48px;color:#B3A6C9;letter-spacing:.14em}
body.lcars .mono{font-family:'Antonio','FGDC',system-ui}
body.lcars .lcars-overlay{position:fixed;inset:0;pointer-events:none;z-index:0}
body.lcars .lcars-rail{position:absolute;display:flex;transition:opacity .5s ease}
body.lcars .lcars-rail-left{left:36px;top:140px;bottom:90px;flex-direction:column;gap:18px}
body.lcars .lcars-node{display:block;width:160px;border-radius:0 44px 44px 0;height:58px}
body.lcars .lcars-node.primary{background:#FF9966}
body.lcars .lcars-node.secondary{background:#CC6699;height:72px}
body.lcars .lcars-node.highlight{background:#FFCC66;height:40px;margin-top:auto;border-radius:0 40px 40px 0}
body.lcars .lcars-rail-top{top:36px;right:56px;flex-direction:row;gap:18px;align-items:flex-end}
body.lcars .lcars-strip{display:block;height:34px;border-radius:34px;opacity:.55;transition:opacity .5s ease,transform .5s ease}
body.lcars .lcars-strip.primary{background:#FF9966;width:220px}
body.lcars .lcars-strip.secondary{background:#CC6699;width:160px}
body.lcars .lcars-strip.highlight{background:#FFCC66;width:120px;height:26px}
body.lcars .lcars-strip.alert{background:#FF3300;width:72px;height:20px}
body.lcars .lcars-strip.is-active{opacity:1;transform:translateY(-6px)}
body.lcars .lcars-rail-top::after{content:"";display:block;width:46px;height:180px;background:#66CCCC;border-radius:46px 46px 0 46px;pointer-events:none}
body.lcars .lcars-swoop{position:absolute;right:-60px;bottom:-80px;width:420px;height:320px;background:#CC6699;border-radius:60% 0 0 60%;transform:rotate(-12deg);opacity:.35;pointer-events:none}
body.lcars.kiosk-mode #layout{padding:0 28px 32px}
body.lcars.kiosk-mode aside{grid-template-columns:repeat(auto-fit,minmax(260px,1fr));grid-auto-rows:minmax(0,1fr)}
body.lcars.kiosk-mode .panel{height:100%}

body.cyberpunk{background:radial-gradient(circle at 20% 20%,rgba(0,255,255,.18),transparent 55%),radial-gradient(circle at 80% 35%,rgba(255,0,183,.18),transparent 60%),#02010a;color:#d9fbff;text-shadow:0 0 12px rgba(0,255,255,.35);position:relative;overflow:hidden;font-family:'Courier Prime','Fira Code','Source Code Pro','IBM Plex Mono','Lucida Console','Courier New',monospace}
body.cyberpunk::before{content:"";position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(0,255,255,.04)0,rgba(0,255,255,.04)2px,transparent 2px,transparent 4px);mix-blend-mode:screen;pointer-events:none;animation:scanlines 8s linear infinite}
body.cyberpunk::after{content:"";position:fixed;inset:-40px;background:radial-gradient(circle at 15% 20%,rgba(0,255,255,.24),transparent 55%),radial-gradient(circle at 80% 15%,rgba(255,0,183,.28),transparent 50%),radial-gradient(circle at 70% 80%,rgba(0,255,170,.22),transparent 60%);filter:blur(18px);opacity:.7;pointer-events:none;z-index:-1}
body.cyberpunk .cyberpunk-hud-lines{position:fixed;inset:0;background:linear-gradient(120deg,rgba(117,247,255,.08)0,rgba(0,0,0,0)40%),linear-gradient(-120deg,rgba(255,0,183,.12)0,rgba(0,0,0,0)45%);mix-blend-mode:screen;pointer-events:none;animation:hudSweep 18s ease-in-out infinite alternate;opacity:.45;z-index:-2}
body.cyberpunk header{background:rgba(3,11,20,.92);border-bottom-color:rgba(0,255,255,.35);box-shadow:0 0 25px rgba(0,255,255,.2)}
body.cyberpunk header h1{letter-spacing:.08em;text-transform:uppercase;color:#75f7ff}
body.cyberpunk #controls{padding-right:230px}
body.cyberpunk select{background:rgba(4,16,26,.9);border:1px solid rgba(117,247,255,.6);color:#9dfcff;box-shadow:0 0 12px rgba(0,255,255,.3);text-shadow:none}
body.cyberpunk .chip{background:rgba(2,16,24,.75);border-color:rgba(255,0,183,.4);color:#9ad7ff;box-shadow:0 0 14px rgba(0,255,255,.2)}
body.cyberpunk table{background:rgba(2,12,22,.65);border:1px solid rgba(0,255,255,.18);box-shadow:0 15px 40px rgba(0,0,0,.35);backdrop-filter:blur(6px)}
body.cyberpunk th,body.cyberpunk td{border-color:rgba(0,255,255,.12)}
body.cyberpunk th{color:#76f7ff;text-transform:uppercase;letter-spacing:.12em;font-size:12px;background:linear-gradient(90deg,rgba(0,255,255,.15),rgba(255,0,183,.08))}
body.cyberpunk tbody tr:hover{background:rgba(0,255,255,.08)}
body.cyberpunk .pill{background:rgba(3,18,28,.95);border-color:rgba(117,247,255,.35);box-shadow:0 0 14px rgba(0,255,255,.25)}
body.cyberpunk .pill .dot{box-shadow:0 0 12px currentColor}
body.cyberpunk .ok{color:#4bffca}
body.cyberpunk .warn{color:#ffe680}
body.cyberpunk .bad{color:#ff8bb7}
body.cyberpunk .hint{color:#6aa9ff}
body.cyberpunk aside{border-left:1px solid rgba(255,0,183,.3)}
body.cyberpunk h2{color:#ff80ff;text-transform:uppercase;letter-spacing:.14em;font-size:15px;text-shadow:0 0 10px rgba(255,0,183,.4)}
body.cyberpunk #extra-buses li{background:rgba(3,15,27,.9);border-color:rgba(117,247,255,.24);color:#a9f6ff}
body.cyberpunk #map-frame{filter:contrast(1.2) saturate(1.45) hue-rotate(140deg) drop-shadow(-10px 0 25px rgba(0,255,255,.3));border-left:1px solid rgba(0,255,255,.35)}
body.cyberpunk .credit{color:#57caff;text-shadow:0 0 10px rgba(0,255,255,.4)}
body.cyberpunk .cyberpunk-grid{position:fixed;inset:-80px;background:linear-gradient(0deg,rgba(0,255,255,.09)1px,transparent 1px),linear-gradient(90deg,rgba(255,0,183,.09)1px,transparent 1px);background-size:120px 120px;mix-blend-mode:screen;opacity:.4;animation:gridDrift 28s linear infinite;pointer-events:none;z-index:-3}
body.cyberpunk .cyberpunk-vignette{position:fixed;inset:-160px;background:radial-gradient(circle at center,transparent 40%,rgba(0,0,0,.85)92%);pointer-events:none;z-index:-1}
body.cyberpunk .cyberpunk-corners{position:fixed;inset:0;pointer-events:none;z-index:3}
body.cyberpunk .corner{position:absolute;width:70px;height:70px;border:2px solid rgba(0,255,255,.45);box-shadow:0 0 20px rgba(0,255,255,.45);animation:pulseGlow 5s ease-in-out infinite}
body.cyberpunk .corner::after{content:"";position:absolute;background:rgba(255,0,183,.45);box-shadow:0 0 18px rgba(255,0,183,.7)}
body.cyberpunk .corner-tl{top:18px;left:18px;border-right:none;border-bottom:none;border-radius:12px 0 0 0}
body.cyberpunk .corner-tl::after{width:12px;height:2px;right:-6px;top:10px}
body.cyberpunk .corner-tr{top:18px;right:18px;border-left:none;border-bottom:none;border-radius:0 12px 0 0}
body.cyberpunk .corner-tr::after{width:2px;height:12px;bottom:-6px;left:10px}
body.cyberpunk .corner-bl{bottom:18px;left:18px;border-right:none;border-top:none;border-radius:0 0 0 12px}
body.cyberpunk .corner-bl::after{width:2px;height:12px;top:-6px;right:10px}
body.cyberpunk .corner-br{bottom:18px;right:18px;border-left:none;border-top:none;border-radius:0 0 12px 0}
body.cyberpunk .corner-br::after{width:12px;height:2px;left:-6px;bottom:10px}
body.cyberpunk .cyberpunk-ticker{position:absolute;left:18px;right:18px;bottom:12px;padding:10px 16px;border:1px solid rgba(0,255,255,.25);background:rgba(2,16,28,.92);box-shadow:0 0 26px rgba(0,255,255,.2);display:flex;align-items:center;gap:16px;font-size:13px;letter-spacing:.18em;text-transform:uppercase;overflow:hidden}
body.cyberpunk .ticker-label{color:#ff7afc;font-weight:bold}
body.cyberpunk .ticker-marquee{flex:1;display:flex;gap:48px;animation:tickerScroll 36s linear infinite}
body.cyberpunk .ticker-marquee span{white-space:nowrap;color:#9dfcff;text-shadow:0 0 12px rgba(0,255,255,.4)}
body.cyberpunk .cyberpunk-hud{margin:0 18px 18px;padding:18px;border:1px solid rgba(0,255,255,.18);background:rgba(4,20,32,.78);backdrop-filter:blur(12px);box-shadow:0 0 38px rgba(0,255,255,.2);display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;border-radius:14px;position:relative;overflow:hidden}
body.cyberpunk .cyberpunk-hud::before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,rgba(0,255,255,.08),rgba(255,0,183,.05));opacity:.65;pointer-events:none}
body.cyberpunk .cyberpunk-hud::after{content:"";position:absolute;inset:12px;border:1px solid rgba(0,255,255,.12);border-radius:10px;pointer-events:none;opacity:.6;box-shadow:0 0 18px rgba(0,255,255,.25)}
body.cyberpunk .hud-card{position:relative;padding:14px;border:1px solid rgba(117,247,255,.28);border-radius:10px;background:rgba(2,14,28,.88);box-shadow:inset 0 0 22px rgba(0,255,255,.15);display:flex;flex-direction:column;gap:6px;font-size:13px;letter-spacing:.08em;text-transform:uppercase}
body.cyberpunk .hud-card::before{content:"";position:absolute;inset:-1px;border-radius:10px;border:1px solid rgba(255,0,183,.18);opacity:.5;filter:blur(0);mix-blend-mode:screen}
body.cyberpunk .hud-card strong{font-size:22px;line-height:1;color:#7cfbff;text-shadow:0 0 18px rgba(0,255,255,.45)}
body.cyberpunk .hud-card span{color:#ff90ff;font-size:11px;letter-spacing:.16em}
body.cyberpunk .hud-card .hud-trend{font-size:12px;color:#a0ffba;letter-spacing:.12em}
body.cyberpunk .hud-card .hud-trend.warn{color:#ffe680}
body.cyberpunk .hud-card .hud-trend.bad{color:#ff7f9d}
body.cyberpunk .hud-card .hud-graph{height:42px;display:flex;align-items:flex-end;gap:4px}
body.cyberpunk .hud-card .hud-bar{flex:1;background:linear-gradient(180deg,rgba(0,255,255,.7),rgba(0,255,170,.2));border-radius:3px;box-shadow:0 0 12px rgba(0,255,255,.35);animation:holoPulse 4.2s ease-in-out infinite}
body.cyberpunk .hud-card .hud-bar:nth-child(odd){background:linear-gradient(180deg,rgba(255,0,183,.7),rgba(0,0,0,.2))}
body.cyberpunk .cyberpunk-orb{position:fixed;width:360px;height:360px;border:1px solid rgba(0,255,255,.2);border-radius:50%;top:12%;right:-120px;background:radial-gradient(circle at 40% 35%,rgba(0,255,255,.45),rgba(0,0,0,0)70%);box-shadow:0 0 120px rgba(0,255,255,.35);filter:blur(0);opacity:.6;pointer-events:none;animation:orbDrift 26s ease-in-out infinite;mix-blend-mode:screen;z-index:-2}
body.cyberpunk .cyberpunk-orb::after{content:"";position:absolute;inset:18%;border:1px solid rgba(255,0,183,.28);border-radius:50%;box-shadow:0 0 40px rgba(255,0,183,.45);animation:orbPulse 7s ease-in-out infinite}
body.cyberpunk .cyberpunk-datafall{position:fixed;inset:0;pointer-events:none;mix-blend-mode:screen;opacity:.55;z-index:-2}
body.cyberpunk .cyberpunk-holo-badge{position:absolute;top:60px;right:40px;padding:12px 20px;border:1px solid rgba(0,255,255,.45);background:rgba(2,18,32,.85);box-shadow:0 0 18px rgba(0,255,255,.35);text-transform:uppercase;letter-spacing:.24em;font-size:11px;color:#92f8ff;display:flex;align-items:center;gap:12px;border-radius:999px;backdrop-filter:blur(6px);animation:hudPulse 5s ease-in-out infinite}
body.cyberpunk .cyberpunk-holo-badge::before{content:"◎";color:#ff80ff;text-shadow:0 0 12px rgba(255,0,183,.6)}
body.cyberpunk .cyberpunk-holo-badge span{color:#0ff;text-shadow:0 0 10px rgba(0,255,255,.45)}
body.cyberpunk #left{background:rgba(2,10,22,.82);backdrop-filter:blur(12px);box-shadow:0 0 45px rgba(0,255,255,.18);border-right:1px solid rgba(255,0,183,.25);padding-bottom:70px}
body.cyberpunk header{position:sticky;top:0;z-index:5}
body.cyberpunk header::after{content:"";position:absolute;left:0;right:0;bottom:-1px;height:2px;background:linear-gradient(90deg,rgba(0,255,255,.6),rgba(255,0,183,.6),rgba(0,255,170,.6));box-shadow:0 0 12px rgba(0,255,255,.7);opacity:.85}
body.cyberpunk main,body.cyberpunk aside{position:relative}
body.cyberpunk main::before,body.cyberpunk aside::before{content:"";position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,rgba(0,255,255,.15),rgba(255,0,183,.1),transparent);opacity:.8}
body.cyberpunk #layout{position:relative}
body.cyberpunk #layout::after{content:"";position:absolute;inset:12px;border:1px solid rgba(0,255,255,.1);border-radius:12px;pointer-events:none;box-shadow:0 0 22px rgba(0,255,255,.14)}
body.cyberpunk table tbody tr{position:relative;transition:background .3s ease,transform .3s ease}
body.cyberpunk table tbody tr::after{content:"";position:absolute;inset:0;border:1px solid rgba(0,255,255,.05);border-radius:6px;pointer-events:none;opacity:0;transition:opacity .3s ease}
body.cyberpunk table tbody tr:hover{background:rgba(0,255,255,.1);transform:translateY(-1px)}
body.cyberpunk table tbody tr:hover::after{opacity:1}
body.cyberpunk select:focus{outline:none;box-shadow:0 0 0 2px rgba(0,255,255,.25)}
body.cyberpunk .banner{color:#9dfcff;background:rgba(3,18,28,.92);border-color:rgba(255,0,183,.35);box-shadow:0 0 16px rgba(255,0,183,.2)}
body.cyberpunk iframe#map-frame{box-shadow:inset 0 0 35px rgba(0,0,0,.6),0 0 45px rgba(0,255,255,.18);position:relative;z-index:1}
body.cyberpunk iframe#map-frame::backdrop{background:rgba(0,0,0,.6)}

body.cyberpunk .cyberpunk-runes{position:fixed;bottom:30px;right:32px;display:flex;gap:12px;pointer-events:none;z-index:4}
body.cyberpunk .cyberpunk-rune{padding:10px 14px;border:1px solid rgba(0,255,255,.3);border-radius:10px;background:rgba(2,16,28,.88);color:#9dfcff;font-size:12px;letter-spacing:.32em;text-transform:uppercase;box-shadow:0 0 16px rgba(0,255,255,.25);animation:runeBlink 6s linear infinite}
body.cyberpunk .cyberpunk-rune:nth-child(2){animation-delay:1.4s}
body.cyberpunk .cyberpunk-rune:nth-child(3){animation-delay:2.8s}

@keyframes gridDrift{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(-60px,-60px,0)}}
@keyframes scanlines{0%{transform:translateY(0)}100%{transform:translateY(-4px)}}
@keyframes bootGlitch{0%,100%{transform:translate(0)}20%{transform:translate(-2px,1px)}40%{transform:translate(3px,-2px)}60%{transform:translate(-1px,2px)}80%{transform:translate(2px,-1px)}}
@keyframes pulseGlow{0%,100%{opacity:.65;filter:drop-shadow(0 0 10px rgba(0,255,255,.4))}50%{opacity:1;filter:drop-shadow(0 0 22px rgba(0,255,255,.75))}}
@keyframes hudSweep{0%{opacity:.2;transform:translateY(-6%)}100%{opacity:.6;transform:translateY(6%)} }
@keyframes holoPulse{0%,100%{transform:scaleY(.75);opacity:.7}50%{transform:scaleY(1);opacity:1}}
@keyframes orbDrift{0%{transform:translate3d(0,0,0) rotate(0deg)}50%{transform:translate3d(-30px,10px,0) rotate(8deg)}100%{transform:translate3d(10px,-20px,0) rotate(-6deg)}}
@keyframes orbPulse{0%,100%{transform:scale(.85);opacity:.4}50%{transform:scale(1);opacity:1}}
@keyframes hudPulse{0%,100%{box-shadow:0 0 16px rgba(0,255,255,.35)}50%{box-shadow:0 0 32px rgba(255,0,183,.45)}}
@keyframes runeBlink{0%,40%,100%{opacity:.85}50%{opacity:.35}}
@keyframes tickerScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

#cli-preroll{position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at center,rgba(0,8,6,.96)0%,rgba(0,4,2,.98)55%,rgba(0,0,0,.99)100%);color:#9dfcb1;font-family:'Courier Prime','Fira Code','Source Code Pro','IBM Plex Mono','Lucida Console','Courier New',monospace;letter-spacing:.04em;opacity:0;visibility:hidden;transition:opacity var(--cli-fade-duration,.42s) ease,visibility var(--cli-fade-duration,.42s) ease}
#cli-preroll.visible{opacity:1;visibility:visible}
#cli-preroll.fade-out{opacity:0;visibility:hidden}
#cli-preroll .cli-terminal{position:relative;width:min(640px,90vw);padding:32px 36px;border:1px solid rgba(138,247,155,.35);background:rgba(0,10,4,.9);box-shadow:0 0 40px rgba(0,255,120,.25);line-height:1.5;overflow:hidden}
#cli-preroll .cli-terminal::before{content:"";position:absolute;inset:-40%;background:radial-gradient(circle at center,rgba(0,255,120,.18),transparent 62%);opacity:.45;filter:blur(18px);animation:cliScan 7s ease-in-out infinite alternate;pointer-events:none}
#cli-preroll .cli-terminal::after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(0deg,rgba(0,255,120,.08)0,rgba(0,255,120,.08)1px,transparent 1px,transparent 3px);opacity:.22;pointer-events:none}
#cli-preroll .cli-content{position:relative;z-index:1;display:flex;flex-direction:column;gap:6px;font-size:15px}
#cli-preroll .cli-line{white-space:pre;letter-spacing:.03em;color:#9dfcb1}
#cli-preroll .cli-line.cli-banner{color:#78f59d}
#cli-preroll .cli-line.cli-op{color:#b9ffcc}
#cli-preroll .cli-line.cli-command{color:#d3ffe1}
#cli-preroll .cli-line.cli-command .cli-prompt{margin-right:6px;color:#78f59d}
#cli-preroll .cli-line.typing::after,#cli-preroll .cli-line.cursor-hold::after{content:'█';margin-left:4px;animation:cliCursor 1s steps(1,end) infinite}
#cli-preroll .cli-footer{position:relative;z-index:1;margin-top:18px;color:rgba(157,252,177,.75);font-size:12px;letter-spacing:.18em;text-transform:uppercase}
#cli-preroll .cli-footer .cli-key{display:inline-block;margin:0 4px;padding:2px 6px;border:1px solid rgba(138,247,155,.35);border-radius:4px;background:rgba(6,26,12,.65);font-size:11px;letter-spacing:.16em}
@keyframes cliCursor{0%,45%{opacity:1}55%,100%{opacity:0}}
@keyframes cliScan{0%{transform:translateY(-6%)}100%{transform:translateY(6%)} }
@media (prefers-reduced-motion:reduce){
  #cli-preroll{transition:none}
  #cli-preroll .cli-terminal::before{animation:none}
}
#boot-overlay{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at center,rgba(0,8,16,.95)0%,rgba(0,0,0,.98)60%,rgba(0,0,0,.98)100%);color:#9dfcff;font-family:'Courier Prime','Fira Code','Source Code Pro','IBM Plex Mono','Lucida Console','Courier New',monospace;letter-spacing:.06em;text-transform:uppercase;transition:opacity .9s ease,visibility .9s ease;box-shadow:inset 0 0 80px rgba(0,255,255,.2);overflow:hidden}
#boot-overlay::before{content:"";position:absolute;inset:0;background:linear-gradient(120deg,rgba(0,255,255,.08),rgba(255,0,183,.05));mix-blend-mode:screen;animation:scanlines 6s linear infinite;opacity:.6}
#boot-overlay::after{content:"";position:absolute;inset:-50%;background:conic-gradient(from 90deg,rgba(0,255,255,.12),rgba(255,0,183,.08),rgba(0,255,170,.12),rgba(0,255,255,.12));animation:bootGlitch 3s linear infinite;opacity:.15;filter:blur(40px)}
#boot-overlay.boot-complete{opacity:0;visibility:hidden;pointer-events:none}
#boot-overlay .boot-inner{position:relative;z-index:1;width:min(640px,90vw);padding:40px 38px 34px;border:1px solid rgba(0,255,255,.25);box-shadow:0 0 40px rgba(0,255,255,.35);background:rgba(0,6,12,.85);backdrop-filter:blur(12px)}
#boot-overlay .boot-title{font-size:24px;color:#75f7ff;margin-bottom:24px;display:flex;align-items:center;gap:12px;text-shadow:0 0 20px rgba(0,255,255,.45);position:relative}
#boot-overlay .boot-title::after{content:"// CYBER DISPATCH";font-size:12px;color:#ff7afc;letter-spacing:.3em}
#boot-overlay .boot-title.glitch{animation:bootGlitch .4s steps(2,end)}
#boot-overlay .boot-progress{position:relative;height:12px;border:1px solid rgba(0,255,255,.4);background:rgba(0,0,0,.6);margin-bottom:12px;overflow:hidden}
#boot-overlay .boot-progress-fill{position:absolute;inset:0;width:0;background:linear-gradient(90deg,rgba(0,255,255,.8),rgba(255,0,183,.9));box-shadow:0 0 18px rgba(0,255,255,.6)}
#boot-overlay .boot-progress-label{display:flex;justify-content:space-between;font-size:12px;color:#57caff;margin-bottom:14px}
#boot-overlay .boot-log{height:180px;overflow:hidden;background:rgba(0,10,18,.9);border:1px solid rgba(0,255,255,.2);padding:16px;box-shadow:inset 0 0 14px rgba(0,255,255,.2);font-size:13px;line-height:1.6;display:flex;flex-direction:column;gap:6px}
#boot-overlay .boot-line{opacity:0;transform:translateY(8px);animation:fadeInUp .4s ease forwards}
#boot-overlay .boot-footer{margin-top:18px;font-size:11px;color:rgba(117,247,255,.7);letter-spacing:.3em;text-align:right}

@keyframes fadeInUp{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:translateY(0)}}
 </style>
<body data-hg-nav-requires-auth="true">
<div id="left" style="flex:1;position:relative">
<header>
  <div id="controls">
    <label for="block-layout-select" class="control-field">
      <span>Layout</span>
      <select id="block-layout-select" aria-label="Block layout" disabled>
        <option value="">Loading layouts…</option>
      </select>
    </label>
    <button id="center-map-button" type="button">Center Map</button>
    <div id="duty-roster" aria-live="polite">
      <div class="duty-line duty-empty" id="sup-duty-line">
        <span class="duty-title">SUP ON DUTY</span>
        <span class="duty-name" id="sup-duty-name">—</span>
      </div>
      <div class="duty-line duty-empty" id="dispatch-duty-line">
        <span class="duty-title">DISPATCHER ON DUTY</span>
        <span class="duty-name" id="dispatch-duty-name">—</span>
      </div>
    </div>
    <div id="banner" class="banner info"></div>
  </div>
</header>
<div id="layout">
  <aside style="flex:1;padding:0 12px 16px;border-left:1px solid #1f2630">
    <section class="panel">
      <h2>Current Block Assignments</h2>
      <div class="panel-body">
        <div id="blocks-grid" class="blocks-grid">
          <div class="blocks-grid-status hint">Loading…</div>
          <div class="blocks-grid-table" hidden></div>
        </div>
      </div>
    </section>
    <section class="panel">
      <h2>Extra Buses</h2>
      <div class="panel-body">
        <ul id="extra-buses"><li class="hint">Loading…</li></ul>
      </div>
    </section>
    <section class="panel downed-panel">
      <h2>Downed Buses</h2>
      <div class="panel-body">
        <div class="downed-embed-wrapper">
          <iframe
            title="Downed buses overview"
            src="/downed?embedded=true"
            loading="lazy"
            class="downed-embed-frame"
          ></iframe>
        </div>
      </div>
    </section>
  </aside>
</div>
</div>
<div id="splitter" role="separator" aria-orientation="vertical" aria-label="Resize panels"></div>
<iframe id="map-frame" data-src="/testmap?dispatcher=true" style="flex:1;height:100%"></iframe>
<script>
const $ = s => document.querySelector(s);
const DOWNED_ENDPOINT = '/v1/dispatcher/downed_buses';
const DOWNED_REFRESH_MS = 60000;
const DOWNED_SUFFIXES = new Set(['12','31','32']);
const OPS_STATUS_VALUES = new Set(['DOWNED','LIMITED','COSMETIC','COMFORT']);
const SHOP_STATUS_VALUES = new Set(['DOWN','UP','USABLE']);
const STATUS_LABELS = {DOWNED:'Downed',LIMITED:'Limited',COSMETIC:'Cosmetic',COMFORT:'Comfort',DOWN:'Down',UP:'Up',USABLE:'Usable'};
const STATUS_CLASSES = {
  DOWNED:'downed',
  DOWN:'down',
  LIMITED:'hold',
  COSMETIC:'cosmetic',
  COMFORT:'comfort',
  UP:'up',
  USABLE:'usable'
};

const urlParams = new URLSearchParams(window.location.search);
const LCARS_ENABLED = urlParams.get('lcars') === 'true';
const CYBERPUNK_ENABLED = !LCARS_ENABLED && urlParams.get('cyberpunk') === 'true';
const KIOSK_MODE = urlParams.has('kioskMode');
let dispatcherSecretLabel = null;

function isHowellSecret(label){
  return typeof label==='string' && label.trim().toLowerCase()==='howell';
}

function isAshleySecret(label){
  return typeof label==='string' && label.trim().toLowerCase()==='ashley';
}

function shouldUseFootballLayout(label){
  return isHowellSecret(label) || isAshleySecret(label);
}

function applyDispatcherSecretMode(){
  if(isHowellSecret(dispatcherSecretLabel)){
    applyHowellMode();
  }
}

function applyHowellMode(){
  if(!document.body) return;
  document.body.classList.add('howell-mode');
  applyHowellFontOverride();
}

function applyHowellFontOverride(){
  if(applyHowellFontOverride.done) return;
  const styleEl=document.getElementById('dispatcher-style');
  if(styleEl){
    let text=styleEl.textContent||'';
    let updated=false;
    if(text.includes('FGDC.ttf')){
      text=text.replace(/FGDC\.ttf/g,'centurygothic.ttf');
      updated=true;
    }
    if(!text.includes('FGDC-Nav')){
      const navFontCss=`\n@font-face{font-family:'FGDC-Nav';src:url('FGDC.ttf') format('truetype');font-display:swap;}\nbody.howell-mode #hg-nav,body.howell-mode #hg-nav *,body.howell-mode #hg-nav *::before,body.howell-mode #hg-nav *::after{font-family:'FGDC-Nav' !important;}`;
      text+=navFontCss;
      updated=true;
    }
    if(updated){
      styleEl.textContent=text;
    }
  }
  applyHowellFontOverride.done=true;
}
applyHowellFontOverride.done=false;
const leftPane = document.getElementById('left');
const mapFrame = document.getElementById('map-frame');
const mobileLayoutQuery = window.matchMedia('(max-width: 768px)');
const isMobileLayout = () => mobileLayoutQuery.matches;
const DEFAULT_MAP_FRAME_SRC = '/testmap?dispatcher=true';
let mapFramePendingSrc = DEFAULT_MAP_FRAME_SRC;

function setMapFramePendingSource(nextSrc) {
  mapFramePendingSrc = nextSrc || DEFAULT_MAP_FRAME_SRC;
  if (mapFrame) {
    mapFrame.dataset.src = mapFramePendingSrc;
    if (mapFrame.dataset.loaded === 'true' && mapFrame.src !== mapFramePendingSrc) {
      mapFrame.src = mapFramePendingSrc;
    }
  }
}

function loadMapFrameIfNeeded() {
  if (!mapFrame) return;
  if (mapFrame.dataset.loaded === 'true' && mapFrame.src === mapFramePendingSrc) return;
  mapFrame.src = mapFramePendingSrc;
}

if (mapFrame) {
  const initialSrc = mapFrame.dataset.src || mapFrame.getAttribute('src');
  if (initialSrc) {
    mapFramePendingSrc = initialSrc;
  }
  setMapFramePendingSource(mapFramePendingSrc);
  mapFrame.addEventListener('load', () => {
    mapFrame.dataset.loaded = 'true';
  });
}
function readCookieValue(name){
  if(!name) return '';
  const raw=document.cookie.split(';').map(part=>part.trim()).find(part=>part.startsWith(`${name}=`));
  if(!raw) return '';
  const value=raw.split('=').slice(1).join('=');
  return value?decodeURIComponent(value):'';
}
function writeCookieValue(name,value,{maxAge}={}){
  if(!name) return;
  let cookie=`${name}=${encodeURIComponent(value||'')}; path=/`;
  if(typeof maxAge==='number' && Number.isFinite(maxAge)){
    cookie+=`; max-age=${maxAge}`;
  }
  document.cookie=cookie;
}
function deleteCookieValue(name){
  if(!name) return;
  document.cookie=`${name}=; max-age=0; path=/`;
}
const LEFT_PANE_WIDTH_COOKIE_NAME = 'dispatcherLeftWidth';
window.LEFT_PANE_WIDTH_COOKIE_NAME = LEFT_PANE_WIDTH_COOKIE_NAME;
const splitter = document.getElementById('splitter');
if(leftPane && mapFrame && splitter){
  let isResizing=false;
  let startX=0;
  let startWidth=0;
  let activePointerId=null;
  const LEFT_MIN_WIDTH=260;
  const RIGHT_MIN_WIDTH=320;
  const COOKIE_MAX_AGE=60*60*24*90;
  const getCookie=name=>{
    const raw=document.cookie.split(';').map(part=>part.trim()).find(part=>part.startsWith(`${name}=`))?.split('=')[1]||'';
    return raw?decodeURIComponent(raw):'';
  };
  const setCookie=(name,value)=>{
    document.cookie=`${name}=${encodeURIComponent(value)}; max-age=${COOKIE_MAX_AGE}; path=/`;
  };
  const clampWidth=width=>{
    const bodyWidth=document.body.getBoundingClientRect().width;
    const maxWidth=Math.max(LEFT_MIN_WIDTH,bodyWidth-RIGHT_MIN_WIDTH);
    return Math.min(Math.max(width,LEFT_MIN_WIDTH),maxWidth);
  };
  const applyLeftPaneWidth=({fromResize=false}={})=>{
    if(isMobileLayout()){
      leftPane.style.flex='';
      leftPane.style.width='';
      return;
    }
    if(fromResize){
      const currentWidth=parseFloat(leftPane.style.width);
      if(Number.isNaN(currentWidth)){
        const saved=parseFloat(getCookie(LEFT_PANE_WIDTH_COOKIE_NAME));
        if(Number.isNaN(saved)) return;
        const clampedSaved=clampWidth(saved);
        leftPane.style.flex='0 0 auto';
        leftPane.style.width=`${clampedSaved}px`;
        if(clampedSaved!==saved){
          setCookie(LEFT_PANE_WIDTH_COOKIE_NAME,clampedSaved);
        }
        return;
      }
      const clampedWidth=clampWidth(currentWidth);
      leftPane.style.flex='0 0 auto';
      leftPane.style.width=`${clampedWidth}px`;
      setCookie(LEFT_PANE_WIDTH_COOKIE_NAME,clampedWidth);
      return;
    }
    const savedWidth=parseFloat(getCookie(LEFT_PANE_WIDTH_COOKIE_NAME));
    if(!Number.isNaN(savedWidth)){
      const clampedWidth=clampWidth(savedWidth);
      leftPane.style.flex='0 0 auto';
      leftPane.style.width=`${clampedWidth}px`;
      if(clampedWidth!==savedWidth){
        setCookie(LEFT_PANE_WIDTH_COOKIE_NAME,clampedWidth);
      }
    }else{
      leftPane.style.flex='';
      leftPane.style.width='';
    }
  };
  applyLeftPaneWidth();
  if(typeof mobileLayoutQuery.addEventListener==='function'){
    mobileLayoutQuery.addEventListener('change',()=>applyLeftPaneWidth());
  }else if(typeof mobileLayoutQuery.addListener==='function'){
    mobileLayoutQuery.addListener(()=>applyLeftPaneWidth());
  }
  const onPointerMove=event=>{
    if(!isResizing || event.pointerId!==activePointerId || isMobileLayout()) return;
    const delta=event.clientX-startX;
    let newWidth=startWidth+delta;
    newWidth=clampWidth(newWidth);
    leftPane.style.flex='0 0 auto';
    leftPane.style.width=`${newWidth}px`;
  };
  const stopResizing=event=>{
    if(!isResizing || (event && event.pointerId!==activePointerId)) return;
    isResizing=false;
    if(activePointerId!==null){
      try{splitter.releasePointerCapture(activePointerId);}catch(_err){}
    }
    activePointerId=null;
    document.body.classList.remove('resizing');
    const currentWidth=parseFloat(leftPane.style.width);
    if(!Number.isNaN(currentWidth) && !isMobileLayout()){
      setCookie(LEFT_PANE_WIDTH_COOKIE_NAME,clampWidth(currentWidth));
    }
  };
  splitter.addEventListener('pointerdown',event=>{
    if(event.button!==0 || isMobileLayout()) return;
    isResizing=true;
    activePointerId=event.pointerId;
    startX=event.clientX;
    startWidth=leftPane.getBoundingClientRect().width;
    leftPane.style.flex='0 0 auto';
    try{splitter.setPointerCapture(event.pointerId);}catch(_err){}
    document.body.classList.add('resizing');
  });
  splitter.addEventListener('pointermove',onPointerMove);
  splitter.addEventListener('pointerup',stopResizing);
  splitter.addEventListener('pointercancel',stopResizing);
  window.addEventListener('pointerup',stopResizing);
  window.addEventListener('resize',()=>{
    applyLeftPaneWidth({fromResize:true});
  });
}
if (KIOSK_MODE) {
  document.body.classList.add('kiosk-mode');
}
if (LCARS_ENABLED) {
  activateLcarsMode();
} else if (CYBERPUNK_ENABLED) {
  const url = new URL(mapFramePendingSrc, window.location.origin);
  url.pathname = '/radar';
  setMapFramePendingSource(url.pathname + url.search);
  activateCyberpunkMode();
}

const blocksGridEl = document.getElementById('blocks-grid');
const blocksGridTable = blocksGridEl ? blocksGridEl.querySelector('.blocks-grid-table') : null;
const blocksGridStatus = blocksGridEl ? blocksGridEl.querySelector('.blocks-grid-status') : null;
const blockLayoutSelect = document.getElementById('block-layout-select');
const blockLayoutSelectContainer = blockLayoutSelect ? blockLayoutSelect.closest('label') : null;
const centerMapButton = document.getElementById('center-map-button');

const MAP_MESSAGE_SOURCE = 'dispatcher';
const MAP_MESSAGE_TYPES = Object.freeze({
  focusBus: 'dispatcher:focusBus',
  centerMap: 'dispatcher:centerMap'
});
const MAP_RESPONSE_SOURCE = 'testmap';
const MAP_RESPONSE_TYPES = Object.freeze({
  vehicleUnavailable: 'testmap:vehicleUnavailable'
});
let mapBannerRestoreTimeoutId = null;
let mapBannerBaseState = null;
let mapBannerActiveMessage = null;

const BLOCK_LAYOUT_COOKIE_NAME = 'dispatcherBlockLayout';
window.BLOCK_LAYOUT_COOKIE_NAME = BLOCK_LAYOUT_COOKIE_NAME;
const BLOCK_LAYOUT_COOKIE_MAX_AGE = 60*60*24*90;
let blockGridLayoutMap = new Map();
let blockGridAvailableLayouts = [];
let currentBlockGridLayoutId = '';
let latestBlockGridEntries = [];
let latestBlockGridNowMinutes = null;
let latestBlockGridColorMap = null;
let latestBlockGridMessage = null;

function getSavedBlockLayoutPreference(){
  return readCookieValue(BLOCK_LAYOUT_COOKIE_NAME);
}

function saveBlockLayoutPreference(value){
  if(value){
    writeCookieValue(BLOCK_LAYOUT_COOKIE_NAME,value,{maxAge:BLOCK_LAYOUT_COOKIE_MAX_AGE});
  }else{
    deleteCookieValue(BLOCK_LAYOUT_COOKIE_NAME);
  }
}

function determineRequestedBlockLayout(preferredLayoutId){
  const direct=String(preferredLayoutId||'').trim();
  if(direct) return direct;
  const saved=String(getSavedBlockLayoutPreference()||'').trim();
  if(saved) return saved;
  if(shouldUseFootballLayout(dispatcherSecretLabel)){
    return FOOTBALL_BLOCK_LAYOUT_NAME;
  }
  return '';
}

function formatLayoutOptionLabel(layoutId){
  const raw=String(layoutId||'').trim();
  if(!raw || raw.toLowerCase()==='default') return 'Default';
  return raw
    .replace(/[-_]+/g,' ')
    .replace(/\s+/g,' ')
    .trim()
    .replace(/\b\w/g,char=>char.toUpperCase());
}

function updateLayoutSelectOptions(layoutIds,selectedId){
  if(!blockLayoutSelect) return;
  const unique=[];
  const seen=new Set();
  const pushId=id=>{
    const value=String(id||'').trim()||'default';
    if(seen.has(value)) return;
    seen.add(value);
    unique.push(value);
  };
  if(Array.isArray(layoutIds)){
    layoutIds.forEach(id=>pushId(id));
  }
  const selectedValueRaw=String(selectedId||'').trim();
  if(selectedValueRaw){
    pushId(selectedValueRaw);
  }
  if(!unique.length){
    unique.push('default');
  }
  const previousValue=String(blockLayoutSelect.value||'').trim();
  blockLayoutSelect.innerHTML='';
  unique.forEach(id=>{
    const option=document.createElement('option');
    option.value=id;
    option.textContent=formatLayoutOptionLabel(id);
    blockLayoutSelect.appendChild(option);
  });
  const selectedValue=selectedValueRaw&&seen.has(selectedValueRaw)?selectedValueRaw:'';
  const desiredValue=selectedValue || (previousValue && seen.has(previousValue) ? previousValue : '');
  blockLayoutSelect.value=desiredValue || unique[0];
  blockLayoutSelect.disabled=unique.length<=1;
  if(blockLayoutSelectContainer){
    blockLayoutSelectContainer.hidden=false;
  }
  blockLayoutSelect.title = blockLayoutSelect.value ? `Layout: ${blockLayoutSelect.value}` : 'Layout';
}

function reapplyLatestBlockAssignments(){
  if(!blocksGridTable) return;
  if(Array.isArray(latestBlockGridEntries) && latestBlockGridEntries.length){
    updateBlockGrid(latestBlockGridEntries,latestBlockGridNowMinutes||0,{busColorMap:latestBlockGridColorMap});
    latestBlockGridMessage=blocksGridStatus && !blocksGridStatus.hidden?(blocksGridStatus.textContent||''):null;
  }else if(typeof latestBlockGridMessage==='string' && latestBlockGridMessage){
    clearBlockGrid({message:latestBlockGridMessage});
  }else{
    clearBlockGrid({});
    latestBlockGridMessage=null;
  }
}

function showMapTransientBanner(message, kind = 'info', duration = 6000) {
  const bannerEl = document.getElementById('banner');
  if (!bannerEl) return;
  const bannerVisible = bannerEl.style.display !== 'none';
  const hasErrorBanner = bannerVisible && bannerEl.classList.contains('error');
  if (hasErrorBanner && kind !== 'error') {
    return;
  }
  if (!mapBannerBaseState) {
    if (bannerVisible) {
      const bannerKind = bannerEl.classList.contains('error') ? 'error'
        : (bannerEl.classList.contains('info') ? 'info' : '');
      mapBannerBaseState = {
        text: bannerEl.textContent || '',
        kind: bannerKind
      };
    } else {
      mapBannerBaseState = { text: '', kind: kind || 'info' };
    }
  }
  if (mapBannerRestoreTimeoutId) {
    clearTimeout(mapBannerRestoreTimeoutId);
    mapBannerRestoreTimeoutId = null;
  }
  setBanner(message, kind);
  mapBannerActiveMessage = message || '';
  if (duration > 0) {
    mapBannerRestoreTimeoutId = window.setTimeout(() => {
      const bannerNode = document.getElementById('banner');
      if (bannerNode) {
        const currentText = (bannerNode.textContent || '').trim();
        const activeText = (mapBannerActiveMessage || '').trim();
        if (currentText && activeText && currentText !== activeText) {
          mapBannerBaseState = null;
          mapBannerActiveMessage = null;
          mapBannerRestoreTimeoutId = null;
          return;
        }
        if (bannerNode.classList.contains('error') && (!mapBannerBaseState || mapBannerBaseState.kind !== 'error')) {
          mapBannerBaseState = null;
          mapBannerActiveMessage = null;
          mapBannerRestoreTimeoutId = null;
          return;
        }
      }
      if (mapBannerBaseState && mapBannerBaseState.text) {
        setBanner(mapBannerBaseState.text, mapBannerBaseState.kind);
      } else {
        setBanner('', kind);
      }
      mapBannerBaseState = null;
      mapBannerActiveMessage = null;
      mapBannerRestoreTimeoutId = null;
    }, duration);
  }
}

function handleMapVehicleUnavailableMessage(payload) {
  if (!payload || typeof payload !== 'object') return;
  const labels = [];
  if (typeof payload.label === 'string') labels.push(payload.label.trim());
  if (typeof payload.bus === 'string') labels.push(payload.bus.trim());
  if (typeof payload.vehicleId === 'string') labels.push(payload.vehicleId.trim());
  const label = labels.find(text => text) || 'Vehicle';
  const reason = typeof payload.reason === 'string' ? payload.reason.trim() : '';
  const message = reason === 'unresolved'
    ? `${label} does not have a live vehicle on the map right now.`
    : `${label} is not currently visible on the map.`;
  showMapTransientBanner(message, 'info', 6000);
}

function handleMapFrameMessage(event) {
  if (!event || !event.data || typeof event.data !== 'object') return;
  if (event.origin && event.origin !== window.location.origin) return;
  const { source, type } = event.data;
  if (source !== MAP_RESPONSE_SOURCE) return;
  if (type === MAP_RESPONSE_TYPES.vehicleUnavailable) {
    handleMapVehicleUnavailableMessage(event.data);
  }
}

if (typeof window !== 'undefined' && typeof window.addEventListener === 'function') {
  window.addEventListener('message', handleMapFrameMessage);
}

function postMapMessage(message){
  if(!mapFrame || !mapFrame.contentWindow || !message || typeof message!=='object') return;
  const payload=Object.assign({source:MAP_MESSAGE_SOURCE},message);
  try{
    mapFrame.contentWindow.postMessage(payload,window.location.origin);
  }catch(error){
    console.warn('Failed to post message to map frame:',error);
  }
}

if(centerMapButton){
  centerMapButton.addEventListener('click',()=>{
    postMapMessage({type:MAP_MESSAGE_TYPES.centerMap});
  });
}

if(blocksGridTable){
  blocksGridTable.addEventListener('click',event=>{
    const cell=event.target.closest('.cell');
    if(!cell || !blocksGridTable.contains(cell)) return;
    if(cell.dataset.empty==='true') return;
    const vehicleId=cell.dataset.vehicleId||'';
    const bus=cell.dataset.bus||cleanBusIdentifier(cell.querySelector('.bus')?.textContent||'');
    const targetId=vehicleId||bus;
    const displayLabelRaw=(cell.querySelector('.bus')?.textContent||'').trim();
    const displayLabel=displayLabelRaw==='—'?'':displayLabelRaw;
    if(!targetId && !displayLabel) return;
    postMapMessage({type:MAP_MESSAGE_TYPES.focusBus,vehicleId:targetId,bus:bus||'',label:displayLabel});
  });
}

const BLOCK_GRID_ROW_COUNT = 9;
const BLOCK_GRID_LAYOUT_ENDPOINT = '/api/eink-block/layout';
const FOOTBALL_BLOCK_LAYOUT_NAME = 'football-layout';
const BLOCK_GRID_DEFAULT_LAYOUT_DATA = [
  ['01','02','03','04','05','06','07','08','09'],
  ['10','11','12','13','14','15','16AM','17','18AM'],
  ['19','20AM','21AM','22AM','23AM','24AM','25AM','26AM','27'],
  ['','20PM','21PM','22PM','23PM','24PM','25PM','26PM','27PM']
];

let blockGridLayout = [];
let blockGridInitialized = false;
let blockGridLayoutPromise = null;
let plainLanguageVehicleNames = new Map();
let configuredVehicleNames = new Map();

const DRIVER_DISPLAY_ENABLED = true;
const DUTY_ROSTER_POSITIONS = [
  {blockKey:'Sup', lineId:'sup-duty-line', nameId:'sup-duty-name'},
  {blockKey:'OnDemand Dispatch', lineId:'dispatch-duty-line', nameId:'dispatch-duty-name'}
];
let driverAssignmentsByBlock = Object.create(null);
let driverAssignmentsDisabled = false;

const AM_PM_BLOCKS = new Set(['20','21','22','23','24','25','26']);
const DAY_IN_MS = 24*60*60*1000;
const MINUTES_PER_DAY = 1440;
const NOON_MINUTES = 12*60;

function setBlocksGridMessage(message){
  if(!blocksGridStatus || !blocksGridTable) return;
  if(message){
    blocksGridStatus.textContent = message;
    blocksGridStatus.hidden = false;
    blocksGridTable.hidden = true;
  }else{
    blocksGridStatus.hidden = true;
    blocksGridTable.hidden = false;
  }
}

function createEmptyCell(){
  return {value:'',display:''};
}

function toCellString(value){
  if(typeof value==='string') return value;
  if(value==null) return '';
  return String(value);
}

function normalizeCellValue(value){
  if(value && typeof value==='object'){
    const cell=createEmptyCell();
    if('value' in value){
      cell.value=toCellString(value.value);
    }else if('label' in value){
      cell.value=toCellString(value.label);
    }else if('block' in value){
      cell.value=toCellString(value.block);
    }
    if('display' in value){
      cell.display=toCellString(value.display);
    }else if('text' in value){
      cell.display=toCellString(value.text);
    }
    return cell;
  }
  const cell=createEmptyCell();
  cell.value=toCellString(value);
  return cell;
}

function normalizeColumn(column,fallback){
  const result=Array.from({length:BLOCK_GRID_ROW_COUNT},()=>createEmptyCell());
  const source=Array.isArray(column)?column:[];
  const fallbackSource=Array.isArray(fallback)?fallback:[];
  for(let i=0;i<BLOCK_GRID_ROW_COUNT;i++){
    const value=source[i];
    if(value!=null){
      result[i]=normalizeCellValue(value);
    }else{
      const fallbackValue=fallbackSource[i];
      if(fallbackValue!=null){
        result[i]=normalizeCellValue(fallbackValue);
      }
    }
  }
  return result;
}

function normalizeLayout(layoutData){
  const layoutArray=Array.isArray(layoutData)?layoutData:[];
  if(!layoutArray.length){
    return BLOCK_GRID_DEFAULT_LAYOUT_DATA.map(col=>normalizeColumn(col));
  }
  return layoutArray.map(col=>normalizeColumn(col));
}

function applyLayoutById(layoutId){
  const key=String(layoutId||'').trim();
  if(!key || !blockGridLayoutMap.has(key)) return false;
  const layoutData=blockGridLayoutMap.get(key);
  blockGridLayout=normalizeLayout(layoutData);
  currentBlockGridLayoutId=key;
  if(blockLayoutSelect && blockLayoutSelect.value!==key){
    blockLayoutSelect.value=key;
  }
  if(blocksGridTable){
    buildBlockGrid();
    blockGridInitialized=true;
    reapplyLatestBlockAssignments();
  }
  return true;
}

function applyBlockGridLayoutData(data){
  const layoutMap=data && data.layouts instanceof Map?data.layouts:new Map();
  const resolvedId=String(data && data.layoutId?data.layoutId:'').trim();
  const nextMap=new Map();
  layoutMap.forEach((value,key)=>{
    const id=String(key||'').trim();
    if(!id) return;
    nextMap.set(id,Array.isArray(value)?value:[]);
  });
  if(resolvedId && data && Array.isArray(data.layout) && !nextMap.has(resolvedId)){
    nextMap.set(resolvedId,data.layout);
  }
  if(!nextMap.size){
    nextMap.set('default',BLOCK_GRID_DEFAULT_LAYOUT_DATA);
  }
  blockGridLayoutMap=nextMap;
  const availableLayoutsRaw=Array.isArray(data?.availableLayouts)?data.availableLayouts:[];
  const available=availableLayoutsRaw.map(id=>String(id||'').trim()).filter(id=>id);
  for(const key of blockGridLayoutMap.keys()){
    if(!available.includes(key)){
      available.push(key);
    }
  }
  if(!available.length){
    available.push('default');
  }
  blockGridAvailableLayouts=available;
  let targetLayoutId=resolvedId && blockGridLayoutMap.has(resolvedId)?resolvedId:'';
  if(!targetLayoutId){
    const savedPref=String(getSavedBlockLayoutPreference()||'').trim();
    if(savedPref && blockGridLayoutMap.has(savedPref)){
      targetLayoutId=savedPref;
    }
  }
  if(!targetLayoutId){
    targetLayoutId=available.find(id=>blockGridLayoutMap.has(id))||available[0];
  }
  updateLayoutSelectOptions(available,targetLayoutId);
  if(!applyLayoutById(targetLayoutId)){
    const fallbackId=available.find(id=>blockGridLayoutMap.has(id));
    if(fallbackId){
      applyLayoutById(fallbackId);
      targetLayoutId=fallbackId;
    }
  }
  const savedPreference=String(getSavedBlockLayoutPreference()||'').trim();
  if(savedPreference && savedPreference!==targetLayoutId){
    saveBlockLayoutPreference(targetLayoutId);
  }
  return targetLayoutId;
}

async function fetchBlockGridLayout(preferredLayoutId){
  const requestedLayout=determineRequestedBlockLayout(preferredLayoutId);
  try{
    const params=new URLSearchParams();
    if(requestedLayout){
      params.set('name',requestedLayout);
    }
    params.set('all','true');
    const queryString=params.toString();
    const url=queryString?`${BLOCK_GRID_LAYOUT_ENDPOINT}?${queryString}`:BLOCK_GRID_LAYOUT_ENDPOINT;
    const res=await fetch(url,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data=await res.json();
    const resolvedIdRaw=typeof data?.layout_id==='string'?data.layout_id:'';
    const resolvedId=resolvedIdRaw?resolvedIdRaw.trim():'';
    const layoutEntries=new Map();
    if(data && data.layouts && typeof data.layouts==='object'){
      for(const [key,value] of Object.entries(data.layouts)){
        const id=String(key||'').trim();
        if(!id) continue;
        if(Array.isArray(value)){
          layoutEntries.set(id,value);
        }
      }
    }
    if(Array.isArray(data?.layout)){
      const id=resolvedId || requestedLayout || 'default';
      layoutEntries.set(id,data.layout);
    }
    const availableLayouts=Array.isArray(data?.available_layouts)
      ? data.available_layouts.map(id=>String(id||'').trim()).filter(id=>id)
      : [];
    return {
      layoutId: resolvedId || requestedLayout || 'default',
      layout: Array.isArray(data?.layout)?data.layout:[],
      layouts: layoutEntries,
      availableLayouts
    };
  }catch(err){
    console.warn('Failed to load block grid layout',err);
  }
  return {
    layoutId: requestedLayout || 'default',
    layout: BLOCK_GRID_DEFAULT_LAYOUT_DATA,
    layouts: new Map(),
    availableLayouts: ['default']
  };
}

async function loadBlockGridLayout(preferredLayoutId,{force=false}={}){
  if(blockGridLayoutPromise && !force){
    return blockGridLayoutPromise;
  }
  const requestPromise=(async()=>{
    try{
      const data=await fetchBlockGridLayout(preferredLayoutId);
      applyBlockGridLayoutData(data);
      return data;
    }catch(err){
      console.warn('Failed to prepare block grid layout',err);
      const fallback={
        layoutId:'default',
        layout:BLOCK_GRID_DEFAULT_LAYOUT_DATA,
        layouts:new Map(),
        availableLayouts:['default']
      };
      applyBlockGridLayoutData(fallback);
      return fallback;
    }
  })();
  blockGridLayoutPromise=requestPromise;
  try{
    return await requestPromise;
  }finally{
    if(blockGridLayoutPromise===requestPromise){
      blockGridLayoutPromise=null;
    }
  }
}

async function ensureBlockGridReady(){
  if(blockGridInitialized) return true;
  if(!blocksGridTable) return false;
  await loadBlockGridLayout();
  return blockGridInitialized;
}

if(blockLayoutSelect){
  blockLayoutSelect.addEventListener('change',event=>{
    const selected=String(event.target.value||'').trim();
    if(!selected) return;
    saveBlockLayoutPreference(selected);
    applyLayoutById(selected);
    loadBlockGridLayout(selected,{force:true}).catch(()=>{});
  });
}

function buildBlockGrid(){
  if(!blocksGridTable) return;
  blocksGridTable.innerHTML='';
  if(!Array.isArray(blockGridLayout) || !blockGridLayout.length){
    setBlocksGridMessage('Layout unavailable.');
    return;
  }
  const columnCount=blockGridLayout.length;
  const normalizedColumns=[];
  let lastNonEmptyRow=-1;
  for(let col=0;col<columnCount;col++){
    const column=blockGridLayout[col]||[];
    const normalizedColumn=[];
    for(let row=0;row<BLOCK_GRID_ROW_COUNT;row++){
      const cellData=normalizeCellValue(column[row]);
      normalizedColumn[row]=cellData;
      const trimmedLabel=(cellData.value||'').trim();
      const trimmedDisplay=(cellData.display||'').trim();
      if((trimmedLabel||trimmedDisplay) && row>lastNonEmptyRow){
        lastNonEmptyRow=row;
      }
    }
    normalizedColumns[col]=normalizedColumn;
  }
  const rowCount=lastNonEmptyRow+1;
  if(rowCount<=0){
    setBlocksGridMessage('Layout unavailable.');
    return;
  }
  blocksGridTable.style.setProperty('--grid-columns',String(columnCount));
  for(let row=0;row<rowCount;row++){
    for(let col=0;col<columnCount;col++){
      const column=normalizedColumns[col]||[];
      const cellData=column[row]||createEmptyCell();
      const cell=document.createElement('div');
      cell.className='cell';
      cell.dataset.col=String(col);
      cell.dataset.row=String(row);
      const trimmedLabel=(cellData.value||'').trim();
      const displayOverride=(cellData.display||'').trim();
      if(trimmedLabel){
        const normalizedLabel=normalizeIdentifier(trimmedLabel);
        const match=normalizedLabel.match(/^(\d{2})(AM|PM)?$/);
        let blockMatch=match||null;
        if(!blockMatch){
          const bracketMatch=trimmedLabel.match(/^\[(\d{2})(AM|PM)?\]$/i) || trimmedLabel.match(/\[(\d{2})(AM|PM)?\]/i);
          if(bracketMatch){
            blockMatch=[bracketMatch[0],bracketMatch[1],bracketMatch[2]];
          }
        }
        if(blockMatch){
          cell.dataset.block=blockMatch[1];
          const periodValue=(blockMatch[2]||'').toLowerCase();
          if(periodValue){
            cell.dataset.period=periodValue;
          }else{
            delete cell.dataset.period;
          }
        }else{
          delete cell.dataset.block;
          delete cell.dataset.period;
        }
        if(normalizedLabel){
          cell.dataset.customBlockId=normalizedLabel;
        }else{
          delete cell.dataset.customBlockId;
        }
        const blockNumber=blockMatch?blockMatch[1]:trimmedLabel;
        const periodSuffix=blockMatch && blockMatch[2]?blockMatch[2].toUpperCase():'';
        const defaultLabel=blockMatch?(periodSuffix?`Block ${blockNumber} ${periodSuffix}`:`Block ${blockNumber}`):trimmedLabel;
        const displayLabel=displayOverride||defaultLabel;
        cell.innerHTML=`<div class="block-label">${displayLabel}</div><div class="bus mono">—</div><div class="drivers" hidden></div>`;
        const colors=getBlockCellColors(cell.dataset.block||'',cell.dataset.period||'',cell.dataset.customBlockId||'');
        setDefaultBlockCellColors(cell,colors);
        applyDefaultBlockCellColors(cell);
      }else{
        cell.dataset.empty='true';
        cell.innerHTML='<div class="block-label">&nbsp;</div><div class="bus mono">—</div><div class="drivers" hidden></div>';
        setDefaultBlockCellColors(cell,null);
        applyDefaultBlockCellColors(cell);
      }
      blocksGridTable.appendChild(cell);
    }
  }
}

function clearBlockGrid({message}={}){
  if(!blocksGridTable) return;
  const cells=blocksGridTable.querySelectorAll('.cell');
  cells.forEach(cell=>{
    const busEl=cell.querySelector('.bus');
    if(busEl) busEl.textContent='—';
    const driverContainer=cell.querySelector('.drivers');
    if(driverContainer){
      driverContainer.innerHTML='';
      driverContainer.hidden=true;
    }
    delete cell.dataset.bus;
    delete cell.dataset.vehicleId;
    applyDefaultBlockCellColors(cell);
  });
  if(message){
    setBlocksGridMessage(message);
  }
}

function normalizeIdentifier(value){
  return String(value||'').replace(/[^0-9a-z]/gi,'').toUpperCase();
}

function getBlockCellColors(block,period,customId){
  const blockId=String(block||'').padStart(2,'0');
  const periodId=String(period||'').toLowerCase();
  const normalizedCustom=String(customId||'').toLowerCase();

  if(normalizedCustom.includes('charter')){
    return {bg:'#FF69B4',text:'#000'};
  }

  if(normalizedCustom.includes('training')){
    return {bg:'#92FB02',text:'#000'};
  }

  if(!blockId) return null;

  const numeric=parseInt(blockId,10);

  if(['01','02'].includes(blockId)) return {bg:'#0C8103',text:'#fff'};
  if(['03','04'].includes(blockId)) return {bg:'#232D48',text:'#fff'};
  if(Number.isFinite(numeric) && numeric>=5 && numeric<=8) return {bg:'#FF7300',text:'#111'};
  if(Number.isFinite(numeric) && numeric>=9 && numeric<=12) return {bg:'#FFDD00',text:'#000'};
  if(Number.isFinite(numeric) && numeric>=13 && numeric<=14) return {bg:'#C3C1C1',text:'#000'};
  if(Number.isFinite(numeric) && numeric>=15 && numeric<=18) return {bg:'#0072BC',text:'#fff'};

  if(periodId==='am' && Number.isFinite(numeric) && numeric>=20 && numeric<=26){
    return {bg:'#F60303',text:'#fff'};
  }

  if(periodId==='pm' && blockId==='21'){
    return {bg:'#A812C9',text:'#fff'};
  }

  if(periodId==='pm' && ['20','22','24','26'].includes(blockId)){
    return {bg:'#F60303',text:'#fff'};
  }

  return null;
}

function setDefaultBlockCellColors(cell,colors){
  if(!cell) return;
  if(colors){
    cell.dataset.defaultCellBg=colors.bg;
    cell.dataset.defaultCellText=colors.text;
  }else{
    delete cell.dataset.defaultCellBg;
    delete cell.dataset.defaultCellText;
  }
}

function applyDefaultBlockCellColors(cell){
  if(!cell) return;
  const defaultBg=cell.dataset.defaultCellBg||'';
  const defaultText=cell.dataset.defaultCellText||'';
  if(defaultBg){
    cell.style.setProperty('--cell-bg',defaultBg);
    cell.style.setProperty('--cell-border',defaultBg);
    cell.style.setProperty('--route-color',defaultBg);
  }else{
    cell.style.removeProperty('--cell-bg');
    cell.style.removeProperty('--cell-border');
    cell.style.removeProperty('--route-color');
  }
  if(defaultText){
    cell.style.setProperty('--cell-text',defaultText);
    cell.style.setProperty('--driver-color',defaultText);
    cell.style.setProperty('--label-color',defaultText);
    cell.style.setProperty('--text-color',defaultText);
  }else{
    cell.style.removeProperty('--cell-text');
    cell.style.removeProperty('--driver-color');
    cell.style.removeProperty('--label-color');
    cell.style.removeProperty('--text-color');
  }
}

function cleanBusIdentifier(value){
  if(value==null) return '';
  const text=String(value).trim();
  if(!text) return '';
  if(text==='—') return '';
  if(/^0+$/.test(text)) return '';
  return text;
}

function extractVehicleName(value){
  if(value==null) return '';
  const text=String(value).trim();
  if(!text || text==='—') return '';
  return text;
}

function extractConfiguredVehicleNames(cfg){
  const map=new Map();
  if(!cfg || typeof cfg!=='object') return map;
  const addEntry=(id,name)=>{
    const normalized=cleanBusIdentifier(id);
    if(!normalized) return;
    if(name==null) return;
    let text=typeof name==='string'?name:String(name);
    text=text.trim();
    if(!text || text==='—') return;
    if(/^\d+$/.test(text) && text===normalized) return;
    map.set(normalized,text);
  };
  const candidateKeys=['VEHICLE_NAMES','VEHICLE_NAME_OVERRIDES','VEHICLE_LABELS','VEHICLE_ALIASES'];
  for(const key of candidateKeys){
    const value=cfg[key];
    if(!value) continue;
    if(Array.isArray(value)){
      for(const entry of value){
        if(!entry || typeof entry!=='object') continue;
        const id=entry.id ?? entry.vehicle_id ?? entry.vehicleId ?? entry.bus ?? entry.code ?? entry.key ?? entry.number;
        const label=entry.name ?? entry.label ?? entry.display ?? entry.vehicle_name ?? entry.vehicleName ?? entry.value;
        addEntry(id,label);
      }
    }else if(typeof value==='object'){
      for(const [id,label] of Object.entries(value)){
        addEntry(id,label);
      }
    }
  }
  return map;
}

function normalizeVehicleNameForCompare(value){
  if(value==null) return '';
  const text=String(value).replace(/\s+/g,' ').trim();
  if(!text) return '';
  return text.toUpperCase();
}

function normalizeExtraBusEntry(value){
  if(value==null) return null;
  let vehicleName='';
  let displayText='';
  let busId='';
  if(typeof value==='object' && !Array.isArray(value)){
    const nameCandidate=value.VehicleName ?? value.vehicle_name ?? value.vehicleName ?? value.name ?? value.label ?? value.display ?? value.text ?? '';
    if(nameCandidate!=null){
      vehicleName=String(nameCandidate).trim();
    }
    const idCandidate=value.VehicleId ?? value.vehicle_id ?? value.vehicleId ?? value.id ?? value.bus ?? value.code ?? value.number ?? '';
    if(idCandidate!=null){
      const normalized=cleanBusIdentifier(idCandidate);
      if(normalized){
        busId=normalized;
      }
    }
    if(!vehicleName){
      const alt=value.alias ?? value.title ?? value.value ?? '';
      if(alt!=null){
        vehicleName=String(alt).trim();
      }
    }
    if(value.display!=null){
      displayText=String(value.display).trim();
    }
    if(!displayText){
      displayText=vehicleName;
    }
  }else{
    const text=String(value).trim();
    if(!text) return null;
    vehicleName=text;
    displayText=text;
    const normalized=cleanBusIdentifier(text);
    if(normalized){
      busId=normalized;
    }
  }
  if(!busId){
    const inferred=cleanBusIdentifier(vehicleName);
    if(inferred){
      busId=inferred;
    }
  }
  if(!displayText){
    displayText=busId || vehicleName;
  }
  vehicleName=vehicleName || displayText || busId || '';
  const normalizedName=normalizeVehicleNameForCompare(vehicleName);
  const digitString=String(vehicleName||displayText||busId||'').replace(/\D+/g,'');
  const normalizedDigits=digitString?normalizeVehicleNameForCompare(digitString):'';
  if(!busId && !normalizedName){
    return null;
  }
  return {
    id:busId,
    display:displayText||busId||'',
    vehicleName,
    normalizedName,
    normalizedDigits
  };
}

function buildExtraBusEntries(values){
  const entries=[];
  if(!Array.isArray(values)) return entries;
  const seen=new Set();
  for(const value of values){
    const entry=normalizeExtraBusEntry(value);
    if(!entry) continue;
    const key=`${entry.id||''}::${entry.normalizedName||''}::${entry.normalizedDigits||''}::${entry.display}`;
    if(seen.has(key)) continue;
    seen.add(key);
    entries.push(entry);
  }
  return entries;
}

function supportsAmPmBlock(blockNumber){
  return AM_PM_BLOCKS.has(String(blockNumber||'').padStart(2,'0'));
}

function formatDriverTimeParts(hourStr,minuteStr,meridiem){
  let hour=Number(hourStr);
  if(!Number.isFinite(hour)) return hourStr;
  let minutes=Number(minuteStr);
  if(!Number.isFinite(minutes)) minutes=0;
  if(meridiem){
    const marker=String(meridiem).toLowerCase();
    if(marker.startsWith('p') && hour<12){
      hour+=12;
    }else if(marker.startsWith('a') && hour===12){
      hour=0;
    }
  }
  hour=(hour%24+24)%24;
  const hourOut=String(hour).padStart(2,'0');
  const minuteOut=String(Math.max(0,Math.min(59,Math.trunc(minutes)))).padStart(2,'0');
  return `${hourOut}:${minuteOut}`;
}

function formatDriverTimeLabel(label,timestamp){
  const raw=typeof label==='string'?label:'';
  const trimmed=raw.trim();
  if(trimmed){
    const replaced=trimmed.replace(/\b(\d{1,2})(?::([0-5]\d))?\s*([AaPp])(?:[Mm]\.?|\.?)?\b/g,
      (match,hour,minute,meridiem)=>formatDriverTimeParts(hour,minute,meridiem));
    if(replaced!==trimmed){
      return replaced;
    }
    const simpleMatch=trimmed.match(/^\s*(\d{1,2})(?::([0-5]\d))?\s*$/);
    if(simpleMatch){
      return formatDriverTimeParts(simpleMatch[1],simpleMatch[2],null);
    }
    return trimmed;
  }
  if(timestamp!=null){
    let numericTs=Number(timestamp);
    if(Number.isFinite(numericTs)){
      if(Math.abs(numericTs)<1e12){
        numericTs*=1000;
      }
      const date=new Date(numericTs);
      if(!Number.isNaN(date.getTime())){
        return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
      }
    }
  }
  return trimmed;
}

function normalizeDriverAssignmentsPayload(payload){
  const result=Object.create(null);
  if(!payload || typeof payload!=='object') return result;
  const assignments=payload.assignments_by_block || payload.assignmentsByBlock;
  if(!assignments || typeof assignments!=='object') return result;
  for(const [blockKey,periods] of Object.entries(assignments)){
    if(!periods || typeof periods!=='object') continue;
    const blockMap=Object.create(null);
    for(const [periodKey,drivers] of Object.entries(periods)){
      if(!Array.isArray(drivers) || !drivers.length) continue;
      const normalizedDrivers=[];
      for(const driver of drivers){
        if(!driver || typeof driver!=='object') continue;
        const rawName=typeof driver.name==='string'?driver.name.trim():'';
        if(!rawName) continue;
        const rawColorId=('COLOR_ID' in driver)?driver.COLOR_ID:(('color_id' in driver)?driver.color_id:(('colorId' in driver)?driver.colorId:null));
        let colorId=null;
        if(typeof rawColorId==='number' && Number.isFinite(rawColorId)){
          colorId=String(Math.trunc(rawColorId));
        }else if(typeof rawColorId==='string'){
          const trimmedColorId=rawColorId.trim();
          if(trimmedColorId){
            const numericColor=Number(trimmedColorId);
            colorId=Number.isFinite(numericColor)?String(Math.trunc(numericColor)):trimmedColorId;
          }
        }
        if(colorId==='9') continue;
        const startLabel=typeof driver.start_label==='string'?driver.start_label.trim():(typeof driver.startLabel==='string'?driver.startLabel.trim():'');
        const endLabel=typeof driver.end_label==='string'?driver.end_label.trim():(typeof driver.endLabel==='string'?driver.endLabel.trim():'');
        let startTs=null;
        const rawStartTs=('start_ts' in driver)?driver.start_ts:driver.startTs;
        if(typeof rawStartTs==='number' && Number.isFinite(rawStartTs)){
          startTs=rawStartTs;
        }else if(typeof rawStartTs==='string'){
          const trimmed=rawStartTs.trim();
          if(trimmed){
            const parsed=Number(trimmed);
            if(Number.isFinite(parsed)) startTs=parsed;
          }
        }
        let endTs=null;
        const rawEndTs=('end_ts' in driver)?driver.end_ts:driver.endTs;
        if(typeof rawEndTs==='number' && Number.isFinite(rawEndTs)){
          endTs=rawEndTs;
        }else if(typeof rawEndTs==='string'){
          const trimmed=rawEndTs.trim();
          if(trimmed){
            const parsed=Number(trimmed);
            if(Number.isFinite(parsed)) endTs=parsed;
          }
        }
        normalizedDrivers.push({
          name:rawName,
          startLabel:formatDriverTimeLabel(startLabel,startTs),
          endLabel:formatDriverTimeLabel(endLabel,endTs),
          startTs:startTs,
          endTs:endTs,
          colorId:colorId
        });
      }
      if(!normalizedDrivers.length) continue;
      normalizedDrivers.sort((a,b)=>{
        const aKey=a.startTs!=null?a.startTs:(a.endTs!=null?a.endTs:0);
        const bKey=b.startTs!=null?b.startTs:(b.endTs!=null?b.endTs:0);
        return aKey-bKey;
      });
      const periodKeyString=String(periodKey||'').toLowerCase();
      blockMap[periodKeyString]=normalizedDrivers;
    }
    if(Object.keys(blockMap).length){
      result[String(blockKey)]=blockMap;
    }
  }
  return result;
}

function selectDriversForBlock(blockNumber,periodSuffix){
  if(!DRIVER_DISPLAY_ENABLED || driverAssignmentsDisabled) return [];
  if(!blockNumber) return [];
  const normalizedBlock=String(blockNumber).padStart(2,'0');
  const normalizedPeriod=supportsAmPmBlock(normalizedBlock)?String(periodSuffix||'').toLowerCase():'';
  const entry=driverAssignmentsByBlock[normalizedBlock] || driverAssignmentsByBlock[String(blockNumber)] || null;
  if(!entry || typeof entry!=='object') return [];
  if(normalizedPeriod){
    const specific=entry[normalizedPeriod];
    if(Array.isArray(specific) && specific.length) return specific;
  }
  const fallbackKeys=['any',''];
  for(const key of fallbackKeys){
    const list=entry[key];
    if(Array.isArray(list) && list.length) return list;
  }
  if(!normalizedPeriod){
    for(const key of Object.keys(entry)){
      const list=entry[key];
      if(Array.isArray(list) && list.length) return list;
    }
  }
  return [];
}

function normalizeDriverTimestampToMs(value){
  if(value==null) return null;
  const numeric=Number(value);
  if(!Number.isFinite(numeric)) return null;
  if(Math.abs(numeric)<1e12){
    return numeric*1000;
  }
  return numeric;
}

function isDriverActiveNow(driver,nowMs){
  if(!driver) return false;
  const startMs=normalizeDriverTimestampToMs(driver.startTs);
  const endMs=normalizeDriverTimestampToMs(driver.endTs);
  if(startMs==null && endMs==null){
    return true;
  }
  let current=nowMs;
  if(startMs!=null && endMs!=null){
    let start=startMs;
    let end=endMs;
    if(end<start){
      end+=DAY_IN_MS;
      if(current<start){
        current+=DAY_IN_MS;
      }
    }
    return current>=start && current<=end;
  }
  if(startMs!=null){
    return current>=startMs;
  }
  if(endMs!=null){
    return current<=endMs;
  }
  return false;
}

function shouldDisplayDriver(driver,nowMs,nowMinutes){
  if(!driver) return false;
  if(isDriverActiveNow(driver,nowMs)) return true;
  const startMs=normalizeDriverTimestampToMs(driver.startTs);
  if(startMs!=null && startMs>=nowMs) return true;
  const endMs=normalizeDriverTimestampToMs(driver.endTs);
  if(endMs!=null && endMs>=nowMs) return true;
  const startInfo=getDriverTimeInfo(driver,'start');
  if(startInfo.minutes!=null && startInfo.minutes>=nowMinutes) return true;
  const endInfo=getDriverTimeInfo(driver,'end');
  if(endInfo.minutes!=null && endInfo.minutes>=nowMinutes) return true;
  return false;
}

function getDriverStartLabel(driver){
  if(!driver) return '';
  const label=typeof driver.startLabel==='string'?driver.startLabel.trim():'';
  if(label) return label;
  return formatDriverTimeLabel('',driver.startTs);
}

function buildDriverLineTexts(drivers){
  if(!DRIVER_DISPLAY_ENABLED || driverAssignmentsDisabled) return [];
  const items=Array.isArray(drivers)?drivers.filter(item=>{
    if(!item || !item.name) return false;
    if(item.colorId!=null){
      const normalizedColor=typeof item.colorId==='number'?String(Math.trunc(item.colorId)):(typeof item.colorId==='string'?item.colorId.trim():null);
      if(normalizedColor==='9') return false;
    }
    return true;
  }):[];
  if(!items.length) return [];
  const now=new Date();
  const nowMs=now.getTime();
  const nowMinutes=now.getHours()*60+now.getMinutes();
  const visibleEntries=items.map((driver,index)=>({driver,index}))
    .filter(entry=>shouldDisplayDriver(entry.driver,nowMs,nowMinutes));
  const visibleDrivers=visibleEntries.map(entry=>entry.driver);
  if(!visibleDrivers.length) return [];
  const lines=[];
  const hasActive=visibleDrivers.some(item=>isDriverActiveNow(item,nowMs));
  const firstVisibleIndex=visibleEntries[0].index;
  const precedingDriver=firstVisibleIndex>0?items[firstVisibleIndex-1]:null;
  if(!hasActive){
    if(precedingDriver && !shouldDisplayDriver(precedingDriver,nowMs,nowMinutes)){
      const gapLabel=buildOpenGapLabel(precedingDriver,visibleDrivers[0]);
      if(gapLabel){
        lines.push(gapLabel);
      }
    }
    const nextDriver=visibleDrivers[0];
    const nextLabel=getDriverStartLabel(nextDriver);
    lines.push(nextLabel ? `${nextDriver.name} @ ${nextLabel}` : nextDriver.name);
    for(let i=1;i<visibleDrivers.length;i++){
      const driver=visibleDrivers[i];
      const startLabel=getDriverStartLabel(driver);
      lines.push(startLabel ? `${driver.name} @ ${startLabel}` : driver.name);
    }
    return lines;
  }
  if(precedingDriver && !shouldDisplayDriver(precedingDriver,nowMs,nowMinutes)){
    const gapLabel=buildOpenGapLabel(precedingDriver,visibleDrivers[0]);
    if(gapLabel){
      lines.push(gapLabel);
    }
  }
  const includeLabels=visibleDrivers.length>1;
  let previousDriver=null;
  for(let i=0;i<visibleDrivers.length;i++){
    const driver=visibleDrivers[i];
    if(previousDriver){
      const gapLabel=buildOpenGapLabel(previousDriver,driver);
      if(gapLabel){
        lines.push(gapLabel);
      }
    }
    if(includeLabels){
      const endLabelRaw=typeof driver.endLabel==='string'?driver.endLabel.trim():'';
      const startLabelRaw=typeof driver.startLabel==='string'?driver.startLabel.trim():'';
      if(i===0){
        const label=endLabelRaw || startLabelRaw;
        lines.push(label?`${driver.name} until ${label}`:driver.name);
      }else{
        const label=startLabelRaw || endLabelRaw;
        lines.push(label?`${driver.name} @ ${label}`:driver.name);
      }
    }else{
      lines.push(driver.name);
    }
    previousDriver=driver;
  }
  return lines;
}

function renderDriverLines(container,drivers){
  if(!container) return;
  if(!DRIVER_DISPLAY_ENABLED || driverAssignmentsDisabled){
    container.innerHTML='';
    container.hidden=true;
    return;
  }
  const lines=buildDriverLineTexts(drivers);
  if(!lines.length){
    container.innerHTML='';
    container.hidden=true;
    return;
  }
  container.innerHTML='';
  for(const text of lines){
    const line=document.createElement('div');
    line.className='driver-line';
    line.textContent=text;
    container.appendChild(line);
  }
  container.hidden=false;
}

function updateDutyRoster(){
  for(const duty of DUTY_ROSTER_POSITIONS){
    if(!duty || !duty.nameId || !duty.lineId) continue;
    const nameEl=document.getElementById(duty.nameId);
    const lineEl=document.getElementById(duty.lineId);
    if(!nameEl || !lineEl) continue;
    const drivers=selectDriversForBlock(duty.blockKey,'');
    const lines=buildDriverLineTexts(drivers);
    const displayLine=Array.isArray(lines)
      ? lines.find(text=>typeof text==='string' && text.trim() && !/^OPEN\b/i.test(text)) || ''
      : '';
    const hasLine=Boolean(displayLine);
    nameEl.textContent=hasLine?displayLine:'—';
    lineEl.classList.toggle('duty-empty',!hasLine);
  }
}

function buildOpenGapLabel(previousDriver,nextDriver){
  if(!previousDriver || !nextDriver) return '';
  const previousEndInfo=getDriverTimeInfo(previousDriver,'end');
  const nextStartInfo=getDriverTimeInfo(nextDriver,'start');
  if(previousEndInfo.minutes==null || nextStartInfo.minutes==null) return '';
  const prevEnd=previousEndInfo.minutes;
  const nextStart=nextStartInfo.minutes;
  if(!Number.isFinite(prevEnd) || !Number.isFinite(nextStart)) return '';
  if(nextStart<=prevEnd) return '';
  const startLabel=formatGapTimeForDisplay(prevEnd,previousEndInfo.label);
  const endLabel=formatGapTimeForDisplay(nextStart,nextStartInfo.label);
  if(!startLabel || !endLabel) return '';
  return `OPEN ${startLabel} - ${endLabel}`;
}

function getDriverTimeInfo(driver,type){
  const prop=type==='end'?'endLabel':'startLabel';
  const tsProp=type==='end'?'endTs':'startTs';
  const rawLabel=typeof driver[prop]==='string'?driver[prop].trim():'';
  let minutes=parseTimeToMinutes(rawLabel);
  if(minutes==null){
    const ts=normalizeDriverTimestampToMs(driver[tsProp]);
    if(ts!=null){
      const date=new Date(ts);
      if(!Number.isNaN(date.getTime())){
        minutes=date.getHours()*60+date.getMinutes();
      }
    }
  }
  return {minutes,label:rawLabel};
}

function formatGapTimeForDisplay(minutes,fallbackLabel){
  if(minutes!=null && Number.isFinite(minutes)){
    let value=minutes%MINUTES_PER_DAY;
    if(value<0) value+=MINUTES_PER_DAY;
    const hours=Math.floor(value/60);
    const mins=value%60;
    return `${String(hours).padStart(2,'0')}${String(mins).padStart(2,'0')}`;
  }
  if(!fallbackLabel) return '';
  const digits=fallbackLabel.replace(/[^0-9]/g,'');
  if(!digits) return '';
  if(digits.length>=4) return digits.slice(-4);
  return digits.padStart(4,'0');
}

function parseTimeToMinutes(str){
  if(!str) return null;
  const value=String(str).trim();
  if(!value) return null;

  let match=value.match(/^PT(?:(\d+)H)?(?:(\d+)M)?$/i);
  if(match){
    const hours=parseInt(match[1]||'0',10);
    const minutes=parseInt(match[2]||'0',10);
    return hours*60+minutes;
  }

  match=value.match(/^\/Date\((\d+)\)\/$/);
  if(match){
    const date=new Date(Number(match[1]));
    if(!isNaN(date.getTime())){
      return date.getHours()*60+date.getMinutes();
    }
  }

  match=value.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
  if(match){
    let hours=parseInt(match[1],10)%12;
    const minutes=parseInt(match[2],10);
    if(match[3].toUpperCase()==='PM') hours+=12;
    return hours*60+minutes;
  }

  match=value.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
  if(match){
    const hours=parseInt(match[1],10);
    const minutes=parseInt(match[2],10);
    return hours*60+minutes;
  }

  return null;
}

function collectRanges(block){
  const ranges=[];
  const consider=(startStr,endStr)=>{
    const start=parseTimeToMinutes(startStr);
    const end=parseTimeToMinutes(endStr);
    if(start==null && end==null) return;
    ranges.push({start,end});
  };

  consider(block.BlockStartTime,block.BlockEndTime);
  consider(block.TripStartTime,block.TripEndTime);

  const trips=Array.isArray(block.Trips)?block.Trips:[];
  for(const trip of trips){
    consider(trip.BlockStartTime,trip.BlockEndTime);
    consider(trip.TripStartTime,trip.TripEndTime);
    consider(trip.StartTime,trip.EndTime);
    consider(trip.StartTimeDate,trip.EndTimeDate);
  }

  return ranges;
}

function calculatePeriodMinutes(start,end){
  let am=0;
  let pm=0;
  if(start==null || end==null) return {am,pm};

  let rangeStart=start;
  let rangeEnd=end;
  if(rangeEnd<rangeStart) rangeEnd+=MINUTES_PER_DAY;

  while(rangeStart<rangeEnd){
    const dayStart=Math.floor(rangeStart/MINUTES_PER_DAY)*MINUTES_PER_DAY;
    const dayEnd=dayStart+MINUTES_PER_DAY;
    const segmentEnd=Math.min(rangeEnd,dayEnd);
    const segStartOfDay=rangeStart-dayStart;
    const segEndOfDay=segmentEnd-dayStart;

    const amStart=Math.max(segStartOfDay,0);
    const amEnd=Math.min(segEndOfDay,NOON_MINUTES);
    if(amEnd>amStart) am+=amEnd-amStart;

    const pmStart=Math.max(segStartOfDay,NOON_MINUTES);
    const pmEnd=Math.min(segEndOfDay,MINUTES_PER_DAY);
    if(pmEnd>pmStart) pm+=pmEnd-pmStart;

    rangeStart=segmentEnd;
  }

  return {am,pm};
}

function buildBlockGridEntry(group){
  const id=String(group.BlockGroupId||'').trim();
  const blocks=Array.isArray(group.Blocks)?group.Blocks:[];
  const blockNumbers=[];
  const blockPeriods=Object.create(null);
  const seenNumbers=new Set();
  const matches=id.match(/\[(\d+)\]/g)||[];
  for(const raw of matches){
    const num=raw.replace(/[^0-9]/g,'');
    if(!num) continue;
    const parsed=parseInt(num,10);
    if(Number.isNaN(parsed)) continue;
    const normalized=String(parsed).padStart(2,'0');
    if(!seenNumbers.has(normalized)){
      seenNumbers.add(normalized);
      blockNumbers.push(normalized);
    }
  }

  const periodMatch=id.match(/\b(AM|PM)\b/i);
  const periodLabel=periodMatch?periodMatch[1].toLowerCase():'';

  if(periodLabel){
    for(const num of blockNumbers){
      if(supportsAmPmBlock(num)){
        blockPeriods[num]=periodLabel;
      }
    }
  }else if(blockNumbers.length===2){
    const [first,second]=blockNumbers;
    if(supportsAmPmBlock(first) && supportsAmPmBlock(second)){
      blockPeriods[first]='am';
      blockPeriods[second]='pm';
    }
  }

  let busValue='';
  let displayBus='';
  let vehicleId='';
  let vehicleName='';
  for(const block of blocks){
    const trips=Array.isArray(block.Trips)?block.Trips:[];
    let blockBusId='';
    let blockBusLabel='';
    let blockVehicleDisplay='';
    let hasVehicleName=false;
    const blockVehicleNameDisplay=extractVehicleName(block.VehicleName);
    const blockVehicleNameClean=cleanBusIdentifier(blockVehicleNameDisplay||block.VehicleName);
    if(blockVehicleNameClean){
      blockBusId=blockVehicleNameClean;
      const preferred=blockVehicleNameDisplay||blockVehicleNameClean;
      blockBusLabel=preferred;
      blockVehicleDisplay=preferred;
      if(!vehicleName || blockVehicleNameDisplay){
        vehicleName=preferred;
      }
      hasVehicleName=true;
    }
    let blockVehicleId=cleanBusIdentifier(block?.VehicleId??block?.VehicleID);
    if(blockVehicleId){
      const friendly=lookupPlainLanguageVehicleName(blockVehicleId);
      if(friendly && !hasVehicleName){
        blockBusLabel=friendly;
      }
    }
    if(!blockBusId && block.VehicleId!=null){
      const idString=cleanBusIdentifier(block.VehicleId);
      if(idString){
        blockBusId=idString;
        if(!blockBusLabel){
          const friendly=lookupPlainLanguageVehicleName(idString);
          blockBusLabel=friendly||idString;
        }
      }
    }
    for(const trip of trips){
      const tripVehicleNameDisplay=extractVehicleName(trip?.VehicleName);
      const tripBus=trip?cleanBusIdentifier(tripVehicleNameDisplay||trip.VehicleName):'';
      if(tripBus){
        if(!blockBusId){
          blockBusId=tripBus;
        }
        if(tripVehicleNameDisplay){
          blockBusLabel=tripVehicleNameDisplay;
          blockVehicleDisplay=tripVehicleNameDisplay;
          vehicleName=tripVehicleNameDisplay;
          hasVehicleName=true;
        }else if(!blockBusLabel){
          blockBusLabel=tripBus;
        }
      }
      const tripVehicleId=trip?cleanBusIdentifier(trip.VehicleId??trip.VehicleID):'';
      if(tripVehicleId){
        if(!blockVehicleId){
          blockVehicleId=tripVehicleId;
        }
        if(!blockBusLabel && !hasVehicleName){
          const friendly=lookupPlainLanguageVehicleName(tripVehicleId);
          if(friendly){
            blockBusLabel=friendly;
          }
        }
      }
      if(blockBusId && blockVehicleId && blockBusLabel){
        break;
      }
    }
    if(blockVehicleId && !blockBusLabel && !hasVehicleName){
      const friendly=lookupPlainLanguageVehicleName(blockVehicleId);
      if(friendly){
        blockBusLabel=friendly;
      }
    }
    if(!busValue && blockBusId){
      busValue=blockBusId;
    }
    if(!displayBus && blockBusLabel){
      displayBus=blockBusLabel;
    }
    if(!vehicleName && blockVehicleDisplay){
      vehicleName=blockVehicleDisplay;
    }
    if(!vehicleId && blockVehicleId){
      vehicleId=blockVehicleId;
    }
    if(busValue && vehicleId && displayBus){
      break;
    }
  }

  const bus=busValue||'—';
  displayBus=displayBus||bus;

  let minStart=null;
  let maxEnd=null;
  let amMinutes=0;
  let pmMinutes=0;
  const blockPeriodMinutes=new Map();
  const perNumberMinutes=new Map();
  for(const block of blocks){
    const ranges=collectRanges(block);
    for(const range of ranges){
      let {start,end}=range;
      if(start==null && end==null) continue;
      if(start!=null && end!=null){
        const contribution=calculatePeriodMinutes(start,end);
        amMinutes+=contribution.am;
        pmMinutes+=contribution.pm;
        let totals=blockPeriodMinutes.get(block);
        if(!totals){
          totals={am:0,pm:0};
          blockPeriodMinutes.set(block,totals);
        }
        totals.am+=contribution.am;
        totals.pm+=contribution.pm;
      }
      if(start!=null){
        if(minStart==null || start<minStart) minStart=start;
      }
      if(start!=null && end!=null && end<start){
        end+=MINUTES_PER_DAY;
      }
      if(end!=null){
        if(minStart!=null && end<minStart){
          while(end<minStart){
            end+=MINUTES_PER_DAY;
          }
        }
        if(maxEnd==null || end>maxEnd) maxEnd=end;
      }
    }
  }

  const coversAm=amMinutes>0;
  const coversPm=pmMinutes>0;

  let inferredPeriod='';
  if(periodLabel){
    inferredPeriod=periodLabel;
  }else if(coversAm && !coversPm){
    inferredPeriod='am';
  }else if(coversPm && !coversAm){
    inferredPeriod='pm';
  }else if(coversAm && coversPm){
    inferredPeriod='any';
  }else if(minStart!=null && maxEnd!=null){
    let start=minStart;
    let end=maxEnd;
    if(end<start) end+=MINUTES_PER_DAY;
    const duration=end-start;
    if(duration>0){
      const midpoint=(start+duration/2)%MINUTES_PER_DAY;
      inferredPeriod=midpoint>=NOON_MINUTES?'pm':'am';
    }
  }

  const blockIdLookup=new Map();
  const blockNumberSet=new Set(blockNumbers);
  const hasAuthoritativeNumbers=blockNumbers.length>0;

  const addNumber=(num,{allowFromBlockId=false}={})=>{
    if(!num) return null;
    const parsed=parseInt(num,10);
    if(Number.isNaN(parsed)) return null;
    const normalized=String(parsed).padStart(2,'0');
    if(allowFromBlockId && hasAuthoritativeNumbers && !blockNumberSet.has(normalized)){
      return null;
    }
    if(!blockNumberSet.has(normalized)){
      blockNumberSet.add(normalized);
      blockNumbers.push(normalized);
    }
    return normalized;
  };

  for(const block of blocks){
    const blockInfoNumbers=[];
    const blockIdRaw=String(block.BlockId||block.BlockID||block.Block||block.BlockNumber||block.Id||block.ID||'').trim();
    const normalizedId=normalizeIdentifier(blockIdRaw);
    if(normalizedId){
      const numericIdMatch=normalizedId.match(/^(\d{2})(AM|PM)?$/);
      const bracketMatches=blockIdRaw.match(/\[(\d{2})(AM|PM)?\]/gi)||[];
      if(numericIdMatch){
        const normalizedNum=addNumber(numericIdMatch[1],{allowFromBlockId:true});
        if(normalizedNum && !blockInfoNumbers.includes(normalizedNum)){
          blockInfoNumbers.push(normalizedNum);
        }
      }
      for(const raw of bracketMatches){
        const bracketMatch=raw.match(/\[(\d{2})(AM|PM)?\]/i);
        if(!bracketMatch) continue;
        const normalizedNum=addNumber(bracketMatch[1],{allowFromBlockId:true});
        if(normalizedNum && !blockInfoNumbers.includes(normalizedNum)){
          blockInfoNumbers.push(normalizedNum);
        }
      }
    }

    const coverageNumbers=blockInfoNumbers.filter(num=>supportsAmPmBlock(num));
    const blockTotals=blockPeriodMinutes.get(block);
    if(blockTotals && coverageNumbers.length){
      for(const num of coverageNumbers){
        let totals=perNumberMinutes.get(num);
        if(!totals){
          totals={am:0,pm:0};
          perNumberMinutes.set(num,totals);
        }
        totals.am+=blockTotals.am;
        totals.pm+=blockTotals.pm;
      }
    }

    let blockBusId='';
    let blockBusLabel='';
    let blockVehicleDisplay='';
    let hasVehicleName=false;
    const blockVehicleNameDisplay=extractVehicleName(block.VehicleName);
    const blockVehicleNameClean=cleanBusIdentifier(blockVehicleNameDisplay||block.VehicleName);
    if(blockVehicleNameClean){
      blockBusId=blockVehicleNameClean;
      const preferred=blockVehicleNameDisplay||blockVehicleNameClean;
      blockBusLabel=preferred;
      blockVehicleDisplay=preferred;
      hasVehicleName=true;
    }
    let blockVehicleId=cleanBusIdentifier(block?.VehicleId??block?.VehicleID);
    if(blockVehicleId){
      const friendly=lookupPlainLanguageVehicleName(blockVehicleId);
      if(friendly && !hasVehicleName){
        blockBusLabel=friendly;
      }
    }
    if(!blockBusId && block.VehicleId!=null){
      const idString=cleanBusIdentifier(block.VehicleId);
      if(idString){
        blockBusId=idString;
        if(!blockBusLabel){
          const friendly=lookupPlainLanguageVehicleName(idString);
          blockBusLabel=friendly||idString;
        }
      }
    }
    const trips=Array.isArray(block.Trips)?block.Trips:[];
    for(const trip of trips){
      const tripVehicleNameDisplay=extractVehicleName(trip?.VehicleName);
      const tripBus=trip?cleanBusIdentifier(tripVehicleNameDisplay||trip.VehicleName):'';
      if(tripBus){
        if(!blockBusId){
          blockBusId=tripBus;
        }
        if(tripVehicleNameDisplay){
          blockBusLabel=tripVehicleNameDisplay;
          blockVehicleDisplay=tripVehicleNameDisplay;
          hasVehicleName=true;
        }else if(!blockBusLabel){
          blockBusLabel=tripBus;
        }
      }
      const tripVehicleId=trip?cleanBusIdentifier(trip.VehicleId??trip.VehicleID):'';
      if(tripVehicleId){
        if(!blockVehicleId){
          blockVehicleId=tripVehicleId;
        }
        if(!blockBusLabel && !hasVehicleName){
          const friendly=lookupPlainLanguageVehicleName(tripVehicleId);
          if(friendly){
            blockBusLabel=friendly;
          }
        }
      }
      if(blockBusId && blockVehicleId && blockBusLabel){
        break;
      }
    }
    if(blockVehicleId && !blockBusLabel && !hasVehicleName){
      const friendly=lookupPlainLanguageVehicleName(blockVehicleId);
      if(friendly){
        blockBusLabel=friendly;
      }
    }
    const busValue=blockBusId||'—';
    const displayBusValue=blockBusLabel||busValue;

    if(normalizedId){
      const periodsForBlock=Object.create(null);
      const periodInId=normalizedId.match(/(AM|PM)$/);
      if(periodInId){
        const label=periodInId[1].toLowerCase();
        for(const num of blockInfoNumbers){
          if(!supportsAmPmBlock(num)) continue;
          periodsForBlock[num]=label;
          if(!blockPeriods[num]){
            blockPeriods[num]=label;
          }
        }
      }
      blockIdLookup.set(normalizedId,{
        bus:busValue,
        displayBus:displayBusValue,
        vehicleId:blockVehicleId||'',
        vehicleName:hasVehicleName?(blockVehicleDisplay||displayBusValue):'',
        numbers:blockInfoNumbers.slice(),
        periods:periodsForBlock
      });
    }

    if(!vehicleId && blockVehicleId){
      vehicleId=blockVehicleId;
    }
  }

  if(perNumberMinutes.size){
    const applyCoverageLabel=(num,label)=>{
      if(!label || !supportsAmPmBlock(num)) return;
      const current=blockPeriods[num];
      if(!current){
        blockPeriods[num]=label;
      }else if(current!==label && current!=='any'){
        blockPeriods[num]='any';
      }
      if(!blockIdLookup.size) return;
      for(const info of blockIdLookup.values()){
        if(!info) continue;
        const numbers=Array.isArray(info.numbers) && info.numbers.length?info.numbers:blockNumbers;
        if(!numbers.includes(num)) continue;
        const periods=info.periods || (info.periods=Object.create(null));
        const assigned=periods[num];
        if(!assigned){
          periods[num]=label;
        }else if(assigned!==label && assigned!=='any'){
          periods[num]='any';
        }
      }
    };

    for(const [num,totals] of perNumberMinutes.entries()){
      const am=totals.am||0;
      const pm=totals.pm||0;
      let label='';
      if(am>0 && pm>0){
        label='any';
      }else if(am>0){
        label='am';
      }else if(pm>0){
        label='pm';
      }
      if(label){
        applyCoverageLabel(num,label);
      }
    }
  }

  if(vehicleName && displayBus!==vehicleName){
    displayBus=vehicleName;
  }

  return {id,blockNumbers,blockPeriods,period:periodLabel,inferredPeriod,bus:busValue,displayBus,vehicleId,vehicleName,minStart,maxEnd,blockIdLookup};
}

function isActive(entry,nowMinutes){
  if(entry.minStart==null || entry.maxEnd==null) return false;
  let start=entry.minStart;
  let end=entry.maxEnd;
  let now=nowMinutes;
  if(end<start){
    end+=MINUTES_PER_DAY;
    if(now<start) now+=MINUTES_PER_DAY;
  }
  return now>=start && now<=end;
}

function pickBest(entries,nowMinutes){
  if(!entries.length) return null;
  const active=entries.filter(e=>isActive(e,nowMinutes));
  const activeWithBus=active.find(e=>e.bus && e.bus!=='—');
  if(activeWithBus) return activeWithBus;
  if(active.length) return active[0];

  const withBus=entries.find(e=>e.bus && e.bus!=='—');
  if(withBus) return withBus;

  return entries[0];
}

function selectBestAssignment(matches,blockNumber,normalizedPeriod,nowMinutes){
  if(!matches.length) return null;
  let filtered=matches;
  let allowFallback=!normalizedPeriod;
  if(blockNumber){
    const exactMatches=matches.filter(entry=>{
      const periods=entry.blockPeriods||null;
      if(!periods) return false;
      const assigned=periods[blockNumber];
      if(!assigned) return false;
      if(assigned==='any') return true;
      return assigned===normalizedPeriod;
    });
    if(normalizedPeriod && exactMatches.length){
      filtered=exactMatches;
      allowFallback=false;
    }else if(normalizedPeriod){
      const unspecified=matches.filter(entry=>{
        const periods=entry.blockPeriods||null;
        const assigned=periods?periods[blockNumber]:'';
        if(assigned){
          if(assigned==='any') return true;
          return false;
        }
        const explicit=(entry.period||'').toLowerCase();
        if(explicit){
          if(explicit==='any') return true;
          if(explicit!==normalizedPeriod) return false;
        }
        const inferred=(entry.inferredPeriod||'').toLowerCase();
        if(inferred){
          if(inferred==='any') return true;
          if(inferred!==normalizedPeriod) return false;
        }
        return true;
      });
      if(unspecified.length){
        filtered=unspecified;
        allowFallback=true;
      }else if(!exactMatches.length){
        filtered=[];
        allowFallback=false;
      }
    }
  }else if(normalizedPeriod){
    const periodFiltered=matches.filter(entry=>{
      const explicit=(entry.period||'').toLowerCase();
      if(explicit){
        if(explicit==='any') return true;
        return explicit===normalizedPeriod;
      }
      const inferred=(entry.inferredPeriod||'').toLowerCase();
      if(inferred){
        if(inferred==='any') return true;
        return inferred===normalizedPeriod;
      }
      return true;
    });
    if(periodFiltered.length){
      filtered=periodFiltered;
      const hasPeriodInfo=periodFiltered.some(entry=>{
        const explicit=(entry.period||'').toLowerCase();
        if(explicit && explicit!=='any') return true;
        const inferred=(entry.inferredPeriod||'').toLowerCase();
        if(inferred && inferred!=='any') return true;
        return false;
      });
      allowFallback=!hasPeriodInfo;
    }else{
      filtered=[];
      allowFallback=false;
    }
  }

  const best=pickBest(filtered,nowMinutes);
  if(best) return best;
  if(filtered!==matches && allowFallback){
    const fallback=pickBest(matches,nowMinutes);
    if(fallback) return fallback;
  }
  return null;
}

function lookupPlainLanguageVehicleName(id){
  const normalized=cleanBusIdentifier(id);
  if(!normalized) return '';
  const sources=[plainLanguageVehicleNames,configuredVehicleNames];
  for(const source of sources){
    const friendly=source.get(normalized);
    if(typeof friendly==='string'){
      const trimmed=friendly.trim();
      if(trimmed && trimmed!=='—'){
        if(/^\d+$/.test(trimmed) && trimmed===normalized){
          continue;
        }
        return trimmed;
      }
    }
  }
  return '';
}

function deriveVehicleDisplayLabel({display,bus,vehicleId,vehicleName}){
  const trimmedDisplay=typeof display==='string'?display.trim():'';
  const normalizedVehicleId=cleanBusIdentifier(vehicleId);
  const normalizedBus=cleanBusIdentifier(bus);
  const trimmedVehicleName=typeof vehicleName==='string'?vehicleName.trim():'';
  if(trimmedVehicleName && trimmedVehicleName!=='—'){
    return trimmedVehicleName;
  }
  const friendlyByVehicle=lookupPlainLanguageVehicleName(normalizedVehicleId);
  const friendlyByBus=lookupPlainLanguageVehicleName(normalizedBus);
  if(trimmedDisplay && trimmedDisplay!=='—'){
    const normalizedDisplay=cleanBusIdentifier(trimmedDisplay);
    const looksNumeric=/^\d+$/.test(normalizedDisplay);
    const matchesVehicle=normalizedVehicleId && normalizedDisplay===normalizedVehicleId;
    const matchesBus=normalizedBus && normalizedDisplay===normalizedBus;
    if(!(looksNumeric && (matchesVehicle || matchesBus))){
      return trimmedDisplay;
    }
  }
  if(friendlyByVehicle) return friendlyByVehicle;
  if(friendlyByBus) return friendlyByBus;
  if(trimmedDisplay && trimmedDisplay!=='—') return trimmedDisplay;
  if(normalizedBus) return normalizedBus;
  if(normalizedVehicleId) return normalizedVehicleId;
  return '—';
}

function normalizeAssignmentResult(entry){
  if(!entry) return {bus:'—',vehicleId:'',label:'—'};
  const rawBus=typeof entry.bus==='string'?entry.bus:'';
  const busClean=cleanBusIdentifier(rawBus);
  const bus=busClean||rawBus.trim()||'—';
  const vehicleIdClean=cleanBusIdentifier(entry.vehicleId);
  const displayRaw=typeof entry.displayBus==='string'?entry.displayBus:'';
  const vehicleNameRaw=typeof entry.vehicleName==='string'?entry.vehicleName:'';
  const label=deriveVehicleDisplayLabel({
    display:displayRaw,
    bus:bus,
    vehicleId:vehicleIdClean||busClean,
    vehicleName:vehicleNameRaw
  });
  return {bus:bus||'—',vehicleId:vehicleIdClean,label};
}

function findBestAssignment(blockNumber,periodSuffix,blockIdNormalized,entries,nowMinutes){
  const matches=blockNumber?entries.filter(e=>Array.isArray(e.blockNumbers)&&e.blockNumbers.includes(blockNumber)):[];
  const normalizedPeriod=(periodSuffix||'').toLowerCase();

  if(blockIdNormalized){
    const idCandidates=[];
    for(const entry of entries){
      const lookup=entry.blockIdLookup;
      if(lookup && lookup.has(blockIdNormalized)){
        const info=lookup.get(blockIdNormalized);
        const infoBusRaw=typeof info?.bus==='string'?info.bus:'';
        const infoBusClean=cleanBusIdentifier(infoBusRaw);
        const infoBusTrimmed=infoBusRaw.trim();
        const hasInfoBus=Boolean(infoBusClean || cleanBusIdentifier(infoBusTrimmed));
        const infoVehicleIdClean=cleanBusIdentifier(info?.vehicleId);
        const entryDisplayRaw=typeof entry.displayBus==='string'?entry.displayBus:'';
        const infoDisplayRaw=typeof info?.displayBus==='string'?info.displayBus:'';
        const trimmedInfoDisplay=typeof infoDisplayRaw==='string'?infoDisplayRaw.trim():'';
        const entryDisplayTrimmed=entryDisplayRaw.trim();
        const displayCandidate=trimmedInfoDisplay || (hasInfoBus?entryDisplayTrimmed:'');
        const infoVehicleNameRaw=typeof info?.vehicleName==='string'?info.vehicleName:'';
        const infoVehicleName=infoVehicleNameRaw.trim();
        const candidate={
          bus:hasInfoBus?(infoBusClean||infoBusTrimmed||'—'):'—',
          vehicleId:infoVehicleIdClean||'',
          displayBus:displayCandidate,
          vehicleName:infoVehicleName,
          blockNumbers:Array.isArray(info.numbers)&&info.numbers.length?info.numbers.slice():entry.blockNumbers.slice(),
          blockPeriods:(info.periods && Object.keys(info.periods).length)?info.periods:entry.blockPeriods,
          period:entry.period,
          inferredPeriod:entry.inferredPeriod,
          minStart:entry.minStart,
          maxEnd:entry.maxEnd
        };
        idCandidates.push(candidate);
      }
    }
    if(idCandidates.length){
      let targetNumber=blockNumber;
      if(!targetNumber){
        for(const candidate of idCandidates){
          if(Array.isArray(candidate.blockNumbers) && candidate.blockNumbers.length){
            targetNumber=candidate.blockNumbers[0];
            break;
          }
        }
      }
      const assignmentFromId=selectBestAssignment(idCandidates,targetNumber||'',normalizedPeriod,nowMinutes);
      const normalizedAssignment=normalizeAssignmentResult(assignmentFromId);
      if(normalizedAssignment.vehicleId || (normalizedAssignment.bus && normalizedAssignment.bus!=='—')){
        return normalizedAssignment;
      }
      if(!/^\d{2}(?:AM|PM)?$/.test(blockIdNormalized)){
        return {bus:'—',vehicleId:'',label:'—'};
      }
    }
  }
  if(!blockNumber){
    return {bus:'—',vehicleId:'',label:'—'};
  }
  if(!matches.length) return {bus:'—',vehicleId:'',label:'—'};
  const assignment=selectBestAssignment(matches,blockNumber,normalizedPeriod,nowMinutes);
  return normalizeAssignmentResult(assignment);
}

const BLOCK_ASSIGNMENT_PREFIX_COLORS=[
  {prefix:'JPJFan_',color:'#25E011'},
  {prefix:'NGFan_',color:'#0072BC'},
  {prefix:'FRPFan_',color:'#F60C02'},
  {prefix:'PGFan_',color:'#232D80'}
];

function matchSpecialAssignmentColor(value){
  if(value==null) return null;
  const text=String(value).trim();
  if(!text) return null;
  const upper=text.toUpperCase();
  const normalized=upper.replace(/[^0-9A-Z]/g,'');
  for(const entry of BLOCK_ASSIGNMENT_PREFIX_COLORS){
    if(text.startsWith(entry.prefix)) return entry.color;
    const prefixUpper=entry.prefix.toUpperCase();
    if(upper.startsWith(prefixUpper)) return entry.color;
    const prefixNormalized=prefixUpper.replace(/[^0-9A-Z]/g,'');
    if(prefixNormalized && normalized.startsWith(prefixNormalized)) return entry.color;
  }
  return null;
}

function resolveAssignmentColor({bus,displayBus,vehicleId,colorLookup,additionalKeys}={}){
  const keys=[bus,displayBus,vehicleId];
  if(Array.isArray(additionalKeys) && additionalKeys.length){
    for(const key of additionalKeys){
      keys.push(key);
    }
  }
  for(const key of keys){
    const specialColor=matchSpecialAssignmentColor(key);
    if(specialColor){
      return {color:specialColor,override:true};
    }
  }
  if(!colorLookup) return {color:null,override:false};
  for(const key of keys){
    if(!key) continue;
    const color=colorLookup.get(key);
    if(color) return {color,override:false};
  }
  return {color:null,override:false};
}

function updateBlockGrid(entries,nowMinutes,{busColorMap}={}){
  if(!blocksGridTable) return;
  if(!Array.isArray(entries) || !entries.length){
    clearBlockGrid({});
    setBlocksGridMessage('No block assignments available.');
    return;
  }
  const colorLookup=busColorMap||null;
  const cells=blocksGridTable.querySelectorAll('.cell');
  let hasAny=false;
  cells.forEach(cell=>{
    if(cell.dataset.empty==='true'){
      const busEl=cell.querySelector('.bus');
      if(busEl){
        busEl.textContent='—';
      }
      const driverContainer=cell.querySelector('.drivers');
      if(driverContainer){
        driverContainer.innerHTML='';
        driverContainer.hidden=true;
      }
      delete cell.dataset.bus;
      delete cell.dataset.vehicleId;
      applyDefaultBlockCellColors(cell);
      return;
    }
    const blockNumber=cell.dataset.block||'';
    const periodSuffix=cell.dataset.period||'';
    const customId=cell.dataset.customBlockId||'';
    let assignment={bus:'—',vehicleId:'',label:'—'};
    if(blockNumber || customId){
      assignment=findBestAssignment(blockNumber,periodSuffix,customId,entries,nowMinutes)||{bus:'—',vehicleId:'',label:'—'};
    }
    const bus=assignment.bus||'—';
    const displayBus=assignment.label||bus||'—';
    const busEl=cell.querySelector('.bus');
    if(busEl){
      busEl.textContent=displayBus||'—';
    }
    const normalizedBus=cleanBusIdentifier(bus);
    if(normalizedBus){
      cell.dataset.bus=normalizedBus;
    }else{
      delete cell.dataset.bus;
    }
    const normalizedVehicleId=cleanBusIdentifier(assignment.vehicleId);
    if(normalizedVehicleId){
      cell.dataset.vehicleId=normalizedVehicleId;
    }else{
      delete cell.dataset.vehicleId;
    }
    const driverContainer=cell.querySelector('.drivers');
    if(driverContainer){
      let driverBlock=blockNumber;
      let driverPeriod=periodSuffix;
      if(!driverBlock && customId){
        const blockMatch=customId.match(/^(\d{2})/);
        if(blockMatch){
          driverBlock=blockMatch[1];
        }
        if(!driverPeriod){
          const periodMatch=customId.match(/(AM|PM)$/);
          if(periodMatch){
            driverPeriod=periodMatch[1].toLowerCase();
          }
        }
      }
      const driverList=selectDriversForBlock(driverBlock,driverPeriod);
      renderDriverLines(driverContainer,driverList);
    }
    const hasAssignedBus=(displayBus && displayBus!=='—') || (bus && bus!=='—');
    if(hasAssignedBus){
      hasAny=true;
    }
    const {color:resolvedColor,override}=resolveAssignmentColor({
      bus,
      displayBus,
      vehicleId:assignment.vehicleId,
      colorLookup,
      additionalKeys:[customId]
    });
    let colorValue=resolvedColor;
    if(colorValue && !String(colorValue).startsWith('#')){
      colorValue='#'+String(colorValue);
    }
    const hasDefaultColors=Boolean(
      (cell.dataset && (cell.dataset.defaultCellBg || cell.dataset.defaultCellText))
    );
    if(colorValue && (!hasDefaultColors || override)){
      const textColor=contrastColor(colorValue);
      cell.style.setProperty('--cell-bg',colorValue);
      cell.style.setProperty('--cell-border',colorValue);
      cell.style.setProperty('--route-color',colorValue);
      cell.style.setProperty('--cell-text',textColor);
      cell.style.setProperty('--driver-color',textColor);
      cell.style.setProperty('--label-color',textColor);
      cell.style.setProperty('--text-color',textColor);
    }else{
      applyDefaultBlockCellColors(cell);
    }
  });
  if(hasAny){
    setBlocksGridMessage(null);
  }else{
    if(blocksGridStatus){
      blocksGridStatus.textContent='No buses assigned.';
      blocksGridStatus.hidden=false;
    }
    if(blocksGridTable){
      blocksGridTable.hidden=false;
    }
  }
}

function formatAssignmentLabel(entry,blockId,numbers){
  if(blockId){
    return blockId;
  }
  if(Array.isArray(numbers) && numbers.length){
    return '['+numbers.join('/')+']';
  }
  if(entry && typeof entry.id==='string' && entry.id.trim()){
    return entry.id.trim();
  }
  if(entry && Array.isArray(entry.blockNumbers) && entry.blockNumbers.length){
    return '['+entry.blockNumbers.join('/')+']';
  }
  return '';
}

function collectBusAssignments(entries,nowMinutes){
  const allAssignments=new Map();
  const activeAssignments=new Map();
  const assignedNames=new Set();
  const register=(bus,label,{isActive=false,vehicleName='',displayBus=''}={})=>{
    const clean=cleanBusIdentifier(bus);
    if(clean){
      assignedNames.add(normalizeVehicleNameForCompare(clean));
      if(!allAssignments.has(clean)){
        allAssignments.set(clean,label||'');
      }
      if(isActive && !activeAssignments.has(clean)){
        activeAssignments.set(clean,label||'');
      }
    }
    const friendly=extractVehicleName(vehicleName)||extractVehicleName(displayBus)||extractVehicleName(bus);
    if(friendly){
      assignedNames.add(normalizeVehicleNameForCompare(friendly));
    }
    const digits=String(vehicleName||displayBus||bus||'').replace(/\D+/g,'');
    if(digits){
      assignedNames.add(normalizeVehicleNameForCompare(digits));
    }
  };
  for(const entry of entries){
    if(!entry) continue;
    const active=isActive(entry,nowMinutes);
    register(entry.bus,formatAssignmentLabel(entry,null,null),{
      isActive:active,
      vehicleName:entry.vehicleName,
      displayBus:entry.displayBus
    });
    if(entry.blockIdLookup instanceof Map){
      for(const [blockId,info] of entry.blockIdLookup.entries()){
        if(!info) continue;
        const label=formatAssignmentLabel(entry,blockId,info.numbers);
        register(info.bus,label,{
          isActive:active,
          vehicleName:info.vehicleName ?? entry.vehicleName,
          displayBus:info.displayBus ?? entry.displayBus
        });
      }
    }
  }
  return {allAssignments,activeAssignments,assignedNames};
}

function normalizeHeaderText(value){
  return (value||'').replace(/\s+/g,' ').trim().toLowerCase();
}

const DOWNED_HEADER_VARIANTS = [
  ['Bus','Status','Date','Supervisor','Notes/Description','Diagnostic Date','Mechanic','Diagnostic Description','Current ETA','Actual Delivery Date','Status'],
  ['P&T Support Vehicle','Status','Date','Supervisor','Notes/Description','Diagnostic Date','Mechanic','Diagnostic Description','Current ETA','Actual Delivery Date','Status']
].map(h=>h.map(normalizeHeaderText));
async function j(u){ const r = await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(r.status); return r.json(); }
function setBanner(txt,kind){ const b=$('#banner'); if(!txt){ b.style.display='none'; b.textContent=''; return; } b.className='banner '+(kind||'info'); b.textContent=txt; b.style.display='block'; }

function runCyberpunkBootSequence(){
  if(!CYBERPUNK_ENABLED) return Promise.resolve();
  const overrideKey='Escape';
  const overrideLabel=overrideKey==='Escape'?'ESC':overrideKey.toUpperCase();
  return new Promise(resolve=>{
    const overlay=document.createElement('div');
    overlay.id='cli-preroll';
    overlay.setAttribute('role','dialog');
    overlay.setAttribute('aria-modal','true');
    overlay.setAttribute('aria-label','Dispatcher interface boot sequence');
    overlay.setAttribute('aria-live','polite');
    overlay.tabIndex=-1;
    overlay.innerHTML=`
      <div class="cli-terminal">
        <div class="cli-content" aria-live="polite" aria-atomic="false"></div>
        <div class="cli-footer">Press <span class="cli-key">${overrideLabel}</span> to skip</div>
      </div>`;
    document.body.appendChild(overlay);

    const content=overlay.querySelector('.cli-content');
    if(!content){
      overlay.remove();
      resolve();
      return;
    }
    const prefersReduced=window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const charDelay=prefersReduced?0:18;
    const linePause=prefersReduced?80:70;
    const bannerPause=prefersReduced?180:320;
    const commandPause=prefersReduced?140:220;
    const finalPause=prefersReduced?200:380;
    const fadeDuration=prefersReduced?180:420;
    overlay.style.setProperty('--cli-fade-duration', fadeDuration+'ms');

    const bannerLines=[
      'Phoenix BIOS v4.06 (C) 1985-2001',
      'Memory Test: 640K OK',
      'Initializing devices...'
    ];
    const typedLines=[
      'POST diagnostics.............. OK',
      'Loading system drivers........ OK',
      'Mounting volume A:\\ .......... OK',
      'Calibrating dispatch relays... OK'
    ];
    const commandText='RUN DISPATCHER.EXE';

    const wait=ms=>new Promise(r=>setTimeout(r,ms));
    const appendLine=(text,className)=>{
      const line=document.createElement('div');
      line.className='cli-line'+(className?' '+className:'');
      if(text!=null) line.textContent=text;
      content.appendChild(line);
      content.scrollTop=content.scrollHeight;
      return line;
    };

    const typeText=(text,target,holdCursor)=>new Promise(done=>{
      const lineEl=target.closest?target.closest('.cli-line'):target;
      if(!lineEl){ done(); return; }
      const applyFinal=()=>{
        target.textContent=text;
        lineEl.classList.remove('typing');
        if(holdCursor) lineEl.classList.add('cursor-hold');
        done();
      };
      if(charDelay<=0){
        applyFinal();
        return;
      }
      lineEl.classList.add('typing');
      target.textContent='';
      let idx=0;
      const step=()=>{
        if(finished){
          applyFinal();
          return;
        }
        target.textContent=text.slice(0,idx+1);
        idx++;
        if(idx<text.length){
          setTimeout(step,charDelay);
        }else{
          applyFinal();
        }
      };
      step();
    });

    const typeLine=(text,className)=>{
      const line=appendLine('',className);
      return typeText(text,line,false).then(()=>line);
    };

    const appendCommandLine=()=>{
      const line=document.createElement('div');
      line.className='cli-line cli-command';
      line.innerHTML='<span class="cli-prompt">A:\\></span><span class="cli-type"></span>';
      content.appendChild(line);
      content.scrollTop=content.scrollHeight;
      return line;
    };

    let finished=false;
    const cleanup=()=>{
      document.removeEventListener('keydown',handleKey);
      if(overlay.parentNode) overlay.parentNode.removeChild(overlay);
    };
    const startFade=()=>{
      if(finished) return;
      finished=true;
      overlay.classList.add('fade-out');
      setTimeout(()=>{
        cleanup();
        resolve();
      },fadeDuration);
    };
    const handleKey=ev=>{
      if(ev.key===overrideKey){
        ev.preventDefault();
        startFade();
      }
    };

    document.addEventListener('keydown',handleKey);
    requestAnimationFrame(()=>{
      overlay.classList.add('visible');
      try{ overlay.focus({preventScroll:true}); }catch(_){ overlay.focus(); }
    });

    (async()=>{
      bannerLines.forEach(text=>appendLine(text,'cli-banner'));
      await wait(bannerPause);
      if(finished) return;
      for(const text of typedLines){
        await typeLine(text,'cli-op');
        if(finished) return;
        await wait(linePause);
        if(finished) return;
      }
      const commandLine=appendCommandLine();
      const target=commandLine.querySelector('.cli-type');
      if(target){
        await typeText(commandText,target,true);
        if(finished) return;
      }
      await wait(commandPause);
      if(finished) return;
      appendLine('Executing DISPATCHER.EXE...','cli-op');
      await wait(finalPause);
      if(finished) return;
      startFade();
    })().catch(()=>{
      if(!finished) startFade();
    });
  });
}

function activateLcarsMode(){
  document.body.classList.add('lcars');
  document.documentElement.style.setProperty('color-scheme','dark');

  const overlay=document.createElement('div');
  overlay.className='lcars-overlay';
  overlay.innerHTML=`
    <div class="lcars-rail lcars-rail-left">
      <span class="lcars-node primary"></span>
      <span class="lcars-node secondary"></span>
      <span class="lcars-node highlight"></span>
    </div>
    <div class="lcars-rail lcars-rail-top">
      <span class="lcars-strip primary"></span>
      <span class="lcars-strip highlight"></span>
      <span class="lcars-strip secondary"></span>
      <span class="lcars-strip alert"></span>
    </div>
    <div class="lcars-swoop" aria-hidden="true"></div>`;
  document.body.appendChild(overlay);

  const strips=overlay.querySelectorAll('.lcars-strip');
  const prefersReduced=window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  if(strips.length && !prefersReduced){
    let activeIndex=0;
    strips.forEach((strip,index)=>strip.classList.toggle('is-active',index===activeIndex));
    setInterval(()=>{
      activeIndex=(activeIndex+1)%strips.length;
      strips.forEach((strip,index)=>strip.classList.toggle('is-active',index===activeIndex));
    },4200);
  }
}

function activateCyberpunkMode(){
  document.body.classList.add('cyberpunk');
  document.documentElement.style.setProperty('color-scheme','dark');

  const datafallCanvas=document.createElement('canvas');
  datafallCanvas.className='cyberpunk-datafall';
  document.body.prepend(datafallCanvas);

  const grid=document.createElement('div');
  grid.className='cyberpunk-grid';
  document.body.prepend(grid);

  const vignette=document.createElement('div');
  vignette.className='cyberpunk-vignette';
  document.body.prepend(vignette);

  const hudLines=document.createElement('div');
  hudLines.className='cyberpunk-hud-lines';
  document.body.appendChild(hudLines);

  const orb=document.createElement('div');
  orb.className='cyberpunk-orb';
  document.body.appendChild(orb);

  const corners=document.createElement('div');
  corners.className='cyberpunk-corners';
  corners.innerHTML='<span class="corner corner-tl"></span><span class="corner corner-tr"></span><span class="corner corner-bl"></span><span class="corner corner-br"></span>';
  document.body.appendChild(corners);

  const holoBadge=document.createElement('div');
  holoBadge.className='cyberpunk-holo-badge';
  holoBadge.innerHTML='Neural Dispatch Core <span>STANDING BY</span>';
  document.body.appendChild(holoBadge);

  const runeContainer=document.createElement('div');
  runeContainer.className='cyberpunk-runes';
  const runePhrases=['ALIGN','VECTOR','SPECTRUM'];
  runePhrases.forEach(text=>{
    const rune=document.createElement('div');
    rune.className='cyberpunk-rune';
    rune.textContent=text;
    runeContainer.appendChild(rune);
  });
  document.body.appendChild(runeContainer);

  const runeVariants=['ALIGN','VECTOR','SPECTRUM','NEURAL','STASIS','PRIME','AURORA'];
  const holoMessages=['STANDING BY','OVERRIDE READY','LINKED','FIELD SYNC','OMNI CONTROL'];
  setInterval(()=>{
    const badgeSpan=holoBadge.querySelector('span');
    if(badgeSpan){
      badgeSpan.textContent=holoMessages[Math.floor(Math.random()*holoMessages.length)];
    }
    runeContainer.querySelectorAll('.cyberpunk-rune').forEach(rune=>{
      rune.textContent=runeVariants[Math.floor(Math.random()*runeVariants.length)];
    });
  },6200);

  const ctx=datafallCanvas.getContext('2d');
  const glyphs='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ△▽◇✶☰☷⟁';
  let rainWidth=0;
  let rainHeight=0;
  let columns=0;
  let drops=[];
  const resizeRain=()=>{
    const dpr=window.devicePixelRatio||1;
    rainWidth=window.innerWidth;
    rainHeight=window.innerHeight;
    datafallCanvas.width=rainWidth*dpr;
    datafallCanvas.height=rainHeight*dpr;
    datafallCanvas.style.width=rainWidth+'px';
    datafallCanvas.style.height=rainHeight+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
    const charSize=18;
    columns=Math.floor(rainWidth/charSize);
    drops=new Array(columns).fill(0);
  };
  resizeRain();
  window.addEventListener('resize',resizeRain);

  const drawRain=()=>{
    ctx.fillStyle='rgba(0,10,20,0.16)';
    ctx.fillRect(0,0,rainWidth,rainHeight);
    ctx.fillStyle='rgba(0,255,255,0.9)';
    ctx.shadowBlur=12;
    ctx.shadowColor='rgba(0,255,255,0.55)';
    ctx.font='16px "Courier Prime", monospace';
    for(let i=0;i<columns;i++){
      const text=glyphs[Math.floor(Math.random()*glyphs.length)];
      const x=i*18;
      const y=drops[i]*18;
      ctx.fillText(text,x,y);
      if(y>rainHeight && Math.random()>0.95){
        drops[i]=0;
      }else{
        drops[i]+=1;
      }
    }
    requestAnimationFrame(drawRain);
  };
  requestAnimationFrame(drawRain);

  if(leftPane){
    const hud=document.createElement('div');
    hud.className='cyberpunk-hud';
    hud.innerHTML=`
      <div class="hud-card" data-card="variance">
        <span>Headway Variance</span>
        <strong data-value="variance">00.0s</strong>
        <div class="hud-trend" data-trend="variance">Δ +0.0 HOLD</div>
        <div class="hud-graph" data-graph="variance">${'<div class="hud-bar"></div>'.repeat(8)}</div>
      </div>
      <div class="hud-card" data-card="latency">
        <span>Neural Latency</span>
        <strong data-value="latency">000ms</strong>
        <div class="hud-trend warn" data-trend="latency">Δ +0.0 ALERT</div>
        <div class="hud-graph" data-graph="latency">${'<div class="hud-bar"></div>'.repeat(6)}</div>
      </div>
      <div class="hud-card" data-card="integrity">
        <span>Route Integrity</span>
        <strong data-value="integrity">000%</strong>
        <div class="hud-trend" data-trend="integrity">Δ +0.0 STABLE</div>
        <div class="hud-graph" data-graph="integrity">${'<div class="hud-bar"></div>'.repeat(5)}</div>
      </div>`;
    const layout=document.getElementById('layout');
    if(layout){
      leftPane.insertBefore(hud,layout);
    }else{
      leftPane.appendChild(hud);
    }

    const randomBetween=(min,max)=>Math.random()*(max-min)+min;
    const hudState={variance:'00.0s',latency:'000ms',integrity:'000%'};
    const setTrend=(name,delta,unit,labels)=>{
      const el=hud.querySelector(`[data-trend="${name}"]`);
      if(!el) return;
      el.classList.remove('warn','bad');
      const textDelta=`${delta>0?'+':''}${delta.toFixed(unit==='%'?1:1)}${unit||''}`;
      let suffix=' HOLD';
      if(delta>1.2 || (unit==='%' && delta>0.6)){
        el.classList.add('bad');
        suffix=' ALERT';
      }else if(delta>0.4 || (unit==='%' && delta>0.3)){
        el.classList.add('warn');
        suffix=' WATCH';
      }else if(delta<0){
        suffix=' CALM';
      }
      if(Array.isArray(labels) && labels.length){
        suffix=' '+labels[Math.floor(Math.random()*labels.length)];
      }
      el.textContent=`Δ ${textDelta}${suffix}`;
    };
    const updateGraph=name=>{
      const graph=hud.querySelector(`[data-graph="${name}"]`);
      if(!graph) return;
      const bars=graph.querySelectorAll('.hud-bar');
      bars.forEach((bar,index)=>{
        bar.style.height=Math.round(randomBetween(25,100))+'%';
        bar.style.opacity=(0.6+Math.random()*0.4).toFixed(2);
        bar.style.animationDelay=(index*0.18)+'s';
      });
    };
    const updateHud=()=>{
      const variance=randomBetween(4.8,18.6);
      hudState.variance=variance.toFixed(1)+'s';
      const varianceValue=hud.querySelector('[data-value="variance"]');
      if(varianceValue) varianceValue.textContent=hudState.variance;
      setTrend('variance',randomBetween(-1.2,2.4),'s',['HOLD','STABLE','SYNC']);
      updateGraph('variance');

      const latency=randomBetween(36,220);
      hudState.latency=Math.round(latency)+'ms';
      const latencyValue=hud.querySelector('[data-value="latency"]');
      if(latencyValue) latencyValue.textContent=hudState.latency;
      setTrend('latency',randomBetween(-8,12),'ms',['ALERT','TRACK','LINK']);
      updateGraph('latency');

      const integrity=randomBetween(88,99.4);
      hudState.integrity=integrity.toFixed(1)+'%';
      const integrityValue=hud.querySelector('[data-value="integrity"]');
      if(integrityValue) integrityValue.textContent=hudState.integrity;
      setTrend('integrity',randomBetween(-0.6,0.9),'%',['STABLE','LOCK','FIELD']);
      updateGraph('integrity');
    };
    updateHud();
    setInterval(updateHud,4600);

    const ticker=document.createElement('div');
    ticker.className='cyberpunk-ticker';
    const label=document.createElement('span');
    label.className='ticker-label';
    label.textContent='UPLINK';
    const marquee=document.createElement('div');
    marquee.className='ticker-marquee';
    const spanA=document.createElement('span');
    const spanB=document.createElement('span');
    marquee.append(spanA,spanB);
    ticker.append(label,marquee);
    leftPane.appendChild(ticker);

    const tickerPhrases=['FIELD OPS READY','SYNTH GRID ONLINE','OVERRIDE CHANNEL ARMED','DRONE RELAY CLEAN','SPECTRUM HOLD'];
    const randomFrom=arr=>arr[Math.floor(Math.random()*arr.length)];

    const refreshTicker=()=>{
      const now=new Date();
      const segments=[
        'NODE '+(window.location.hostname||'DISPATCH'),
        'SYNC '+now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
        'VAR '+hudState.variance.toUpperCase(),
        'LAT '+hudState.latency.toUpperCase(),
        'INT '+hudState.integrity.toUpperCase(),
        randomFrom(tickerPhrases),
        'CODE '+Math.floor(Math.random()*4096).toString(16).toUpperCase().padStart(3,'0')
      ];
      const text=segments.join(' // ');
      spanA.textContent=text;
      spanB.textContent=text;
    };

    refreshTicker();
    setInterval(refreshTicker,15000);
  }

  runCyberpunkBootSequence().then(()=>startCyberpunkSplash());
}

function startCyberpunkSplash(){
  const overlay=document.createElement('div');
  overlay.id='boot-overlay';
  overlay.innerHTML=`
    <div class="boot-inner">
      <div class="boot-title">Dispatcher Neural Link</div>
      <div class="boot-progress"><div class="boot-progress-fill"></div></div>
      <div class="boot-progress-label"><span>STATUS</span><span class="boot-progress-value">0%</span></div>
      <div class="boot-log"></div>
      <div class="boot-footer">Click or press any key to skip boot sequence</div>
    </div>`;
  document.body.appendChild(overlay);

  const title=overlay.querySelector('.boot-title');
  const log=overlay.querySelector('.boot-log');
  const progressFill=overlay.querySelector('.boot-progress-fill');
  const progressValue=overlay.querySelector('.boot-progress-value');
  const steps=[
    {delay:400,text:'<span class="hint">[SYS]</span> Starting grounds fiber uplink…'},
    {delay:520,text:'<span class="hint">[CORE]</span> Booting UTS Operations Dashboard primary systems.'},
    {delay:540,text:'<span class="hint">[SENSORS]</span> Syncing with all AVL beacons <span class="ok">LOCKED</span>.',glitch:true},
    {delay:460,text:'<span class="hint">[OPS]</span> Parsing block assignments &mdash; vehicles within tolerance.'},
    {delay:580,text:'<span class="hint">[AI]</span> Predictive load balancer compiling headway futures…',glitch:true},
    {delay:500,text:'<span class="hint">[MAP]</span> Extruding 3D route lattice and holo-grid.'},
    {delay:480,text:'<span class="hint">[DOWNLINK]</span> Syncing downed bus dossier &amp; shop intel.'},
    {delay:540,text:'<span class="hint">[COMM]</span> Establishing encrypted radio channel for emergency comms.'},
    {delay:520,text:'<span class="hint">[AUDIO]</span> Deploying synthwave ambience for tactical focus.'},
    {delay:640,text:'<span class="hint">[READY]</span> Dispatch authority granted. Maintain headway. <span class="ok">ONLINE</span>',glitch:true}
  ];
  const totalSteps=steps.length;

  const bootSound=new Audio('https://assets.mixkit.co/sfx/preview/mixkit-futuristic-tech-ui-interface-click-1125.mp3');
  bootSound.volume=0.6;
  const ambientSound=new Audio('https://assets.mixkit.co/music/preview/mixkit-ambient-futuristic-straight-pattern-715.mp3');
  ambientSound.loop=true;
  ambientSound.volume=0.18;

  const ensurePlayback=audio=>{
    if(!audio) return;
    audio.play().catch(()=>{
      const resume=()=>{
        audio.play().catch(()=>{});
      };
      document.addEventListener('pointerdown',resume,{once:true});
      document.addEventListener('keydown',resume,{once:true});
    });
  };
  ensurePlayback(bootSound);
  setTimeout(()=>ensurePlayback(ambientSound),900);

  let finished=false;
  const finishBoot=()=>{
    if(finished) return;
    finished=true;
    progressFill.style.width='100%';
    progressValue.textContent='ONLINE';
    overlay.classList.add('boot-complete');
    setTimeout(()=>{
      overlay.remove();
    },900);
  };

  overlay.addEventListener('click',finishBoot);
  window.addEventListener('keydown',finishBoot,{once:true});

  let elapsed=0;
  steps.forEach((step,index)=>{
    elapsed+=step.delay;
    setTimeout(()=>{
      const el=document.createElement('div');
      el.className='boot-line';
      el.innerHTML=step.text;
      log.appendChild(el);
      log.scrollTop=log.scrollHeight;
      const pct=Math.min(100,Math.round(((index+1)/totalSteps)*100));
      progressFill.style.width=pct+'%';
      progressValue.textContent=pct+'%';
      if(step.glitch){
        title.classList.add('glitch');
        setTimeout(()=>title.classList.remove('glitch'),220);
      }
    },elapsed);
  });

  setTimeout(finishBoot,elapsed+900);
}

function htmlEscape(str){
  if(str==null) return '';
  return String(str).replace(/[&<>"']/g,ch=>({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  })[ch]);
}

function htmlEscapeMultiline(str){
  return htmlEscape(str).replace(/\r?\n/g,'<br>');
}

function normalizeOpsStatus(val){
  const raw=(val||'').trim();
  if(!raw) return '';
  const up=raw.toUpperCase();
  if(OPS_STATUS_VALUES.has(up)) return up;
  if(up==='DOWN') return 'DOWNED';
  return '';
}

function normalizeShopStatus(val){
  const raw=(val||'').trim();
  if(!raw) return '';
  const up=raw.toUpperCase();
  if(SHOP_STATUS_VALUES.has(up)) return up;
  if(up==='DOWNED') return 'DOWN';
  return '';
}

function parseCsv(text){
  const rows=[];
  let row=[];
  let cur='';
  let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(inQuotes){
      if(ch==='"'){
        if(text[i+1]==='"'){ cur+='"'; i++; }
        else{ inQuotes=false; }
      }else{
        cur+=ch;
      }
    }else{
      if(ch==='"') inQuotes=true;
      else if(ch===','){ row.push(cur); cur=''; }
      else if(ch==='\r'){ /* ignore */ }
      else if(ch==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else cur+=ch;
    }
  }
  if(inQuotes) inQuotes=false;
  if(cur!=='' || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

function rowMatchesHeader(row){
  return DOWNED_HEADER_VARIANTS.some(header=>{
    for(let i=0;i<header.length;i++){
      const cell=normalizeHeaderText(row[i]);
      if(cell!==header[i]) return false;
    }
    return true;
  });
}

function parseDateValue(str){
  const raw=(str||'').trim();
  if(!raw) return null;
  const parsed=Date.parse(raw);
  if(!Number.isNaN(parsed)) return parsed;
  const m=raw.match(/^(\d{1,2})[\/-](\d{1,2})(?:[\/-](\d{2,4}))?$/);
  if(m){
    let [,mm,dd,yy]=m;
    const month=parseInt(mm,10)-1;
    const day=parseInt(dd,10);
    let year;
    if(yy==null){
      year=new Date().getFullYear();
    }else{
      year=parseInt(yy,10);
      if(year<100) year+=2000;
    }
    const dt=new Date(year,month,day);
    if(dt.getFullYear()===year && dt.getMonth()===month && dt.getDate()===day){
      return dt.getTime();
    }
  }
  return null;
}

function formatDateValue(ts){
  if(ts==null) return '';
  const d=new Date(ts);
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function normalizeDateField(str){
  const raw=(str||'').trim();
  if(!raw) return {text:'',value:null};
  const value=parseDateValue(raw);
  if(value==null) return {text:raw,value:null};
  return {text:formatDateValue(value),value};
}

function maxDateValue(...values){
  let max=null;
  for(const v of values){
    if(v==null) continue;
    if(max==null || v>max) max=v;
  }
  return max;
}

function buildVehicleRecord(row){
  const id=(row[0]||'').trim();
  if(!id) return null;
  const opsStatus=normalizeOpsStatus(row[1]);
  const opsDate=normalizeDateField(row[2]);
  const shopDiagDate=normalizeDateField(row[5]);
  const shopActualDate=normalizeDateField(row[9]);
  const shopStatus=normalizeShopStatus(row[10]);
  const record={
    vehicleId:id,
    opsStatus,
    opsDateText:opsDate.text,
    opsDateValue:opsDate.value,
    opsSupervisor:(row[3]||'').trim(),
    opsNotes:(row[4]||'').trim(),
    shopDiagDateText:shopDiagDate.text,
    shopDiagDateValue:shopDiagDate.value,
    shopMechanic:(row[6]||'').trim(),
    shopDiagNotes:(row[7]||'').trim(),
    shopETA:(row[8]||'').trim(),
    shopActualDeliveryText:shopActualDate.text,
    shopActualDeliveryValue:shopActualDate.value,
    shopStatus,
    shopLatestValue:maxDateValue(shopDiagDate.value,shopActualDate.value)
  };
  record.isDown = record.opsStatus==='DOWNED' && (!record.shopStatus || record.shopStatus==='DOWN');
  return record;
}

function isRecordNewer(newRec,oldRec){
  const a=newRec.opsDateValue;
  const b=oldRec.opsDateValue;
  if(a!=null || b!=null){
    if(a==null) return false;
    if(b==null) return true;
    if(a!==b) return a>b;
  }
  const sa=newRec.shopLatestValue;
  const sb=oldRec.shopLatestValue;
  if(sa!=null || sb!=null){
    if(sa==null) return false;
    if(sb==null) return true;
    if(sa!==sb) return sa>sb;
  }
  return false;
}

function dedupeVehicleRecords(records){
  const byId=new Map();
  for(const rec of records){
    const existing=byId.get(rec.vehicleId);
    if(!existing || isRecordNewer(rec,existing)){
      byId.set(rec.vehicleId,rec);
    }
  }
  return Array.from(byId.values());
}

function parseVehicleSheet(text){
  const rawRows=parseCsv(text);
  if(!rawRows.length) return [];
  const rows=rawRows.map(r=>r.map(c=>c.trim()));
  let firstRowSkipped=false;
  let inSection=false;
  const records=[];
  for(const row of rows){
    if(!firstRowSkipped){
      firstRowSkipped=true;
      continue;
    }
    if(rowMatchesHeader(row)){
      inSection=true;
      continue;
    }
    if(!inSection) continue;
    if(row.every(cell=>!cell.trim())) continue;
    const rec=buildVehicleRecord(row);
    if(rec) records.push(rec);
  }
  return dedupeVehicleRecords(records);
}

function statusLabel(status){
  if(!status) return '';
  const key=String(status).toUpperCase();
  if(STATUS_LABELS[key]) return STATUS_LABELS[key];
  const text=String(status);
  return text.charAt(0)+text.slice(1).toLowerCase();
}

function statusClass(status){
  if(!status) return '';
  const key=String(status).toUpperCase();
  return STATUS_CLASSES[key] || '';
}

let lastDownedRows=[];
let downedBusFullIds=new Set();
let downedBusBaseIds=new Set();

function extractDigits(str){
  return (str||'').replace(/\D+/g,'');
}

function refreshDownedBusSets(rows){
  downedBusFullIds=new Set();
  downedBusBaseIds=new Set();
  for(const row of rows){
    const rawId=String(row?.vehicleId||'').trim();
    if(!rawId) continue;
    const digits=extractDigits(rawId);
    if(digits.length>=5){
      downedBusFullIds.add(digits.slice(-5));
    }else if(digits.length>=3){
      downedBusBaseIds.add(digits);
      if(digits.length>3){
        downedBusBaseIds.add(digits.slice(-3));
      }
    }
  }
}

function isBusDowned(busId){
  const digits=extractDigits(busId);
  if(!digits) return false;
  if(downedBusFullIds.has(digits.slice(-5))) return true;
  if(digits.length>=5){
    const base=digits.slice(0,-2);
    const suffix=digits.slice(-2);
    if(DOWNED_SUFFIXES.has(suffix)){
      if(downedBusBaseIds.has(base) || downedBusBaseIds.has(base.slice(-3))) return true;
    }
  }
  return false;
}

function renderDownedVehicles(rows){
  lastDownedRows=rows.slice();
  refreshDownedBusSets(rows);
  updateExtraBuses();
}

async function loadDownedBuses(){
  try{
    const res=await fetch(DOWNED_ENDPOINT,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const payload=await res.json();
    if(payload && payload.error){
      console.warn('Downed buses sheet returned with warning:', payload.error);
    }
    const text=payload && typeof payload.csv==='string'?payload.csv:'';
    const records=parseVehicleSheet(text);
    const downed=records.filter(r=>r.isDown);
    renderDownedVehicles(downed);
  }catch(err){
    console.error('Failed to load downed buses sheet', err);
  }
}

function contrastColor(hex){
  if(!hex) return '#e8eef5';
  const c=hex.replace('#','');
  const r=parseInt(c.substr(0,2),16)/255;
  const g=parseInt(c.substr(2,2),16)/255;
  const b=parseInt(c.substr(4,2),16)/255;
  const l=0.2126*r+0.7152*g+0.0722*b;
  return l>0.5?'#000':'#fff';
}

const DEFAULT_ALL_BUSES=[
  "12132","12232","12332","12432","12532","12632",
  "14132","14232","14332","14432","14532",
  "17132","17232","17332","17432","17532","17632","17732",
  "18132","18232","18332","18432","18532","18632","18732","18832",
  "19132","19232","19332","19432","19532",
  "20131","20231","20331","20431",
  "24012","24112","24212","24312","24412",
  "25131","25231","25331","25431",
];

let allBuses=DEFAULT_ALL_BUSES.slice();
let extraBusEntries=buildExtraBusEntries(allBuses);
let OVERHEIGHT_BUSES=['25131','25231','25331','25431','17132','14132','12432','18532'];
let assignedVehicleNamesNormalized=new Set();

async function loadConfig(){
  try{
    const cfg = await j('/v1/config');
    if(cfg.ALL_BUSES){
      if(Array.isArray(cfg.ALL_BUSES)){
        allBuses=cfg.ALL_BUSES.slice();
      }else{
        allBuses=[cfg.ALL_BUSES];
      }
    }else{
      allBuses=DEFAULT_ALL_BUSES.slice();
    }
    extraBusEntries=buildExtraBusEntries(allBuses);
    if(cfg.OVERHEIGHT_BUSES){
      const list=Array.isArray(cfg.OVERHEIGHT_BUSES)?cfg.OVERHEIGHT_BUSES:[cfg.OVERHEIGHT_BUSES];
      OVERHEIGHT_BUSES=list.map(item=>{
        const normalized=cleanBusIdentifier(item);
        if(normalized) return normalized;
        const text=String(item??'').trim();
        return text||null;
      }).filter(Boolean);
    }
    configuredVehicleNames = extractConfiguredVehicleNames(cfg);
  }catch(e){
    extraBusEntries=buildExtraBusEntries(allBuses);
  }
  updateExtraBuses();
}

let blockByBus=new Map(), allBlockByBus=new Map();

function updateExtraBuses(){
  const extra=$('#extra-buses');
  if(!extra) return;
  const unassigned=extraBusEntries.filter(entry=>{
    if(!entry) return false;
    const normalizedId=entry.id||'';
    if(normalizedId && allBlockByBus.has(normalizedId)) return false;
    if(entry.normalizedName && assignedVehicleNamesNormalized.has(entry.normalizedName)) return false;
    if(entry.normalizedDigits && assignedVehicleNamesNormalized.has(entry.normalizedDigits)) return false;
    const downedKey=normalizedId || entry.vehicleName || entry.display;
    if(downedKey && isBusDowned(downedKey)) return false;
    return true;
  });
  extra.innerHTML=unassigned.length
    ? unassigned.map(entry=>{
        const normalizedId=entry.id||'';
        let bg='#EEE8AA';
        if(normalizedId && OVERHEIGHT_BUSES.includes(normalizedId)){
          bg='#E57200';
        }else if(normalizedId && normalizedId.startsWith('24')){
          bg='#232D4B';
        }
        const color=contrastColor(bg);
        const label=entry.display || entry.vehicleName || normalizedId || '—';
        return `<li class="mono" style="background:${bg};color:${color};border-color:${bg}">${label}</li>`;
      }).join('')
    : '<li class="hint">None</li>';
}

async function loadBlocks(){
  try{
    await ensureBlockGridReady();
    setBlocksGridMessage('Loading…');
    latestBlockGridMessage='Loading…';
    const blockPromise=j('/v1/dispatch/blocks');
    const driverPromise=fetch('/v1/dispatch/block-drivers',{cache:'no-store'}).catch(()=>null);
    const [res,driverRes]=await Promise.all([blockPromise,driverPromise]);
    const groups=res.block_groups||[];
    const colorByRoute=new Map(Object.entries(res.color_by_route||{}));
    const routeByBus=new Map(Object.entries(res.route_by_bus||{}));
    const plainLanguageBlocks=Array.isArray(res.plain_language_blocks)?res.plain_language_blocks:[];

    if(plainLanguageBlocks.length){
      const map=new Map();
      for(const entry of plainLanguageBlocks){
        if(!entry || typeof entry!=='object') continue;
        const rawId=('vehicle_id' in entry)?entry.vehicle_id:(('vehicleId' in entry)?entry.vehicleId:null);
        const id=cleanBusIdentifier(rawId);
        if(!id) continue;
        let name='';
        if(typeof entry.vehicle_name==='string'){ 
          name=entry.vehicle_name.trim();
        }else if(typeof entry.vehicleName==='string'){
          name=entry.vehicleName.trim();
        }
        if(name && name!=='—'){
          map.set(id,name);
        }
      }
      plainLanguageVehicleNames=map;
    }else{
      plainLanguageVehicleNames=new Map();
    }

    if(driverRes && driverRes.ok){
      const driverData=await driverRes.json();
      driverAssignmentsDisabled=!!(driverData && driverData.disabled);
      driverAssignmentsByBlock=driverAssignmentsDisabled?Object.create(null):normalizeDriverAssignmentsPayload(driverData);
    }else{
      driverAssignmentsByBlock=Object.create(null);
      driverAssignmentsDisabled=false;
      if(driverRes && !driverRes.ok){
        console.warn('Failed to fetch driver assignments',driverRes.status);
      }
    }

    updateDutyRoster();

    if(!groups.length){
      latestBlockGridEntries=[];
      latestBlockGridNowMinutes=null;
      latestBlockGridColorMap=null;
      latestBlockGridMessage='No block assignments available.';
      clearBlockGrid({message:latestBlockGridMessage});
      blockByBus=new Map();
      allBlockByBus=new Map();
      plainLanguageVehicleNames=new Map();
      assignedVehicleNamesNormalized=new Set();
      updateExtraBuses();
      return;
    }

    const busColorMap=new Map();
    for(const g of groups){
      const blocks=g.Blocks||[];
      if(!blocks.length) continue;
      for(const b of blocks){
        const trip=b.Trips?.[0];
        const bus=trip?.VehicleName||'—';
        let rid=routeByBus.get(bus);
        if(rid==null) rid=trip?.RouteID||b.Route?.RouteId;
        let col=null;
        if(rid===0){
          col='#000000';
        }else if(rid){
          col=colorByRoute.get(String(rid))||trip?.RouteColor||b.Route?.Color||null;
        }else{
          col=trip?.RouteColor||b.Route?.Color||null;
        }
        if(col && !col.startsWith('#')) col='#'+col;
        if(bus && bus!=='—' && col){
          busColorMap.set(bus,col);
        }
      }
    }

    const gridEntries=[];
    for(const group of groups){
      const entry=buildBlockGridEntry(group);
      const hasCustomIds=entry.blockIdLookup && entry.blockIdLookup.size;
      if(entry.blockNumbers.length || hasCustomIds){
        gridEntries.push(entry);
      }
    }
    const now=new Date();
    const nowMinutes=now.getHours()*60+now.getMinutes();
    const {allAssignments,activeAssignments,assignedNames}=collectBusAssignments(gridEntries,nowMinutes);
    allBlockByBus=allAssignments;
    blockByBus=activeAssignments;
    assignedVehicleNamesNormalized=assignedNames;
    updateExtraBuses();
    latestBlockGridEntries=gridEntries;
    latestBlockGridNowMinutes=nowMinutes;
    latestBlockGridColorMap=busColorMap;
    updateBlockGrid(gridEntries,nowMinutes,{busColorMap});
    latestBlockGridMessage=blocksGridStatus && !blocksGridStatus.hidden?(blocksGridStatus.textContent||''):null;
  }catch(e){
    console.error('Failed to load block assignments',e);
    latestBlockGridEntries=[];
    latestBlockGridNowMinutes=null;
    latestBlockGridColorMap=null;
    latestBlockGridMessage='Error loading blocks.';
    clearBlockGrid({message:latestBlockGridMessage});
    blockByBus=new Map();
    allBlockByBus=new Map();
    plainLanguageVehicleNames=new Map();
    assignedVehicleNamesNormalized=new Set();
    updateExtraBuses();
    updateDutyRoster();
  }
}

async function pollHealth(){
  try{ const h=await j('/v1/health'); if(!h.ok && h.last_error){ setBanner('Feed error: '+h.last_error, 'error'); }
       else{ /* keep info banner state */ } }
  catch(e){ setBanner('Health check failed', 'error'); }
  setTimeout(pollHealth, 15000);
}

function buildReturnTarget(){
  const path=window.location.pathname||'/';
  const search=window.location.search||'';
  const hash=window.location.hash||'';
  return `${path}${search}${hash}`;
}
function redirectToLogin(){
  const target=buildReturnTarget();
  window.location.href=`/login?return=${encodeURIComponent(target)}`;
}
let dispatcherAuthPromise=null;

async function requireDispatcherPassword(){
  if(dispatcherAuthPromise) return dispatcherAuthPromise;
  dispatcherAuthPromise=(async()=>{
    dispatcherSecretLabel=null;
    try{
      const resp=await fetch('/api/dispatcher/auth',{cache:'no-store'});
      if(resp.ok){
        const data=await resp.json();
        if(data&&typeof data.secret==='string'&&data.secret){
          dispatcherSecretLabel=data.secret;
        }
        const authorized=data&&data.authorized===true;
        const requiresPassword = data&&typeof data.required==='boolean' ? data.required : true;
        if(authorized||requiresPassword===false){
          return true;
        }
      }
    }catch(err){
      console.warn('Failed to check dispatcher auth',err);
    }
    redirectToLogin();
    return false;
  })().finally(()=>{ dispatcherAuthPromise=null; });
  return dispatcherAuthPromise;
}

document.addEventListener('DOMContentLoaded', async ()=>{
  const authorized = await requireDispatcherPassword();
  if(!authorized) return;
  applyDispatcherSecretMode();
  loadMapFrameIfNeeded();
  await loadConfig();
  pollHealth();
  loadBlocks();
  setInterval(loadBlocks,30000);
  loadDownedBuses();
  setInterval(loadDownedBuses,DOWNED_REFRESH_MS);
});
</script>
<script src="nav-bar.js"></script>
</body>
