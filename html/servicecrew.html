<!doctype html>
<html>
<head>
<link rel="icon" type="image/png" href="/media/favicon.ico" />
<link rel="apple-touch-icon" sizes="120x120" href="/media/apple-touch-icon-120.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/media/apple-touch-icon-152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/media/apple-touch-icon-180.png" />
<meta charset="utf-8" />
<title>Service Crew - UTS Operations Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preload" href="FGDC.ttf" as="font" type="font/ttf" crossorigin />
<style>
  @font-face{font-family:'FGDC';src:url('FGDC.ttf') format('truetype');font-weight:normal;font-style:normal;}
  :root{ --bg:#24234b; --panel:#24234b; --ink:#e8eef5; --muted:#9fb0c9; --line:#24234b; --chip:#2a3442; }
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.2 'FGDC',sans-serif;height:100vh;width:100vw;display:flex;flex-direction:column;}
  table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:32px;background:#24234b;}
  th,td{border:1px solid var(--line);padding:4px 8px;text-align:left;}
  #bustable th{font-size:24px;white-space:nowrap;}
  #bustable th:nth-child(1), #bustable td:nth-child(1),
  #bustable th:nth-child(3), #bustable td:nth-child(3){
    text-align:center;
  }
  #layout{flex:1;display:flex;overflow:hidden;height:100vh;gap:8px;padding:0 8px;}
  #table-wrapper{width:876px;overflow:hidden;display:flex;flex-direction:column;}
  #bustable col.bus{width:7ch;}
  #bustable col.miles{width:120px;}
  #dateDisplay{background:#24234b;padding:4px;border:1px solid #24234b;margin-bottom:8px;}
  #map-section{flex:1;display:flex;flex-direction:column;overflow:hidden;}
  #map-header{height:162px;display:flex;flex-direction:row;gap:8px;padding:4px 0;flex-shrink:0;}
  #soc-panel{flex:1;display:flex;flex-direction:column;justify-content:center;gap:4px;overflow-y:auto;padding:0 4px;}
  .soc-row{display:flex;align-items:center;gap:8px;padding:2px 4px;}
  .soc-bus{font-size:22px;width:5ch;flex-shrink:0;}
  .soc-chg{width:1.2em;flex-shrink:0;text-align:center;color:#4caf50;font-style:normal;}
  @keyframes chg-flash{0%,100%{opacity:1;}50%{opacity:0.1;}}
  .soc-chg.soc-charging{animation:chg-flash 1.8s ease-in-out infinite;}
  .soc-bar-bg{flex:1;height:22px;background:#1a1a3a;border-radius:4px;overflow:hidden;}
  .soc-bar-fill{height:100%;}
  .soc-pct{font-size:20px;width:4ch;text-align:right;flex-shrink:0;}
  #clock-panel{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;}
  #clock-time{font-size:80px;line-height:1;}
  #clock-date{font-size:28px;margin-top:6px;color:var(--muted);}
  #mapframe{border:1px solid var(--line);flex:1;}
  .credit{position:fixed;bottom:8px;right:8px;font-size:12px;color:var(--muted,#9fb0c9);}
  td.high-mileage{background:red;}
</style>
</head>
<body>
<div id="layout">
  <div id="table-wrapper">
    <div id="dateDisplay"></div>
    <table id="bustable">
      <colgroup>
        <col class="bus" />
        <col />
        <col class="miles" />
      </colgroup>
      <thead>
        <tr>
          <th>Bus</th>
          <th>Blocks</th>
          <th>Miles Today</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="map-section">
    <div id="map-header">
      <div id="soc-panel"><span style="color:var(--muted);font-size:18px;">Loading EV data…</span></div>
      <div id="clock-panel">
        <div id="clock-time">--:--:--</div>
        <div id="clock-date">--</div>
      </div>
    </div>
    <iframe id="mapframe" src="/testmap?adminKioskMode=true&pass=b6k192aw4bet"></iframe>
  </div>
</div>
<div class="credit">proof of concept created by pat cox • phc6j@virginia.edu</div>
<script>
const dateSpan=document.getElementById('dateDisplay');
const tbody=document.querySelector('#bustable tbody');
let OVERHEIGHT_BUSES=[];

function contrastColor(hex){
  if(!hex) return '#e8eef5';
  const c=hex.replace('#','');
  const r=parseInt(c.substr(0,2),16)/255;
  const g=parseInt(c.substr(2,2),16)/255;
  const b=parseInt(c.substr(4,2),16)/255;
  const l=0.2126*r+0.7152*g+0.0722*b;
  return l>0.5?'#000':'#fff';
}

async function loadConfig(){
  try{
    const cfg=await fetch('/v1/config');
    const data=await cfg.json();
    if(data.OVERHEIGHT_BUSES) OVERHEIGHT_BUSES=data.OVERHEIGHT_BUSES;
  }catch(_){ }
}

function friendlyBlock(name){
  const s=String(name||'').trim();
  // [N]-style names are already human-friendly
  if(s.includes('[')) return s;
  // For other names (Charter_01, Training, etc.) replace underscores with spaces
  return s.replace(/_/g,' ');
}

function deduplicateBlocks(names){
  const unique=[...new Set(names)];
  // Drop any name that is a word-boundary prefix of a longer name:
  // e.g. "[22]/[06]" is dropped when "[22]/[06] Detour" is also present
  return unique.filter((name,_,arr)=>
    !arr.some(other=>other!==name&&other.startsWith(name+' '))
  );
}

function todayStr(){
  // Treat "today" as the 24h period starting at the most recent 3AM
  const tz='America/New_York';
  const now=new Date();
  const hour=parseInt(new Intl.DateTimeFormat('en-US',{timeZone:tz,hour:'2-digit',hour12:false}).format(now),10);
  const day=hour<3?new Date(now.getTime()-86400000):now;
  return day.toLocaleDateString('en-CA',{timeZone:tz});
}
async function fetchData(){
  const date=todayStr();
  dateSpan.textContent=`Date: ${date}`;
  const res=await fetch(`/v1/servicecrew?date=${date}`);
  const data=await res.json();
  tbody.innerHTML='';
  const buses=Object.entries(data.buses)
    .sort(([,a],[,b]) => (b.actual_miles||0)-(a.actual_miles||0));
  for(const [b,info] of buses){
    const tr=document.createElement('tr');
    const blocks=info.blocks.length?deduplicateBlocks(info.blocks.map(friendlyBlock)).join(', '):'—';
    const totalMilesToday=(info.actual_miles||0).toFixed(2);
    tr.innerHTML=`<td>${b}</td><td>${blocks}</td><td>${totalMilesToday}</td>`;
    const busCell=tr.children[0];
    let bg='#EEE8AA';
    if(OVERHEIGHT_BUSES.includes(b)){
      bg='#E57200';
    }else if(b.startsWith('24')){
      bg='#232D4B';
    }
    busCell.style.background=bg;
    busCell.style.color=contrastColor(bg);

    const milesCell=tr.children[2];
    if((info.actual_miles||0)>=100){
      milesCell.classList.add('high-mileage');
    }
    tbody.appendChild(tr);
  }
}
  async function init(){
    await loadConfig();
    fetchData();
    setInterval(fetchData,30000);
    setInterval(loadConfig,30000);
  }
  init();
  const svcES=new EventSource('/v1/stream/servicecrew_refresh');
  svcES.onmessage=()=>location.reload();

  // Clock
  function updateClock(){
    const tz='America/New_York';
    const now=new Date();
    document.getElementById('clock-time').textContent=now.toLocaleTimeString('en-US',{timeZone:tz,hourCycle:'h23',hour:'2-digit',minute:'2-digit',second:'2-digit'});
    document.getElementById('clock-date').textContent=now.toLocaleDateString('en-US',{timeZone:tz,month:'2-digit',day:'2-digit',year:'numeric'});
  }
  updateClock();
  setInterval(updateClock,1000);

  // EV SOC
  let socData={};
  function renderSoc(){
    const panel=document.getElementById('soc-panel');
    const entries=Object.entries(socData).sort(([a],[b])=>a.localeCompare(b,undefined,{numeric:true}));
    if(!entries.length){panel.innerHTML='<span style="color:var(--muted);font-size:18px;">No EV data</span>';return;}
    panel.innerHTML=entries.map(([bus,d])=>{
      const soc=d.soc!=null?d.soc:null;
      const pct=soc!=null?Math.max(0,Math.min(100,soc)):0;
      const color=pct>40?'#4caf50':pct>20?'#ff9800':'#f44336';
      const label=soc!=null?Math.round(soc)+'%':'?';
      const chg=`<span class="soc-chg${d.charging?' soc-charging':''}" title="${d.charging?'Charging':''}">${d.charging?'⚡':''}</span>`;
      return `<div class="soc-row"><span class="soc-bus">${bus}</span>${chg}<div class="soc-bar-bg"><div class="soc-bar-fill" style="width:${pct}%;background:${color};"></div></div><span class="soc-pct">${label}</span></div>`;
    }).join('');
  }
  const socES=new EventSource('/v1/stream/viriciti/soc');
  socES.onmessage=(e)=>{
    const msg=JSON.parse(e.data);
    if(msg.type==='initial'){
      if(!msg.payload.enabled){document.getElementById('soc-panel').innerHTML='<span style="color:var(--muted);font-size:18px;">EV telemetry not enabled</span>';return;}
      socData=msg.payload.vehicles||{};
    }else if(msg.type==='soc_update'){
      const p=msg.payload;
      socData[p.bus_number]=p;
    }
    renderSoc();
  };
  </script>
  <script src="nav-bar.js"></script>
  </body>
  </html>
