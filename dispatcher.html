<!doctype html>
<link rel="icon" type="image/png" href="headwayguardicon.png" />
<meta charset="utf-8">
<title>Dispatch - Headway Guard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
@font-face{font-family:'FGDC';src:url('FGDC.ttf') format('truetype')}
:root{--route-color:#2a3442}
body{font-family:'FGDC',system-ui;font-size:17px;margin:0;background:#0b0e11;color:#e8eef5;display:flex;height:100vh;position:relative}
#left{overflow:auto}
header{display:flex;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid #1f2630;flex-wrap:wrap}
header h1{flex-basis:100%}
 #controls{display:flex;gap:10px;align-items:center;position:relative;padding-right:200px}
select{background:#10151c;color:#e8eef5;border:1px solid #2a3442;border-radius:10px;padding:8px 10px}
.chip{display:inline-block;border:1px solid #2a3442;border-radius:999px;padding:2px 8px;margin-left:8px;color:#cfe1ff}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border-bottom:1px solid #1f2630;padding:8px 10px;text-align:left}
#downed-table td{vertical-align:top}
#blocks-table,#future-blocks-table{width:auto;table-layout:fixed}
#blocks td,#future-blocks td{border:none;padding:2px 4px;text-align:center;width:12ch}
#blocks td .cell,#future-blocks td .cell{border-radius:4px;background:var(--route-color,transparent);color:var(--text-color,#e8eef5);display:flex;flex-direction:column;justify-content:center;align-items:center;width:100%;min-height:2.6em;max-height:2.6em;padding:2px 0;line-height:1.15}
#extra-buses{list-style:none;padding:0;margin:0;display:grid;grid-template-columns:repeat(auto-fill,minmax(10ch,1fr));gap:4px}
.panel-body{position:relative}
#extra-buses li{background:#10151c;border:1px solid #2a3442;border-radius:4px;padding:4px 6px;text-align:center;line-height:1.15;display:flex;align-items:center;justify-content:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-height:calc(1.2em + 8px)}
#extra-buses .hint{background:none;border:none;padding:0;grid-column:1/-1;text-align:left;display:block;white-space:normal;overflow:visible;text-overflow:clip;min-height:auto;line-height:inherit}
.mono{font-family:FGDC,ui-monospace,Menlo,Consolas,monospace}
body.cyberpunk .mono{font-family:'Courier Prime','Fira Code','Source Code Pro','IBM Plex Mono','Lucida Console','Courier New',monospace}
.pill{display:inline-flex;gap:8px;align-items:center;border:1px solid #2a3442;border-radius:999px;padding:4px 8px;background:#10151c}
.dot{width:10px;height:10px;border-radius:50%}
.ok{color:#b6f0cb}.ok .dot{background:#24c28a}
.warn{color:#ffe29a}.warn .dot{background:#ffbf47}
.bad{color:#ffb0b0}.bad .dot{background:#ff6b6b}
.hint{color:#9fb0c9}
.banner{display:none;position:absolute;right:0;top:50%;transform:translateY(-50%);padding:4px 8px;text-align:right;border-radius:4px}
.banner.error{background:#3b1f1f;color:#ffbfbf;border:1px solid #5a2b2b}
.banner.info{background:#121922;color:#cfe1ff;border:1px solid #2a3442}
h2{font-size:18px;margin:16px 0 0}
#layout{display:flex}
aside .panel+.panel{margin-top:16px}
body.kiosk-mode{font-size:16px;--kiosk-block-height:2.6em;--kiosk-entry-padding:4px}
body.kiosk-mode header{padding:10px 12px}
body.kiosk-mode #controls{flex-wrap:wrap;padding-right:0}
body.kiosk-mode #controls label{flex:1 1 140px}
body.kiosk-mode #banner{position:static;transform:none;margin-left:auto}
body.kiosk-mode #left{overflow:hidden;display:flex;flex-direction:column}
body.kiosk-mode #layout{flex:1;overflow:hidden}
body.kiosk-mode main{display:none}
body.kiosk-mode #layout aside{border-left:none;padding:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));grid-auto-rows:minmax(0,1fr);gap:12px}
body.kiosk-mode #layout aside .panel{margin:0;display:flex;flex-direction:column;min-height:0;background:#0f141c;border:1px solid #1f2630;border-radius:10px;padding:12px}
body.kiosk-mode #layout aside .panel h2{margin:0 0 8px;font-size:16px}
body.kiosk-mode #layout aside .panel .panel-body{flex:1;min-height:0;display:flex;flex-direction:column;overflow:hidden}
body.kiosk-mode #layout aside .panel .panel-body table{flex:1;overflow:auto;width:100%}
body.kiosk-mode #layout aside .panel .panel-body ul{flex:1;overflow:auto;margin:0;width:100%}
body.kiosk-mode #blocks-table,body.kiosk-mode #future-blocks-table,body.kiosk-mode #downed-table{width:100%;table-layout:fixed}
body.kiosk-mode #blocks td,body.kiosk-mode #future-blocks td{width:clamp(11ch,25%,14ch)}
body.kiosk-mode #blocks td .cell,body.kiosk-mode #future-blocks td .cell{min-height:var(--kiosk-block-height);max-height:var(--kiosk-block-height);padding:var(--kiosk-entry-padding) 0;gap:2px}
body.kiosk-mode #extra-buses{grid-template-columns:repeat(auto-fill,minmax(11ch,1fr));grid-auto-rows:auto;gap:6px}
body.kiosk-mode #extra-buses li{display:flex;align-items:center;justify-content:center;min-height:calc(1.2em + 2*var(--kiosk-entry-padding));padding:var(--kiosk-entry-padding) calc(var(--kiosk-entry-padding)*1.5)}
body.kiosk-mode #downed-table th,body.kiosk-mode #downed-table td{width:50%}
body.kiosk-mode #downed-table tbody tr{height:auto}
body.kiosk-mode #downed-table tbody td{padding:var(--kiosk-entry-padding) calc(var(--kiosk-entry-padding)*1.5);line-height:1.1}
body.kiosk-mode iframe#map-frame{flex:1.1;border-left:1px solid #1f2630}
body.kiosk-mode .credit{margin-top:auto;padding:8px 12px}
body.cyberpunk.kiosk-mode #layout aside .panel{background:rgba(3,18,28,.92);border-color:rgba(117,247,255,.35);box-shadow:0 0 18px rgba(0,255,255,.18)}
body.cyberpunk.kiosk-mode #layout aside .panel h2{color:#ff80ff}
@media(max-width:600px){
  #layout{flex-direction:column}
  #layout aside{border-left:none !important;border-top:1px solid #1f2630}
}
.credit{position:absolute;bottom:8px;right:8px;font-size:12px;color:var(--muted,#9fb0c9)}

body.cyberpunk{background:radial-gradient(circle at 20% 20%,rgba(0,255,255,.18),transparent 55%),radial-gradient(circle at 80% 35%,rgba(255,0,183,.18),transparent 60%),#02010a;color:#d9fbff;text-shadow:0 0 12px rgba(0,255,255,.35);position:relative;overflow:hidden;font-family:'Courier Prime','Fira Code','Source Code Pro','IBM Plex Mono','Lucida Console','Courier New',monospace}
body.cyberpunk::before{content:"";position:fixed;inset:0;background:repeating-linear-gradient(0deg,rgba(0,255,255,.04)0,rgba(0,255,255,.04)2px,transparent 2px,transparent 4px);mix-blend-mode:screen;pointer-events:none;animation:scanlines 8s linear infinite}
body.cyberpunk::after{content:"";position:fixed;inset:-40px;background:radial-gradient(circle at 15% 20%,rgba(0,255,255,.24),transparent 55%),radial-gradient(circle at 80% 15%,rgba(255,0,183,.28),transparent 50%),radial-gradient(circle at 70% 80%,rgba(0,255,170,.22),transparent 60%);filter:blur(18px);opacity:.7;pointer-events:none;z-index:-1}
body.cyberpunk .cyberpunk-hud-lines{position:fixed;inset:0;background:linear-gradient(120deg,rgba(117,247,255,.08)0,rgba(0,0,0,0)40%),linear-gradient(-120deg,rgba(255,0,183,.12)0,rgba(0,0,0,0)45%);mix-blend-mode:screen;pointer-events:none;animation:hudSweep 18s ease-in-out infinite alternate;opacity:.45;z-index:-2}
body.cyberpunk header{background:rgba(3,11,20,.92);border-bottom-color:rgba(0,255,255,.35);box-shadow:0 0 25px rgba(0,255,255,.2)}
body.cyberpunk header h1{letter-spacing:.08em;text-transform:uppercase;color:#75f7ff}
body.cyberpunk #controls{padding-right:230px}
body.cyberpunk select{background:rgba(4,16,26,.9);border:1px solid rgba(117,247,255,.6);color:#9dfcff;box-shadow:0 0 12px rgba(0,255,255,.3);text-shadow:none}
body.cyberpunk .chip{background:rgba(2,16,24,.75);border-color:rgba(255,0,183,.4);color:#9ad7ff;box-shadow:0 0 14px rgba(0,255,255,.2)}
body.cyberpunk table{background:rgba(2,12,22,.65);border:1px solid rgba(0,255,255,.18);box-shadow:0 15px 40px rgba(0,0,0,.35);backdrop-filter:blur(6px)}
body.cyberpunk th,body.cyberpunk td{border-color:rgba(0,255,255,.12)}
body.cyberpunk th{color:#76f7ff;text-transform:uppercase;letter-spacing:.12em;font-size:12px;background:linear-gradient(90deg,rgba(0,255,255,.15),rgba(255,0,183,.08))}
body.cyberpunk tbody tr:hover{background:rgba(0,255,255,.08)}
body.cyberpunk .pill{background:rgba(3,18,28,.95);border-color:rgba(117,247,255,.35);box-shadow:0 0 14px rgba(0,255,255,.25)}
body.cyberpunk .pill .dot{box-shadow:0 0 12px currentColor}
body.cyberpunk .ok{color:#4bffca}
body.cyberpunk .warn{color:#ffe680}
body.cyberpunk .bad{color:#ff8bb7}
body.cyberpunk .hint{color:#6aa9ff}
body.cyberpunk aside{border-left:1px solid rgba(255,0,183,.3)}
body.cyberpunk h2{color:#ff80ff;text-transform:uppercase;letter-spacing:.14em;font-size:15px;text-shadow:0 0 10px rgba(255,0,183,.4)}
body.cyberpunk #extra-buses li{background:rgba(3,15,27,.9);border-color:rgba(117,247,255,.24);color:#a9f6ff}
body.cyberpunk #map-frame{filter:contrast(1.2) saturate(1.45) hue-rotate(140deg) drop-shadow(-10px 0 25px rgba(0,255,255,.3));border-left:1px solid rgba(0,255,255,.35)}
body.cyberpunk .credit{color:#57caff;text-shadow:0 0 10px rgba(0,255,255,.4)}
body.cyberpunk .cyberpunk-grid{position:fixed;inset:-80px;background:linear-gradient(0deg,rgba(0,255,255,.09)1px,transparent 1px),linear-gradient(90deg,rgba(255,0,183,.09)1px,transparent 1px);background-size:120px 120px;mix-blend-mode:screen;opacity:.4;animation:gridDrift 28s linear infinite;pointer-events:none;z-index:-3}
body.cyberpunk .cyberpunk-vignette{position:fixed;inset:-160px;background:radial-gradient(circle at center,transparent 40%,rgba(0,0,0,.85)92%);pointer-events:none;z-index:-1}
body.cyberpunk .cyberpunk-corners{position:fixed;inset:0;pointer-events:none;z-index:3}
body.cyberpunk .corner{position:absolute;width:70px;height:70px;border:2px solid rgba(0,255,255,.45);box-shadow:0 0 20px rgba(0,255,255,.45);animation:pulseGlow 5s ease-in-out infinite}
body.cyberpunk .corner::after{content:"";position:absolute;background:rgba(255,0,183,.45);box-shadow:0 0 18px rgba(255,0,183,.7)}
body.cyberpunk .corner-tl{top:18px;left:18px;border-right:none;border-bottom:none;border-radius:12px 0 0 0}
body.cyberpunk .corner-tl::after{width:12px;height:2px;right:-6px;top:10px}
body.cyberpunk .corner-tr{top:18px;right:18px;border-left:none;border-bottom:none;border-radius:0 12px 0 0}
body.cyberpunk .corner-tr::after{width:2px;height:12px;bottom:-6px;left:10px}
body.cyberpunk .corner-bl{bottom:18px;left:18px;border-right:none;border-top:none;border-radius:0 0 0 12px}
body.cyberpunk .corner-bl::after{width:2px;height:12px;top:-6px;right:10px}
body.cyberpunk .corner-br{bottom:18px;right:18px;border-left:none;border-top:none;border-radius:0 0 12px 0}
body.cyberpunk .corner-br::after{width:12px;height:2px;left:-6px;bottom:10px}
body.cyberpunk .cyberpunk-ticker{position:absolute;left:18px;right:18px;bottom:12px;padding:10px 16px;border:1px solid rgba(0,255,255,.25);background:rgba(2,16,28,.92);box-shadow:0 0 26px rgba(0,255,255,.2);display:flex;align-items:center;gap:16px;font-size:13px;letter-spacing:.18em;text-transform:uppercase;overflow:hidden}
body.cyberpunk .ticker-label{color:#ff7afc;font-weight:bold}
body.cyberpunk .ticker-marquee{flex:1;display:flex;gap:48px;animation:tickerScroll 36s linear infinite}
body.cyberpunk .ticker-marquee span{white-space:nowrap;color:#9dfcff;text-shadow:0 0 12px rgba(0,255,255,.4)}
body.cyberpunk .cyberpunk-hud{margin:0 18px 18px;padding:18px;border:1px solid rgba(0,255,255,.18);background:rgba(4,20,32,.78);backdrop-filter:blur(12px);box-shadow:0 0 38px rgba(0,255,255,.2);display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;border-radius:14px;position:relative;overflow:hidden}
body.cyberpunk .cyberpunk-hud::before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,rgba(0,255,255,.08),rgba(255,0,183,.05));opacity:.65;pointer-events:none}
body.cyberpunk .cyberpunk-hud::after{content:"";position:absolute;inset:12px;border:1px solid rgba(0,255,255,.12);border-radius:10px;pointer-events:none;opacity:.6;box-shadow:0 0 18px rgba(0,255,255,.25)}
body.cyberpunk .hud-card{position:relative;padding:14px;border:1px solid rgba(117,247,255,.28);border-radius:10px;background:rgba(2,14,28,.88);box-shadow:inset 0 0 22px rgba(0,255,255,.15);display:flex;flex-direction:column;gap:6px;font-size:13px;letter-spacing:.08em;text-transform:uppercase}
body.cyberpunk .hud-card::before{content:"";position:absolute;inset:-1px;border-radius:10px;border:1px solid rgba(255,0,183,.18);opacity:.5;filter:blur(0);mix-blend-mode:screen}
body.cyberpunk .hud-card strong{font-size:22px;line-height:1;color:#7cfbff;text-shadow:0 0 18px rgba(0,255,255,.45)}
body.cyberpunk .hud-card span{color:#ff90ff;font-size:11px;letter-spacing:.16em}
body.cyberpunk .hud-card .hud-trend{font-size:12px;color:#a0ffba;letter-spacing:.12em}
body.cyberpunk .hud-card .hud-trend.warn{color:#ffe680}
body.cyberpunk .hud-card .hud-trend.bad{color:#ff7f9d}
body.cyberpunk .hud-card .hud-graph{height:42px;display:flex;align-items:flex-end;gap:4px}
body.cyberpunk .hud-card .hud-bar{flex:1;background:linear-gradient(180deg,rgba(0,255,255,.7),rgba(0,255,170,.2));border-radius:3px;box-shadow:0 0 12px rgba(0,255,255,.35);animation:holoPulse 4.2s ease-in-out infinite}
body.cyberpunk .hud-card .hud-bar:nth-child(odd){background:linear-gradient(180deg,rgba(255,0,183,.7),rgba(0,0,0,.2))}
body.cyberpunk .cyberpunk-orb{position:fixed;width:360px;height:360px;border:1px solid rgba(0,255,255,.2);border-radius:50%;top:12%;right:-120px;background:radial-gradient(circle at 40% 35%,rgba(0,255,255,.45),rgba(0,0,0,0)70%);box-shadow:0 0 120px rgba(0,255,255,.35);filter:blur(0);opacity:.6;pointer-events:none;animation:orbDrift 26s ease-in-out infinite;mix-blend-mode:screen;z-index:-2}
body.cyberpunk .cyberpunk-orb::after{content:"";position:absolute;inset:18%;border:1px solid rgba(255,0,183,.28);border-radius:50%;box-shadow:0 0 40px rgba(255,0,183,.45);animation:orbPulse 7s ease-in-out infinite}
body.cyberpunk .cyberpunk-datafall{position:fixed;inset:0;pointer-events:none;mix-blend-mode:screen;opacity:.55;z-index:-2}
body.cyberpunk .cyberpunk-holo-badge{position:absolute;top:60px;right:40px;padding:12px 20px;border:1px solid rgba(0,255,255,.45);background:rgba(2,18,32,.85);box-shadow:0 0 18px rgba(0,255,255,.35);text-transform:uppercase;letter-spacing:.24em;font-size:11px;color:#92f8ff;display:flex;align-items:center;gap:12px;border-radius:999px;backdrop-filter:blur(6px);animation:hudPulse 5s ease-in-out infinite}
body.cyberpunk .cyberpunk-holo-badge::before{content:"◎";color:#ff80ff;text-shadow:0 0 12px rgba(255,0,183,.6)}
body.cyberpunk .cyberpunk-holo-badge span{color:#0ff;text-shadow:0 0 10px rgba(0,255,255,.45)}
body.cyberpunk #left{background:rgba(2,10,22,.82);backdrop-filter:blur(12px);box-shadow:0 0 45px rgba(0,255,255,.18);border-right:1px solid rgba(255,0,183,.25);padding-bottom:70px}
body.cyberpunk header{position:sticky;top:0;z-index:5}
body.cyberpunk header::after{content:"";position:absolute;left:0;right:0;bottom:-1px;height:2px;background:linear-gradient(90deg,rgba(0,255,255,.6),rgba(255,0,183,.6),rgba(0,255,170,.6));box-shadow:0 0 12px rgba(0,255,255,.7);opacity:.85}
body.cyberpunk main,body.cyberpunk aside{position:relative}
body.cyberpunk main::before,body.cyberpunk aside::before{content:"";position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,rgba(0,255,255,.15),rgba(255,0,183,.1),transparent);opacity:.8}
body.cyberpunk #layout{position:relative}
body.cyberpunk #layout::after{content:"";position:absolute;inset:12px;border:1px solid rgba(0,255,255,.1);border-radius:12px;pointer-events:none;box-shadow:0 0 22px rgba(0,255,255,.14)}
body.cyberpunk table tbody tr{position:relative;transition:background .3s ease,transform .3s ease}
body.cyberpunk table tbody tr::after{content:"";position:absolute;inset:0;border:1px solid rgba(0,255,255,.05);border-radius:6px;pointer-events:none;opacity:0;transition:opacity .3s ease}
body.cyberpunk table tbody tr:hover{background:rgba(0,255,255,.1);transform:translateY(-1px)}
body.cyberpunk table tbody tr:hover::after{opacity:1}
body.cyberpunk select:focus{outline:none;box-shadow:0 0 0 2px rgba(0,255,255,.25)}
body.cyberpunk .banner{color:#9dfcff;background:rgba(3,18,28,.92);border-color:rgba(255,0,183,.35);box-shadow:0 0 16px rgba(255,0,183,.2)}
body.cyberpunk iframe#map-frame{box-shadow:inset 0 0 35px rgba(0,0,0,.6),0 0 45px rgba(0,255,255,.18);position:relative;z-index:1}
body.cyberpunk iframe#map-frame::backdrop{background:rgba(0,0,0,.6)}

body.cyberpunk .cyberpunk-runes{position:fixed;bottom:30px;right:32px;display:flex;gap:12px;pointer-events:none;z-index:4}
body.cyberpunk .cyberpunk-rune{padding:10px 14px;border:1px solid rgba(0,255,255,.3);border-radius:10px;background:rgba(2,16,28,.88);color:#9dfcff;font-size:12px;letter-spacing:.32em;text-transform:uppercase;box-shadow:0 0 16px rgba(0,255,255,.25);animation:runeBlink 6s linear infinite}
body.cyberpunk .cyberpunk-rune:nth-child(2){animation-delay:1.4s}
body.cyberpunk .cyberpunk-rune:nth-child(3){animation-delay:2.8s}

@keyframes gridDrift{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(-60px,-60px,0)}}
@keyframes scanlines{0%{transform:translateY(0)}100%{transform:translateY(-4px)}}
@keyframes bootGlitch{0%,100%{transform:translate(0)}20%{transform:translate(-2px,1px)}40%{transform:translate(3px,-2px)}60%{transform:translate(-1px,2px)}80%{transform:translate(2px,-1px)}}
@keyframes pulseGlow{0%,100%{opacity:.65;filter:drop-shadow(0 0 10px rgba(0,255,255,.4))}50%{opacity:1;filter:drop-shadow(0 0 22px rgba(0,255,255,.75))}}
@keyframes hudSweep{0%{opacity:.2;transform:translateY(-6%)}100%{opacity:.6;transform:translateY(6%)} }
@keyframes holoPulse{0%,100%{transform:scaleY(.75);opacity:.7}50%{transform:scaleY(1);opacity:1}}
@keyframes orbDrift{0%{transform:translate3d(0,0,0) rotate(0deg)}50%{transform:translate3d(-30px,10px,0) rotate(8deg)}100%{transform:translate3d(10px,-20px,0) rotate(-6deg)}}
@keyframes orbPulse{0%,100%{transform:scale(.85);opacity:.4}50%{transform:scale(1);opacity:1}}
@keyframes hudPulse{0%,100%{box-shadow:0 0 16px rgba(0,255,255,.35)}50%{box-shadow:0 0 32px rgba(255,0,183,.45)}}
@keyframes runeBlink{0%,40%,100%{opacity:.85}50%{opacity:.35}}
@keyframes tickerScroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}

#cli-preroll{position:fixed;inset:0;z-index:10000;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at center,rgba(0,8,6,.96)0%,rgba(0,4,2,.98)55%,rgba(0,0,0,.99)100%);color:#9dfcb1;font-family:'Courier Prime','Fira Code','Source Code Pro','IBM Plex Mono','Lucida Console','Courier New',monospace;letter-spacing:.04em;opacity:0;visibility:hidden;transition:opacity var(--cli-fade-duration,.42s) ease,visibility var(--cli-fade-duration,.42s) ease}
#cli-preroll.visible{opacity:1;visibility:visible}
#cli-preroll.fade-out{opacity:0;visibility:hidden}
#cli-preroll .cli-terminal{position:relative;width:min(640px,90vw);padding:32px 36px;border:1px solid rgba(138,247,155,.35);background:rgba(0,10,4,.9);box-shadow:0 0 40px rgba(0,255,120,.25);line-height:1.5;overflow:hidden}
#cli-preroll .cli-terminal::before{content:"";position:absolute;inset:-40%;background:radial-gradient(circle at center,rgba(0,255,120,.18),transparent 62%);opacity:.45;filter:blur(18px);animation:cliScan 7s ease-in-out infinite alternate;pointer-events:none}
#cli-preroll .cli-terminal::after{content:"";position:absolute;inset:0;background:repeating-linear-gradient(0deg,rgba(0,255,120,.08)0,rgba(0,255,120,.08)1px,transparent 1px,transparent 3px);opacity:.22;pointer-events:none}
#cli-preroll .cli-content{position:relative;z-index:1;display:flex;flex-direction:column;gap:6px;font-size:15px}
#cli-preroll .cli-line{white-space:pre;letter-spacing:.03em;color:#9dfcb1}
#cli-preroll .cli-line.cli-banner{color:#78f59d}
#cli-preroll .cli-line.cli-op{color:#b9ffcc}
#cli-preroll .cli-line.cli-command{color:#d3ffe1}
#cli-preroll .cli-line.cli-command .cli-prompt{margin-right:6px;color:#78f59d}
#cli-preroll .cli-line.typing::after,#cli-preroll .cli-line.cursor-hold::after{content:'█';margin-left:4px;animation:cliCursor 1s steps(1,end) infinite}
#cli-preroll .cli-footer{position:relative;z-index:1;margin-top:18px;color:rgba(157,252,177,.75);font-size:12px;letter-spacing:.18em;text-transform:uppercase}
#cli-preroll .cli-footer .cli-key{display:inline-block;margin:0 4px;padding:2px 6px;border:1px solid rgba(138,247,155,.35);border-radius:4px;background:rgba(6,26,12,.65);font-size:11px;letter-spacing:.16em}
@keyframes cliCursor{0%,45%{opacity:1}55%,100%{opacity:0}}
@keyframes cliScan{0%{transform:translateY(-6%)}100%{transform:translateY(6%)} }
@media (prefers-reduced-motion:reduce){
  #cli-preroll{transition:none}
  #cli-preroll .cli-terminal::before{animation:none}
}
#boot-overlay{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at center,rgba(0,8,16,.95)0%,rgba(0,0,0,.98)60%,rgba(0,0,0,.98)100%);color:#9dfcff;font-family:'Courier Prime','Fira Code','Source Code Pro','IBM Plex Mono','Lucida Console','Courier New',monospace;letter-spacing:.06em;text-transform:uppercase;transition:opacity .9s ease,visibility .9s ease;box-shadow:inset 0 0 80px rgba(0,255,255,.2);overflow:hidden}
#boot-overlay::before{content:"";position:absolute;inset:0;background:linear-gradient(120deg,rgba(0,255,255,.08),rgba(255,0,183,.05));mix-blend-mode:screen;animation:scanlines 6s linear infinite;opacity:.6}
#boot-overlay::after{content:"";position:absolute;inset:-50%;background:conic-gradient(from 90deg,rgba(0,255,255,.12),rgba(255,0,183,.08),rgba(0,255,170,.12),rgba(0,255,255,.12));animation:bootGlitch 3s linear infinite;opacity:.15;filter:blur(40px)}
#boot-overlay.boot-complete{opacity:0;visibility:hidden;pointer-events:none}
#boot-overlay .boot-inner{position:relative;z-index:1;width:min(640px,90vw);padding:40px 38px 34px;border:1px solid rgba(0,255,255,.25);box-shadow:0 0 40px rgba(0,255,255,.35);background:rgba(0,6,12,.85);backdrop-filter:blur(12px)}
#boot-overlay .boot-title{font-size:24px;color:#75f7ff;margin-bottom:24px;display:flex;align-items:center;gap:12px;text-shadow:0 0 20px rgba(0,255,255,.45);position:relative}
#boot-overlay .boot-title::after{content:"// CYBER DISPATCH";font-size:12px;color:#ff7afc;letter-spacing:.3em}
#boot-overlay .boot-title.glitch{animation:bootGlitch .4s steps(2,end)}
#boot-overlay .boot-progress{position:relative;height:12px;border:1px solid rgba(0,255,255,.4);background:rgba(0,0,0,.6);margin-bottom:12px;overflow:hidden}
#boot-overlay .boot-progress-fill{position:absolute;inset:0;width:0;background:linear-gradient(90deg,rgba(0,255,255,.8),rgba(255,0,183,.9));box-shadow:0 0 18px rgba(0,255,255,.6)}
#boot-overlay .boot-progress-label{display:flex;justify-content:space-between;font-size:12px;color:#57caff;margin-bottom:14px}
#boot-overlay .boot-log{height:180px;overflow:hidden;background:rgba(0,10,18,.9);border:1px solid rgba(0,255,255,.2);padding:16px;box-shadow:inset 0 0 14px rgba(0,255,255,.2);font-size:13px;line-height:1.6;display:flex;flex-direction:column;gap:6px}
#boot-overlay .boot-line{opacity:0;transform:translateY(8px);animation:fadeInUp .4s ease forwards}
#boot-overlay .boot-footer{margin-top:18px;font-size:11px;color:rgba(117,247,255,.7);letter-spacing:.3em;text-align:right}

@keyframes fadeInUp{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:translateY(0)}}
 </style>
<body>
<div id="left" style="flex:2;position:relative">
<header>
  <h1 style="font-size:18px;margin:0">Dispatch - Headway Guard</h1>
  <div id="controls">
    <label>Route: <select id="route"></select></label>
    <span id="target" class="chip">Target —</span>
    <span id="upd" class="chip">Updated — ago</span>
    <div id="banner" class="banner info"></div>
  </div>
</header>
<div id="layout">
  <main style="flex:1;padding:0 12px 16px">
    <h2>Headway Guard AntiBunching</h2>
    <table>
      <thead><tr>
        <th>Vehicle</th><th>Block</th><th>Order</th><th>Leader</th><th>Adjustment</th>
      </tr></thead>
      <tbody id="rows"><tr><td class="hint" colspan="5">Loading…</td></tr></tbody>
    </table>
    <h2>TransLoc AntiBunching</h2>
    <table>
      <thead><tr>
        <th>Vehicle</th><th>Block</th><th>Order</th><th>Leader</th><th>Adjustment</th>
      </tr></thead>
      <tbody id="rows-tl"><tr><td class="hint" colspan="5">Loading…</td></tr></tbody>
    </table>
  </main>
  <aside style="flex:1;padding:0 12px 16px;border-left:1px solid #1f2630">
    <section class="panel">
      <h2>Current Block Assignments</h2>
      <div class="panel-body">
        <table id="blocks-table">
          <tbody id="blocks"><tr><td class="hint">Loading…</td></tr></tbody>
        </table>
      </div>
    </section>
    <section class="panel">
      <h2>Future Block Assignments</h2>
      <div class="panel-body">
        <table id="future-blocks-table">
          <tbody id="future-blocks"><tr><td class="hint">Loading…</td></tr></tbody>
        </table>
      </div>
    </section>
    <section class="panel">
      <h2>Extra Buses</h2>
      <div class="panel-body">
        <ul id="extra-buses"><li class="hint">Loading…</li></ul>
      </div>
    </section>
    <section class="panel">
      <h2>Downed Buses</h2>
      <div class="panel-body">
        <table id="downed-table">
          <thead>
            <tr><th>Vehicle</th><th>Ops</th><th>Notes</th><th>Shop</th></tr>
          </thead>
          <tbody id="downed-rows"><tr><td class="hint" colspan="4">Loading…</td></tr></tbody>
        </table>
      </div>
    </section>
  </aside>
</div>
<div class="credit">proof of concept created by pat cox • phc6j@virginia.edu</div>
</div>
<iframe src="/testmap?dispatcher=true" id="map-frame" style="flex:1;border-left:1px solid #1f2630;border:none;height:100%"></iframe>
<script>
const $ = s => document.querySelector(s);
const fmt = s => { if (s==null || !isFinite(s)) return "—"; s = Math.round(s); return String(Math.floor(s/60)).padStart(2,'0')+":"+String(s%60).padStart(2,'0'); };
const pill = st => { const m = {green:["OK","ok"],yellow:["Slow Down","warn"],red:["HOLD","bad"]}; const [t,c] = m[st] || ["OK","ok"]; return '<span class="pill '+c+'"><span class="dot"></span><span>'+t+'</span></span>'; };
const DOWNED_ENDPOINT = '/v1/dispatcher/downed_buses';
const DOWNED_REFRESH_MS = 60000;
const DOWNED_SUFFIXES = new Set(['12','31','32']);
const OPS_STATUS_VALUES = new Set(['DOWNED','LIMITED','COSMETIC','COMFORT']);
const SHOP_STATUS_VALUES = new Set(['DOWN','UP','USABLE']);
const STATUS_LABELS = {DOWNED:'Downed',LIMITED:'Limited',COSMETIC:'Cosmetic',COMFORT:'Comfort',DOWN:'Down',UP:'Up',USABLE:'Usable'};

const urlParams = new URLSearchParams(window.location.search);
const CYBERPUNK_ENABLED = urlParams.get('cyberpunk') === 'true';
const KIOSK_MODE = urlParams.has('kioskMode');
const DOWNED_TABLE_COLSPAN = KIOSK_MODE ? 2 : 4;
if (KIOSK_MODE) {
  document.body.classList.add('kiosk-mode');
}
if (CYBERPUNK_ENABLED) {
  const mapFrame = document.getElementById('map-frame');
  if (mapFrame) {
    const url = new URL(mapFrame.getAttribute('src'), window.location.origin);
    url.pathname = '/radar';
    mapFrame.src = url.pathname + url.search;
  }
  activateCyberpunkMode();
}

if (KIOSK_MODE) {
  const downedTable = document.getElementById('downed-table');
  if (downedTable) {
    const headers = downedTable.querySelectorAll('thead th');
    headers.forEach((th, index) => {
      if (index > 1) {
        th.remove();
      }
    });
    downedTable.querySelectorAll('tbody td[colspan]').forEach(cell => {
      cell.colSpan = DOWNED_TABLE_COLSPAN;
    });
  }
}

function normalizeHeaderText(value){
  return (value||'').replace(/\s+/g,' ').trim().toLowerCase();
}

const DOWNED_HEADER_VARIANTS = [
  ['Bus','Status','Date','Supervisor','Notes/Description','Diagnostic Date','Mechanic','Diagnostic Description','Current ETA','Actual Delivery Date','Status'],
  ['P&T Support Vehicle','Status','Date','Supervisor','Notes/Description','Diagnostic Date','Mechanic','Diagnostic Description','Current ETA','Actual Delivery Date','Status']
].map(h=>h.map(normalizeHeaderText));
async function j(u){ const r = await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(r.status); return r.json(); }
function setBanner(txt,kind){ const b=$('#banner'); if(!txt){ b.style.display='none'; b.textContent=''; return; } b.className='banner '+(kind||'info'); b.textContent=txt; b.style.display='block'; }

function runCyberpunkBootSequence(){
  if(!CYBERPUNK_ENABLED) return Promise.resolve();
  const overrideKey='Escape';
  const overrideLabel=overrideKey==='Escape'?'ESC':overrideKey.toUpperCase();
  return new Promise(resolve=>{
    const overlay=document.createElement('div');
    overlay.id='cli-preroll';
    overlay.setAttribute('role','dialog');
    overlay.setAttribute('aria-modal','true');
    overlay.setAttribute('aria-label','Dispatcher interface boot sequence');
    overlay.setAttribute('aria-live','polite');
    overlay.tabIndex=-1;
    overlay.innerHTML=`
      <div class="cli-terminal">
        <div class="cli-content" aria-live="polite" aria-atomic="false"></div>
        <div class="cli-footer">Press <span class="cli-key">${overrideLabel}</span> to skip</div>
      </div>`;
    document.body.appendChild(overlay);

    const content=overlay.querySelector('.cli-content');
    if(!content){
      overlay.remove();
      resolve();
      return;
    }
    const prefersReduced=window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const charDelay=prefersReduced?0:18;
    const linePause=prefersReduced?80:70;
    const bannerPause=prefersReduced?180:320;
    const commandPause=prefersReduced?140:220;
    const finalPause=prefersReduced?200:380;
    const fadeDuration=prefersReduced?180:420;
    overlay.style.setProperty('--cli-fade-duration', fadeDuration+'ms');

    const bannerLines=[
      'Phoenix BIOS v4.06 (C) 1985-2001',
      'Memory Test: 640K OK',
      'Initializing devices...'
    ];
    const typedLines=[
      'POST diagnostics.............. OK',
      'Loading system drivers........ OK',
      'Mounting volume A:\\ .......... OK',
      'Calibrating dispatch relays... OK'
    ];
    const commandText='RUN DISPATCHER.EXE';

    const wait=ms=>new Promise(r=>setTimeout(r,ms));
    const appendLine=(text,className)=>{
      const line=document.createElement('div');
      line.className='cli-line'+(className?' '+className:'');
      if(text!=null) line.textContent=text;
      content.appendChild(line);
      content.scrollTop=content.scrollHeight;
      return line;
    };

    const typeText=(text,target,holdCursor)=>new Promise(done=>{
      const lineEl=target.closest?target.closest('.cli-line'):target;
      if(!lineEl){ done(); return; }
      const applyFinal=()=>{
        target.textContent=text;
        lineEl.classList.remove('typing');
        if(holdCursor) lineEl.classList.add('cursor-hold');
        done();
      };
      if(charDelay<=0){
        applyFinal();
        return;
      }
      lineEl.classList.add('typing');
      target.textContent='';
      let idx=0;
      const step=()=>{
        if(finished){
          applyFinal();
          return;
        }
        target.textContent=text.slice(0,idx+1);
        idx++;
        if(idx<text.length){
          setTimeout(step,charDelay);
        }else{
          applyFinal();
        }
      };
      step();
    });

    const typeLine=(text,className)=>{
      const line=appendLine('',className);
      return typeText(text,line,false).then(()=>line);
    };

    const appendCommandLine=()=>{
      const line=document.createElement('div');
      line.className='cli-line cli-command';
      line.innerHTML='<span class="cli-prompt">A:\\></span><span class="cli-type"></span>';
      content.appendChild(line);
      content.scrollTop=content.scrollHeight;
      return line;
    };

    let finished=false;
    const cleanup=()=>{
      document.removeEventListener('keydown',handleKey);
      if(overlay.parentNode) overlay.parentNode.removeChild(overlay);
    };
    const startFade=()=>{
      if(finished) return;
      finished=true;
      overlay.classList.add('fade-out');
      setTimeout(()=>{
        cleanup();
        resolve();
      },fadeDuration);
    };
    const handleKey=ev=>{
      if(ev.key===overrideKey){
        ev.preventDefault();
        startFade();
      }
    };

    document.addEventListener('keydown',handleKey);
    requestAnimationFrame(()=>{
      overlay.classList.add('visible');
      try{ overlay.focus({preventScroll:true}); }catch(_){ overlay.focus(); }
    });

    (async()=>{
      bannerLines.forEach(text=>appendLine(text,'cli-banner'));
      await wait(bannerPause);
      if(finished) return;
      for(const text of typedLines){
        await typeLine(text,'cli-op');
        if(finished) return;
        await wait(linePause);
        if(finished) return;
      }
      const commandLine=appendCommandLine();
      const target=commandLine.querySelector('.cli-type');
      if(target){
        await typeText(commandText,target,true);
        if(finished) return;
      }
      await wait(commandPause);
      if(finished) return;
      appendLine('Executing DISPATCHER.EXE...','cli-op');
      await wait(finalPause);
      if(finished) return;
      startFade();
    })().catch(()=>{
      if(!finished) startFade();
    });
  });
}

function activateCyberpunkMode(){
  document.body.classList.add('cyberpunk');
  document.documentElement.style.setProperty('color-scheme','dark');

  const datafallCanvas=document.createElement('canvas');
  datafallCanvas.className='cyberpunk-datafall';
  document.body.prepend(datafallCanvas);

  const grid=document.createElement('div');
  grid.className='cyberpunk-grid';
  document.body.prepend(grid);

  const vignette=document.createElement('div');
  vignette.className='cyberpunk-vignette';
  document.body.prepend(vignette);

  const hudLines=document.createElement('div');
  hudLines.className='cyberpunk-hud-lines';
  document.body.appendChild(hudLines);

  const orb=document.createElement('div');
  orb.className='cyberpunk-orb';
  document.body.appendChild(orb);

  const corners=document.createElement('div');
  corners.className='cyberpunk-corners';
  corners.innerHTML='<span class="corner corner-tl"></span><span class="corner corner-tr"></span><span class="corner corner-bl"></span><span class="corner corner-br"></span>';
  document.body.appendChild(corners);

  const holoBadge=document.createElement('div');
  holoBadge.className='cyberpunk-holo-badge';
  holoBadge.innerHTML='Neural Dispatch Core <span>STANDING BY</span>';
  document.body.appendChild(holoBadge);

  const runeContainer=document.createElement('div');
  runeContainer.className='cyberpunk-runes';
  const runePhrases=['ALIGN','VECTOR','SPECTRUM'];
  runePhrases.forEach(text=>{
    const rune=document.createElement('div');
    rune.className='cyberpunk-rune';
    rune.textContent=text;
    runeContainer.appendChild(rune);
  });
  document.body.appendChild(runeContainer);

  const runeVariants=['ALIGN','VECTOR','SPECTRUM','NEURAL','STASIS','PRIME','AURORA'];
  const holoMessages=['STANDING BY','OVERRIDE READY','LINKED','FIELD SYNC','OMNI CONTROL'];
  setInterval(()=>{
    const badgeSpan=holoBadge.querySelector('span');
    if(badgeSpan){
      badgeSpan.textContent=holoMessages[Math.floor(Math.random()*holoMessages.length)];
    }
    runeContainer.querySelectorAll('.cyberpunk-rune').forEach(rune=>{
      rune.textContent=runeVariants[Math.floor(Math.random()*runeVariants.length)];
    });
  },6200);

  const ctx=datafallCanvas.getContext('2d');
  const glyphs='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ△▽◇✶☰☷⟁';
  let rainWidth=0;
  let rainHeight=0;
  let columns=0;
  let drops=[];
  const resizeRain=()=>{
    const dpr=window.devicePixelRatio||1;
    rainWidth=window.innerWidth;
    rainHeight=window.innerHeight;
    datafallCanvas.width=rainWidth*dpr;
    datafallCanvas.height=rainHeight*dpr;
    datafallCanvas.style.width=rainWidth+'px';
    datafallCanvas.style.height=rainHeight+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
    const charSize=18;
    columns=Math.floor(rainWidth/charSize);
    drops=new Array(columns).fill(0);
  };
  resizeRain();
  window.addEventListener('resize',resizeRain);

  const drawRain=()=>{
    ctx.fillStyle='rgba(0,10,20,0.16)';
    ctx.fillRect(0,0,rainWidth,rainHeight);
    ctx.fillStyle='rgba(0,255,255,0.9)';
    ctx.shadowBlur=12;
    ctx.shadowColor='rgba(0,255,255,0.55)';
    ctx.font='16px "Courier Prime", monospace';
    for(let i=0;i<columns;i++){
      const text=glyphs[Math.floor(Math.random()*glyphs.length)];
      const x=i*18;
      const y=drops[i]*18;
      ctx.fillText(text,x,y);
      if(y>rainHeight && Math.random()>0.95){
        drops[i]=0;
      }else{
        drops[i]+=1;
      }
    }
    requestAnimationFrame(drawRain);
  };
  requestAnimationFrame(drawRain);

  const leftPane=document.getElementById('left');
  if(leftPane){
    const hud=document.createElement('div');
    hud.className='cyberpunk-hud';
    hud.innerHTML=`
      <div class="hud-card" data-card="variance">
        <span>Headway Variance</span>
        <strong data-value="variance">00.0s</strong>
        <div class="hud-trend" data-trend="variance">Δ +0.0 HOLD</div>
        <div class="hud-graph" data-graph="variance">${'<div class="hud-bar"></div>'.repeat(8)}</div>
      </div>
      <div class="hud-card" data-card="latency">
        <span>Neural Latency</span>
        <strong data-value="latency">000ms</strong>
        <div class="hud-trend warn" data-trend="latency">Δ +0.0 ALERT</div>
        <div class="hud-graph" data-graph="latency">${'<div class="hud-bar"></div>'.repeat(6)}</div>
      </div>
      <div class="hud-card" data-card="integrity">
        <span>Route Integrity</span>
        <strong data-value="integrity">000%</strong>
        <div class="hud-trend" data-trend="integrity">Δ +0.0 STABLE</div>
        <div class="hud-graph" data-graph="integrity">${'<div class="hud-bar"></div>'.repeat(5)}</div>
      </div>`;
    const layout=document.getElementById('layout');
    if(layout){
      leftPane.insertBefore(hud,layout);
    }else{
      leftPane.appendChild(hud);
    }

    const randomBetween=(min,max)=>Math.random()*(max-min)+min;
    const hudState={variance:'00.0s',latency:'000ms',integrity:'000%'};
    const setTrend=(name,delta,unit,labels)=>{
      const el=hud.querySelector(`[data-trend="${name}"]`);
      if(!el) return;
      el.classList.remove('warn','bad');
      const textDelta=`${delta>0?'+':''}${delta.toFixed(unit==='%'?1:1)}${unit||''}`;
      let suffix=' HOLD';
      if(delta>1.2 || (unit==='%' && delta>0.6)){
        el.classList.add('bad');
        suffix=' ALERT';
      }else if(delta>0.4 || (unit==='%' && delta>0.3)){
        el.classList.add('warn');
        suffix=' WATCH';
      }else if(delta<0){
        suffix=' CALM';
      }
      if(Array.isArray(labels) && labels.length){
        suffix=' '+labels[Math.floor(Math.random()*labels.length)];
      }
      el.textContent=`Δ ${textDelta}${suffix}`;
    };
    const updateGraph=name=>{
      const graph=hud.querySelector(`[data-graph="${name}"]`);
      if(!graph) return;
      const bars=graph.querySelectorAll('.hud-bar');
      bars.forEach((bar,index)=>{
        bar.style.height=Math.round(randomBetween(25,100))+'%';
        bar.style.opacity=(0.6+Math.random()*0.4).toFixed(2);
        bar.style.animationDelay=(index*0.18)+'s';
      });
    };
    const updateHud=()=>{
      const variance=randomBetween(4.8,18.6);
      hudState.variance=variance.toFixed(1)+'s';
      const varianceValue=hud.querySelector('[data-value="variance"]');
      if(varianceValue) varianceValue.textContent=hudState.variance;
      setTrend('variance',randomBetween(-1.2,2.4),'s',['HOLD','STABLE','SYNC']);
      updateGraph('variance');

      const latency=randomBetween(36,220);
      hudState.latency=Math.round(latency)+'ms';
      const latencyValue=hud.querySelector('[data-value="latency"]');
      if(latencyValue) latencyValue.textContent=hudState.latency;
      setTrend('latency',randomBetween(-8,12),'ms',['ALERT','TRACK','LINK']);
      updateGraph('latency');

      const integrity=randomBetween(88,99.4);
      hudState.integrity=integrity.toFixed(1)+'%';
      const integrityValue=hud.querySelector('[data-value="integrity"]');
      if(integrityValue) integrityValue.textContent=hudState.integrity;
      setTrend('integrity',randomBetween(-0.6,0.9),'%',['STABLE','LOCK','FIELD']);
      updateGraph('integrity');
    };
    updateHud();
    setInterval(updateHud,4600);

    const ticker=document.createElement('div');
    ticker.className='cyberpunk-ticker';
    const label=document.createElement('span');
    label.className='ticker-label';
    label.textContent='UPLINK';
    const marquee=document.createElement('div');
    marquee.className='ticker-marquee';
    const spanA=document.createElement('span');
    const spanB=document.createElement('span');
    marquee.append(spanA,spanB);
    ticker.append(label,marquee);
    leftPane.appendChild(ticker);

    const tickerPhrases=['FIELD OPS READY','SYNTH GRID ONLINE','OVERRIDE CHANNEL ARMED','DRONE RELAY CLEAN','SPECTRUM HOLD'];
    const randomFrom=arr=>arr[Math.floor(Math.random()*arr.length)];

    const refreshTicker=()=>{
      const now=new Date();
      const segments=[
        'NODE '+(window.location.hostname||'DISPATCH'),
        'SYNC '+now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
        'VAR '+hudState.variance.toUpperCase(),
        'LAT '+hudState.latency.toUpperCase(),
        'INT '+hudState.integrity.toUpperCase(),
        randomFrom(tickerPhrases),
        'CODE '+Math.floor(Math.random()*4096).toString(16).toUpperCase().padStart(3,'0')
      ];
      const text=segments.join(' // ');
      spanA.textContent=text;
      spanB.textContent=text;
    };

    refreshTicker();
    setInterval(refreshTicker,15000);
  }

  runCyberpunkBootSequence().then(()=>startCyberpunkSplash());
}

function startCyberpunkSplash(){
  const overlay=document.createElement('div');
  overlay.id='boot-overlay';
  overlay.innerHTML=`
    <div class="boot-inner">
      <div class="boot-title">Dispatcher Neural Link</div>
      <div class="boot-progress"><div class="boot-progress-fill"></div></div>
      <div class="boot-progress-label"><span>STATUS</span><span class="boot-progress-value">0%</span></div>
      <div class="boot-log"></div>
      <div class="boot-footer">Click or press any key to skip boot sequence</div>
    </div>`;
  document.body.appendChild(overlay);

  const title=overlay.querySelector('.boot-title');
  const log=overlay.querySelector('.boot-log');
  const progressFill=overlay.querySelector('.boot-progress-fill');
  const progressValue=overlay.querySelector('.boot-progress-value');
  const steps=[
    {delay:400,text:'<span class="hint">[SYS]</span> Starting grounds fiber uplink…'},
    {delay:520,text:'<span class="hint">[CORE]</span> Booting Headway Guard primary systems.'},
    {delay:540,text:'<span class="hint">[SENSORS]</span> Syncing with all AVL beacons <span class="ok">LOCKED</span>.',glitch:true},
    {delay:460,text:'<span class="hint">[OPS]</span> Parsing block assignments &mdash; vehicles within tolerance.'},
    {delay:580,text:'<span class="hint">[AI]</span> Predictive load balancer compiling headway futures…',glitch:true},
    {delay:500,text:'<span class="hint">[MAP]</span> Extruding 3D route lattice and holo-grid.'},
    {delay:480,text:'<span class="hint">[DOWNLINK]</span> Syncing downed bus dossier &amp; shop intel.'},
    {delay:540,text:'<span class="hint">[COMM]</span> Establishing encrypted radio channel for emergency comms.'},
    {delay:520,text:'<span class="hint">[AUDIO]</span> Deploying synthwave ambience for tactical focus.'},
    {delay:640,text:'<span class="hint">[READY]</span> Dispatch authority granted. Maintain headway. <span class="ok">ONLINE</span>',glitch:true}
  ];
  const totalSteps=steps.length;

  const bootSound=new Audio('https://assets.mixkit.co/sfx/preview/mixkit-futuristic-tech-ui-interface-click-1125.mp3');
  bootSound.volume=0.6;
  const ambientSound=new Audio('https://assets.mixkit.co/music/preview/mixkit-ambient-futuristic-straight-pattern-715.mp3');
  ambientSound.loop=true;
  ambientSound.volume=0.18;

  const ensurePlayback=audio=>{
    if(!audio) return;
    audio.play().catch(()=>{
      const resume=()=>{
        audio.play().catch(()=>{});
      };
      document.addEventListener('pointerdown',resume,{once:true});
      document.addEventListener('keydown',resume,{once:true});
    });
  };
  ensurePlayback(bootSound);
  setTimeout(()=>ensurePlayback(ambientSound),900);

  let finished=false;
  const finishBoot=()=>{
    if(finished) return;
    finished=true;
    progressFill.style.width='100%';
    progressValue.textContent='ONLINE';
    overlay.classList.add('boot-complete');
    setTimeout(()=>{
      overlay.remove();
    },900);
  };

  overlay.addEventListener('click',finishBoot);
  window.addEventListener('keydown',finishBoot,{once:true});

  let elapsed=0;
  steps.forEach((step,index)=>{
    elapsed+=step.delay;
    setTimeout(()=>{
      const el=document.createElement('div');
      el.className='boot-line';
      el.innerHTML=step.text;
      log.appendChild(el);
      log.scrollTop=log.scrollHeight;
      const pct=Math.min(100,Math.round(((index+1)/totalSteps)*100));
      progressFill.style.width=pct+'%';
      progressValue.textContent=pct+'%';
      if(step.glitch){
        title.classList.add('glitch');
        setTimeout(()=>title.classList.remove('glitch'),220);
      }
    },elapsed);
  });

  setTimeout(finishBoot,elapsed+900);
}

function htmlEscape(str){
  if(str==null) return '';
  return String(str).replace(/[&<>"']/g,ch=>({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  })[ch]);
}

function htmlEscapeMultiline(str){
  return htmlEscape(str).replace(/\r?\n/g,'<br>');
}

function normalizeOpsStatus(val){
  const raw=(val||'').trim();
  if(!raw) return '';
  const up=raw.toUpperCase();
  if(OPS_STATUS_VALUES.has(up)) return up;
  if(up==='DOWN') return 'DOWNED';
  return '';
}

function normalizeShopStatus(val){
  const raw=(val||'').trim();
  if(!raw) return '';
  const up=raw.toUpperCase();
  if(SHOP_STATUS_VALUES.has(up)) return up;
  if(up==='DOWNED') return 'DOWN';
  return '';
}

function parseCsv(text){
  const rows=[];
  let row=[];
  let cur='';
  let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(inQuotes){
      if(ch==='"'){
        if(text[i+1]==='"'){ cur+='"'; i++; }
        else{ inQuotes=false; }
      }else{
        cur+=ch;
      }
    }else{
      if(ch==='"') inQuotes=true;
      else if(ch===','){ row.push(cur); cur=''; }
      else if(ch==='\r'){ /* ignore */ }
      else if(ch==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
      else cur+=ch;
    }
  }
  if(inQuotes) inQuotes=false;
  if(cur!=='' || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

function rowMatchesHeader(row){
  return DOWNED_HEADER_VARIANTS.some(header=>{
    for(let i=0;i<header.length;i++){
      const cell=normalizeHeaderText(row[i]);
      if(cell!==header[i]) return false;
    }
    return true;
  });
}

function parseDateValue(str){
  const raw=(str||'').trim();
  if(!raw) return null;
  const parsed=Date.parse(raw);
  if(!Number.isNaN(parsed)) return parsed;
  const m=raw.match(/^(\d{1,2})[\/-](\d{1,2})(?:[\/-](\d{2,4}))?$/);
  if(m){
    let [,mm,dd,yy]=m;
    const month=parseInt(mm,10)-1;
    const day=parseInt(dd,10);
    let year;
    if(yy==null){
      year=new Date().getFullYear();
    }else{
      year=parseInt(yy,10);
      if(year<100) year+=2000;
    }
    const dt=new Date(year,month,day);
    if(dt.getFullYear()===year && dt.getMonth()===month && dt.getDate()===day){
      return dt.getTime();
    }
  }
  return null;
}

function formatDateValue(ts){
  if(ts==null) return '';
  const d=new Date(ts);
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

function normalizeDateField(str){
  const raw=(str||'').trim();
  if(!raw) return {text:'',value:null};
  const value=parseDateValue(raw);
  if(value==null) return {text:raw,value:null};
  return {text:formatDateValue(value),value};
}

function maxDateValue(...values){
  let max=null;
  for(const v of values){
    if(v==null) continue;
    if(max==null || v>max) max=v;
  }
  return max;
}

function buildVehicleRecord(row){
  const id=(row[0]||'').trim();
  if(!id) return null;
  const opsStatus=normalizeOpsStatus(row[1]);
  const opsDate=normalizeDateField(row[2]);
  const shopDiagDate=normalizeDateField(row[5]);
  const shopActualDate=normalizeDateField(row[9]);
  const shopStatus=normalizeShopStatus(row[10]);
  const record={
    vehicleId:id,
    opsStatus,
    opsDateText:opsDate.text,
    opsDateValue:opsDate.value,
    opsSupervisor:(row[3]||'').trim(),
    opsNotes:(row[4]||'').trim(),
    shopDiagDateText:shopDiagDate.text,
    shopDiagDateValue:shopDiagDate.value,
    shopMechanic:(row[6]||'').trim(),
    shopDiagNotes:(row[7]||'').trim(),
    shopETA:(row[8]||'').trim(),
    shopActualDeliveryText:shopActualDate.text,
    shopActualDeliveryValue:shopActualDate.value,
    shopStatus,
    shopLatestValue:maxDateValue(shopDiagDate.value,shopActualDate.value)
  };
  record.isDown = record.opsStatus==='DOWNED' && (!record.shopStatus || record.shopStatus==='DOWN');
  return record;
}

function isRecordNewer(newRec,oldRec){
  const a=newRec.opsDateValue;
  const b=oldRec.opsDateValue;
  if(a!=null || b!=null){
    if(a==null) return false;
    if(b==null) return true;
    if(a!==b) return a>b;
  }
  const sa=newRec.shopLatestValue;
  const sb=oldRec.shopLatestValue;
  if(sa!=null || sb!=null){
    if(sa==null) return false;
    if(sb==null) return true;
    if(sa!==sb) return sa>sb;
  }
  return false;
}

function dedupeVehicleRecords(records){
  const byId=new Map();
  for(const rec of records){
    const existing=byId.get(rec.vehicleId);
    if(!existing || isRecordNewer(rec,existing)){
      byId.set(rec.vehicleId,rec);
    }
  }
  return Array.from(byId.values());
}

function parseVehicleSheet(text){
  const rawRows=parseCsv(text);
  if(!rawRows.length) return [];
  const rows=rawRows.map(r=>r.map(c=>c.trim()));
  let firstRowSkipped=false;
  let inSection=false;
  const records=[];
  for(const row of rows){
    if(!firstRowSkipped){
      firstRowSkipped=true;
      continue;
    }
    if(rowMatchesHeader(row)){
      inSection=true;
      continue;
    }
    if(!inSection) continue;
    if(row.every(cell=>!cell.trim())) continue;
    const rec=buildVehicleRecord(row);
    if(rec) records.push(rec);
  }
  return dedupeVehicleRecords(records);
}

function statusLabel(status){
  if(!status) return '';
  return STATUS_LABELS[status] || (status.charAt(0)+status.slice(1).toLowerCase());
}

let lastDownedRows=[];
let downedBusFullIds=new Set();
let downedBusBaseIds=new Set();

function extractDigits(str){
  return (str||'').replace(/\D+/g,'');
}

function refreshDownedBusSets(rows){
  downedBusFullIds=new Set();
  downedBusBaseIds=new Set();
  for(const row of rows){
    const rawId=String(row?.vehicleId||'').trim();
    if(!rawId) continue;
    const digits=extractDigits(rawId);
    if(digits.length>=5){
      downedBusFullIds.add(digits.slice(-5));
    }else if(digits.length>=3){
      downedBusBaseIds.add(digits);
      if(digits.length>3){
        downedBusBaseIds.add(digits.slice(-3));
      }
    }
  }
}

function isBusDowned(busId){
  const digits=extractDigits(busId);
  if(!digits) return false;
  if(downedBusFullIds.has(digits.slice(-5))) return true;
  if(digits.length>=5){
    const base=digits.slice(0,-2);
    const suffix=digits.slice(-2);
    if(DOWNED_SUFFIXES.has(suffix)){
      if(downedBusBaseIds.has(base) || downedBusBaseIds.has(base.slice(-3))) return true;
    }
  }
  return false;
}

function renderDownedVehicles(rows){
  const tbody=$('#downed-rows');
  if(!tbody) return;
  lastDownedRows=rows.slice();
  refreshDownedBusSets(rows);
  updateExtraBuses();
  if(!rows.length){
    tbody.innerHTML=`<tr><td class="hint" colspan="${DOWNED_TABLE_COLSPAN}">All buses available.</td></tr>`;
    return;
  }
  tbody.innerHTML=rows.map(row=>{
    const statusChip=row.opsStatus
      ? `<div><span class="pill ${row.opsStatus==='DOWNED'?'bad':'warn'}"><span class="dot"></span><span>${htmlEscape(statusLabel(row.opsStatus))}</span></span></div>`
      : '';
    const opsParts=[
      statusChip,
      row.opsDateText?`<div><strong>Reported:</strong> ${htmlEscape(row.opsDateText)}</div>`:'',
      row.opsSupervisor?`<div class="hint">${htmlEscape(row.opsSupervisor)}</div>`:''
    ].filter(Boolean).join('');
    const notes=row.opsNotes?htmlEscapeMultiline(row.opsNotes):'<span class="hint">None</span>';
    const shopParts=[
      row.shopStatus?`<div><strong>Status:</strong> ${htmlEscape(statusLabel(row.shopStatus))}</div>`:'',
      row.shopDiagDateText||row.shopMechanic
        ? `<div><strong>Diag:</strong> ${htmlEscape(row.shopDiagDateText||'—')}${row.shopMechanic?` <span class="hint">${htmlEscape(row.shopMechanic)}</span>`:''}</div>`
        : '',
      row.shopDiagNotes?`<div>${htmlEscapeMultiline(row.shopDiagNotes)}</div>`:'',
      row.shopETA?`<div><strong>ETA:</strong> ${htmlEscape(row.shopETA)}</div>`:'',
      row.shopActualDeliveryText?`<div><strong>Delivery:</strong> ${htmlEscape(row.shopActualDeliveryText)}</div>`:''
    ].filter(Boolean);
    if(!shopParts.length) shopParts.push('<div class="hint">No shop updates yet.</div>');
    const cells=[
      `<td class="mono">${htmlEscape(row.vehicleId)}</td>`,
      `<td>${opsParts||'<span class="hint">—</span>'}</td>`
    ];
    if(!KIOSK_MODE){
      cells.push(`<td>${notes}</td>`);
      cells.push(`<td>${shopParts.join('')}</td>`);
    }
    return `<tr>${cells.join('')}</tr>`;
  }).join('');
}

async function loadDownedBuses(){
  const tbody=$('#downed-rows');
  if(!tbody) return;
  try{
    const res=await fetch(DOWNED_ENDPOINT,{cache:'no-store'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const payload=await res.json();
    if(payload && payload.error){
      console.warn('Downed buses sheet returned with warning:', payload.error);
    }
    const text=payload && typeof payload.csv==='string'?payload.csv:'';
    const records=parseVehicleSheet(text);
    const downed=records.filter(r=>r.isDown);
    renderDownedVehicles(downed);
  }catch(err){
    if(!lastDownedRows.length){
      tbody.innerHTML=`<tr><td class="hint" colspan="${DOWNED_TABLE_COLSPAN}">Unable to load.</td></tr>`;
    }
    console.error('Failed to load downed buses sheet', err);
  }
}

function contrastColor(hex){
  if(!hex) return '#e8eef5';
  const c=hex.replace('#','');
  const r=parseInt(c.substr(0,2),16)/255;
  const g=parseInt(c.substr(2,2),16)/255;
  const b=parseInt(c.substr(4,2),16)/255;
  const l=0.2126*r+0.7152*g+0.0722*b;
  return l>0.5?'#000':'#fff';
}

let allBuses=[
  "12132","12232","12332","12432","12532","12632",
  "14132","14232","14332","14432","14532",
  "17132","17232","17332","17432","17532","17632","17732",
  "18132","18232","18332","18432","18532","18632","18732","18832",
  "19132","19232","19332","19432","19532",
  "20131","20231","20331","20431",
  "24012","24112","24212","24312","24412",
  "25131","25231","25331","25431",
];

let OVERHEIGHT_BUSES=['25131','25231','25331','25431','17132','14132','12432','18532'];

async function loadConfig(){
  try{
    const cfg = await j('/v1/config');
    if(cfg.ALL_BUSES) allBuses = cfg.ALL_BUSES;
    if(cfg.OVERHEIGHT_BUSES) OVERHEIGHT_BUSES = cfg.OVERHEIGHT_BUSES;
  }catch(e){}
}

let activeES=null, activeIV=null, activeTL=null, currentRid=null, sessionId=0, userLocked=false, busOrder=[], lastRows=[], lastTLRows=[], blockByBus=new Map(), allBlockByBus=new Map(), lastUpdateTs=Date.now();

function updateLastUpdated(){
  const secondsAgo = (Date.now() - lastUpdateTs) / 1000;
  const updatedAgo = fmt(secondsAgo);
  $('#upd').textContent = "Updated " + updatedAgo + " ago";
}

function updateExtraBuses(){
  const extra=$('#extra-buses');
  const unassigned=allBuses.filter(b=>!allBlockByBus.has(b) && !isBusDowned(b));
  extra.innerHTML=unassigned.length
    ? unassigned.map(b=>{
        let bg='#EEE8AA';
        if(OVERHEIGHT_BUSES.includes(b)){
          bg='#E57200';
        }else if(b.startsWith('24')){
          bg='#232D4B';
        }
        const color=contrastColor(bg);
        return `<li class="mono" style="background:${bg};color:${color};border-color:${bg}">${b}</li>`;
      }).join('')
    : '<li class="hint">None</li>';
}

async function loadBlocks(){
  try{
    const res=await j('/v1/dispatch/blocks');
    const groups=res.block_groups||[];
    const colorByRoute=new Map(Object.entries(res.color_by_route||{}));
    const routeByBus=new Map(Object.entries(res.route_by_bus||{}));
    const tbody=$('#blocks');
    const futureBody=$('#future-blocks');
    if(!groups.length){
      const msg='<tr><td class="hint" colspan="4">No blocks.</td></tr>';
      tbody.innerHTML=msg;
      futureBody.innerHTML=msg;
      blockByBus=new Map();
      allBlockByBus=new Map();
      updateExtraBuses();
      return;
    }

    const entryMap=new Map();
    const busMap=new Map();
    for(const g of groups){
      const blocks=g.Blocks||[];
      if(blocks.length){
        for(const b of blocks){
          const trip=b.Trips?.[0];
          const bus=trip?.VehicleName||'—';
          let rid=routeByBus.get(bus);
          if(rid==null) rid=trip?.RouteID||b.Route?.RouteId;
          let col=null;
          if(rid===0){
            col='#000000';
          }else if(rid){
            col=colorByRoute.get(String(rid))||trip?.RouteColor||b.Route?.Color||null;
          }else{
            col=trip?.RouteColor||b.Route?.Color||null;
          }
          if(col && !col.startsWith('#')) col='#'+col;
          let key=g.BlockGroupId;
          if(!String(key).includes('[')) key = b.BlockId || key;
          const segs=[];
          segs.push({start:b.BlockStartTime,end:b.BlockEndTime});
          for(const t of (b.Trips||[])){
            segs.push({start:t.TripStartTime||t.BlockStartTime,end:t.TripEndTime||t.BlockEndTime});
          }
          let info=entryMap.get(key);
          if(!info){
            info={block:key,bus:bus,color:col,textColor:contrastColor(col),segments:[]};
            entryMap.set(key,info);
          }else{
            if(info.bus==='—' && bus!=='—') info.bus=bus;
            if(!info.color && col){ info.color=col; info.textColor=contrastColor(col); }
          }
          info.segments.push(...segs);
          if(bus && bus!=='—'){
            let bb=busMap.get(bus);
            if(!bb){ bb={block:key,segments:[]}; busMap.set(bus,bb); }
            bb.segments.push(...segs);
          }
        }
      }else{
        const key=g.BlockGroupId;
        if(!entryMap.has(key)){
          entryMap.set(key,{block:key,bus:'—',color:null,textColor:contrastColor(null),segments:[]});
        }
      }
    }

    let entries=Array.from(entryMap.values()).filter(e=>e.block.includes('[') || e.bus!=='—');
    let busBlocks=Array.from(busMap.entries()).map(([bus,val])=>({bus,block:val.block,segments:val.segments}));
    const alias={
      "[01]":"[01]/[04]",
      "[03]":"[05]/[03]",
      "[04]":"[01]/[04]",
      "[05]":"[05]/[03]",
      "[06]":"[22]/[06]",
      "[10]":"[20]/[10]",
      "[15]":"[26]/[15]",
      "[16] AM":"[21]/[16] AM",
      "[17]":"[23]/[17]",
      "[18] AM":"[24]/[18] AM",
      "[20] AM":"[20]/[10]",
      "[21] AM":"[21]/[16] AM",
      "[22] AM":"[22]/[06]",
      "[23]":"[23]/[17]",
      "[24] AM":"[24]/[18] AM",
      "[26] AM":"[26]/[15]"
    };
    function aliasBlock(b){ const key=String(b||'').trim(); return alias[key]||key; }
    entries=entries.map(e=>({...e,block:aliasBlock(e.block)}));
    busBlocks=busBlocks.map(e=>({...e,block:aliasBlock(e.block)}));
    allBlockByBus=new Map(busBlocks.map(e=>[e.bus,e.block]));
    const seen=new Map();
    const filtered=[];
    for(const e of entries){
      if(e.block.includes('[')){
        const prev=seen.get(e.block);
        if(!prev || (prev.bus==='—' && e.bus!=='—')){
          seen.set(e.block,e);
        }
      }else{
        filtered.push(e);
      }
    }
    entries=[...filtered,...seen.values()];
    entries.sort((a,b)=>{
      function parse(s){
        s=String(s).trim();
        const letters=(s.match(/^[A-Za-z]+/)||[''])[0].toUpperCase();
        const nums=(s.match(/\d+/g)||[]).map(Number);
        return {letters,nums};
      }
      const pa=parse(a.block), pb=parse(b.block);
      if(pa.letters<pb.letters) return -1; if(pa.letters>pb.letters) return 1;
      const len=Math.max(pa.nums.length,pb.nums.length);
      for(let i=0;i<len;i++){
        const na=pa.nums[i]||0, nb=pb.nums[i]||0;
        if(na!==nb) return na-nb;
      }
      return 0;
    });
    const now=new Date();
    function parseTime(t){
      if(!t) return null;
      const m=t.match(/(\d+):(\d+)\s*(AM|PM)/i);
      if(!m) return null;
      let [_,hh,mm,ap]=m; hh=parseInt(hh,10); mm=parseInt(mm,10); ap=ap.toUpperCase();
      if(ap==='PM' && hh<12) hh+=12; if(ap==='AM' && hh===12) hh=0;
      const d=new Date(); d.setHours(hh,mm,0,0); return d;
    }
    for(const e of entries){
      e.active=e.segments.some(seg=>{
        const start=parseTime(seg.start), end=parseTime(seg.end);
        return start && end && now>=start && now<=end;
      });
    }
    const activeEntries=entries.filter(e=>e.active);
    const futureEntries=entries.filter(e=>!e.active && e.bus!=='—');
    const tmp=new Map();
    for(const e of busBlocks){
      for(const seg of e.segments){
        const start=parseTime(seg.start), end=parseTime(seg.end);
        if(!start||!end) continue;
        const s=new Date(start.getTime()-30*60000);
        const f=new Date(end.getTime()+30*60000);
        if(now>=s && now<=f){
          const prev=tmp.get(e.bus);
          if(!prev || prev.start<start){ tmp.set(e.bus,{block:e.block,start}); }
        }
      }
    }
    blockByBus=new Map(Array.from(tmp.entries()).map(([bus,val])=>[bus,val.block]));
    const cols=4;
    function renderTable(list,useColors){
      const rows=Math.ceil(list.length/cols);
      let html='';
      for(let r=0;r<rows;r++){
        html+='<tr>';
        for(let c=0;c<cols;c++){
          const it=list[r+c*rows];
          html+=it
            ? `<td><div class="cell" style="--route-color:${useColors&&it.color?it.color:'transparent'};--text-color:${useColors&&it.color?it.textColor:contrastColor(null)}"><div class="mono">${it.block}</div><div>${it.bus}</div></div></td>`
            : '<td></td>';
        }
        html+='</tr>';
      }
      if(!list.length) html='<tr><td class="hint" colspan="4">No blocks.</td></tr>';
      return html;
    }
    tbody.innerHTML=renderTable(activeEntries,true);
    futureBody.innerHTML=renderTable(futureEntries,false);
    updateExtraBuses();
    if(lastRows.length) render(lastRows);
    if(lastTLRows.length) renderTL(lastTLRows);
  }catch(e){ $('#blocks').innerHTML='<tr><td class="hint" colspan="4">Error</td></tr>'; $('#future-blocks').innerHTML='<tr><td class="hint" colspan="4">Error</td></tr>'; blockByBus=new Map(); allBlockByBus=new Map(); updateExtraBuses(); }
}

async function loadRoutes(){
  const d = await j("/v1/routes");
  const list = d.routes || [];
  const active = list.filter(r => r.active_vehicles > 0).sort((a, b) => String(a.name || "").localeCompare(String(b.name || "")));
  const inactive = list.filter(r => !r.active_vehicles).sort((a, b) => String(a.name || "").localeCompare(String(b.name || "")));
  const sel = $('#route');
  const prev = currentRid;
  const combined = active.concat(inactive);
  sel.innerHTML = combined.map(r => '<option value="' + r.id + '">' + (r.name || ("Route " + r.id)) + '</option>').join("");
  if (prev) { sel.value = String(prev); }
  if (!sel.value && combined.length) { sel.value = String(combined[0].id); }
  if (!currentRid && sel.value) await start(sel.value);
}

function computeBusOrder(rows){
  const names = rows.map(r=>r.name).filter(Boolean);
  const followerOf=new Map();
  for(const r of rows){
    const leader=r.leader_name;
    if(leader && names.includes(leader)) followerOf.set(r.name, leader);
  }
  const next=new Map();
  for(const [f,l] of followerOf){ next.set(l,f); }
  const starts=names.filter(n=>!followerOf.has(n) || !names.includes(followerOf.get(n)));
  const order=[];
  const seen=new Set();
  for(const st of starts){
    let cur=st;
    while(cur && !seen.has(cur)){
      order.push(cur);
      seen.add(cur);
      cur=next.get(cur);
    }
  }
  for(const n of names) if(!seen.has(n)) order.push(n);
  return order.length?order:names.slice().sort();
}

function render(rows){
  lastRows=rows.slice();
  const t=lastRows.find(x=>x.target_headway_sec!=null)?.target_headway_sec; $('#target').textContent="Target "+(t!=null?fmt(t):"—");
  const ts = lastRows[0]?.updated_at ? (lastRows[0].updated_at * 1000) : Date.now();
  lastUpdateTs = ts;
  updateLastUpdated();
  rows = rows.filter(r=>blockByBus.has(r.name));
  const onlyBus = rows.length===1 && rows.every(x=>x.headway_sec==null || x.headway_sec===undefined);

  if(!rows.length){ $('#rows').innerHTML='<tr><td class="hint" colspan="5">No vehicles.</td></tr>'; return; }

  busOrder = computeBusOrder(rows);
  const orderMap=new Map(busOrder.map((n,i)=>[n,i]));
  rows = rows.slice().sort((a,b)=>{
    const ia=orderMap.has(a.name)?orderMap.get(a.name):Infinity;
    const ib=orderMap.has(b.name)?orderMap.get(b.name):Infinity;
    if(ia!==ib) return ia-ib;
    return String(a.name||'').localeCompare(String(b.name||''));
  });

  $('#rows').innerHTML=rows.map(v=>'<tr>'
    +'<td class="mono">'+(v.name||"—")+'</td>'
    +'<td class="mono">'+(blockByBus.get(v.name)||"—")+'</td>'
    +'<td>'+ (onlyBus ? '<span class="pill ok"><span class="dot"></span><span>Only Bus</span></span>' : pill(v.status)) +'</td>'
    +'<td class="mono">'+(v.leader_name||"—")+'</td>'
    +'<td class="mono">'+(v.countdown_sec!=null?fmt(v.countdown_sec):"—")+'</td>'
    +'</tr>').join("");
  setBanner(onlyBus ? 'Only 1 vehicle on route — headway control inactive.' : '', 'info');
  if(lastTLRows.length) renderTL(lastTLRows);
}

function renderTL(rows){
  lastTLRows = rows.slice();
  rows = rows.filter(r=>blockByBus.has(r.VehicleName));
  if(!rows.length){ $('#rows-tl').innerHTML='<tr><td class="hint" colspan="5">No vehicles.</td></tr>'; return; }
  const orderMap=new Map(busOrder.map((n,i)=>[n,i]));
  rows = rows.slice().sort((a,b)=>{
    const ia=orderMap.has(a.VehicleName)?orderMap.get(a.VehicleName):Infinity;
    const ib=orderMap.has(b.VehicleName)?orderMap.get(b.VehicleName):Infinity;
    if(ia!==ib) return ia-ib;
    return String(a.VehicleName||'').localeCompare(String(b.VehicleName||''));
  });
  $('#rows-tl').innerHTML=rows.map(v=>{
    const sev=String(v.Severity||'').toLowerCase();
    return '<tr>'
      +'<td class="mono">'+(v.VehicleName||"—")+'</td>'
      +'<td class="mono">'+(blockByBus.get(v.VehicleName)||"—")+'</td>'
      +'<td>'+pill(sev)+'</td>'
      +'<td class="mono">—</td>'
      +'<td class="mono">'+(v.Adjustment!=null?fmt(v.Adjustment):"—")+'</td>'
      +'</tr>';
  }).join('');
}

async function start(rid){
  rid=String(rid);
  if(activeES){ try{ activeES.close(); }catch(_){}; activeES=null; }
  if(activeIV){ clearInterval(activeIV); activeIV=null; }
  if(activeTL){ clearInterval(activeTL); activeTL=null; }
  currentRid=rid;
  const sid=++sessionId;
  try{
    const route=await j('/v1/routes/'+rid);
    const col=route && route.color ? route.color : null;
    if(col) document.documentElement.style.setProperty('--route-color', col);
  }catch(_){ document.documentElement.style.setProperty('--route-color','#2a3442'); }

  try{
    const es=new EventSource("/v1/stream/routes/"+rid);
    activeES=es;
    es.onmessage=ev=>{ if(rid!==currentRid || sid!==sessionId) return; try{ render(JSON.parse(ev.data||"[]")); }catch(_){} };
    es.onerror=_=>{ if(activeES===es){ es.close(); if(sid!==sessionId) return; activeES=null; startPoll(); } };
  }catch(_){ startPoll(); }

  function startPoll(){
    async function tick(){ if(rid!==currentRid || sid!==sessionId) return; try{ render(await j('/v1/routes/'+rid+'/status')); }catch(_){} }
    tick();
    activeIV=setInterval(tick, 10000);
  }

  function startTransloc(){
    async function tick(){
      if(rid!==currentRid || sid!==sessionId) return;
      try{
        const data=await j('/v1/transloc/anti_bunching');
        const route=(data||[]).find(r=>String(r.RouteID)===rid);
        renderTL(route?.VehicleAntiBunching||[]);
      }catch(_){ }
    }
    tick();
    activeTL=setInterval(tick, 10000);
  }

  startTransloc();
}

async function pollHealth(){
  try{ const h=await j('/v1/health'); if(!h.ok && h.last_error){ setBanner('Feed error: '+h.last_error, 'error'); }
       else{ /* keep info banner state */ } }
  catch(e){ setBanner('Health check failed', 'error'); }
  setTimeout(pollHealth, 15000);
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadConfig();
  loadRoutes();
  pollHealth();
  loadBlocks();
  setInterval(loadBlocks,30000);
  loadDownedBuses();
  setInterval(loadDownedBuses,DOWNED_REFRESH_MS);
  updateLastUpdated();
  setInterval(updateLastUpdated,1000);
});
document.getElementById('route').addEventListener('change', e=> { userLocked=true; start(e.target.value); });
</script>
</body>
