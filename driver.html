<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Driver Anti-Bunching</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="preload" href="FGDC.ttf" as="font" type="font/ttf" crossorigin />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapbox/polyline@1.1.1"></script>
<style>
  @font-face{font-family:'FGDC';src:url('FGDC.ttf') format('truetype');font-weight:normal;font-style:normal;}
  :root{ --bg:#0b0e11; --panel:#0f141a; --ink:#e8eef5; --muted:#9fb0c9; --line:#1f2630; --chip:#2a3442; --btn:#15202b; --btn-danger:#2b1515; --btn-danger-border:#523737; --ok:#24c28a; --warn:#ffbf47; --bad:#ff6b6b; }
  body.light{ --bg:#f0f4f8; --panel:#ffffff; --ink:#000000; --muted:#555555; --line:#cccccc; --chip:#dddddd; --btn:#e0e0e0; --btn-danger:#ffdddd; --btn-danger-border:#ffbbbb; }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 'FGDC',sans-serif;}
  *,*::before,*::after{font-family:'FGDC',sans-serif !important;}
  button,select{font-family:inherit;}
  body.centered{display:flex;align-items:center;justify-content:center;}
  .card{width:min(560px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px 16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1{margin:0 0 12px 0;font-size:18px}
  label{display:block;margin:8px 0 6px 2px;color:var(--muted)}
  select{width:100%;background:var(--panel);color:var(--ink);border:1px solid var(--chip);border-radius:10px;padding:10px}
  .row{display:flex;gap:10px}
  .row>div{flex:1}
  .btn{width:100%;margin-top:12px;background:var(--btn);border:1px solid var(--chip);color:var(--ink);border-radius:10px;padding:10px;cursor:pointer;font-weight:600}
  .btn:hover{filter:brightness(1.1)}
  .btn.danger{background:var(--btn-danger);border-color:var(--btn-danger-border)}
  .btn.danger:hover{filter:brightness(1.05)}
  .out{margin-top:14px;border-top:1px solid var(--line);padding-top:12px}
  .mono{font-family:'FGDC',ui-monospace,Menlo,Consolas,monospace}
  .muted{color:var(--muted)}
  /* Dashboard layout */
  #dashboard{display:flex;height:100%;width:100%;}
  #left,#right{flex:1;display:flex;flex-direction:column;}
  #topbar{background:var(--panel);padding:16px;border-bottom:1px solid var(--line);text-align:center;font-size:24px;}
  .route-pill{display:inline-block;padding:2px 8px;border-radius:999px;}
  #overheight{background:var(--bad);color:#000;text-align:center;padding:8px;font-weight:700;display:none;font-size:20px;}
  #info{padding:12px;flex:1;display:flex;flex-direction:column;align-items:center;text-align:center;}
  #info .out{margin-top:0;border-top:none;padding-top:0;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;}
  #instruction{width:100%;height:120px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:700;margin-bottom:12px;background:var(--panel);border:1px solid var(--line);}
  #instruction.green{background:var(--ok);color:#000;}
  #instruction.yellow{background:var(--warn);color:#000;}
  #instruction.red{background:var(--bad);color:#000;}
  #clock{flex:0 0 33%;display:flex;align-items:center;justify-content:center;font-size:20vh;border-bottom:1px solid var(--line);background:var(--panel);}
  #map{flex:1;}
  #bridgeWarning{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#ff0000;color:#fff;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;font-size:8vh;font-weight:700;z-index:10000;}
  #bridgeWarning p{margin:1vh 0;}
  @keyframes flashText{0%,49%{opacity:1;}50%,100%{opacity:0;}}
  #bridgeWarning.flash p{animation:flashText 1s steps(1,end) infinite;}
</style>
</head>
<body class="centered">
<div id="setup" class="card">
  <h1>Driver Anti-Bunching</h1>
  <div id="warn" class="muted" style="display:none;margin:6px 2px 2px"></div>
  <div id="setupInner">
    <div class="row">
      <div>
        <label>Unit Number</label>
        <select id="bus"></select>
      </div>
      <div>
        <label>Route</label>
        <select id="route"></select>
      </div>
    </div>
    <button id="go" class="btn">Start Anti-Bunching</button>
    <div class="muted" style="margin-top:8px">Pick your bus and route, then press Start.</div>
  </div>
</div>
<div id="dashboard" style="display:none">
  <div id="left">
    <div id="topbar"></div>
    <div id="overheight">OVERHEIGHT VEHICLE. DO NOT GO UNDER THE 14TH STREET BRIDGE.</div>
    <div id="info">
      <div id="out" class="out">
        <div id="instruction">Connecting…</div>
        <div id="details" class="mono muted"></div>
      </div>
      <div class="row" style="margin-top:auto">
        <button id="theme" class="btn">Light Mode</button>
        <button id="end" class="btn danger">End Anti-Bunching</button>
      </div>
    </div>
  </div>
  <div id="right">
    <div id="clock"></div>
    <div id="map"></div>
  </div>
</div>
<div id="bridgeWarning">
  <p>DO NOT GO UNDER THE 14TH STREET BRIDGE.</p>
  <p>VEHICLE IS OVERHEIGHT: 11' 11".</p>
  <p>DAMAGE WILL OCCUR.</p>
</div>
<script>
const $ = s=>document.querySelector(s);
const fmt = s=>{ if(s==null||!isFinite(s)) return "—"; s=Math.round(s); const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; };
async function j(u){ const r=await fetch(u,{cache:"no-store"}); if(!r.ok) throw new Error(r.status+" "+r.statusText); return r.json(); }
let timer=null, busTimer=null, currentBus="", currentRoute=0, currentRouteLabel="", map=null, routeLayer=null, markers={}, nameMarkers={}, routeColor='#E57200';
const OVERHEIGHT_BUSES = ['25131','25231','25331','25431','17132'];
const BRIDGE_POINT = L.latLng(38.03404931117353, -78.4995922309842);
const BRIDGE_RADIUS = 60; // meters
let bridgeWarningActive = false;
let alertCtx=null, alertInterval=null;
function startAlert(){
  if(alertCtx) return;
  alertCtx = new (window.AudioContext||window.webkitAudioContext)();
  $('#bridgeWarning').classList.add('flash');
  const beep=()=>{
    const osc=alertCtx.createOscillator();
    const gain=alertCtx.createGain();
    osc.type='sine';
    osc.frequency.value=440;
    gain.gain.value=0.2;
    osc.connect(gain);
    gain.connect(alertCtx.destination);
    osc.start();
    setTimeout(()=>osc.stop(),200);
  };
  beep();
  alertInterval=setInterval(beep,1000);
}
function stopAlert(){
  if(alertCtx){
    clearInterval(alertInterval);
    alertInterval=null;
    alertCtx.close();
    alertCtx=null;
  }
  $('#bridgeWarning').classList.remove('flash');
}
function updateBridgeWarning(show){
  const overlay=$('#bridgeWarning');
  if(show){
    if(!bridgeWarningActive){
      overlay.style.display='flex';
      startAlert();
      bridgeWarningActive=true;
    }
  }else{
    if(bridgeWarningActive){
      overlay.style.display='none';
      stopAlert();
      bridgeWarningActive=false;
    }
  }
}
// Load pickers once
async function loadBuses(){
  let list=[];
  try{ const d=await j('/v1/vehicles?include_stale=1&include_unassigned=1'); list=(d.vehicles||[]).map(x=>x.name); }
  catch(e){ try{ const d=await j('/v1/roster/vehicles'); list=(d.vehicles||[]).map(x=>x.name); } catch(_) { list=[]; } }
  const uniq=[...new Set(list.filter(Boolean))].sort((a,b)=>String(a).localeCompare(String(b)));
  $('#bus').innerHTML=uniq.map(n=>`<option>${n}</option>`).join('');
}
async function loadRoutes(){
  let list=[]; const d=await j('/v1/routes_all'); list=(d.routes||[]);
  list.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
  $('#route').innerHTML=list.map(r=>`<option value="${r.id}">${r.name}${r.active?'':' (inactive)'}</option>`).join('');
}
function showSession(busName, routeId, routeLabel){
  $('#setup').style.display='none';
  document.body.classList.remove('centered');
  $('#dashboard').style.display='flex';
  updateOverheightBanner(busName);
  updateBridgeWarning(false);
  currentRouteLabel = routeLabel;
  $('#topbar').innerHTML = `Unit ${busName} • <span id="route-pill" class="route-pill">${routeLabel}</span>`;
  setRoutePillColor(routeColor);
  $('#instruction').className='';
  $('#instruction').textContent='Connecting…';
  $('#details').textContent='';
  updateClock();
  if(timer) clearInterval(timer);
  tick();
  timer = setInterval(tick, 5000);
  initMap();
  if(busTimer) clearInterval(busTimer);
  updateBuses();
  busTimer = setInterval(updateBuses, 4000);
}
function showSetup(){
  $('#dashboard').style.display='none';
  document.body.classList.add('centered');
  $('#setup').style.display='block';
  updateBridgeWarning(false);
  updateOverheightBanner('');
  if(map){ map.remove(); map=null; routeLayer=null; markers={}; nameMarkers={}; }
  routeColor='#E57200';
  currentRouteLabel='';
  if(timer) { clearInterval(timer); timer=null; }
  if(busTimer){ clearInterval(busTimer); busTimer=null; }
}

function updateOverheightBanner(busName){
  const banner = $('#overheight');
  if(banner){
    banner.style.display = OVERHEIGHT_BUSES.includes(String(busName)) ? 'block' : 'none';
  }
}

function setRoutePillColor(color){
  const pill = $('#route-pill');
  if(pill){
    const contrast = getContrastColor(color);
    pill.style.background = color;
    pill.style.color = contrast;
  }
}
async function tick(){
  try{
    const data=await j(`/v1/routes/${currentRoute}/vehicles/${encodeURIComponent(currentBus)}/instruction`);
    const cls=(data.order==='HOLD'?'red':(data.order==='Ease off'?'yellow':'green'));
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const inst=data.order==='Ease off'? 'Ease off' : (data.order==='HOLD'?'HOLD':'Anti-Bunching OK');
    const box=$('#instruction');
    box.className=cls;
    box.textContent=inst;
    $('#details').innerHTML=`Headway: ${data.headway||'—'} • Target: ${data.target||'—'}<br>Gap: ${data.gap||'—'} • Countdown: ${data.countdown||'—'}<br><span class=\"muted\">Leader: ${data.leader||'—'} • Updated: ${new Date((data.updated_at||Date.now()/1000)*1000).toLocaleTimeString([], {timeZone: tz})}</span>`;
  } catch(e){
    const box=$('#instruction');
    box.className='red';
    box.textContent='Anti-Bunching not active';
    $('#details').innerHTML=`<div class=\"red mono\">Selected route or unit is not active.</div><div class=\"muted\">Anti-Bunching is not currently running for this selection.</div>`;
  }
}
function updateClock(){
  const now=new Date();
  const t=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
  $('#clock').textContent=t;
}
setInterval(updateClock,1000);
  function initMap(){
    map = L.map('map', {zoomControl:false}).setView([38.03799212281404, -78.50981502838886], 14);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'}).addTo(map);
  loadRoutePath();
}
async function loadRoutePath(){
  try{
    const res=await fetch('https://uva.transloc.com/Services/JSONPRelay.svc/GetRoutesForMapWithScheduleWithEncodedLine?APIKey=8882812681');
    const data=await res.json();
    const r=data.find(x=>x.RouteID==currentRoute);
    if(r && r.EncodedPolyline){
      routeColor = r.MapLineColor ? (r.MapLineColor.startsWith('#') ? r.MapLineColor : `#${r.MapLineColor}`) : '#E57200';
      setRoutePillColor(routeColor);
      const pts=polyline.decode(r.EncodedPolyline);
      routeLayer=L.polyline(pts,{color:routeColor,weight:5}).addTo(map);
      map.fitBounds(routeLayer.getBounds());
    }
  }catch(e){console.error('route load',e);}
}
async function updateBuses(){
  if(!map) return;
  try{
    const res=await fetch('https://uva.transloc.com/Services/JSONPRelay.svc/GetMapVehiclePoints?APIKey=8882812681');
    const data=await res.json();
    const active=new Set();
    let nearBridge=false;
    data.forEach(v=>{
      if(v.RouteID==currentRoute){
        const id=v.VehicleID;
        const pos=[v.Latitude,v.Longitude];
        const isMoving = v.GroundSpeed > 0;
        const heading = v.Heading || 0;
        const busName = v.Name;
        active.add(id);
        if(busName===currentBus){
          const dist=L.latLng(pos).distanceTo(BRIDGE_POINT);
          nearBridge=dist<=BRIDGE_RADIUS;
        }
        const color = routeColor;
        const contrast = getContrastColor(color);
        const svgIcon = `<svg width="40" height="80" viewBox="0 0 40 80" xmlns="http://www.w3.org/2000/svg"><g><circle cx="20" cy="20" r="15" fill="${color}" stroke="white" stroke-width="3" />${isMoving ? `<line x1="20" y1="10" x2="20" y2="22" stroke="${contrast}" stroke-width="4" stroke-linecap="round" style="transform: rotate(${heading + 180}deg); transform-origin: 20px 20px" /><polygon points="15,22 25,22 20,30" fill="${contrast}" style="transform: rotate(${heading + 180}deg); transform-origin: 20px 20px" />` : `<rect x="14" y="14" width="12" height="12" fill="${contrast}" />`}</g></svg>`;
        const busIcon = L.divIcon({html: svgIcon, className:'', iconSize:[40,40], iconAnchor:[20,20]});
        if(markers[id]){ animateMarkerTo(markers[id], pos); markers[id].setIcon(busIcon); }
        else { markers[id]=L.marker(pos,{icon:busIcon}).addTo(map); }
        const bubbleWidth = Math.max(40, busName.length * 10);
        const nameBubble = `<svg width="${bubbleWidth}" height="30" viewBox="0 0 ${bubbleWidth} 30" xmlns="http://www.w3.org/2000/svg"><g><rect x="0" y="5" width="${bubbleWidth}" height="20" rx="10" ry="10" fill="${color}" stroke="white" stroke-width="3" /><text x="${bubbleWidth/2}" y="20" font-size="14" font-weight="bold" text-anchor="middle" fill="${contrast}" font-family="FGDC">${busName}</text></g></svg>`;
        const nameIcon = L.divIcon({html:nameBubble, className:'', iconSize:[bubbleWidth,30], iconAnchor:[bubbleWidth/2,40]});
        if(nameMarkers[id]){ animateMarkerTo(nameMarkers[id], pos); nameMarkers[id].setIcon(nameIcon); }
        else { nameMarkers[id]=L.marker(pos,{icon:nameIcon,interactive:false}).addTo(map); }
      }
    });
    updateBridgeWarning(nearBridge && OVERHEIGHT_BUSES.includes(String(currentBus)));
    Object.keys(markers).forEach(id=>{
      if(!active.has(Number(id))){
        map.removeLayer(markers[id]); delete markers[id];
        if(nameMarkers[id]){ map.removeLayer(nameMarkers[id]); delete nameMarkers[id]; }
      }
    });
  }catch(e){console.error('bus load',e);}
}
$('#go').onclick = ()=>{
  currentBus = $('#bus').value;
  currentRoute = Number($('#route').value);
  const routeLabel = $('#route').selectedOptions[0]?.text || `Route ${currentRoute}`;
  showSession(currentBus, currentRoute, routeLabel);
};
$('#end').onclick = ()=>{
  currentBus=""; currentRoute=0;
  $('#instruction').className='';
  $('#instruction').textContent='';
  $('#details').innerHTML='<div class=\"muted\">Pick your bus and route, then press Start.</div>';
  showSetup();
};

$('#theme').onclick = ()=>{
  const light=document.body.classList.toggle('light');
  $('#theme').textContent=light?'Dark Mode':'Light Mode';
};
document.addEventListener('DOMContentLoaded', async ()=>{ try{ await loadBuses(); await loadRoutes(); }catch(e){ $('#instruction').className='red'; $('#instruction').textContent='Error loading lists'; } });
async function pollHealth(){
  try{ const h=await j('/v1/health'); const w=$('#warn'); if(!h.ok && h.last_error){ w.style.display='block'; w.textContent='Feed error: '+h.last_error; } else { w.style.display='none'; w.textContent=''; } }
  catch(e){ const w=$('#warn'); w.style.display='block'; w.textContent='Health check failed'; }
  setTimeout(pollHealth,15000);
}
pollHealth();

function getContrastColor(hexColor){
  hexColor = hexColor.replace('#','');
  const r = parseInt(hexColor.substring(0,2),16);
  const g = parseInt(hexColor.substring(2,4),16);
  const b = parseInt(hexColor.substring(4,6),16);
  const luminance = (0.299*r + 0.587*g + 0.114*b)/255;
  return luminance > 0.565 ? 'black':'white';
}

function animateMarkerTo(marker, newPosition){
  const startPos = marker.getLatLng();
  const endPos = L.latLng(newPosition);
  const duration = 1000;
  const startTime = performance.now();
  function animate(time){
    const elapsed = time - startTime;
    const t = Math.min(elapsed / duration, 1);
    const currentPos = L.latLng(
      startPos.lat + t * (endPos.lat - startPos.lat),
      startPos.lng + t * (endPos.lng - startPos.lng)
    );
    marker.setLatLng(currentPos);
    if(t < 1) requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);
}
</script>
</body>
</html>
