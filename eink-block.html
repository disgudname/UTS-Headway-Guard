<!doctype html>
<meta charset="utf-8">
<title>E-ink Block Display</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    color-scheme: only light;
  }
  *{box-sizing:border-box;}
  @font-face{
    font-family:'FGDC';
    src:url('FGDC.ttf') format('truetype');
    font-display:swap;
  }
  @font-face{
    font-family:'CenturyGothic';
    src:url('centurygothic.ttf') format('truetype');
    font-display:swap;
  }
  body{
    margin:0;
    width:250px;
    height:122px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#fff;
    color:#000;
    font-family:'FGDC',sans-serif;
  }
  body.grid-mode{
    width:auto;
    min-width:280px;
    height:auto;
    padding:12px;
  }
  main{
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:6px;
  }
  body.grid-mode main{
    height:auto;
    justify-content:flex-start;
    padding:0;
  }
  [hidden]{
    display:none !important;
  }
  #block-view{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
  }
  #block-number{
    font-family:'CenturyGothic',sans-serif;
    font-size:22px;
    letter-spacing:0.08em;
    text-transform:uppercase;
  }
  #bus{
    font-size:62px;
    font-weight:600;
    letter-spacing:1px;
    line-height:1;
  }
  #status{
    font-size:14px;
    letter-spacing:0.06em;
    text-transform:uppercase;
  }
  #grid-view{
    width:520px;
    max-width:100%;
    border:3px solid #000;
    display:flex;
    flex-direction:column;
    font-weight:600;
    font-size:18px;
    background:#fff;
    margin:0 auto;
  }
  body.grid-mode #grid-view{
    height:auto;
  }
  #grid-view .grid-header{
    font-family:'CenturyGothic',sans-serif;
    font-size:22px;
    letter-spacing:0.1em;
    text-transform:uppercase;
    text-align:center;
    padding:12px 8px;
    border-bottom:3px solid #000;
  }
  #grid-view .grid-table{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    grid-template-rows:repeat(9,minmax(48px,1fr));
    width:100%;
  }
  #grid-view .cell{
    padding:10px 6px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:40px;
    gap:6px;
  }
  #grid-view .cell:nth-child(n+5){
    border-top:2px solid #000;
  }
  #grid-view .cell:not(:nth-child(4n+1)){
    border-left:2px solid #000;
  }
  #grid-view .cell .block-label{
    font-family:'CenturyGothic',sans-serif;
    font-size:14px;
    letter-spacing:0.06em;
  }
  #grid-view .cell .bus{
    font-size:18px;
  }
</style>
<main>
  <div id="block-view">
    <div id="block-number" hidden>Block --</div>
    <div id="bus">--</div>
    <div id="status"></div>
  </div>
  <div id="grid-view" hidden>
    <div class="grid-header">BLOCK ASSIGNMENTS</div>
    <div class="grid-table"></div>
  </div>
</main>
<script>
(function(){
  const params=new URLSearchParams(location.search);
  const enableColors=params.get('colors')==='true';
  let block=params.get('block');
  const periodParam=(params.get('period')||'').trim().toLowerCase();
  const statusEl=document.getElementById('status');
  const busEl=document.getElementById('bus');
  const blockView=document.getElementById('block-view');
  const gridView=document.getElementById('grid-view');
  const blockNumberEl=document.getElementById('block-number');
  const isGridMode=!block;
  let blockPeriod='';

  const columns=[
    ['01','02','03','04','05','06','07','08','09'],
    ['10','11','12','13','14','15','16AM','17','18AM'],
    ['19','20AM','21AM','22AM','23AM','24AM','25AM','26AM','27'],
    ['','20PM','21PM','22PM','23PM','24PM','25PM','26PM','27PM']
  ];

  function getCellColors(block,period){
    const blockId=(block||'').padStart(2,'0');
    const periodId=(period||'').toLowerCase();
    if(!blockId) return null;

    const numeric=parseInt(blockId,10);

    if(['01','02'].includes(blockId)) return {bg:'#0C8103',text:'#fff'};
    if(['03','04'].includes(blockId)) return {bg:'#232D48',text:'#fff'};
    if(numeric>=5 && numeric<=8) return {bg:'#FF7300',text:'#111'};
    if(numeric>=9 && numeric<=12) return {bg:'#FFDD00',text:'#000'};
    if(numeric>=13 && numeric<=14) return {bg:'#C3C1C1',text:'#000'};
    if(numeric>=15 && numeric<=18) return {bg:'#0072BC',text:'#fff'};

    if(periodId==='am' && numeric>=20 && numeric<=26){
      return {bg:'#F60303',text:'#fff'};
    }

    if(periodId==='pm' && ['20','21','22','24','26'].includes(blockId)){
      return {bg:'#F60303',text:'#fff'};
    }

    return null;
  }

  function applyCellColors(cell){
    if(!enableColors || !cell || !cell.dataset) return;
    const colors=getCellColors(cell.dataset.block,cell.dataset.period||'');
    if(colors){
      cell.style.backgroundColor=colors.bg;
      cell.style.color=colors.text;
    }
  }

  function buildGrid(){
    const gridTable=gridView.querySelector('.grid-table');
    if(!gridTable) return;
    gridTable.innerHTML='';
    const rows=9;
    for(let row=0;row<rows;row++){
      for(let col=0;col<columns.length;col++){
        const label=columns[col][row]||'';
        const cell=document.createElement('div');
        cell.className='cell';
        if(label){
          const match=label.match(/^(\d{2})(AM|PM)?$/i);
          if(match){
            cell.dataset.block=match[1];
            cell.dataset.period=(match[2]||'').toLowerCase();
          }
          const blockNumber=match?match[1]:label;
          const periodSuffix=match && match[2]?match[2].toUpperCase():'';
          const displayLabel=periodSuffix?`Block ${blockNumber} ${periodSuffix}`:`Block ${blockNumber}`;
          cell.innerHTML=`<div class="block-label">${displayLabel}</div><div class="bus">—</div>`;
          applyCellColors(cell);
        }
        gridTable.appendChild(cell);
      }
    }
  }

  if(isGridMode){
    document.body.classList.add('grid-mode');
    document.title='Block Grid';
    blockView.hidden=true;
    gridView.hidden=false;
    if(blockNumberEl) blockNumberEl.hidden=true;
    buildGrid();
  }
  if(!isGridMode){
    document.body.classList.remove('grid-mode');
    blockView.hidden=false;
    gridView.hidden=true;
    if(blockNumberEl) blockNumberEl.hidden=false;
    block=String(block).trim();
    const blockMatch=block.match(/^(\d{2})(?:\s*(AM|PM))?$/i);
    if(blockMatch){
      block=blockMatch[1];
      if(blockMatch[2]) blockPeriod=blockMatch[2].toLowerCase();
    }
    if(!/^\d{2}$/.test(block)){
      statusEl.textContent='Invalid block';
      busEl.textContent='--';
      if(blockNumberEl){
        blockNumberEl.textContent='Block --';
      }
      return;
    }

    const periodSuffix=blockPeriod||((periodParam==='am'||periodParam==='pm')?periodParam:'');
    const blockLabel = periodSuffix ? `${block} ${periodSuffix.toUpperCase()}` : block;
    document.title = `Block ${blockLabel}`;
    if(blockNumberEl){
      blockNumberEl.textContent = `Block ${blockLabel}`;
    }
  }

  function parseTimeToMinutes(str){
    if(!str) return null;
    const value=String(str).trim();
    if(!value) return null;

    let match=value.match(/^PT(?:(\d+)H)?(?:(\d+)M)?$/i);
    if(match){
      const hours=parseInt(match[1]||'0',10);
      const minutes=parseInt(match[2]||'0',10);
      return hours*60+minutes;
    }

    match=value.match(/^\/Date\((\d+)\)\/$/);
    if(match){
      const date=new Date(Number(match[1]));
      if(!isNaN(date.getTime())){
        return date.getHours()*60+date.getMinutes();
      }
    }

    match=value.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
    if(match){
      let hours=parseInt(match[1],10)%12;
      const minutes=parseInt(match[2],10);
      if(match[3].toUpperCase()==='PM') hours+=12;
      return hours*60+minutes;
    }

    match=value.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
    if(match){
      const hours=parseInt(match[1],10);
      const minutes=parseInt(match[2],10);
      return hours*60+minutes;
    }

    return null;
  }

  const MINUTES_PER_DAY=1440;
  const NOON_MINUTES=12*60;

  function collectRanges(block){
    const ranges=[];
    const consider=(startStr,endStr)=>{
      const start=parseTimeToMinutes(startStr);
      const end=parseTimeToMinutes(endStr);
      if(start==null && end==null) return;
      ranges.push({start,end});
    };

    consider(block.BlockStartTime,block.BlockEndTime);
    consider(block.TripStartTime,block.TripEndTime);

    const trips=Array.isArray(block.Trips)?block.Trips:[];
    for(const trip of trips){
      consider(trip.BlockStartTime,trip.BlockEndTime);
      consider(trip.TripStartTime,trip.TripEndTime);
      consider(trip.StartTime,trip.EndTime);
      consider(trip.StartTimeDate,trip.EndTimeDate);
    }

    return ranges;
  }

  function calculatePeriodMinutes(start,end){
    let am=0;
    let pm=0;
    if(start==null || end==null) return {am,pm};

    let rangeStart=start;
    let rangeEnd=end;
    if(rangeEnd<rangeStart) rangeEnd+=MINUTES_PER_DAY;

    while(rangeStart<rangeEnd){
      const dayStart=Math.floor(rangeStart/MINUTES_PER_DAY)*MINUTES_PER_DAY;
      const dayEnd=dayStart+MINUTES_PER_DAY;
      const segmentEnd=Math.min(rangeEnd,dayEnd);
      const segStartOfDay=rangeStart-dayStart;
      const segEndOfDay=segmentEnd-dayStart;

      const amStart=Math.max(segStartOfDay,0);
      const amEnd=Math.min(segEndOfDay,NOON_MINUTES);
      if(amEnd>amStart) am+=amEnd-amStart;

      const pmStart=Math.max(segStartOfDay,NOON_MINUTES);
      const pmEnd=Math.min(segEndOfDay,MINUTES_PER_DAY);
      if(pmEnd>pmStart) pm+=pmEnd-pmStart;

      rangeStart=segmentEnd;
    }

    return {am,pm};
  }

  function buildEntry(group){
    const id=String(group.BlockGroupId||'').trim();
    const blocks=Array.isArray(group.Blocks)?group.Blocks:[];
    const blockNumbers=[];
    const blockPeriods=Object.create(null);
    const seenNumbers=new Set();
    const matches=id.match(/\[(\d+)\]/g)||[];
    for(const raw of matches){
      const num=raw.replace(/[^0-9]/g,'');
      if(num && !seenNumbers.has(num)){
        seenNumbers.add(num);
        blockNumbers.push(num);
      }
    }

    const periodMatch=id.match(/\b(AM|PM)\b/i);
    const periodLabel=periodMatch?periodMatch[1].toLowerCase():'';

    if(periodLabel){
      for(const num of blockNumbers){
        blockPeriods[num]=periodLabel;
      }
    }else if(blockNumbers.length===2){
      blockPeriods[blockNumbers[0]]='am';
      blockPeriods[blockNumbers[1]]='pm';
    }

    let bus='—';
    for(const block of blocks){
      const trips=Array.isArray(block.Trips)?block.Trips:[];
      for(const trip of trips){
        if(trip && trip.VehicleName){
          bus=String(trip.VehicleName).trim();
          break;
        }
      }
      if(bus!=='—') break;
    }

    let minStart=null;
    let maxEnd=null;
    let amMinutes=0;
    let pmMinutes=0;
    for(const block of blocks){
      const ranges=collectRanges(block);
      for(const range of ranges){
        let {start,end}=range;
        if(start==null && end==null) continue;
        if(start!=null && end!=null){
          const contribution=calculatePeriodMinutes(start,end);
          amMinutes+=contribution.am;
          pmMinutes+=contribution.pm;
        }
        if(start!=null){
          if(minStart==null || start<minStart) minStart=start;
        }
        if(start!=null && end!=null && end<start){
          end+=1440;
        }
        if(end!=null){
          if(minStart!=null && end<minStart){
            while(end<minStart){
              end+=1440;
            }
          }
          if(maxEnd==null || end>maxEnd) maxEnd=end;
        }
      }
    }

    let inferredPeriod='';
    if(periodLabel){
      inferredPeriod=periodLabel;
    }else if(amMinutes && !pmMinutes){
      inferredPeriod='am';
    }else if(pmMinutes && !amMinutes){
      inferredPeriod='pm';
    }else if(amMinutes || pmMinutes){
      if(pmMinutes>amMinutes) inferredPeriod='pm';
      else if(amMinutes>pmMinutes) inferredPeriod='am';
    }else if(minStart!=null && maxEnd!=null){
      let start=minStart;
      let end=maxEnd;
      if(end<start) end+=MINUTES_PER_DAY;
      const duration=end-start;
      if(duration>0){
        const midpoint=(start+duration/2)%MINUTES_PER_DAY;
        inferredPeriod=midpoint>=NOON_MINUTES?'pm':'am';
      }
    }

    return {id,blockNumbers,blockPeriods,period:periodLabel,inferredPeriod,bus,minStart,maxEnd};
  }

  function isActive(entry,nowMinutes){
    if(entry.minStart==null || entry.maxEnd==null) return false;
    let start=entry.minStart;
    let end=entry.maxEnd;
    let now=nowMinutes;
    if(end<start){
      end+=1440;
      if(now<start) now+=1440;
    }
    return now>=start && now<=end;
  }

  function pickBest(entries,nowMinutes){
    if(!entries.length) return null;
    const active=entries.filter(e=>isActive(e,nowMinutes));
    const activeWithBus=active.find(e=>e.bus && e.bus!=='—');
    if(activeWithBus) return activeWithBus;
    if(active.length) return active[0];

    const withBus=entries.find(e=>e.bus && e.bus!=='—');
    if(withBus) return withBus;

    return entries[0];
  }

  function findBestBus(blockNumber,periodSuffix,entries,nowMinutes){
    const matches=entries.filter(e=>e.blockNumbers.includes(blockNumber));
    if(!matches.length) return '—';

    const normalizedPeriod=(periodSuffix||'').toLowerCase();
    let filtered=matches;

    if(normalizedPeriod){
      const exactMatches=matches.filter(entry=>{
        const assigned=entry.blockPeriods&&entry.blockPeriods[blockNumber];
        return assigned===normalizedPeriod;
      });
      if(exactMatches.length){
        filtered=exactMatches;
      }else{
        const unspecified=matches.filter(entry=>{
          const assigned=entry.blockPeriods&&entry.blockPeriods[blockNumber];
          if(assigned) return false;
          const explicitPeriod=(entry.period||'').toLowerCase();
          if(explicitPeriod && explicitPeriod!==normalizedPeriod) return false;
          const inferred=(entry.inferredPeriod||'').toLowerCase();
          if(inferred && inferred!==normalizedPeriod) return false;
          return true;
        });
        if(unspecified.length){
          filtered=unspecified;
        }else{
          return '—';
        }
      }
    }

    const best=pickBest(filtered,nowMinutes);
    if(best && best.bus) return best.bus;

    if(filtered!==matches){
      const fallback=pickBest(matches,nowMinutes);
      if(fallback && fallback.bus) return fallback.bus;
    }

    return '—';
  }

  function updateGrid(entries,nowMinutes){
    const cells=gridView.querySelectorAll('.cell[data-block]');
    for(const cell of cells){
      const blockNumber=cell.dataset.block;
      const periodSuffix=cell.dataset.period||'';
      const bus=findBestBus(blockNumber,periodSuffix,entries,nowMinutes);
      const busEl=cell.querySelector('.bus');
      if(busEl){
        busEl.textContent=bus||'—';
      }
    }
  }

  async function refresh(){
    try{
      statusEl.textContent='';
      const res=await fetch('/v1/dispatch/blocks');
      if(!res.ok) throw new Error(res.status+'');
      const data=await res.json();
      const groups=Array.isArray(data.block_groups)?data.block_groups:[];
      const entries=[];
      for(const group of groups){
        const entry=buildEntry(group);
        if(entry.blockNumbers.length){
          entries.push(entry);
        }
      }

      const now=new Date();
      const nowMinutes=now.getHours()*60+now.getMinutes();

      if(isGridMode){
        updateGrid(entries,nowMinutes);
      }else{
        const periodSuffix=blockPeriod||((periodParam==='am'||periodParam==='pm')?periodParam:'');
        const bus=findBestBus(block,periodSuffix,entries,nowMinutes);
        busEl.textContent=bus||'—';
        statusEl.textContent='';
      }
    }catch(err){
      console.error(err);
      statusEl.textContent='Offline';
      if(!isGridMode){
        busEl.textContent='--';
      }
    }
  }

  refresh();
  setInterval(refresh, 30000);
})();
</script>
