<!doctype html>
<html>
<head>
<link rel="icon" type="image/png" href="headwayguardicon.png" />
<meta charset="utf-8" />
<title>Ridership Counts - Headway Guard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preload" href="FGDC.ttf" as="font" type="font/ttf" crossorigin />
<style>
  @font-face{font-family:'FGDC';src:url('FGDC.ttf') format('truetype');font-weight:normal;font-style:normal;}
  :root{--bg:#0b0e11;--panel:#0f141a;--ink:#e8eef5;--muted:#9fb0c9;--line:#1f2630;--accent:#4b85f2;--danger:#f06c6c;}
  *{box-sizing:border-box;}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px 'FGDC',sans-serif;padding:20px;line-height:1.4;}
  h1{margin-top:0;margin-bottom:16px;}
  button{background:var(--accent);color:#fff;border:none;padding:8px 14px;border-radius:6px;font:inherit;cursor:pointer;}
  button:hover{filter:brightness(1.1);}
  button:disabled{opacity:0.6;cursor:not-allowed;}
  input,select,textarea{font:inherit;border:1px solid var(--line);border-radius:6px;padding:6px;background:var(--panel);color:var(--ink);}
  input[type="date"]{border-color:var(--accent);cursor:pointer;box-shadow:0 0 0 0 rgba(75,133,242,0.4);transition:border-color 0.2s ease,box-shadow 0.2s ease;background:linear-gradient(135deg,rgba(75,133,242,0.15),rgba(75,133,242,0));}
  input[type="date"]:hover,input[type="date"]:focus{border-color:#7aa6ff;box-shadow:0 0 0 3px rgba(75,133,242,0.25);}
  input[type="date"]::-webkit-calendar-picker-indicator{background:var(--accent);border-radius:4px;padding:4px;margin-right:4px;cursor:pointer;filter:invert(1);}
  input[type="date"]::-webkit-calendar-picker-indicator:hover{background:#6b9af5;}
  textarea{width:100%;min-height:80px;margin-top:12px;}
  table{border-collapse:collapse;width:100%;margin-top:12px;}
  th,td{border:1px solid var(--line);padding:8px;text-align:left;}
  th{background:rgba(255,255,255,0.05);font-weight:normal;}
  .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px;}
  .controls label{display:flex;align-items:center;gap:6px;}
  .spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--ink);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
  #newestDisplay{margin:12px 0;color:var(--muted);}
  #tablesContainer{display:flex;flex-direction:column;gap:18px;margin-top:12px;}
  #tablesContainer.is-loading{opacity:0.4;filter:grayscale(0.6);pointer-events:none;transition:opacity 0.2s ease;}
  .route-block{background:var(--panel);padding:16px;border-radius:12px;border:1px solid var(--line);box-shadow:0 4px 12px rgba(0,0,0,0.2);}
  .route-header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;}
  .alternate-input{min-width:220px;}
  .route-header label{display:flex;align-items:center;gap:8px;}
  .time-input{width:100%;min-width:160px;}
  .result-cell{width:120px;text-align:right;font-variant-numeric:tabular-nums;}
  .result-cell.invalid{color:var(--danger);}
  .action-cell{text-align:center;width:60px;}
  .action-header{width:60px;}
  .remove-row-btn{background:var(--danger);padding:6px 10px;}
  .route-total{font-weight:bold;text-align:right;}
  .route-day-total-row{display:none;}
  .route-day-total{font-weight:bold;text-align:right;}
  #addTableBtn{margin-top:16px;background:#2f9d78;}
  .quick-add{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
  .loading-message{margin-top:8px;color:var(--muted);font-style:italic;display:none;}
  #routeTotalsWrapper{margin-top:12px;display:none;background:var(--panel);padding:12px;border-radius:12px;border:1px solid var(--line);}
  #routeTotalsWrapper table{margin-top:8px;}
  #routeTotalsWrapper th{background:transparent;color:var(--muted);font-weight:normal;}
  #routeTotalsWrapper td{border-color:var(--line);}
  #routeTotalsWrapper .route-totals-value{text-align:right;font-variant-numeric:tabular-nums;}
  #routeTotalsWrapper .route-totals-title{font-weight:bold;}
  #routeTotalsWrapper .route-overall-row td{font-weight:bold;border-top:2px solid var(--line);}
  #routeTotalsChartWrapper{margin-top:12px;display:none;background:var(--panel);padding:12px;border-radius:12px;border:1px solid var(--line);position:relative;max-height:420px;}
  #routeTotalsChartWrapper .route-totals-title{font-weight:bold;margin-bottom:8px;}
  #routeTotalsChart{width:100%;height:min(320px,40vh);max-height:360px;}
</style>
</head>
<body>
<h1>Ridership Counts</h1>
<div class="controls">
  <label>Date: <input type="date" id="datePicker"></label>
  <button id="loadBtn">Load</button>
  <span id="spinner" class="spinner" style="display:none"></span>
  <button id="exportBtn">Export CSV</button>
  <button id="templateBtn" type="button">Load Red/Blue Template</button>
  <button id="academicTemplateBtn" type="button">Load Academic Template</button>
</div>
<div id="newestDisplay">Newest Data: <span id="newestTimestamp"></span></div>
<div id="routeTotalsWrapper">
  <div class="route-totals-title">Per-Route Totals</div>
  <table id="routeTotalsTable">
    <thead>
      <tr><th>Route</th><th>Total</th></tr>
    </thead>
    <tbody id="routeTotalsBody">
      <tr id="routeTotalsOverallRow" class="route-overall-row">
        <td>Overall Displayed Total</td>
        <td class="route-totals-value"><span id="overallTotal">0</span></td>
      </tr>
    </tbody>
  </table>
</div>
<div id="routeTotalsChartWrapper">
  <div class="route-totals-title">Ridership by Hour</div>
  <canvas id="routeTotalsChart" aria-label="Ridership by Hour" role="img" height="320"></canvas>
</div>
<div id="loadingMessage" class="loading-message">Loading Data, please wait...</div>
<div id="tablesContainer"></div>
<button id="addTableBtn" type="button">Add Another Route</button>
<textarea id="notes" placeholder="Service Notes..."></textarea>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script>
const urlParams=new URLSearchParams(window.location.search);
const isBrokenChartMode=urlParams.get('broken')==='true';
let brokenChartHeight=null;

const dateInput=document.getElementById('datePicker');
const loadBtn=document.getElementById('loadBtn');
const exportBtn=document.getElementById('exportBtn');
const spinner=document.getElementById('spinner');
const newestTimestamp=document.getElementById('newestTimestamp');
const tablesContainer=document.getElementById('tablesContainer');
const overallTotalDisplay=document.getElementById('overallTotal');
const routeTotalsWrapper=document.getElementById('routeTotalsWrapper');
const routeTotalsBody=document.getElementById('routeTotalsBody');
const routeTotalsOverallRow=document.getElementById('routeTotalsOverallRow');
const routeTotalsChartWrapper=document.getElementById('routeTotalsChartWrapper');
const routeTotalsChartCanvas=document.getElementById('routeTotalsChart');
const addTableBtn=document.getElementById('addTableBtn');
const templateBtn=document.getElementById('templateBtn');
const academicTemplateBtn=document.getElementById('academicTemplateBtn');
const notesInput=document.getElementById('notes');
const loadingMessage=document.getElementById('loadingMessage');

function readCssVar(name,fallback){
  try{
    const value=getComputedStyle(document.documentElement).getPropertyValue(name);
    const trimmed=(value||'').trim();
    return trimmed||fallback;
  }catch(err){
    return fallback;
  }
}

const INK_COLOR=readCssVar('--ink','#ffffff');
const CHART_LABEL_COLOR='#000000';
const MUTED_COLOR=readCssVar('--muted','#9fb0c9');
const DEFAULT_ROUTE_COLOR=readCssVar('--accent','#4b85f2');

let routeTotalsChart=null;

if(window.Chart&&window.ChartDataLabels){
  Chart.register(window.ChartDataLabels);
}

tablesContainer.classList.add('is-loading');
loadingMessage.textContent='Select a date to load data.';
loadingMessage.style.display='block';
loadBtn.disabled=true;

const MAX_EXTENDED_HOUR=27;
const MAX_EXTENDED_MINUTES=MAX_EXTENDED_HOUR*60;

const ROUTE_INFO_URL='https://uva.transloc.com/Services/JSONPRelay.svc/GetRoutesForMapWithScheduleWithEncodedLine?APIKey=8882812681';

let ridershipByRoute={};
let routeList=[];
let newestDataTimestamp=null;
let routeInfoById={};
let routeInfoPromise=null;
let routeMetaByKey={};
let groupMetaByKey={};
let routeGroupMembers={};
let routeMemberToGroup={};
let isLoading=false;

function updateLoadAvailability(){
  loadBtn.disabled=!dateInput.value||isLoading;
}

dateInput.addEventListener('change',updateLoadAvailability);
dateInput.addEventListener('input',updateLoadAvailability);

function normalizeColor(value){
  if(typeof value!=='string'){return null;}
  const trimmed=value.trim();
  if(!trimmed){return null;}
  if(trimmed[0]==='#'){return trimmed;}
  if(/^[0-9a-f]{6}$/i.test(trimmed)){return `#${trimmed}`;}
  return trimmed;
}

function normalizeApiArray(payload){
  if(Array.isArray(payload)){return payload;}
  if(payload&&Array.isArray(payload.d)){return payload.d;}
  if(payload&&typeof payload.d==='string'){
    try{
      const parsed=JSON.parse(payload.d);
      if(Array.isArray(parsed)){return parsed;}
    }catch(err){
      console.error('Failed to parse array payload',err);
    }
  }
  return [];
}

function fetchRouteInfo(){
  if(routeInfoPromise){return routeInfoPromise;}
  if(Object.keys(routeInfoById).length){return Promise.resolve(routeInfoById);}
  routeInfoPromise=fetch(ROUTE_INFO_URL).then(r=>r.json()).then(raw=>{
    const list=normalizeApiArray(raw);
    const map={};
    list.forEach(route=>{
      if(!route){return;}
      const id=route.RouteID;
      if(id===undefined||id===null){return;}
      map[String(id)]=route;
    });
    routeInfoById=map;
    return routeInfoById;
  }).catch(err=>{
    console.error('Failed to fetch route metadata',err);
    return routeInfoById;
  }).finally(()=>{
    routeInfoPromise=null;
  });
  return routeInfoPromise;
}

function getRouteMeta(routeKey){
  if(groupMetaByKey[routeKey]){return groupMetaByKey[routeKey];}
  if(routeMetaByKey[routeKey]){return routeMetaByKey[routeKey];}
  const groupKey=routeMemberToGroup[routeKey];
  if(groupKey&&groupMetaByKey[groupKey]){return groupMetaByKey[groupKey];}
  return null;
}

function getRouteDisplayName(routeKey){
  const meta=getRouteMeta(routeKey);
  if(meta){
    if(meta.displayName){return meta.displayName;}
    if(meta.baseName){return meta.baseName;}
  }
  return routeKey||'';
}

function getRouteBaseName(routeKey){
  const meta=getRouteMeta(routeKey);
  if(meta&&meta.baseName){return meta.baseName;}
  return '';
}

function findRouteKeyForTemplate(routeName,infoTextHint,usageMap){
  const normalized=normalizeRouteName(routeName||'');
  if(!normalized){return null;}
  const matches=routeList.filter(key=>normalizeRouteName(getRouteBaseName(key))===normalized);
  if(!matches.length){return null;}
  if(infoTextHint){
    const target=infoTextHint.trim().toLowerCase();
    const withInfo=matches.find(key=>{
      const meta=getRouteMeta(key);
      if(!meta||!meta.infoText){return false;}
      return meta.infoText.trim().toLowerCase()===target;
    });
    if(withInfo){
      if(usageMap){
        const usage=usageMap.get(normalized)||0;
        usageMap.set(normalized,usage+1);
      }
      return withInfo;
    }
  }
  if(usageMap){
    const usage=usageMap.get(normalized)||0;
    const choice=matches[usage]||matches[0];
    usageMap.set(normalized,usage+1);
    return choice||null;
  }
  return matches[0];
}

function buildRouteGroups(){
  Object.keys(ridershipByRoute).forEach(routeKey=>{
    const meta=routeMetaByKey[routeKey]||{};
    const baseName=meta.baseName||String(routeKey||'');
    const infoText=typeof meta.infoText==='string'?meta.infoText:'';
    const displayName=meta.displayName|| (infoText?`${baseName} – ${infoText}`:baseName);
    const groupKey=JSON.stringify([baseName,infoText]);
    if(!groupMetaByKey[groupKey]){
      groupMetaByKey[groupKey]={displayName,baseName,infoText,color:meta.color||null,members:[]};
      routeGroupMembers[groupKey]=groupMetaByKey[groupKey].members;
    }
    if(meta.color&&!groupMetaByKey[groupKey].color){
      groupMetaByKey[groupKey].color=meta.color;
    }
    groupMetaByKey[groupKey].members.push(routeKey);
    routeMemberToGroup[routeKey]=groupKey;
  });
}

function normalizeRouteValue(routeKey){
  if(!routeKey){return '';}
  if(routeGroupMembers[routeKey]){return routeKey;}
  if(routeMemberToGroup[routeKey]){return routeMemberToGroup[routeKey];}
  return routeKey;
}

function getGroupMembers(routeKey){
  const normalized=normalizeRouteValue(routeKey);
  if(!normalized){return [];}
  if(routeGroupMembers[normalized]){return routeGroupMembers[normalized];}
  if(ridershipByRoute[normalized]){return [normalized];}
  return [];
}

function getRouteColor(routeKey){
  const meta=getRouteMeta(routeKey);
  if(meta&&meta.color){return meta.color;}
  return DEFAULT_ROUTE_COLOR;
}

updateLoadAvailability();

loadBtn.addEventListener('click',load);
exportBtn.addEventListener('click',exportCsv);
addTableBtn.addEventListener('click',()=>{
  const block=addRouteTable();
  const input=block.querySelector('.time-input');
  if(input){input.focus();}
});
templateBtn.addEventListener('click',loadTemplate);
academicTemplateBtn.addEventListener('click',loadAcademicTemplate);

if(!tablesContainer.children.length){
  addRouteTable();
}

function normalizeRouteName(route){
  if(typeof route!=='string'){return '';}
  const trimmed=route.trim();
  if(trimmed==='Red Line AM'||trimmed==='Red Line PM'){
    return 'Red Line';
  }
  return trimmed;
}

function load(){
  if(!dateInput.value){
    loadingMessage.textContent='Select a date to load data.';
    loadingMessage.style.display='block';
    return;
  }
  isLoading=true;
  updateLoadAvailability();
  spinner.style.display='inline-block';
  tablesContainer.classList.add('is-loading');
  loadingMessage.textContent='Loading Data, please wait...';
  loadingMessage.style.display='block';
  const [y,m,d]=dateInput.value.split('-').map(Number);
  const start=new Date(y,m-1,d);
  const nextStart=new Date(start);
  nextStart.setDate(start.getDate()+1);
  const end=new Date(nextStart);
  end.setDate(end.getDate()+1);
  const startStr=(start.getMonth()+1)+"/"+start.getDate()+"/"+start.getFullYear();
  const endStr=(end.getMonth()+1)+"/"+end.getDate()+"/"+end.getFullYear();
  const bounds={start,nextStart,end};
  const url=`https://uva.transloc.com/Services/JSONPRelay.svc/GetRidershipData?startDate=${encodeURIComponent(startStr)}&endDate=${encodeURIComponent(endStr)}`;
  const ridershipPromise=fetch(url).then(r=>r.json()).catch(err=>{
    console.error(err);
    return [];
  });
  Promise.all([
    fetchRouteInfo().catch(err=>{
      console.error(err);
      return routeInfoById;
    }),
    ridershipPromise
  ]).then(([,data])=>{
    render(normalizeApiArray(data),bounds);
  }).catch(err=>{
    console.error(err);
    render([],bounds);
  }).finally(()=>{
    isLoading=false;
    spinner.style.display='none';
    tablesContainer.classList.remove('is-loading');
    loadingMessage.style.display='none';
    updateLoadAvailability();
  });
}

function render(data,bounds){
  ridershipByRoute=Object.create(null);
  routeMetaByKey=Object.create(null);
  groupMetaByKey=Object.create(null);
  routeGroupMembers=Object.create(null);
  routeMemberToGroup=Object.create(null);
  let newest=null;
  const startBoundary=bounds?.start||null;
  const endBoundary=bounds?.end||null;
  (Array.isArray(data)?data:[]).forEach(rec=>{
    if(!rec){return;}
    const routeId=rec.RouteID;
    const routeKey=routeId!==undefined&&routeId!==null?String(routeId):normalizeRouteName(rec.Route);
    if(!routeKey){return;}
    const entries=Number(rec.Entries)||0;
    const timestamp=new Date(rec.ClientTime);
    let minutes=timestamp.getHours()*60+timestamp.getMinutes();
    if(startBoundary){
      const diffMinutes=Math.floor((timestamp-startBoundary)/60000);
      if(diffMinutes<0){return;}
      minutes=diffMinutes;
    }
    if(endBoundary&&timestamp>=endBoundary){return;}
    if(minutes>MAX_EXTENDED_MINUTES){return;}
    if(!ridershipByRoute[routeKey]){ridershipByRoute[routeKey]=[];}
    ridershipByRoute[routeKey].push({minutes,entries});
    if(!newest||timestamp>newest){newest=timestamp;}
    if(!routeMetaByKey[routeKey]){
      const info=routeId!==undefined&&routeId!==null?routeInfoById[String(routeId)]:null;
      const nameCandidates=[];
      if(info){
        if(typeof info.Description==='string'){nameCandidates.push(info.Description);}
        if(typeof info.RouteName==='string'){nameCandidates.push(info.RouteName);}
      }
      if(typeof rec.Route==='string'){nameCandidates.push(rec.Route);}
      let baseName='';
      for(let i=0;i<nameCandidates.length;i+=1){
        const normalized=normalizeRouteName(nameCandidates[i]);
        if(normalized){
          baseName=normalized;
          break;
        }
      }
      if(!baseName){
        baseName=routeId!==undefined&&routeId!==null?`Route ${routeId}`:'Unknown Route';
      }
      const infoText=info&&typeof info.InfoText==='string'?info.InfoText.trim():'';
      const displayName=infoText?`${baseName} – ${infoText}`:baseName;
      const infoColor=info&&typeof info.MapLineColor==='string'?normalizeColor(info.MapLineColor):null;
      routeMetaByKey[routeKey]={displayName,baseName,infoText:infoText||'',color:infoColor};
    }
  });
  buildRouteGroups();
  routeList=Object.keys(groupMetaByKey).sort((a,b)=>getRouteDisplayName(a).localeCompare(getRouteDisplayName(b)));
  newestDataTimestamp=newest;
  newestTimestamp.textContent=newest?newest.toLocaleString():'';
  let blocks=[...tablesContainer.querySelectorAll('.route-block')];
  if(!blocks.length){
    addRouteTable();
    blocks=[...tablesContainer.querySelectorAll('.route-block')];
  }
  blocks.forEach(block=>{
    const select=block.querySelector('.route-select');
    populateRouteOptions(select);
    updateBlock(block);
  });
}

function populateRouteOptions(select){
  const previous=normalizeRouteValue(select.value);
  select.innerHTML='';
  const placeholder=document.createElement('option');
  placeholder.value='';
  placeholder.textContent=routeList.length?'Select a route':'Loading routes...';
  select.appendChild(placeholder);
  routeList.forEach(route=>{
    const opt=document.createElement('option');
    opt.value=route;
    opt.textContent=getRouteDisplayName(route);
    select.appendChild(opt);
  });
  if(routeList.includes(previous)){
    select.value=previous;
  }else{
    select.value='';
  }
}

function addRouteTable(){
  const block=document.createElement('div');
  block.className='route-block';

  const header=document.createElement('div');
  header.className='route-header';

  const label=document.createElement('label');
  label.textContent='Route:';
  const select=document.createElement('select');
  select.className='route-select';
  label.appendChild(select);

  const altLabel=document.createElement('label');
  altLabel.textContent='Alternate Name:';
  const altInput=document.createElement('input');
  altInput.type='text';
  altInput.placeholder='Optional description';
  altInput.className='alternate-input';
  altLabel.appendChild(altInput);

  header.appendChild(label);
  header.appendChild(altLabel);
  block.appendChild(header);

  const table=document.createElement('table');
  table.className='route-table';

  const thead=document.createElement('thead');
  const headRow=document.createElement('tr');
  const thRange=document.createElement('th');
  thRange.textContent='Time Range (HHMM - HHMM)';
  const thPassengers=document.createElement('th');
  thPassengers.textContent='Passengers';
  const thActions=document.createElement('th');
  thActions.textContent='';
  thActions.className='action-header';
  headRow.appendChild(thRange);
  headRow.appendChild(thPassengers);
  headRow.appendChild(thActions);
  thead.appendChild(headRow);

  const tbody=document.createElement('tbody');

  const tfoot=document.createElement('tfoot');
  const footRow=document.createElement('tr');
  const totalLabel=document.createElement('th');
  totalLabel.textContent='Total Displayed';
  const totalValue=document.createElement('td');
  totalValue.className='route-total';
  totalValue.textContent='0';
  footRow.appendChild(totalLabel);
  footRow.appendChild(totalValue);
  tfoot.appendChild(footRow);

  const dayRow=document.createElement('tr');
  dayRow.className='route-day-total-row';
  const dayLabel=document.createElement('th');
  dayLabel.textContent='Day Total';
  const dayValue=document.createElement('td');
  dayValue.className='route-day-total';
  dayValue.textContent='0';
  dayRow.appendChild(dayLabel);
  dayRow.appendChild(dayValue);
  tfoot.appendChild(dayRow);

  table.appendChild(thead);
  table.appendChild(tbody);
  table.appendChild(tfoot);
  block.appendChild(table);

  const quickAdd=document.createElement('div');
  quickAdd.className='quick-add';

  const add30Btn=createQuickAddButton(block,'+30 min',30);
  const add60Btn=createQuickAddButton(block,'+1 hr',60);
  const addRowBtn=document.createElement('button');
  addRowBtn.type='button';
  addRowBtn.textContent='Add Time Range';
  quickAdd.appendChild(add30Btn);
  quickAdd.appendChild(add60Btn);
  quickAdd.appendChild(addRowBtn);

  block.appendChild(quickAdd);

  tablesContainer.appendChild(block);

  populateRouteOptions(select);
  addTimeRow(block);
  select.addEventListener('change',()=>updateBlock(block));
  addRowBtn.addEventListener('click',()=>{
    const row=addTimeRow(block);
    const input=row.querySelector('.time-input');
    if(input){input.focus();}
  });

  updateBlock(block);
  return block;
}

function addTimeRow(block){
  const tbody=block.querySelector('tbody');
  const row=document.createElement('tr');
  row.className='time-row';

  const timeCell=document.createElement('td');
  const input=document.createElement('input');
  input.type='text';
  input.placeholder='2200 - 2630';
  input.className='time-input';
  input.addEventListener('change',()=>updateBlock(block));
  input.addEventListener('input',()=>updateBlock(block));
  timeCell.appendChild(input);

  const resultCell=document.createElement('td');
  resultCell.className='result-cell';
  resultCell.textContent='-';

  const actionCell=document.createElement('td');
  actionCell.className='action-cell';
  const removeBtn=document.createElement('button');
  removeBtn.type='button';
  removeBtn.className='remove-row-btn';
  removeBtn.textContent='−';
  removeBtn.title='Remove time frame';
  removeBtn.addEventListener('click',()=>{
    row.remove();
    updateBlock(block);
  });
  actionCell.appendChild(removeBtn);

  row.appendChild(timeCell);
  row.appendChild(resultCell);
  row.appendChild(actionCell);
  tbody.appendChild(row);
  return row;
}

function createQuickAddButton(block,label,duration){
  const btn=document.createElement('button');
  btn.type='button';
  btn.textContent=label;
  btn.addEventListener('click',()=>{
    const range=getNextRange(block,duration);
    if(!range){return;}
    const row=addTimeRow(block);
    const input=row.querySelector('.time-input');
    input.value=formatRange(range.start,range.end);
    updateBlock(block);
    input.focus();
  });
  return btn;
}

function getNextRange(block,duration){
  const lastEnd=getLastRangeEnd(block);
  const start=lastEnd!==null?lastEnd:0;
  if(start>=MAX_EXTENDED_MINUTES){return null;}
  const end=Math.min(start+duration,MAX_EXTENDED_MINUTES);
  if(end<=start){return null;}
  return {start,end};
}

function getLastRangeEnd(block){
  let lastEnd=null;
  block.querySelectorAll('.time-row .time-input').forEach(input=>{
    const range=parseRange(input.value);
    if(range&&range.end>(lastEnd??-Infinity)){
      lastEnd=range.end;
    }
  });
  return lastEnd;
}

function formatRange(start,end){
  return `${formatMinutes(start)} - ${formatMinutes(end)}`;
}

function formatMinutes(total){
  const capped=Math.min(total,MAX_EXTENDED_MINUTES);
  const hours=String(Math.floor(capped/60)).padStart(2,'0');
  const mins=String(capped%60).padStart(2,'0');
  return `${hours}${mins}`;
}

function updateBlock(block){
  const select=block.querySelector('.route-select');
  const normalizedRoute=normalizeRouteValue(select.value);
  if(normalizedRoute&&normalizedRoute!==select.value&&routeList.includes(normalizedRoute)){
    select.value=normalizedRoute;
  }
  const route=normalizeRouteValue(select.value);
  const rows=[...block.querySelectorAll('.time-row')];
  let total=0;
  rows.forEach(row=>{
    const input=row.querySelector('.time-input');
    const resultCell=row.querySelector('.result-cell');
    const range=parseRange(input.value);
    resultCell.classList.remove('invalid');
    if(!route){
      resultCell.textContent='-';
      return;
    }
    if(!range){
      const trimmed=input.value.trim();
      if(trimmed===''||!trimmed.includes('-')){
        resultCell.textContent='-';
      }else{
        resultCell.textContent='Invalid';
        resultCell.classList.add('invalid');
      }
      return;
    }
    const sum=sumForRange(route,range.start,range.end);
    resultCell.textContent=sum;
    total+=sum;
  });
  block.querySelector('.route-total').textContent=total;
  updateOverallTotal();
  updateRouteDayTotals();
  updateRouteTotalsTable();
}

function updateOverallTotal(){
  let sum=0;
  tablesContainer.querySelectorAll('.route-total').forEach(cell=>{
    const value=Number(cell.textContent.replace(/[^0-9.-]/g,''));
    if(!Number.isNaN(value)){sum+=value;}
  });
  overallTotalDisplay.textContent=sum;
}

function collectRouteTotals(blocks){
  const list=blocks||[...tablesContainer.querySelectorAll('.route-block')];
  const totals=[];
  const indexMap=new Map();
  list.forEach(block=>{
    const route=normalizeRouteValue(block.querySelector('.route-select').value);
    if(!route){return;}
    const totalCell=block.querySelector('.route-total');
    const numeric=Number(totalCell.textContent.replace(/[^0-9.-]/g,''));
    const value=Number.isNaN(numeric)?0:numeric;
    let entry;
    if(indexMap.has(route)){
      entry=totals[indexMap.get(route)];
    }else{
      entry={route,total:0,blocks:[]};
      indexMap.set(route,totals.length);
      totals.push(entry);
    }
    entry.total+=value;
    entry.blocks.push(block);
  });
  return totals;
}

function updateRouteDayTotals(){
  const blocks=[...tablesContainer.querySelectorAll('.route-block')];
  blocks.forEach(block=>{
    const dayRow=block.querySelector('.route-day-total-row');
    if(dayRow){dayRow.style.display='none';}
  });
  const totals=collectRouteTotals(blocks);
  totals.forEach(({total,blocks:routeBlocks})=>{
    const showRow=routeBlocks.length>1;
    routeBlocks.forEach(block=>{
      const dayRow=block.querySelector('.route-day-total-row');
      const dayValue=block.querySelector('.route-day-total');
      if(!dayRow||!dayValue){return;}
      if(showRow){
        dayRow.style.display='';
        dayValue.textContent=total;
      }else{
        dayRow.style.display='none';
        dayValue.textContent=total;
      }
    });
  });
}

function updateRouteTotalsTable(){
  if(!routeTotalsWrapper||!routeTotalsBody||!routeTotalsOverallRow){return;}
  if(routeTotalsOverallRow.parentElement===routeTotalsBody){
    routeTotalsBody.removeChild(routeTotalsOverallRow);
  }
  routeTotalsBody.textContent='';
  const totals=collectRouteTotals();
  if(!totals.length){
    routeTotalsWrapper.style.display='none';
    updateRouteTotalsChart();
    return;
  }
  totals.forEach(entry=>{
    const row=document.createElement('tr');
    const nameCell=document.createElement('td');
    nameCell.textContent=getRouteDisplayName(entry.route);
    const valueCell=document.createElement('td');
    valueCell.className='route-totals-value';
    valueCell.textContent=entry.total;
    row.appendChild(nameCell);
    row.appendChild(valueCell);
    routeTotalsBody.appendChild(row);
  });
  routeTotalsBody.appendChild(routeTotalsOverallRow);
  routeTotalsWrapper.style.display='block';
  updateRouteTotalsChart();
}

function sumEntriesForRangeByHour(routeKey,start,end){
  const perHour=new Map();
  const members=getGroupMembers(routeKey);
  if(!members.length){return perHour;}
  members.forEach(member=>{
    const records=ridershipByRoute[member];
    if(!records){return;}
    records.forEach(({minutes,entries})=>{
      if(minutes>=start&&minutes<end){
        const hour=Math.floor(minutes/60);
        perHour.set(hour,(perHour.get(hour)||0)+entries);
      }
    });
  });
  return perHour;
}

function formatHourLabel(hour){
  const normalized=Math.max(0,Math.min(hour,MAX_EXTENDED_HOUR));
  return `${String(normalized).padStart(2,'0')}:00`;
}

function collectRouteChartData(){
  const hourSet=new Set();
  const routeHourTotals=new Map();
  const blocks=[...tablesContainer.querySelectorAll('.route-block')];
  blocks.forEach(block=>{
    const route=normalizeRouteValue(block.querySelector('.route-select').value);
    if(!route){return;}
    const rows=[...block.querySelectorAll('.time-row')];
    if(!rows.length){return;}
    const hourMap=routeHourTotals.get(route)||new Map();
    rows.forEach(row=>{
      const input=row.querySelector('.time-input');
      const range=parseRange(input.value);
      if(!range){return;}
      const contributions=sumEntriesForRangeByHour(route,range.start,range.end);
      contributions.forEach((value,hour)=>{
        hourSet.add(hour);
        hourMap.set(hour,(hourMap.get(hour)||0)+value);
      });
    });
    if(hourMap.size){
      routeHourTotals.set(route,hourMap);
    }
  });
  const hours=Array.from(hourSet).sort((a,b)=>a-b);
  const labels=hours.map(formatHourLabel);
  const datasets=[];
  let maxY=0;
  let hasData=false;
  routeHourTotals.forEach((hourMap,route)=>{
    const label=getRouteDisplayName(route);
    const color=getRouteColor(route);
    const data=hours.map(hour=>{
      const value=hourMap.get(hour)||0;
      if(value>maxY){maxY=value;}
      if(value>0){hasData=true;}
      return value;
    });
    datasets.push({label,data,backgroundColor:color,borderRadius:6,borderSkipped:false,maxBarThickness:40});
  });
  return {labels,datasets,maxY,hasData};
}

function updateRouteTotalsChart(){
  if(!routeTotalsChartWrapper||!routeTotalsChartCanvas||!window.Chart){return;}
  if(routeTotalsChart){
    routeTotalsChart.destroy();
    routeTotalsChart=null;
  }
  const {labels,datasets,maxY,hasData}=collectRouteChartData();
  if(!labels.length||!datasets.length||!hasData){
    routeTotalsChartWrapper.style.display='none';
    return;
  }
  const context=routeTotalsChartCanvas.getContext('2d');
  const pluginOptions={
    legend:{labels:{color:CHART_LABEL_COLOR}}
  };
  if(window.ChartDataLabels){
    pluginOptions.datalabels={
      anchor:'end',
      align:'end',
      color:CHART_LABEL_COLOR,
      formatter:value=>value>0?value:'',
      clamp:true
    };
  }
  const whiteBackgroundPlugin={
    id:'whiteBackground',
    beforeDraw(chart){
      const {ctx,canvas}=chart;
      ctx.save();
      ctx.globalCompositeOperation='destination-over';
      ctx.fillStyle='#fff';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.restore();
    }
  };
  routeTotalsChart=new Chart(context,{
    type:'bar',
    data:{labels,datasets},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      layout:{padding:{top:12,right:12,left:8,bottom:12}},
      scales:{
        x:{
          stacked:false,
          ticks:{color:CHART_LABEL_COLOR},
          title:{display:true,text:'Hour',color:CHART_LABEL_COLOR}
        },
        y:{
          beginAtZero:true,
          suggestedMax:maxY,
          grace:'10%',
          ticks:{color:CHART_LABEL_COLOR},
          title:{display:true,text:'Passengers',color:CHART_LABEL_COLOR},
          grid:{color:'rgba(159,176,201,0.15)'}
        }
      },
      plugins:pluginOptions,
      interaction:{mode:'index',intersect:false}
    },
    plugins:[whiteBackgroundPlugin]
  });
  if(isBrokenChartMode){
    const candidateHeight=brokenChartHeight??Number.parseInt(window.getComputedStyle(routeTotalsChartCanvas).height,10);
    const computedHeight=(Number.isFinite(candidateHeight)?candidateHeight:0)||320;
    brokenChartHeight=computedHeight+80;
    routeTotalsChartWrapper.style.maxHeight=`${brokenChartHeight}px`;
    routeTotalsChartWrapper.style.height=`${brokenChartHeight}px`;
    routeTotalsChartCanvas.style.height=`${brokenChartHeight}px`;
    routeTotalsChartCanvas.height=brokenChartHeight;
  }
  routeTotalsChartWrapper.style.display='block';
}

function parseRange(value){
  if(!value){return null;}
  const cleaned=value.trim().replace(/\s+/g,'');
  const match=cleaned.match(/^(\d{1,2})(\d{2})?-(\d{1,2})(\d{2})?$/);
  if(!match){
    const colonMatch=value.trim().match(/^(\d{1,2})(?::?(\d{2}))\s*-\s*(\d{1,2})(?::?(\d{2}))$/);
    if(!colonMatch){return null;}
    return normalizeRange(colonMatch[1],colonMatch[2],colonMatch[3],colonMatch[4]);
  }
  const [,sh,sm,eh,em]=match;
  const startMinutes=sm!==undefined?Number(sm):0;
  const endMinutes=em!==undefined?Number(em):0;
  return normalizeRange(sh,startMinutes,eh,endMinutes);
}

function normalizeRange(sh,sm,eh,em){
  const startHour=Number(sh);
  const startMin=Number(sm||0);
  const endHour=Number(eh);
  const endMin=Number(em||0);
  if([startHour,startMin,endHour,endMin].some(n=>Number.isNaN(n))){return null;}
  if(startMin>59||endMin>59){return null;}
  if(startHour<0||endHour<0){return null;}
  if(startHour>MAX_EXTENDED_HOUR||endHour>MAX_EXTENDED_HOUR){return null;}
  if((startHour===MAX_EXTENDED_HOUR&&startMin>0)||(endHour===MAX_EXTENDED_HOUR&&endMin>0)){return null;}
  const start=startHour*60+startMin;
  let end=endHour*60+endMin;
  if(endHour===23&&endMin===59){end=24*60;}
  if(endHour===MAX_EXTENDED_HOUR&&endMin===0){end=MAX_EXTENDED_MINUTES;}
  if(end>MAX_EXTENDED_MINUTES){return null;}
  if(end<=start){return null;}
  return {start,end};
}

function sumForRange(route,start,end){
  const members=getGroupMembers(route);
  if(!members.length){return 0;}
  let total=0;
  members.forEach(member=>{
    const records=ridershipByRoute[member];
    if(!records){return;}
    records.forEach(rec=>{
      if(rec.minutes>=start&&rec.minutes<end){
        total+=rec.entries;
      }
    });
  });
  return total;
}

function exportCsv(){
  const lines=[];
  const dateValue=dateInput.value||new Date().toISOString().split('T')[0];
  const asOfValue=newestDataTimestamp?newestDataTimestamp.toLocaleString():'';
  const overallTotal=overallTotalDisplay.textContent.trim();
  lines.push(`Date,${escapeCsv(dateValue)},As Of,${escapeCsv(asOfValue)}`);
  const blocks=[...tablesContainer.querySelectorAll('.route-block')];
  const perRouteTotals=collectRouteTotals(blocks);
  if(perRouteTotals.length){
    lines.push('Route,Total');
    perRouteTotals.forEach(entry=>{
      lines.push(`${escapeCsv(getRouteDisplayName(entry.route))},${escapeCsv(entry.total)}`);
    });
    lines.push(`Overall Displayed Total,${escapeCsv(overallTotal)}`);
  }else{
    lines.push(`Overall Displayed Total,${escapeCsv(overallTotal)}`);
  }
  lines.push('');
  const routeMeta=new Map();
  perRouteTotals.forEach(entry=>{
    routeMeta.set(entry.route,{total:entry.total,count:entry.blocks.length});
  });
  const routeSeen=new Map();
  blocks.forEach((block,index)=>{
    const route=normalizeRouteValue(block.querySelector('.route-select').value)||'';
    const alternate=block.querySelector('.alternate-input')?.value||'';
    const routeLabel=alternate||getRouteDisplayName(route);
    if(index>0){lines.push('');}
    lines.push(`Route,${escapeCsv(routeLabel)}`);
    lines.push('Time Range,Passengers');
    block.querySelectorAll('tbody tr').forEach(row=>{
      const timeValue=row.querySelector('.time-input').value.trim();
      const passengers=row.querySelector('.result-cell').textContent.trim();
      lines.push(`${escapeCsv(timeValue)},${escapeCsv(passengers)}`);
    });
    const total=block.querySelector('.route-total').textContent.trim();
    lines.push(`Total,${escapeCsv(total)}`);
    if(route){
      const count=(routeSeen.get(route)||0)+1;
      routeSeen.set(route,count);
      const meta=routeMeta.get(route);
      if(meta&&meta.count>1&&count===meta.count){
        lines.push(`Day Total,${escapeCsv(meta.total)}`);
      }
    }
  });
  const notes=notesInput.value.trim();
  if(notes){
    lines.push('');
    lines.push(`Notes,${escapeCsv(notes)}`);
  }
  const csv=lines.join('\n');
  const blob=new Blob(['\ufeff'+csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`ridership_${dateValue}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

function ensureRouteOption(select,route,label){
  if(!route){return;}
  const normalized=normalizeRouteValue(route);
  const exists=[...select.options].some(opt=>opt.value===normalized);
  if(!exists){
    const opt=document.createElement('option');
    opt.value=normalized;
    opt.textContent=label||getRouteDisplayName(normalized);
    select.appendChild(opt);
  }
}

function applyTemplateConfig(template){
  tablesContainer.innerHTML='';
  const usageMap=new Map();
  template.forEach(item=>{
    const block=addRouteTable();
    const select=block.querySelector('.route-select');
    const routeKey=findRouteKeyForTemplate(item.route,item.matchInfoText,usageMap);
    const normalizedRoute=normalizeRouteValue(routeKey);
    if(normalizedRoute){
      ensureRouteOption(select,normalizedRoute);
      select.value=normalizedRoute;
    }else{
      select.value='';
    }
    const altInput=block.querySelector('.alternate-input');
    if(altInput){altInput.value=item.alternate||'';}
    const times=Array.isArray(item.times)?item.times:[];
    const rows=[...block.querySelectorAll('.time-row')];
    if(rows[0]){
      rows[0].querySelector('.time-input').value=times[0]||'';
    }
    for(let i=1;i<times.length;i++){
      const row=addTimeRow(block);
      row.querySelector('.time-input').value=times[i];
    }
    if(times.length===0){
      rows.forEach(row=>row.remove());
    }
    updateBlock(block);
  });
}

function loadTemplate(){
  const template=[
    {route:'Red Line',alternate:'Scott Stadium West Parking Lots (Red Line AM)',times:['0430 - 0600','0600 - 0730']},
    {route:'Red Line',alternate:'Scott Stadium West Parking Lots (Red Line PM)',times:['1400 - 1500','1500 - 1600','1600 - 1700','1700 - 1800','1800 - 1900','1900 - 2030']},
    {route:'Blue Line',alternate:'Emmet-Ivy Garage (Blue Line AM)',times:['0630 - 0730','0730 - 0800','0800 - 0900','0900 - 1000']},
    {route:'Blue Line',alternate:'Emmet-Ivy Garage (Blue Line PM)',times:['1000 - 1430','1430 - 1500','1500 - 1600','1600 - 1700','1700 - 1800','1800 - 1900','1900 - 2030']}
  ];
  applyTemplateConfig(template);
}

function loadAcademicTemplate(){
  const template=[
    {route:'Green Line',alternate:'Green Line – Pre-6PM',times:['0700 - 0730','0730 - 0800','0800 - 0900','0900 - 1000','1000 - 1100','1100 - 1200','1200 - 1300','1300 - 1400','1400 - 1500','1500 - 1600','1600 - 1700','1700 - 1800','1800 - 1830']},
    {route:'Green Loop',alternate:'Green Loop – Post-6PM/Weekends',times:['1730 - 1800','1800 - 1900','1900 - 2000','2000 - 2100','2100 - 2200','2200 - 2230']},
    {route:'Orange Line',alternate:'Orange Line – Pre-6PM',times:['0700 - 0730','0730 - 0800','0800 - 0900','0900 - 1000','1000 - 1100','1100 - 1200','1200 - 1300','1300 - 1400','1400 - 1500','1500 - 1600','1600 - 1700','1700 - 1800','1800 - 1830']},
    {route:'Orange Loop',alternate:'Orange Loop – Post-6PM/Weekends',times:['1730 - 1800','1800 - 1900','1900 - 2000','2000 - 2100','2100 - 2200','2200 - 2230']},
    {route:'Gold Line',matchInfoText:'Pre-6PM',alternate:'Gold Line – Pre-6PM',times:['0430 - 0500','0500 - 0600','0600 - 0700','0700 - 0800','0800 - 0900','0900 - 1000','1000 - 1100','1100 - 1200','1200 - 1300','1300 - 1400','1400 - 1500','1500 - 1600','1600 - 1700','1700 - 1800','1800 - 1830']},
    {route:'Gold Line',matchInfoText:'Post-6PM/Weekends',alternate:'Gold Line – Post-6PM/Weekends',times:['1730 - 1800','1800 - 1900','1900 - 2000','2000 - 2100','2100 - 2200','2200 - 2230']},
    {route:'Silver Line',alternate:'Silver Line',times:['0600 - 0630','0630 - 0700','0700 - 0800','0800 - 0900','0900 - 1000','1000 - 1100','1100 - 1200','1200 - 1300','1300 - 1400','1400 - 1500','1500 - 1600','1600 - 1700','1700 - 1800','1800 - 1900','1900 - 2000','2000 - 2030']},
    {route:'Night Pilot',alternate:'Night Pilot',times:['2130 - 2200','2200 - 2300','2300 - 2400','2400 - 2500','2500 - 2600','2600 - 2630']}
  ];
  applyTemplateConfig(template);
}

function escapeCsv(text){
  const str=String(text||'');
  if(/[",\n]/.test(str)){
    return '"'+str.replace(/"/g,'""')+'"';
  }
  return str;
}
</script>
<script src="mobile-nav.js"></script>
</body>
</html>
