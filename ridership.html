<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Ridership Report - Headway Guard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preload" href="FGDC.ttf" as="font" type="font/ttf" crossorigin />
<style>
  @font-face{font-family:'FGDC';src:url('FGDC.ttf') format('truetype');font-weight:normal;font-style:normal;}
  :root{ --bg:#0b0e11; --panel:#0f141a; --ink:#e8eef5; --muted:#9fb0c9; --line:#1f2630; }
  body{margin:0;background:var(--bg);color:var(--ink);font:16px 'FGDC',sans-serif;padding:20px;}
  table{border-collapse:collapse;width:100%;max-width:800px;}
  th,td{border:1px solid var(--line);padding:4px;text-align:center;}
  textarea{width:100%;height:60px;}
  input[type=date]{margin-right:8px;}
</style>
</head>
<body>
<h1>Ridership Report</h1>
<label>Date: <input type="date" id="datePicker"></label><button id="loadBtn">Load</button>
<table id="ridershipTable">
  <tr><th>Overall Total:</th><td id="overallTotal" colspan="8"></td></tr>
  <tr><td colspan="9"><textarea id="notes" placeholder="Service Notes..."></textarea></td></tr>
  <tr><th colspan="9">Red Line</th></tr>
  <tr><th>Total Passengers:</th><td id="totalRed"></td><td colspan="7"></td></tr>
  <tr><th colspan="9">AM Numbers</th></tr>
  <tr><th>5-6AM</th><th>6-7AM</th><th>AM Total</th><td colspan="6"></td></tr>
  <tr><td id="am_5_6"></td><td id="am_6_7"></td><td id="am_total"></td><td colspan="6"></td></tr>
  <tr><th colspan="9">PM Numbers</th></tr>
  <tr><th></th><th>2:30PM-3PM</th><th>3-4PM</th><th>4-5PM</th><th>5-6PM</th><th>6-7PM</th><th>7-8PM</th><th>PM Total</th><th>Day Total</th></tr>
  <tr><td></td><td id="pm_230_3"></td><td id="pm_3_4"></td><td id="pm_4_5"></td><td id="pm_5_6"></td><td id="pm_6_7"></td><td id="pm_7_8"></td><td id="pm_total"></td><td id="day_total"></td></tr>
  <tr><th colspan="9">Blue Line</th></tr>
  <tr><th>Total Passengers:</th><td id="totalBlue"></td><td colspan="7"></td></tr>
  <tr><th colspan="9">AM Numbers</th></tr>
  <tr><th>7-7:30AM</th><th>7:30-8AM</th><th>8-9AM</th><th>9-10AM</th><th>AM Total</th><td colspan="4"></td></tr>
  <tr><td id="blue_am_7_7_30"></td><td id="blue_am_7_30_8"></td><td id="blue_am_8_9"></td><td id="blue_am_9_10"></td><td id="blue_am_total"></td><td colspan="4"></td></tr>
  <tr><th colspan="9">PM Numbers</th></tr>
  <tr><th>10AM-2:30PM</th><th>2:30-3PM</th><th>3-4PM</th><th>4-5PM</th><th>5-6PM</th><th>6-7PM</th><th>7-8PM</th><th>Total after 2:30PM</th><th>Day Total</th></tr>
  <tr><td id="blue_10_14_30"></td><td id="blue_14_30_15"></td><td id="blue_15_16"></td><td id="blue_16_17"></td><td id="blue_17_18"></td><td id="blue_18_19"></td><td id="blue_19_20"></td><td id="blue_total_after_230"></td><td id="blue_day_total"></td></tr>
</table>
<script>
const dateInput=document.getElementById('datePicker');
const today=new Date().toLocaleDateString('en-CA',{timeZone:'America/New_York'});
dateInput.value=today;

document.getElementById('loadBtn').addEventListener('click',load);
window.addEventListener('load',load);

function load(){
  const [y,m,d]=dateInput.value.split('-').map(Number);
  const start=new Date(y,m-1,d);
  const end=new Date(start);
  end.setDate(start.getDate()+1);
  const startStr=(start.getMonth()+1)+"/"+start.getDate()+"/"+start.getFullYear();
  const endStr=(end.getMonth()+1)+"/"+end.getDate()+"/"+end.getFullYear();
  const url=`https://uva.transloc.com/Services/JSONPRelay.svc/GetRidershipData?startDate=${encodeURIComponent(startStr)}&endDate=${encodeURIComponent(endStr)}`;
  fetch(url).then(r=>r.json()).then(render).catch(err=>{
    console.error(err);
  });
}

function render(data){
  const overall={'Red Line AM':0,'Red Line PM':0,'Blue Line':0};
  const routeTotals={'Red Line AM':0,'Red Line PM':0,'Blue Line AM':0,'Blue Line PM':0};
  const redAmSlots={'5-6':0,'6-7':0};
  const redPmSlots={'14_30-15':0,'15-16':0,'16-17':0,'17-18':0,'18-19':0,'19-20':0};
  const blueAmSlots={'7-7_30':0,'7_30-8':0,'8-9':0,'9-10':0};
  const bluePmSlots={'10-14_30':0,'14_30-15':0,'15-16':0,'16-17':0,'17-18':0,'18-19':0,'19-20':0};
  data.forEach(rec=>{
    const route=rec.Route;
    const entries=Number(rec.Entries)||0;
    if(overall[route]!==undefined){overall[route]+=entries;}
    const t=new Date(rec.ClientTime);
    const h=t.getHours();
    const m=t.getMinutes();
    const mins=h*60+m;
    if(route==='Red Line AM'||route==='Red Line PM'){
      routeTotals[route]+=entries;
      if(mins>=4*60+30 && mins<6*60) redAmSlots['5-6']+=entries;
      else if(mins>=6*60 && mins<7*60+30) redAmSlots['6-7']+=entries;
      if(mins>=14*60 && mins<15*60) redPmSlots['14_30-15']+=entries;
      else if(mins>=15*60 && mins<16*60) redPmSlots['15-16']+=entries;
      else if(mins>=16*60 && mins<17*60) redPmSlots['16-17']+=entries;
      else if(mins>=17*60 && mins<18*60) redPmSlots['17-18']+=entries;
      else if(mins>=18*60 && mins<19*60) redPmSlots['18-19']+=entries;
      else if(mins>=19*60 && mins<20*60+30) redPmSlots['19-20']+=entries;
    }
    if(route==='Blue Line'){
      if(mins<10*60){routeTotals['Blue Line AM']+=entries;} else {routeTotals['Blue Line PM']+=entries;}
      if(mins>=6*60+30 && mins<7*60+30) blueAmSlots['7-7_30']+=entries;
      else if(mins>=7*60+30 && mins<8*60) blueAmSlots['7_30-8']+=entries;
      else if(mins>=8*60 && mins<9*60) blueAmSlots['8-9']+=entries;
      else if(mins>=9*60 && mins<10*60) blueAmSlots['9-10']+=entries;
      else if(mins>=10*60 && mins<14*60+30) bluePmSlots['10-14_30']+=entries;
      else if(mins>=14*60+30 && mins<15*60) bluePmSlots['14_30-15']+=entries;
      else if(mins>=15*60 && mins<16*60) bluePmSlots['15-16']+=entries;
      else if(mins>=16*60 && mins<17*60) bluePmSlots['16-17']+=entries;
      else if(mins>=17*60 && mins<18*60) bluePmSlots['17-18']+=entries;
      else if(mins>=18*60 && mins<19*60) bluePmSlots['18-19']+=entries;
      else if(mins>=19*60 && mins<20*60+30) bluePmSlots['19-20']+=entries;
    }
  });
  document.getElementById('overallTotal').textContent=
    overall['Red Line AM']+overall['Red Line PM']+overall['Blue Line'];
  const totalRed=routeTotals['Red Line AM']+routeTotals['Red Line PM'];
  document.getElementById('totalRed').textContent=totalRed;
  document.getElementById('am_5_6').textContent=redAmSlots['5-6'];
  document.getElementById('am_6_7').textContent=redAmSlots['6-7'];
  const amTotal=redAmSlots['5-6']+redAmSlots['6-7'];
  document.getElementById('am_total').textContent=amTotal;
  document.getElementById('pm_230_3').textContent=redPmSlots['14_30-15'];
  document.getElementById('pm_3_4').textContent=redPmSlots['15-16'];
  document.getElementById('pm_4_5').textContent=redPmSlots['16-17'];
  document.getElementById('pm_5_6').textContent=redPmSlots['17-18'];
  document.getElementById('pm_6_7').textContent=redPmSlots['18-19'];
  document.getElementById('pm_7_8').textContent=redPmSlots['19-20'];
  const pmTotal=Object.values(redPmSlots).reduce((a,b)=>a+b,0);
  document.getElementById('pm_total').textContent=pmTotal;
  document.getElementById('day_total').textContent=pmTotal+amTotal;
  const totalBlue=routeTotals['Blue Line AM']+routeTotals['Blue Line PM'];
  document.getElementById('totalBlue').textContent=totalBlue;
  document.getElementById('blue_am_7_7_30').textContent=blueAmSlots['7-7_30'];
  document.getElementById('blue_am_7_30_8').textContent=blueAmSlots['7_30-8'];
  document.getElementById('blue_am_8_9').textContent=blueAmSlots['8-9'];
  document.getElementById('blue_am_9_10').textContent=blueAmSlots['9-10'];
  const blueAmTotal=Object.values(blueAmSlots).reduce((a,b)=>a+b,0);
  document.getElementById('blue_am_total').textContent=blueAmTotal;
  document.getElementById('blue_10_14_30').textContent=bluePmSlots['10-14_30'];
  document.getElementById('blue_14_30_15').textContent=bluePmSlots['14_30-15'];
  document.getElementById('blue_15_16').textContent=bluePmSlots['15-16'];
  document.getElementById('blue_16_17').textContent=bluePmSlots['16-17'];
  document.getElementById('blue_17_18').textContent=bluePmSlots['17-18'];
  document.getElementById('blue_18_19').textContent=bluePmSlots['18-19'];
  document.getElementById('blue_19_20').textContent=bluePmSlots['19-20'];
  const bluePmTotal=Object.values(bluePmSlots).reduce((a,b)=>a+b,0);
  const blueAfter230=bluePmSlots['14_30-15']+bluePmSlots['15-16']+bluePmSlots['16-17']+bluePmSlots['17-18']+bluePmSlots['18-19']+bluePmSlots['19-20'];
  document.getElementById('blue_total_after_230').textContent=blueAfter230;
  document.getElementById('blue_day_total').textContent=blueAmTotal+bluePmTotal;
}
</script>
</body>
</html>
