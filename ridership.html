<!doctype html>
<html>
<head>
<link rel="icon" type="image/png" href="headwayguardicon.png" />
<meta charset="utf-8" />
<title>Ridership Counts - Headway Guard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preload" href="FGDC.ttf" as="font" type="font/ttf" crossorigin />
<style>
  @font-face{font-family:'FGDC';src:url('FGDC.ttf') format('truetype');font-weight:normal;font-style:normal;}
  :root{--bg:#0b0e11;--panel:#0f141a;--ink:#e8eef5;--muted:#9fb0c9;--line:#1f2630;--accent:#4b85f2;--danger:#f06c6c;}
  *{box-sizing:border-box;}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px 'FGDC',sans-serif;padding:20px;line-height:1.4;}
  h1{margin-top:0;margin-bottom:16px;}
  button{background:var(--accent);color:#fff;border:none;padding:8px 14px;border-radius:6px;font:inherit;cursor:pointer;}
  button:hover{filter:brightness(1.1);} 
  button:disabled{opacity:0.6;cursor:not-allowed;}
  input,select,textarea{font:inherit;border:1px solid var(--line);border-radius:6px;padding:6px;background:var(--panel);color:var(--ink);} 
  textarea{width:100%;min-height:80px;margin-top:12px;}
  table{border-collapse:collapse;width:100%;margin-top:12px;}
  th,td{border:1px solid var(--line);padding:8px;text-align:left;}
  th{background:rgba(255,255,255,0.05);font-weight:normal;}
  .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px;}
  .controls label{display:flex;align-items:center;gap:6px;}
  .spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--ink);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
  #newestDisplay{margin:12px 0;color:var(--muted);}
  #tablesContainer{display:flex;flex-direction:column;gap:18px;margin-top:12px;}
  .route-block{background:var(--panel);padding:16px;border-radius:12px;border:1px solid var(--line);box-shadow:0 4px 12px rgba(0,0,0,0.2);}
  .route-header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;}
  .route-header label{display:flex;align-items:center;gap:8px;}
  .time-input{width:100%;min-width:160px;}
  .result-cell{width:120px;text-align:right;font-variant-numeric:tabular-nums;}
  .result-cell.invalid{color:var(--danger);}
  .route-total{font-weight:bold;text-align:right;}
  #overallTotalRow{margin-top:16px;font-size:18px;font-weight:bold;}
  #addTableBtn{margin-top:16px;background:#2f9d78;}
  .quick-add{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
</style>
</head>
<body>
<h1>Ridership Counts</h1>
<div class="controls">
  <label>Date: <input type="date" id="datePicker"></label>
  <button id="loadBtn">Load</button>
  <span id="spinner" class="spinner" style="display:none"></span>
  <button id="exportBtn">Export CSV</button>
</div>
<div id="newestDisplay">Newest Data: <span id="newestTimestamp"></span></div>
<div id="overallTotalRow">Overall Displayed Total: <span id="overallTotal">0</span></div>
<div id="tablesContainer"></div>
<button id="addTableBtn" type="button">Add Another Route</button>
<textarea id="notes" placeholder="Service Notes..."></textarea>
<script>
const dateInput=document.getElementById('datePicker');
const spinner=document.getElementById('spinner');
const newestTimestamp=document.getElementById('newestTimestamp');
const tablesContainer=document.getElementById('tablesContainer');
const overallTotalDisplay=document.getElementById('overallTotal');
const addTableBtn=document.getElementById('addTableBtn');
const notesInput=document.getElementById('notes');

let ridershipByRoute={};
let routeList=[];

const today=new Date();
today.setMinutes(today.getMinutes()-today.getTimezoneOffset());
dateInput.value=today.toISOString().split('T')[0];

document.getElementById('loadBtn').addEventListener('click',load);
window.addEventListener('load',load);
document.getElementById('exportBtn').addEventListener('click',exportCsv);
addTableBtn.addEventListener('click',()=>{
  const block=addRouteTable();
  const input=block.querySelector('.time-input');
  if(input){input.focus();}
});

if(!tablesContainer.children.length){
  addRouteTable();
}

function load(){
  spinner.style.display='inline-block';
  const [y,m,d]=dateInput.value.split('-').map(Number);
  const start=new Date(y,m-1,d);
  const end=new Date(start);
  end.setDate(start.getDate()+1);
  const startStr=(start.getMonth()+1)+"/"+start.getDate()+"/"+start.getFullYear();
  const endStr=(end.getMonth()+1)+"/"+end.getDate()+"/"+end.getFullYear();
  const url=`https://uva.transloc.com/Services/JSONPRelay.svc/GetRidershipData?startDate=${encodeURIComponent(startStr)}&endDate=${encodeURIComponent(endStr)}`;
  fetch(url).then(r=>r.json()).then(data=>{
    render(data||[]);
    spinner.style.display='none';
  }).catch(err=>{
    console.error(err);
    spinner.style.display='none';
  });
}

function render(data){
  ridershipByRoute={};
  let newest=null;
  data.forEach(rec=>{
    const route=rec.Route;
    const entries=Number(rec.Entries)||0;
    if(!route){return;}
    const timestamp=new Date(rec.ClientTime);
    const minutes=timestamp.getHours()*60+timestamp.getMinutes();
    if(!ridershipByRoute[route]){ridershipByRoute[route]=[];}
    ridershipByRoute[route].push({minutes,entries});
    if(!newest||timestamp>newest){newest=timestamp;}
  });
  routeList=Object.keys(ridershipByRoute).sort((a,b)=>a.localeCompare(b));
  newestTimestamp.textContent=newest?newest.toLocaleString():'';
  let blocks=[...tablesContainer.querySelectorAll('.route-block')];
  if(!blocks.length){
    addRouteTable();
    blocks=[...tablesContainer.querySelectorAll('.route-block')];
  }
  blocks.forEach(block=>{
    const select=block.querySelector('.route-select');
    populateRouteOptions(select);
    updateBlock(block);
  });
}

function populateRouteOptions(select){
  const previous=select.value;
  select.innerHTML='';
  const placeholder=document.createElement('option');
  placeholder.value='';
  placeholder.textContent=routeList.length?'Select a route':'Loading routes...';
  select.appendChild(placeholder);
  routeList.forEach(route=>{
    const opt=document.createElement('option');
    opt.value=route;
    opt.textContent=route;
    select.appendChild(opt);
  });
  if(routeList.includes(previous)){
    select.value=previous;
  }else{
    select.value='';
  }
}

function addRouteTable(){
  const block=document.createElement('div');
  block.className='route-block';

  const header=document.createElement('div');
  header.className='route-header';

  const label=document.createElement('label');
  label.textContent='Route:';
  const select=document.createElement('select');
  select.className='route-select';
  label.appendChild(select);

  const addRowBtn=document.createElement('button');
  addRowBtn.type='button';
  addRowBtn.textContent='Add Time Range';

  header.appendChild(label);
  header.appendChild(addRowBtn);
  block.appendChild(header);

  const table=document.createElement('table');
  table.className='route-table';

  const thead=document.createElement('thead');
  const headRow=document.createElement('tr');
  const thRange=document.createElement('th');
  thRange.textContent='Time Range (HHMM - HHMM)';
  const thPassengers=document.createElement('th');
  thPassengers.textContent='Passengers';
  headRow.appendChild(thRange);
  headRow.appendChild(thPassengers);
  thead.appendChild(headRow);

  const tbody=document.createElement('tbody');

  const tfoot=document.createElement('tfoot');
  const footRow=document.createElement('tr');
  const totalLabel=document.createElement('th');
  totalLabel.textContent='Total Displayed';
  const totalValue=document.createElement('td');
  totalValue.className='route-total';
  totalValue.textContent='0';
  footRow.appendChild(totalLabel);
  footRow.appendChild(totalValue);
  tfoot.appendChild(footRow);

  table.appendChild(thead);
  table.appendChild(tbody);
  table.appendChild(tfoot);
  block.appendChild(table);

  const quickAdd=document.createElement('div');
  quickAdd.className='quick-add';

  const add30Btn=createQuickAddButton(block,'+30 min',30);
  const add60Btn=createQuickAddButton(block,'+1 hr',60);
  quickAdd.appendChild(add30Btn);
  quickAdd.appendChild(add60Btn);

  block.appendChild(quickAdd);

  tablesContainer.appendChild(block);

  populateRouteOptions(select);
  addTimeRow(block);
  select.addEventListener('change',()=>updateBlock(block));
  addRowBtn.addEventListener('click',()=>{
    const row=addTimeRow(block);
    const input=row.querySelector('.time-input');
    if(input){input.focus();}
  });

  updateBlock(block);
  return block;
}

function addTimeRow(block){
  const tbody=block.querySelector('tbody');
  const row=document.createElement('tr');
  row.className='time-row';

  const timeCell=document.createElement('td');
  const input=document.createElement('input');
  input.type='text';
  input.placeholder='1430 - 2030';
  input.className='time-input';
  input.addEventListener('change',()=>updateBlock(block));
  input.addEventListener('input',()=>updateBlock(block));
  timeCell.appendChild(input);

  const resultCell=document.createElement('td');
  resultCell.className='result-cell';
  resultCell.textContent='-';

  row.appendChild(timeCell);
  row.appendChild(resultCell);
  tbody.appendChild(row);
  return row;
}

function createQuickAddButton(block,label,duration){
  const btn=document.createElement('button');
  btn.type='button';
  btn.textContent=label;
  btn.addEventListener('click',()=>{
    const range=getNextRange(block,duration);
    if(!range){return;}
    const row=addTimeRow(block);
    const input=row.querySelector('.time-input');
    input.value=formatRange(range.start,range.end);
    updateBlock(block);
    input.focus();
  });
  return btn;
}

function getNextRange(block,duration){
  const lastEnd=getLastRangeEnd(block);
  const start=lastEnd!==null?lastEnd:0;
  if(start>=1440){return null;}
  const end=Math.min(start+duration,1440);
  if(end<=start){return null;}
  return {start,end};
}

function getLastRangeEnd(block){
  let lastEnd=null;
  block.querySelectorAll('.time-row .time-input').forEach(input=>{
    const range=parseRange(input.value);
    if(range&&range.end>(lastEnd??-Infinity)){
      lastEnd=range.end;
    }
  });
  return lastEnd;
}

function formatRange(start,end){
  return `${formatMinutes(start)} - ${formatMinutes(end)}`;
}

function formatMinutes(total){
  const capped=Math.min(total,1439);
  const hours=String(Math.floor(capped/60)).padStart(2,'0');
  const mins=String(capped%60).padStart(2,'0');
  return `${hours}${mins}`;
}

function updateBlock(block){
  const select=block.querySelector('.route-select');
  const route=select.value;
  const rows=[...block.querySelectorAll('.time-row')];
  let total=0;
  rows.forEach(row=>{
    const input=row.querySelector('.time-input');
    const resultCell=row.querySelector('.result-cell');
    const range=parseRange(input.value);
    resultCell.classList.remove('invalid');
    if(!route){
      resultCell.textContent='-';
      return;
    }
    if(!range){
      const trimmed=input.value.trim();
      if(trimmed===''||!trimmed.includes('-')){
        resultCell.textContent='-';
      }else{
        resultCell.textContent='Invalid';
        resultCell.classList.add('invalid');
      }
      return;
    }
    const sum=sumForRange(route,range.start,range.end);
    resultCell.textContent=sum;
    total+=sum;
  });
  block.querySelector('.route-total').textContent=total;
  updateOverallTotal();
}

function updateOverallTotal(){
  let sum=0;
  tablesContainer.querySelectorAll('.route-total').forEach(cell=>{
    const value=Number(cell.textContent.replace(/[^0-9.-]/g,''));
    if(!Number.isNaN(value)){sum+=value;}
  });
  overallTotalDisplay.textContent=sum;
}

function parseRange(value){
  if(!value){return null;}
  const cleaned=value.trim().replace(/\s+/g,'');
  const match=cleaned.match(/^(\d{1,2})(\d{2})?-(\d{1,2})(\d{2})?$/);
  if(!match){
    const colonMatch=value.trim().match(/^(\d{1,2})(?::?(\d{2}))\s*-\s*(\d{1,2})(?::?(\d{2}))$/);
    if(!colonMatch){return null;}
    return normalizeRange(colonMatch[1],colonMatch[2],colonMatch[3],colonMatch[4]);
  }
  const [,sh,sm,eh,em]=match;
  const startMinutes=sm!==undefined?Number(sm):0;
  const endMinutes=em!==undefined?Number(em):0;
  return normalizeRange(sh,startMinutes,eh,endMinutes);
}

function normalizeRange(sh,sm,eh,em){
  const startHour=Number(sh);
  const startMin=Number(sm||0);
  const endHour=Number(eh);
  const endMin=Number(em||0);
  if([startHour,startMin,endHour,endMin].some(n=>Number.isNaN(n))){return null;}
  if(startHour>23||endHour>23||startMin>59||endMin>59){return null;}
  const start=startHour*60+startMin;
  let end=endHour*60+endMin;
  if(endHour===23&&endMin===59){end=1440;}
  if(end>1440){return null;}
  if(end<=start){return null;}
  return {start,end};
}

function sumForRange(route,start,end){
  const records=ridershipByRoute[route];
  if(!records){return 0;}
  let total=0;
  records.forEach(rec=>{
    if(rec.minutes>=start&&rec.minutes<end){
      total+=rec.entries;
    }
  });
  return total;
}

function exportCsv(){
  const lines=[];
  const dateValue=dateInput.value||new Date().toISOString().split('T')[0];
  lines.push(`Date,${escapeCsv(dateValue)}`);
  tablesContainer.querySelectorAll('.route-block').forEach((block,index)=>{
    const route=block.querySelector('.route-select').value||'';
    if(index>0){lines.push('');}
    lines.push(`Route,${escapeCsv(route)}`);
    lines.push('Time Range,Passengers');
    block.querySelectorAll('tbody tr').forEach(row=>{
      const timeValue=row.querySelector('.time-input').value.trim();
      const passengers=row.querySelector('.result-cell').textContent.trim();
      lines.push(`${escapeCsv(timeValue)},${escapeCsv(passengers)}`);
    });
    const total=block.querySelector('.route-total').textContent.trim();
    lines.push(`Total,${escapeCsv(total)}`);
  });
  const notes=notesInput.value.trim();
  if(notes){
    lines.push('');
    lines.push(`Notes,${escapeCsv(notes)}`);
  }
  const csv=lines.join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`ridership_${dateValue}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

function escapeCsv(text){
  const str=String(text||'');
  if(/[",\n]/.test(str)){
    return '"'+str.replace(/"/g,'""')+'"';
  }
  return str;
}
</script>
<script src="mobile-nav.js"></script>
</body>
</html>
