<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Service Crew - Headway Guard</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preload" href="FGDC.ttf" as="font" type="font/ttf" crossorigin />
<style>
  @font-face{font-family:'FGDC';src:url('FGDC.ttf') format('truetype');font-weight:normal;font-style:normal;}
  :root{ --bg:#0b0e11; --panel:#0f141a; --ink:#e8eef5; --muted:#9fb0c9; --line:#1f2630; --chip:#2a3442; }
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.2 'FGDC',sans-serif;height:100vh;width:100vw;display:flex;flex-direction:column;}
  table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:32px;}
  th,td{border:1px solid var(--line);padding:4px 8px;text-align:left;}
  #bustable th{font-size:24px;white-space:nowrap;}
  #bustable th:nth-child(1), #bustable td:nth-child(1),
  #bustable th:nth-child(3), #bustable td:nth-child(3){
    text-align:center;
  }
  #layout{flex:1;display:flex;overflow:hidden;height:100vh;gap:8px;padding:0 8px;}
  #table-wrapper{width:876px;overflow:hidden;display:flex;flex-direction:column;}
  #bustable col.bus{width:7ch;}
  #bustable col.miles{width:120px;}
  #mapframe{border:1px solid var(--line);height:918px;margin-top:162px;flex:1;}
  .credit{position:fixed;bottom:8px;right:8px;font-size:12px;color:var(--muted,#9fb0c9);}
  td.high-mileage{background:red;}
</style>
</head>
<body>
<div id="layout">
  <div id="table-wrapper">
    <div id="dateDisplay"></div>
    <table id="bustable">
      <colgroup>
        <col class="bus" />
        <col />
        <col class="miles" />
      </colgroup>
      <thead>
        <tr>
          <th>Bus</th>
          <th>Blocks</th>
          <th>Miles Today</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <iframe id="mapframe" src="/map?kioskMode=true"></iframe>
</div>
<div class="credit">proof of concept created by pat cox • phc6j@virginia.edu</div>
<script>
const dateSpan=document.getElementById('dateDisplay');
const tbody=document.querySelector('#bustable tbody');
let blockNameMap=new Map();

let OVERHEIGHT_BUSES=[];

function contrastColor(hex){
  if(!hex) return '#e8eef5';
  const c=hex.replace('#','');
  const r=parseInt(c.substr(0,2),16)/255;
  const g=parseInt(c.substr(2,2),16)/255;
  const b=parseInt(c.substr(4,2),16)/255;
  const l=0.2126*r+0.7152*g+0.0722*b;
  return l>0.5?'#000':'#fff';
}

async function loadConfig(){
  try{
    const cfg=await fetch('/v1/config');
    const data=await cfg.json();
    if(data.OVERHEIGHT_BUSES) OVERHEIGHT_BUSES=data.OVERHEIGHT_BUSES;
  }catch(_){ }
}

const alias={
  "[01]":"[01]/[04]",
  "[03]":"[05]/[03]",
  "[04]":"[01]/[04]",
  "[05]":"[05]/[03]",
  "[06]":"[22]/[06]",
  "[10]":"[20]/[10]",
  "[15]":"[26]/[15]",
  "[16] AM":"[21]/[16] AM",
  "[17]":"[23]/[17]",
  "[18] AM":"[24]/[18] AM",
  "[20] AM":"[20]/[10]",
  "[21] AM":"[21]/[16] AM",
  "[22] AM":"[22]/[06]",
  "[23]":"[23]/[17]",
  "[24] AM":"[24]/[18] AM",
  "[26] AM":"[26]/[15]"
};
function aliasBlock(b){const k=String(b||'').trim();return alias[k]||k;}

async function loadBlockMap(){
  try{
    const res=await fetch('/v1/dispatch/blocks');
    const data=await res.json();
    const groups=data.block_groups||[];
    const map=new Map();
    for(const g of groups){
      const name=aliasBlock(g.BlockGroupId);
      for(const b of (g.Blocks||[])){
        map.set(b.BlockId,name);
      }
    }
    blockNameMap=map;
  }catch(_){blockNameMap=new Map();}
}

function todayStr(){
  // Ensure date is computed in Charlottesville's timezone
  return new Date().toLocaleDateString('en-CA',{timeZone:'America/New_York'});
}
async function fetchData(){
  const date=todayStr();
  dateSpan.textContent=`Date: ${date}`;
  if(!blockNameMap.size) await loadBlockMap();
  const res=await fetch(`/v1/servicecrew?date=${date}`);
  const data=await res.json();
  tbody.innerHTML='';
  const buses=Object.entries(data.buses)
    .sort(([,a],[,b]) => (b.actual_miles||0)-(a.actual_miles||0));
  for(const [b,info] of buses){
    const tr=document.createElement('tr');
    const blocks=info.blocks.length?info.blocks.map(x=>blockNameMap.get(x)||x).join(', '):'—';
    const totalMilesToday=(info.actual_miles||0).toFixed(2);
    tr.innerHTML=`<td>${b}</td><td>${blocks}</td><td>${totalMilesToday}</td>`;
    const busCell=tr.children[0];
    let bg='#EEE8AA';
    if(OVERHEIGHT_BUSES.includes(b)){
      bg='#E57200';
    }else if(b.startsWith('24')){
      bg='#232D4B';
    }
    busCell.style.background=bg;
    busCell.style.color=contrastColor(bg);

    const milesCell=tr.children[2];
    if((info.actual_miles||0)>=100){
      milesCell.classList.add('high-mileage');
    }
    tbody.appendChild(tr);
  }
}
  async function init(){
    await loadConfig();
    await loadBlockMap();
    fetchData();
    setInterval(fetchData,30000);
    setInterval(loadBlockMap,30000);
    setInterval(loadConfig,30000);
  }
  init();
  const svcES=new EventSource('/v1/stream/servicecrew_refresh');
  svcES.onmessage=()=>location.reload();
  </script>
  </body>
  </html>
